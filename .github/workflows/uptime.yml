name: uptime-check
on:
  schedule:
    - cron: '*/10 * * * *'  # 10Î∂ÑÎßàÎã§ Ïã§Ìñâ
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping endpoints
        id: ping
        run: |
          set -e
          BASE="${{ secrets.UPTIME_BASE }}"
          
          echo "üîç Checking endpoints..."
          
          # Í∏∞Î≥∏ Ìó¨Ïä§Ï≤¥ÌÅ¨
          echo "Checking /healthz..."
          curl -fsS "$BASE/healthz" >/dev/null
          echo "‚úÖ /healthz OK"
          
          # ÏÇ¨Ïù¥Ìä∏Îßµ ÌôïÏù∏
          echo "Checking /sitemap.xml..."
          curl -fsS "$BASE/sitemap.xml" >/dev/null
          echo "‚úÖ /sitemap.xml OK"
          
          # OG Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÌÖåÏä§Ìä∏
          echo "Checking OG generation..."
          curl -fsS "$BASE/og?title=test&sport=soccer" >/dev/null
          echo "‚úÖ OG generation OK"
          
          # Î©îÏù∏ ÌéòÏù¥ÏßÄ (SPA ÎùºÏö∞ÌåÖ)
          echo "Checking main page..."
          curl -fsS "$BASE/" >/dev/null
          echo "‚úÖ Main page OK"
          
          echo "üéâ All endpoints healthy!"

      - name: Slack notify (on failure)
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "üö® **YAGO Stack Uptime Alert**",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Uptime check failed* on `${{ secrets.UPTIME_BASE }}`\n\nPlease check the logs and service status."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Service"
                      },
                      "url": "${{ secrets.UPTIME_BASE }}/healthz"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "https://github.com/${{ github.repository }}/actions"
                    }
                  ]
                }
              ]
            }' \
            '${{ secrets.SLACK_WEBHOOK_URL }}'

      - name: Success notification (daily summary)
        if: success() && github.event.schedule == '*/10 * * * *'
        run: |
          # Îß§Ïùº Ï≤´ Î≤àÏß∏ ÏÑ±Í≥µ ÏãúÏóêÎßå ÏïåÎ¶º (00:00Ïóê Ïã§ÌñâÎêòÎäî Í≤ΩÏö∞)
          if [ "$(date +%H%M)" = "0000" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "‚úÖ **YAGO Stack Daily Health Report**",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "üéâ *All systems operational*\n\n24-hour uptime check: *100%* ‚úÖ\nService: `${{ secrets.UPTIME_BASE }}`"
                    }
                  }
                ]
              }' \
              '${{ secrets.SLACK_WEBHOOK_URL }}'
          fi
