{
  "name": "YAGO VIBE KakaoTalk Biz API ë¦¬í¬íŠ¸ ì „ì†¡",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "kakao-trigger",
      "name": "ë§¤ì¼ ì˜¤ì „ 8ì‹œ ì‹¤í–‰",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookDescription": "ë§¤ì¼ ì˜¤ì „ 8ì‹œì— ì‹¤í–‰ë˜ì–´ KakaoTalkìœ¼ë¡œ ë¦¬í¬íŠ¸ ìš”ì•½ì„ ì „ì†¡í•©ë‹ˆë‹¤"
    },
    {
      "parameters": {
        "projectId": "jaeman-vibe-platform",
        "collection": "reports",
        "operation": "getMany",
        "limit": 1
      },
      "id": "firestore-latest-report",
      "name": "Firestore: ìµœì‹  ë¦¬í¬íŠ¸ ì¡°íšŒ",
      "type": "n8n-nodes-base.googleFirebase",
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "functionCode": "// ìµœì‹  ë¦¬í¬íŠ¸ ë°ì´í„° ì²˜ë¦¬\nconst reports = $input.all().map(item => item.json);\nconst latestReport = reports[0];\n\nif (!latestReport) {\n  return [{\n    json: {\n      error: \"ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\",\n      hasData: false\n    }\n  }];\n}\n\n// ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ìš© ìš”ì•½ ìƒì„±\nconst totalNotifications = (latestReport.stats?.FCM || 0) + \n                         (latestReport.stats?.Slack || 0) + \n                         (latestReport.stats?.Kakao || 0) + \n                         (latestReport.stats?.message || 0) + \n                         (latestReport.stats?.comment || 0) + \n                         (latestReport.stats?.market || 0) + \n                         (latestReport.stats?.system || 0);\n\nconst reportDate = new Date(latestReport.date).toLocaleDateString('ko-KR', {\n  month: 'long',\n  day: 'numeric',\n  weekday: 'short'\n});\n\n// ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ í…œí”Œë¦¿\nconst kakaoMessage = `âš½ YAGO VIBE ì¼ì¼ ë¦¬í¬íŠ¸\n\nğŸ“… ${reportDate}\nğŸ“Š ì´ ì•Œë¦¼: ${totalNotifications}ê±´\n\nğŸ“± FCM: ${latestReport.stats?.FCM || 0}ê±´\nğŸ“¢ Slack: ${latestReport.stats?.Slack || 0}ê±´\nğŸ’Œ Kakao: ${latestReport.stats?.Kakao || 0}ê±´\n\nğŸ¤– AI ìš”ì•½:\n${latestReport.summary ? latestReport.summary.substring(0, 150) + '...' : 'ìš”ì•½ ë°ì´í„° ì—†ìŒ'}\n\nğŸ“ˆ ìì„¸í•œ ë‚´ìš©ì€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”!`;\n\nconsole.log('ğŸ“± ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ì¤€ë¹„ ì™„ë£Œ:', kakaoMessage.length, 'ì');\n\nreturn [{\n  json: {\n    hasData: true,\n    reportDate: latestReport.date,\n    totalNotifications,\n    kakaoMessage,\n    stats: latestReport.stats,\n    summary: latestReport.summary\n  }\n}];"
      },
      "id": "js-kakao-message",
      "name": "JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "url": "https://kapi.kakao.com/v2/api/talk/memo/default/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.KAKAO_ACCESS_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "template_object",
              "value": "={{JSON.stringify({\"object_type\": \"text\", \"text\": $json.kakaoMessage, \"link\": {\"web_url\": \"http://localhost:5183/admin/reports\", \"mobile_web_url\": \"http://localhost:5183/admin/reports\"}, \"button_title\": \"ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ\"})}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "kakao-api-send",
      "name": "KakaoTalk API: ë©”ì‹œì§€ ì „ì†¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "url": "https://kapi.kakao.com/v1/api/talk/friends",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.KAKAO_ACCESS_TOKEN}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "kakao-friends-list",
      "name": "KakaoTalk: ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1400, 500]
    },
    {
      "parameters": {
        "functionCode": "// ì¹œêµ¬ ëª©ë¡ì—ì„œ íŠ¹ì • ì¹œêµ¬ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡\nconst friendsData = $input.first().json;\nconst messageData = $input.last().json;\n\nif (!friendsData.elements || friendsData.elements.length === 0) {\n  return [{\n    json: {\n      error: \"ì¹œêµ¬ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\",\n      success: false\n    }\n  }];\n}\n\n// íŠ¹ì • ì¹œêµ¬ ì°¾ê¸° (ì˜ˆ: 'ê´€ë¦¬ì' ë˜ëŠ” 'í˜•ë‹˜'ì´ë¼ëŠ” ì´ë¦„ì˜ ì¹œêµ¬)\nconst targetFriend = friendsData.elements.find(friend => \n  friend.profile_nickname && \n  (friend.profile_nickname.includes('ê´€ë¦¬ì') || \n   friend.profile_nickname.includes('í˜•ë‹˜') ||\n   friend.profile_nickname.includes('jaeman'))\n);\n\nif (!targetFriend) {\n  return [{\n    json: {\n      error: \"ëŒ€ìƒ ì¹œêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\",\n      success: false,\n      availableFriends: friendsData.elements.map(f => f.profile_nickname)\n    }\n  }];\n}\n\nconst kakaoMessage = messageData.kakaoMessage;\n\nreturn [{\n  json: {\n    success: true,\n    targetFriend: targetFriend.profile_nickname,\n    targetUuid: targetFriend.uuid,\n    message: kakaoMessage,\n    reportDate: messageData.reportDate,\n    totalNotifications: messageData.totalNotifications\n  }\n}];"
      },
      "id": "js-find-friend",
      "name": "JavaScript: ëŒ€ìƒ ì¹œêµ¬ ì°¾ê¸°",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1800, 400]
    },
    {
      "parameters": {
        "url": "https://kapi.kakao.com/v1/api/talk/friends/message/default/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.KAKAO_ACCESS_TOKEN}}"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "receiver_uuids",
              "value": "=[\"{{$json.targetUuid}}\"]"
            },
            {
              "name": "template_object",
              "value": "={{JSON.stringify({\"object_type\": \"text\", \"text\": $json.message, \"link\": {\"web_url\": \"http://localhost:5183/admin/reports\", \"mobile_web_url\": \"http://localhost:5183/admin/reports\"}, \"button_title\": \"ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ\"})}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "kakao-friend-message",
      "name": "KakaoTalk: ì¹œêµ¬ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2200, 400]
    },
    {
      "parameters": {
        "channel": "#yago-vibe-reports",
        "text": "ğŸ“± **KakaoTalk Biz API ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ!**\\n\\nğŸ“… **ë¦¬í¬íŠ¸ ë‚ ì§œ**: {{$('JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±').item.json.reportDate}}\\nğŸ“Š **ì´ ì•Œë¦¼ ìˆ˜**: {{$('JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±').item.json.totalNotifications}}ê±´\\n\\nâœ… **ì „ì†¡ ê²°ê³¼**:\\n- ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ì „ì†¡: ì„±ê³µ\\n- ëŒ€ìƒ: {{$('JavaScript: ëŒ€ìƒ ì¹œêµ¬ ì°¾ê¸°').item.json.targetFriend || 'ê¸°ë³¸ ë©”ì‹œì§€'}}\\n\\nğŸ’¬ **ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°**:\\n{{$('JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±').item.json.kakaoMessage.substring(0, 100)}}...\\n\\nğŸš€ í˜•ë‹˜ì˜ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë§¤ì¼ ì˜¤ì „ 8ì‹œì— ìë™ ì „ì†¡ë©ë‹ˆë‹¤!"
      },
      "id": "slack-kakao-notify",
      "name": "Slack: ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ ì•Œë¦¼",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [2200, 200]
    }
  ],
  "connections": {
    "ë§¤ì¼ ì˜¤ì „ 8ì‹œ ì‹¤í–‰": {
      "main": [
        [
          {
            "node": "Firestore: ìµœì‹  ë¦¬í¬íŠ¸ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Firestore: ìµœì‹  ë¦¬í¬íŠ¸ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±",
            "type": "main",
            "index": 0
          },
          {
            "node": "KakaoTalk: ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JavaScript: ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ìƒì„±": {
      "main": [
        [
          {
            "node": "KakaoTalk API: ë©”ì‹œì§€ ì „ì†¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KakaoTalk: ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "JavaScript: ëŒ€ìƒ ì¹œêµ¬ ì°¾ê¸°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JavaScript: ëŒ€ìƒ ì¹œêµ¬ ì°¾ê¸°": {
      "main": [
        [
          {
            "node": "KakaoTalk: ì¹œêµ¬ì—ê²Œ ë©”ì‹œì§€ ì „ì†¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "Slack: ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ ì•Œë¦¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["yago-vibe", "kakao", "biz-api", "automation", "mobile"],
  "triggerCount": 0,
  "meta": {
    "description": "ë§¤ì¼ ì˜¤ì „ 8ì‹œì— ì‹¤í–‰ë˜ì–´ ìµœì‹  ë¦¬í¬íŠ¸ ìš”ì•½ì„ KakaoTalk Biz APIë¥¼ í†µí•´ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì „ì†¡í•˜ëŠ” ì›Œí¬í”Œë¡œìš°ì…ë‹ˆë‹¤."
  }
}
