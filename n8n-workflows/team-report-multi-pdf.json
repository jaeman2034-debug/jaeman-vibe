{
  "name": "YAGO VIBE - Team Report Multi-PDF Automation",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "name": "Cron - Every Monday 9AM",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 400],
      "id": "cron-node"
    },
    {
      "parameters": {
        "resource": "document",
        "operation": "getAll",
        "projectId": "={{$env.FIREBASE_PROJECT_ID}}",
        "collection": "chat_summaries",
        "options": {
          "filters": {
            "field": "createdAt",
            "operator": ">=",
            "value": "={{$now.minus(7, 'days').toISO()}}"
          },
          "orderBy": {
            "field": "createdAt",
            "direction": "desc"
          }
        }
      },
      "name": "Firestore - Get All Summaries",
      "type": "n8n-nodes-base.googleFirestore",
      "typeVersion": 1,
      "position": [470, 400],
      "id": "firestore-node"
    },
    {
      "parameters": {
        "functionCode": "const { jsPDF } = require('jspdf');\n\nconst teams = {\n  soheul60: { name: '?뚰쓽FC 60', docs: [], email: 'coach60@yagovibe.com' },\n  soheul88: { name: '?뚰쓽FC 88', docs: [], email: 'coach88@yagovibe.com' },\n  academy: { name: '?뚰쓽 ?꾩뭅?곕?', docs: [], email: 'academy@yagovibe.com' },\n};\n\n// ?곗씠???蹂꾨줈 遺꾨쪟\nitems.forEach((item) => {\n  const { teamId, sentiment, summary, emotion } = item.json;\n  const tid = teamId || 'academy';\n  if (teams[tid]) {\n    teams[tid].docs.push({ \n      sentiment: sentiment || emotion || 'neutral', \n      summary: summary || '?붿빟 ?놁쓬' \n    });\n  }\n});\n\n// ?蹂?PDF ?앹꽦 ?⑥닔\nfunction generateTeamPDF(team) {\n  const doc = new jsPDF();\n  doc.setFont('helvetica', 'normal');\n  \n  // ?쒕ぉ\n  doc.setFontSize(20);\n  doc.text(`YAGO VIBE Team Report`, 20, 20);\n  doc.setFontSize(16);\n  doc.text(`${team.name}`, 20, 30);\n  \n  doc.setFontSize(12);\n  doc.text(`Generated: ${new Date().toLocaleDateString('ko-KR')}`, 20, 40);\n  doc.text(`Period: Last 7 days`, 20, 47);\n  \n  // 媛먯젙 ?듦퀎\n  const counts = { positive: 0, neutral: 0, negative: 0 };\n  team.docs.forEach((d) => {\n    const s = (d.sentiment || 'neutral').toLowerCase();\n    if (s.includes('positive') || s === '湲띿젙') counts.positive++;\n    else if (s.includes('negative') || s === '遺??) counts.negative++;\n    else counts.neutral++;\n  });\n  \n  const total = team.docs.length || 1;\n  \n  doc.setFontSize(14);\n  doc.text('========================================', 20, 60);\n  doc.text('Sentiment Statistics', 20, 68);\n  doc.text('========================================', 20, 75);\n  \n  doc.setFontSize(12);\n  doc.text(`Positive: ${counts.positive} (${(counts.positive / total * 100).toFixed(1)}%)`, 20, 85);\n  doc.text(`Neutral: ${counts.neutral} (${(counts.neutral / total * 100).toFixed(1)}%)`, 20, 92);\n  doc.text(`Negative: ${counts.negative} (${(counts.negative / total * 100).toFixed(1)}%)`, 20, 99);\n  doc.text(`Total Messages: ${total}`, 20, 106);\n  \n  // 二쇱슂 ?붿빟\n  doc.setFontSize(14);\n  doc.text('========================================', 20, 120);\n  doc.text('Top Summaries', 20, 128);\n  doc.text('========================================', 20, 135);\n  \n  let y = 145;\n  team.docs.slice(0, 10).forEach((d, i) => {\n    if (y > 270) {\n      doc.addPage();\n      y = 20;\n    }\n    \n    const s = (d.sentiment || 'neutral').toLowerCase();\n    const label = s.includes('positive') ? '[+]' : s.includes('negative') ? '[-]' : '[=]';\n    \n    const text = `${i + 1}. ${label} ${d.summary}`;\n    const lines = doc.splitTextToSize(text, 170);\n    \n    doc.setFontSize(10);\n    doc.text(lines, 20, y);\n    y += lines.length * 6 + 3;\n  });\n  \n  // ?명꽣\n  doc.setFontSize(8);\n  doc.text(`Generated by YAGO VIBE AI System for ${team.name}`, 20, 285);\n  \n  const pdfBuffer = doc.output('arraybuffer');\n  const base64PDF = Buffer.from(pdfBuffer).toString('base64');\n  \n  return {\n    teamId: Object.keys(teams).find(k => teams[k].name === team.name),\n    teamName: team.name,\n    email: team.email,\n    filename: `YAGO_${team.name.replace(/\\s+/g, '_')}_Report_${new Date().toISOString().slice(0, 10)}.pdf`,\n    pdfBase64: base64PDF,\n    positiveCount: counts.positive,\n    neutralCount: counts.neutral,\n    negativeCount: counts.negative,\n    positivePercent: (counts.positive / total * 100).toFixed(1)\n  };\n}\n\n// 3媛?? PDF ?앹꽦\nconst outputs = Object.values(teams).map((team) => ({\n  json: makeReport(team),\n  binary: {\n    pdf: {\n      data: makeReport(team).pdfBase64,\n      mimeType: 'application/pdf',\n      fileName: makeReport(team).filename\n    }\n  }\n}));\n\nreturn outputs;"
      },
      "name": "Function - Generate Team PDFs",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [690, 400],
      "id": "function-node"
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "to": "={{$json.email}}",
        "subject": "?뱤 [YAGO VIBE] {{$json.teamName}} 二쇨컙 AI 由ы룷??,
        "message": "?덈뀞?섏꽭??{{$json.teamName}} 肄붿튂???몝\n\n?대쾲 二?? ????붿빟 諛?媛먯젙 遺꾩꽍 由ы룷?몄엯?덈떎.\n\n?뱤 媛먯젙 ?듦퀎:\n- ?삃 湲띿젙: {{$json.positiveCount}}媛?({{$json.positivePercent}}%)\n- ?삉 以묐┰: {{$json.neutralCount}}媛?n- ?삍 遺?? {{$json.negativeCount}}媛?n\n泥⑤???PDF ?뚯씪?먯꽌 ?곸꽭 ?댁슜???뺤씤?섏꽭??\n\n媛먯궗?⑸땲??\nYAGO VIBE AI System ??,
        "options": {
          "attachments": "pdf",
          "binaryPropertyName": "pdf"
        }
      },
      "name": "Gmail - Send to Each Coach",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [910, 200],
      "id": "gmail-node",
      "credentials": {
        "gmailOAuth2": {
          "id": "1",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.SLACK_WEBHOOK_URL}}",
        "options": {
          "bodyContentType": "json"
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "?뱤 *YAGO VIBE 二쇨컙 ? 由ы룷??諛쒖넚 ?꾨즺!*\n\n?대쾲 二?3媛?? AI 遺꾩꽍 由ы룷?멸? ?앹꽦?섏뼱 媛?肄붿튂?섍퍡 ?대찓?쇰줈 諛쒖넚?섏뿀?듬땲??\n\n?룇 ?蹂?湲띿젙瑜?\n???뚰쓽FC 60: {{$item(0).$json.positivePercent}}%\n???뚰쓽FC 88: {{$item(1).$json.positivePercent}}%\n???뚰쓽 ?꾩뭅?곕?: {{$item(2).$json.positivePercent}}%\n\n_Generated by YAGO VIBE AI System ??"
            }
          ]
        }
      },
      "name": "Slack - Team Report Summary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [910, 400],
      "id": "slack-node"
    },
    {
      "parameters": {
        "url": "={{$env.DISCORD_WEBHOOK_URL}}",
        "options": {
          "bodyContentType": "json"
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "username",
              "value": "YAGO VIBE Reporter"
            },
            {
              "name": "embeds",
              "value": "=[{\"title\":\"??YAGO VIBE 二쇨컙 ? 由ы룷??",\"description\":\"3媛????AI ???遺꾩꽍???꾨즺?섏뿀?듬땲??\",\"color\":5814783,\"fields\":[{\"name\":\"?뚰쓽FC 60\",\"value\":\"?삃 湲띿젙 {{$item(0).$json.positivePercent}}%\",\"inline\":true},{\"name\":\"?뚰쓽FC 88\",\"value\":\"?삃 湲띿젙 {{$item(1).$json.positivePercent}}%\",\"inline\":true},{\"name\":\"?뚰쓽 ?꾩뭅?곕?\",\"value\":\"?삃 湲띿젙 {{$item(2).$json.positivePercent}}%\",\"inline\":true}],\"footer\":{\"text\":\"YAGO VIBE AI System ??{{$now.format('yyyy.MM.dd HH:mm')}}\"},\"timestamp\":\"{{$now.toISO()}}\"}]"
            }
          ]
        }
      },
      "name": "Discord - Team Report Embed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [910, 600],
      "id": "discord-node"
    }
  ],
  "connections": {
    "Cron - Every Monday 9AM": {
      "main": [
        [
          {
            "node": "Firestore - Get All Summaries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Firestore - Get All Summaries": {
      "main": [
        [
          {
            "node": "Function - Generate Team PDFs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function - Generate Team PDFs": {
      "main": [
        [
          {
            "node": "Gmail - Send to Each Coach",
            "type": "main",
            "index": 0
          },
          {
            "node": "Slack - Team Report Summary",
            "type": "main",
            "index": 0
          },
          {
            "node": "Discord - Team Report Embed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "id": "1",
      "name": "YAGO VIBE"
    },
    {
      "id": "2",
      "name": "Team Report"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-10-14T00:00:00.000Z",
  "versionId": "3"
}

