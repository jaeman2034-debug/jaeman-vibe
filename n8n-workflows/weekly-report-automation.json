{
  "name": "YAGO VIBE - Weekly AI Report Automation",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "name": "Cron - Every Monday 9AM",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "resource": "document",
        "operation": "getAll",
        "projectId": "={{$env.FIREBASE_PROJECT_ID}}",
        "collection": "chat_summaries",
        "options": {
          "filters": {
            "field": "createdAt",
            "operator": ">=",
            "value": "={{$now.minus(7, 'days').toISO()}}"
          },
          "orderBy": {
            "field": "createdAt",
            "direction": "desc"
          }
        }
      },
      "name": "Firestore - Get Summaries",
      "type": "n8n-nodes-base.googleFirestore",
      "typeVersion": 1,
      "position": [470, 300]
    },
    {
      "parameters": {
        "functionCode": "const { jsPDF } = require('jspdf');\nconst doc = new jsPDF();\n\n// ?쒕ぉ\ndoc.setFontSize(20);\ndoc.text('YAGO VIBE AI Report', 20, 20);\n\ndoc.setFontSize(12);\ndoc.text(`Report Period: Last 7 days`, 20, 30);\ndoc.text(`Generated: ${new Date().toLocaleDateString('ko-KR')}`, 20, 37);\n\n// 媛먯젙 ?듦퀎\nconst summaries = items.map(i => i.json);\nconst counts = { positive: 0, neutral: 0, negative: 0 };\nsummaries.forEach(s => {\n  const sentiment = (s.sentiment || s.emotion || 'neutral').toLowerCase();\n  if (sentiment.includes('positive') || sentiment === '湲띿젙') counts.positive++;\n  else if (sentiment.includes('negative') || sentiment === '遺??) counts.negative++;\n  else counts.neutral++;\n});\n\nconst total = summaries.length || 1;\n\ndoc.setFontSize(14);\ndoc.text('========================================', 20, 47);\ndoc.text('Sentiment Statistics', 20, 55);\ndoc.text('========================================', 20, 62);\n\ndoc.setFontSize(12);\ndoc.text(`Positive: ${counts.positive} (${(counts.positive / total * 100).toFixed(1)}%)`, 20, 72);\ndoc.text(`Neutral: ${counts.neutral} (${(counts.neutral / total * 100).toFixed(1)}%)`, 20, 80);\ndoc.text(`Negative: ${counts.negative} (${(counts.negative / total * 100).toFixed(1)}%)`, 20, 88);\ndoc.text(`Total Messages: ${total}`, 20, 96);\n\n// 二쇱슂 ?붿빟\ndoc.setFontSize(14);\ndoc.text('========================================', 20, 110);\ndoc.text('Top Summaries', 20, 118);\ndoc.text('========================================', 20, 125);\n\nlet y = 135;\nsummaries.slice(0, 15).forEach((s, i) => {\n  if (y > 270) {\n    doc.addPage();\n    y = 20;\n  }\n  \n  const sentiment = (s.sentiment || s.emotion || 'neutral').toLowerCase();\n  const label = sentiment.includes('positive') ? '[+]' : sentiment.includes('negative') ? '[-]' : '[=]';\n  \n  const text = `${i + 1}. ${label} ${s.summary || 'No summary'}`;\n  const lines = doc.splitTextToSize(text, 170);\n  \n  doc.setFontSize(10);\n  doc.text(lines, 20, y);\n  y += lines.length * 6 + 3;\n});\n\n// ?명꽣\ndoc.setFontSize(8);\ndoc.text('Generated by YAGO VIBE AI System', 20, 285);\n\nconst pdfBuffer = doc.output('arraybuffer');\nconst base64PDF = Buffer.from(pdfBuffer).toString('base64');\n\nreturn [{\n  json: {\n    filename: `YAGO_Weekly_Report_${new Date().toISOString().slice(0, 10)}.pdf`,\n    pdfBase64: base64PDF,\n    statistics: counts,\n    total: total\n  },\n  binary: {\n    pdf: {\n      data: base64PDF,\n      mimeType: 'application/pdf',\n      fileName: `YAGO_Weekly_Report_${new Date().toISOString().slice(0, 10)}.pdf`\n    }\n  }\n}];"
      },
      "name": "Function - Generate PDF",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [690, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "to": "coach@yagovibe.com, manager@yagovibe.com",
        "subject": "?뱤 [YAGO VIBE] 二쇨컙 AI ???由ы룷??,
        "message": "?덈뀞?섏꽭??肄붿튂???몝\n\n?대쾲 二?YAGO VIBE AI ???由ы룷?몄엯?덈떎.\n\n?뱤 媛먯젙 ?듦퀎:\n- ?삃 湲띿젙: {{$json.statistics.positive}}媛?n- ?삉 以묐┰: {{$json.statistics.neutral}}媛?n- ?삍 遺?? {{$json.statistics.negative}}媛?n- ?뱷 珥?遺꾩꽍: {{$json.total}}媛?n\n?蹂?媛먯젙 鍮꾩쑉怨?二쇱슂 ?쇰뱶諛??붿빟??泥⑤? ?뚯씪?먯꽌 ?뺤씤?섏꽭??\n\n媛먯궗?⑸땲??\nYAGO VIBE AI System ??,
        "options": {
          "attachments": "pdf",
          "binaryPropertyName": "pdf"
        }
      },
      "name": "Gmail - Send Report",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [910, 300],
      "credentials": {
        "gmailOAuth2": {
          "id": "1",
          "name": "Gmail OAuth2"
        }
      }
    }
  ],
  "connections": {
    "Cron - Every Monday 9AM": {
      "main": [
        [
          {
            "node": "Firestore - Get Summaries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Firestore - Get Summaries": {
      "main": [
        [
          {
            "node": "Function - Generate PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function - Generate PDF": {
      "main": [
        [
          {
            "node": "Gmail - Send Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-10-11T00:00:00.000Z",
  "versionId": "1"
}

