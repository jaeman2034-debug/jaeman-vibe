import { useState } from 'react';
export default function DealProposal({ threadId, currentUserId, otherUserId, isDealCompleted, onDealProposed }) { const [mode, setMode] = useState('meet'); const [price, setPrice] = useState(''); const [place, setPlace] = useState(''); const [meetDate, setMeetDate] = useState(''); const [meetTime, setMeetTime] = useState(''); const [loading, setLoading] = useState(false); } // ?�기 ?�성 모달 ?�태  const [showReviewModal, setShowReviewModal] = useState(false);  const [reviewTargetId, setReviewTargetId] = useState('');  const [dealCompleted, setDealCompleted] = useState(false);  // ?�재 ?�간?�로부??1?�간 ?��? 기본값으�??�정  const getDefaultDateTime = () => {    const now = new Date();    now.setHours(now.getHours() + 1);    now.setMinutes(0);    now.setSeconds(0);        const dateStr = now.toISOString().split('T')[0];    const timeStr = now.toTimeString().slice(0, 5);        return { dateStr, timeStr };  };  React.useEffect(() => {    const { dateStr, timeStr } = getDefaultDateTime();    setMeetDate(dateStr);    setMeetTime(timeStr);  }, []);  // 거래 ?�료 ?�태 감�?  React.useEffect(() => {    if (isDealCompleted) {      setDealCompleted(true);    }  }, [isDealCompleted]);  // 거래 ?�료 처리  const handleCompleteDeal = async () => {    try {      setLoading(true);      await completeDeal(threadId);      setDealCompleted(true);            // ?�제 ?��?�?ID ?�용      setReviewTargetId(otherUserId);            // ?�기 ?�성 모달 ?�시      setShowReviewModal(true);          } catch (error: any) {      console.error('거래 ?�료 ?�패:', error);      alert(error.message || '거래 ?�료???�패?�습?�다.');    } finally {      setLoading(false);    }  };  const handleSubmit = async (e: React.FormEvent) => {    e.preventDefault();        if (!price.trim()) {      alert('가격을 ?�력?�주?�요.');      return;    }    if (mode === 'meet' && !place.trim()) {      alert('만남 ?�소�??�력?�주?�요.');      return;    }    if (mode === 'meet' && (!meetDate || !meetTime)) {      alert('만남 ?�간???�택?�주?�요.');      return;    }    try {      setLoading(true);            const priceNum = parseInt(price);      if (isNaN(priceNum) || priceNum <= 0) {        alert('?�바�?가격을 ?�력?�주?�요.');        return;      }      if (mode === 'meet') {        const meetAt = new Date(`${meetDate}T${meetTime}`);        if (meetAt <= new Date()) {          alert('만남 ?�간?� ?�재 ?�간보다 ?�후?�야 ?�니??');          return;        }                await proposeDeal(threadId, {          mode: 'meet',          price: priceNum,          place: place.trim(),          meetAt: meetAt        });      } else {        await proposeDeal(threadId, {          mode: 'delivery',          price: priceNum        });      }      alert('거래 ?�안???�송?�었?�니??');            // ??초기??      setPrice('');      setPlace('');      const { dateStr, timeStr } = getDefaultDateTime();      setMeetDate(dateStr);      setMeetTime(timeStr);            // 콜백 ?�출      onDealProposed?.();          } catch (error: any) {      console.error('거래 ?�안 ?�패:', error);      alert(error.message || '거래 ?�안???�패?�습?�다.');    } finally {      setLoading(false);    }  };  const formatDateTime = (date: string, time: string) => {    if (!date || !time) return '';    const dateObj = new Date(`${date}T${time}`);    return dateObj.toLocaleString('ko-KR', {      year: 'numeric',      month: 'long',      day: 'numeric',      hour: '2-digit',      minute: '2-digit',      weekday: 'long'    });  };  return (    <>      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">        <h3 className="text-lg font-semibold text-blue-800 mb-3">거래 ?�안?�기</h3>                {/* 거래 ?�료 버튼 (거래가 진행 중일 ?�만 ?�시) */}        {dealCompleted && (          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">            <p className="text-green-800 text-sm mb-2">거래가 ?�료?�었?�니??</p>            <button              onClick={handleCompleteDeal}              disabled={loading}              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"            >              {loading ? '처리 �?..' : '거래 ?�료 처리'}            </button>          </div>        )}                <form onSubmit={handleSubmit} className="space-y-4">          {/* 거래 모드 ?�택 */}          <div>            <label className="block text-sm font-medium text-gray-700 mb-2">              거래 방식            </label>            <div className="flex gap-3">              <label className="flex items-center">                <input                  type="radio"                  value="meet"                  checked={mode === 'meet'}                  onChange={(e) => setMode(e.target.value as 'meet' | 'delivery')}                  className="mr-2"                />                <span className="text-sm">직거??/span>              </label>              <label className="flex items-center">                <input                  type="radio"                  value="delivery"                  checked={mode === 'delivery'}                  onChange={(e) => setMode(e.target.value as 'meet' | 'delivery')}                  className="mr-2"                />                <span className="text-sm">?�배</span>              </label>            </div>          </div>          {/* 가�??�력 */}          <div>            <label className="block text-sm font-medium text-gray-700 mb-2">              ?�안 가�?            </label>            <div className="relative">              <input                type="number"                value={price}                onChange={(e) => setPrice(e.target.value)}                placeholder="가격을 ?�력?�세??                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                min="0"              />              <span className="absolute right-3 top-2 text-gray-500">??/span>            </div>          </div>          {/* 만남 ?�소 (직거?�만) */}          {mode === 'meet' && (            <div>              <label className="block text-sm font-medium text-gray-700 mb-2">                만남 ?�소              </label>              <input                type="text"                value={place}                onChange={(e) => setPlace(e.target.value)}                placeholder="?? ?�울??3�?출구 ?��?벅스"                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"              />            </div>          )}          {/* 만남 ?�간 (직거?�만) */}          {mode === 'meet' && (            <div>              <label className="block text-sm font-medium text-gray-700 mb-2">                만남 ?�간              </label>              <div className="flex gap-2">                <input                  type="date"                  value={meetDate}                  onChange={(e) => setMeetDate(e.target.value)}                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                  min={new Date().toISOString().split('T')[0]}                />                <input                  type="time"                  value={meetTime}                  onChange={(e) => setMeetTime(e.target.value)}                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                />              </div>              {meetDate && meetTime && (                <p className="text-sm text-gray-600 mt-1">                  ?�� {formatDateTime(meetDate, meetTime)}                </p>              )}            </div>          )}          {/* ?�출 버튼 */}          <button            type="submit"            disabled={loading}            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"          >            {loading ? '?�안 �?..' : '거래 ?�안?�기'}          </button>        </form>        {/* ?�내 메시지 */}        <div className="mt-3 text-xs text-blue-600">          <p>?�� 거래 ?�안??보내�??��?방이 ?�락/거절?????�습?�다.</p>          {mode === 'meet' && (            <p>?�� 직거?�는 만남 ?�소?� ?�간???�확??지?�해주세??</p>          )}          {mode === 'delivery' && (            <p>?�� ?�배??가격만 ?�안?�면 ?�니??</p>          )}        </div>      </div>      {/* ?�기 ?�성 모달 */}      {showReviewModal && (        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">            <h3 className="text-lg font-semibold mb-4">거래 ?�기 ?�성</h3>            <p className="text-sm text-gray-600 mb-4">              거래가 ?�료?�었?�니?? ?��?방에 ?�???�기�??�겨주세??            </p>                        <ReviewForm              threadId={threadId}              targetId={reviewTargetId}              onReviewSubmitted={() => {                setShowReviewModal(false);                alert('?�기가 ?�성?�었?�니??');              }}              onCancel={() => setShowReviewModal(false)}            />          </div>        </div>      )}    </>  );}
