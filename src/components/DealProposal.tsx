import React, { useState } from 'react';import { auth } from '@/lib/firebase';import { proposeDeal, completeDeal } from '@/services/dealService';import { submitReview } from '@/services/reviewService';interface DealProposalProps {  threadId: string;  currentUserId: string;  otherUserId: string;  isDealCompleted?: boolean;  onDealProposed?: () => void;}export default function DealProposal({ threadId, currentUserId, otherUserId, isDealCompleted, onDealProposed }: DealProposalProps) {  const [mode, setMode] = useState<'meet' | 'delivery'>('meet');  const [price, setPrice] = useState('');  const [place, setPlace] = useState('');  const [meetDate, setMeetDate] = useState('');  const [meetTime, setMeetTime] = useState('');  const [loading, setLoading] = useState(false);    // ?„ê¸° ?‘ì„± ëª¨ë‹¬ ?íƒœ  const [showReviewModal, setShowReviewModal] = useState(false);  const [reviewTargetId, setReviewTargetId] = useState('');  const [dealCompleted, setDealCompleted] = useState(false);  // ?„ì¬ ?œê°„?¼ë¡œë¶€??1?œê°„ ?„ë? ê¸°ë³¸ê°’ìœ¼ë¡??¤ì •  const getDefaultDateTime = () => {    const now = new Date();    now.setHours(now.getHours() + 1);    now.setMinutes(0);    now.setSeconds(0);        const dateStr = now.toISOString().split('T')[0];    const timeStr = now.toTimeString().slice(0, 5);        return { dateStr, timeStr };  };  React.useEffect(() => {    const { dateStr, timeStr } = getDefaultDateTime();    setMeetDate(dateStr);    setMeetTime(timeStr);  }, []);  // ê±°ë˜ ?„ë£Œ ?íƒœ ê°ì?  React.useEffect(() => {    if (isDealCompleted) {      setDealCompleted(true);    }  }, [isDealCompleted]);  // ê±°ë˜ ?„ë£Œ ì²˜ë¦¬  const handleCompleteDeal = async () => {    try {      setLoading(true);      await completeDeal(threadId);      setDealCompleted(true);            // ?¤ì œ ?ë?ë°?ID ?¬ìš©      setReviewTargetId(otherUserId);            // ?„ê¸° ?‘ì„± ëª¨ë‹¬ ?œì‹œ      setShowReviewModal(true);          } catch (error: any) {      console.error('ê±°ë˜ ?„ë£Œ ?¤íŒ¨:', error);      alert(error.message || 'ê±°ë˜ ?„ë£Œ???¤íŒ¨?ˆìŠµ?ˆë‹¤.');    } finally {      setLoading(false);    }  };  const handleSubmit = async (e: React.FormEvent) => {    e.preventDefault();        if (!price.trim()) {      alert('ê°€ê²©ì„ ?…ë ¥?´ì£¼?¸ìš”.');      return;    }    if (mode === 'meet' && !place.trim()) {      alert('ë§Œë‚¨ ?¥ì†Œë¥??…ë ¥?´ì£¼?¸ìš”.');      return;    }    if (mode === 'meet' && (!meetDate || !meetTime)) {      alert('ë§Œë‚¨ ?œê°„??? íƒ?´ì£¼?¸ìš”.');      return;    }    try {      setLoading(true);            const priceNum = parseInt(price);      if (isNaN(priceNum) || priceNum <= 0) {        alert('?¬ë°”ë¥?ê°€ê²©ì„ ?…ë ¥?´ì£¼?¸ìš”.');        return;      }      if (mode === 'meet') {        const meetAt = new Date(`${meetDate}T${meetTime}`);        if (meetAt <= new Date()) {          alert('ë§Œë‚¨ ?œê°„?€ ?„ì¬ ?œê°„ë³´ë‹¤ ?´í›„?¬ì•¼ ?©ë‹ˆ??');          return;        }                await proposeDeal(threadId, {          mode: 'meet',          price: priceNum,          place: place.trim(),          meetAt: meetAt        });      } else {        await proposeDeal(threadId, {          mode: 'delivery',          price: priceNum        });      }      alert('ê±°ë˜ ?œì•ˆ???„ì†¡?˜ì—ˆ?µë‹ˆ??');            // ??ì´ˆê¸°??      setPrice('');      setPlace('');      const { dateStr, timeStr } = getDefaultDateTime();      setMeetDate(dateStr);      setMeetTime(timeStr);            // ì½œë°± ?¸ì¶œ      onDealProposed?.();          } catch (error: any) {      console.error('ê±°ë˜ ?œì•ˆ ?¤íŒ¨:', error);      alert(error.message || 'ê±°ë˜ ?œì•ˆ???¤íŒ¨?ˆìŠµ?ˆë‹¤.');    } finally {      setLoading(false);    }  };  const formatDateTime = (date: string, time: string) => {    if (!date || !time) return '';    const dateObj = new Date(`${date}T${time}`);    return dateObj.toLocaleString('ko-KR', {      year: 'numeric',      month: 'long',      day: 'numeric',      hour: '2-digit',      minute: '2-digit',      weekday: 'long'    });  };  return (    <>      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">        <h3 className="text-lg font-semibold text-blue-800 mb-3">ê±°ë˜ ?œì•ˆ?˜ê¸°</h3>                {/* ê±°ë˜ ?„ë£Œ ë²„íŠ¼ (ê±°ë˜ê°€ ì§„í–‰ ì¤‘ì¼ ?Œë§Œ ?œì‹œ) */}        {dealCompleted && (          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">            <p className="text-green-800 text-sm mb-2">ê±°ë˜ê°€ ?„ë£Œ?˜ì—ˆ?µë‹ˆ??</p>            <button              onClick={handleCompleteDeal}              disabled={loading}              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"            >              {loading ? 'ì²˜ë¦¬ ì¤?..' : 'ê±°ë˜ ?„ë£Œ ì²˜ë¦¬'}            </button>          </div>        )}                <form onSubmit={handleSubmit} className="space-y-4">          {/* ê±°ë˜ ëª¨ë“œ ? íƒ */}          <div>            <label className="block text-sm font-medium text-gray-700 mb-2">              ê±°ë˜ ë°©ì‹            </label>            <div className="flex gap-3">              <label className="flex items-center">                <input                  type="radio"                  value="meet"                  checked={mode === 'meet'}                  onChange={(e) => setMode(e.target.value as 'meet' | 'delivery')}                  className="mr-2"                />                <span className="text-sm">ì§ê±°??/span>              </label>              <label className="flex items-center">                <input                  type="radio"                  value="delivery"                  checked={mode === 'delivery'}                  onChange={(e) => setMode(e.target.value as 'meet' | 'delivery')}                  className="mr-2"                />                <span className="text-sm">?ë°°</span>              </label>            </div>          </div>          {/* ê°€ê²??…ë ¥ */}          <div>            <label className="block text-sm font-medium text-gray-700 mb-2">              ?œì•ˆ ê°€ê²?            </label>            <div className="relative">              <input                type="number"                value={price}                onChange={(e) => setPrice(e.target.value)}                placeholder="ê°€ê²©ì„ ?…ë ¥?˜ì„¸??                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                min="0"              />              <span className="absolute right-3 top-2 text-gray-500">??/span>            </div>          </div>          {/* ë§Œë‚¨ ?¥ì†Œ (ì§ê±°?˜ë§Œ) */}          {mode === 'meet' && (            <div>              <label className="block text-sm font-medium text-gray-700 mb-2">                ë§Œë‚¨ ?¥ì†Œ              </label>              <input                type="text"                value={place}                onChange={(e) => setPlace(e.target.value)}                placeholder="?? ?œìš¸??3ë²?ì¶œêµ¬ ?¤í?ë²…ìŠ¤"                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"              />            </div>          )}          {/* ë§Œë‚¨ ?œê°„ (ì§ê±°?˜ë§Œ) */}          {mode === 'meet' && (            <div>              <label className="block text-sm font-medium text-gray-700 mb-2">                ë§Œë‚¨ ?œê°„              </label>              <div className="flex gap-2">                <input                  type="date"                  value={meetDate}                  onChange={(e) => setMeetDate(e.target.value)}                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                  min={new Date().toISOString().split('T')[0]}                />                <input                  type="time"                  value={meetTime}                  onChange={(e) => setMeetTime(e.target.value)}                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"                />              </div>              {meetDate && meetTime && (                <p className="text-sm text-gray-600 mt-1">                  ?“… {formatDateTime(meetDate, meetTime)}                </p>              )}            </div>          )}          {/* ?œì¶œ ë²„íŠ¼ */}          <button            type="submit"            disabled={loading}            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"          >            {loading ? '?œì•ˆ ì¤?..' : 'ê±°ë˜ ?œì•ˆ?˜ê¸°'}          </button>        </form>        {/* ?ˆë‚´ ë©”ì‹œì§€ */}        <div className="mt-3 text-xs text-blue-600">          <p>?’¡ ê±°ë˜ ?œì•ˆ??ë³´ë‚´ë©??ë?ë°©ì´ ?˜ë½/ê±°ì ˆ?????ˆìŠµ?ˆë‹¤.</p>          {mode === 'meet' && (            <p>?“ ì§ê±°?˜ëŠ” ë§Œë‚¨ ?¥ì†Œ?€ ?œê°„???•í™•??ì§€?•í•´ì£¼ì„¸??</p>          )}          {mode === 'delivery' && (            <p>?“¦ ?ë°°??ê°€ê²©ë§Œ ?œì•ˆ?˜ë©´ ?©ë‹ˆ??</p>          )}        </div>      </div>      {/* ?„ê¸° ?‘ì„± ëª¨ë‹¬ */}      {showReviewModal && (        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">            <h3 className="text-lg font-semibold mb-4">ê±°ë˜ ?„ê¸° ?‘ì„±</h3>            <p className="text-sm text-gray-600 mb-4">              ê±°ë˜ê°€ ?„ë£Œ?˜ì—ˆ?µë‹ˆ?? ?ë?ë°©ì— ?€???„ê¸°ë¥??¨ê²¨ì£¼ì„¸??            </p>                        <ReviewForm              threadId={threadId}              targetId={reviewTargetId}              onReviewSubmitted={() => {                setShowReviewModal(false);                alert('?„ê¸°ê°€ ?‘ì„±?˜ì—ˆ?µë‹ˆ??');              }}              onCancel={() => setShowReviewModal(false)}            />          </div>        </div>      )}    </>  );}