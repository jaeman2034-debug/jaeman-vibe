import { useState, useRef } from "react";
import "./market.css";
export default function MarketLikeLayout() { const [items, setItems] = useState([]); const [loading, setLoading] = useState(true); const [hasMore, setHasMore] = useState(true); const [lastDoc, setLastDoc] = useState(null); const [likedItems, setLikedItems] = useState(new Set()); const observerRef = useRef(null); const ITEMS_PER_PAGE = 10; } // Firestore?�서 ?�품 ?�이??가?�오�?  const fetchItems = useCallback(async (isInitial = false) => {    try {      setLoading(true);            let q = query(        collection(db, 'products'),        where('isDeleted', '!=', true),  // ???�프????��???�품 ?�외        orderBy('createdAt', 'desc'),        limit(ITEMS_PER_PAGE)      );      if (!isInitial && lastDoc) {        q = query(q, startAfter(lastDoc));      }      const snapshot = await getDocs(q);      const newItems = snapshot.docs.map(doc => ({        id: doc.id,        ...doc.data()      })) as Item[];      if (isInitial) {        setItems(newItems);      } else {        setItems(prev => [...prev, ...newItems]);      }      setLastDoc(snapshot.docs[snapshot.docs.length - 1]);      setHasMore(snapshot.docs.length === ITEMS_PER_PAGE);    } catch (error) {      console.error('?�품 ?�이??가?�오�??�패:', error);    } finally {      setLoading(false);    }  }, [lastDoc]);  // 초기 ?�이??로드  useEffect(() => {    fetchItems(true);  }, []);  // 무한 ?�크�?관찰자  useEffect(() => {    const observer = new IntersectionObserver(      (entries) => {        if (entries[0].isIntersecting && hasMore && !loading) {          fetchItems();        }      },      { threshold: 0.1 }    );    if (observerRef.current) {      observer.observe(observerRef.current);    }    return () => observer.disconnect();  }, [fetchItems, hasMore, loading]);  // 찜하�??��?  const toggleLike = async (itemId: string) => {    try {      const itemRef = doc(db, 'products', itemId);      const isLiked = likedItems.has(itemId);            if (isLiked) {        // �??�제        await updateDoc(itemRef, {          likes: increment(-1)        });        setLikedItems(prev => {          const newSet = new Set(prev);          newSet.delete(itemId);          return newSet;        });      } else {        // 찜하�?        await updateDoc(itemRef, {          likes: increment(1)        });        setLikedItems(prev => new Set(prev).add(itemId));      }      // 로컬 ?�태 ?�데?�트      setItems(prev => prev.map(item =>         item.id === itemId           ? { ...item, likes: isLiked ? item.likes - 1 : item.likes + 1 }          : item      ));    } catch (error) {      console.error('찜하�??��? ?�패:', error);    }  };  // ?�간 ?�맷??  const formatTimeAgo = (timestamp: any) => {    if (!timestamp) return '?�간 ?�보 ?�음';        const now = new Date();    const created = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);    const diffMs = now.getTime() - created.getTime();    const diffMins = Math.floor(diffMs / (1000 * 60));    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));    if (diffMins < 1) return '방금 ??;    if (diffMins < 60) return `${diffMins}�???;    if (diffHours < 24) return `${diffHours}?�간 ??;    if (diffDays < 7) return `${diffDays}????;    return created.toLocaleDateString('ko-KR');  };  return (    <div className="market-page">      {/* ?�단 고정 ?�더 */}      <header className="topbar">        <button           className="loc"          onClick={() => {            console.log('?�� ?�치 ?�택 버튼 ?�릭??);            // TODO: ?�치 ?�택 모달 ?�기          }}        >          <span>?�산2??/span>          <svg viewBox="0 0 24 24" className="icon" aria-hidden><path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>        </button>        <div className="top-actions">          <button             onClick={() => document.body.classList.toggle('theme-light')}            aria-label="?�마 ?�환"             className="ghost theme-toggle"          >            <svg viewBox="0 0 24 24" className="icon">              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" strokeWidth="2" fill="none"/>            </svg>          </button>          <button             aria-label="QR/?�캔"             className="ghost"            onClick={() => {              console.log('?�� QR/?�캔 버튼 ?�릭??);              // TODO: QR ?�캔 기능 구현            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>          <button             aria-label="메뉴"             className="ghost"            onClick={() => {              console.log('??메뉴 버튼 ?�릭??);              // TODO: ?�이??메뉴 ?�기            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>          <button             aria-label="검??             className="ghost"            onClick={() => {              console.log('?�� 검??버튼 ?�릭??);              // TODO: 검??모달 ?�기            }}          >            <svg viewBox="0 0 24 24" className="icon"><circle cx="11" cy="11" r="7" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M21 21l-3.5-3.5" stroke="currentColor" strokeWidth="2"/></svg>          </button>          <button             aria-label="?�림"             className="ghost"            onClick={() => {              console.log('?�� ?�림 버튼 ?�릭??);              // TODO: ?�림 목록 ?�기            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M6 8a6 6 0 1112 0v5l2 2H4l2-2V8" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M9 19a3 3 0 006 0" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>        </div>      </header>      {/* 카테고리/?�터 �?*/}      <div className="chip-scroll">        {["중고거래", "?�바", "중고�?, "부?�산", "?�눔", "?�기", "가??, "?�류"].map((c) => (          <button             key={c}             className="chip"            onClick={() => {              console.log(`?���?카테고리 "${c}" ?�택??);              // TODO: 카테고리�??�터�?구현            }}          >            {c}          </button>        ))}      </div>      {/* 리스??*/}      <main className="feed">        {items.map((it) => (          <article key={it.id} className="card" role="listitem">            <div className="thumb">              <img                 src={getFirstImageUrl(it)}                 alt={it.title}                 loading="lazy"               />              {it.status === "sold" && <span className="badge done">거래?�료</span>}            </div>            <div className="meta">              <h2 className="title">{it.title}</h2>              <div className="meta-row">                <span className="sub">{it.location}</span>                {it.distanceKm && <span className="dot">??/span>}                {it.distanceKm && <span className="sub">{it.distanceKm}km</span>}                <span className="dot">??/span>                <span className="sub">{formatTimeAgo(it.createdAt)}</span>              </div>              <div className="price-like">                <strong className="price">{it.price.toLocaleString()}??/strong>                <button                   className={`like-btn ${likedItems.has(it.id) ? 'liked' : ''}`}                  onClick={() => toggleLike(it.id)}                  aria-label={likedItems.has(it.id) ? '�??�제' : '찜하�?}                >                  <svg viewBox="0 0 24 24" className="icon-sm">                    <path                       d="M20.8 4.6a5.5 5.5 0 00-7.8 0L12 5.6l-1-1a5.5 5.5 0 10-7.8 7.8l1 1L12 22l7.8-7.6 1-1a5.5 5.5 0 000-7.8z"                       fill={likedItems.has(it.id) ? "currentColor" : "none"}                      stroke="currentColor"                      strokeWidth="2"                    />                  </svg>                  <span>{it.likes || 0}</span>                </button>              </div>            </div>            <button               className="menu ghost"               aria-label="카드 메뉴"              onClick={() => {                console.log(`??카드 메뉴 ?�릭??- ?�품: ${it.title}`);                // TODO: 카드�?메뉴 (?�고, 공유 ?? 구현              }}            >              <svg viewBox="0 0 24 24" className="icon"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg>            </button>          </article>        ))}                {/* 무한 ?�크�?관찰자 */}        {hasMore && (          <div ref={observerRef} className="scroll-observer">            {loading ? (              <div className="loading-spinner">로딩 �?..</div>            ) : (              <div className="scroll-hint">?�크롤하????보기</div>            )}          </div>        )}      </main>      {/* ?�로??글?�기 버튼 */}      <button className="fab" aria-label="글?�기">        <svg viewBox="0 0 24 24" className="icon"><path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>        <span>글?�기</span>      </button>      {/* ?�단 ??*/}      <nav className="tabbar" aria-label="?�단 ??��">        {[          { label: "??, path: "#", svg: <path d="M3 11l9-7 9 7v9a2 2 0 01-2 2h-4a2 2 0 01-2-2V13H9v7a2 2 0 01-2 2H3z" /> },          { label: "?�네?�활", path: "#", svg: <path d="M4 6h16M4 12h16M4 18h16" /> },          { label: "?�네지??, path: "#", svg: <><path d="M12 2v4"/><path d="M12 22v-4"/><path d="M2 12h4"/><path d="M22 12h-4"/><circle cx="12" cy="12" r="4"/></> },          { label: "채팅", path: "#", svg: <><path d="M21 15a4 4 0 01-4 4H7l-4 3V7a4 4 0 014-4h10a4 4 0 014 4v8z" /></> },          { label: "?�의 ?�근", path: "#", svg: <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 11a4 4 0 100-8 4 4 0 000 8z" /> },        ].map((t) => (          <a key={t.label} href={t.path} className="tab">            <svg viewBox="0 0 24 24" className="icon" aria-hidden>{t.svg}</svg>            <span className="tab-label">{t.label}</span>          </a>        ))}      </nav>    </div>  );}
