import React, { useState, useEffect, useRef, useCallback } from "react";import { collection, query, orderBy, limit, startAfter, getDocs, onSnapshot, doc, updateDoc, increment } from "firebase/firestore";import { db } from "@/lib/firebase";import { getFirstImageUrl } from "@/lib/images";import "./market.css";type Item = {  id: string;  title: string;  price: number;  images?: string[];  location: string;  distanceKm?: number;  createdAt: any;  likes: number;  status?: "active" | "reserved" | "sold";  sellerId: string;  geo?: { lat: number; lng: number; geohash: string };};export default function MarketLikeLayout() {  const [items, setItems] = useState<Item[]>([]);  const [loading, setLoading] = useState(true);  const [hasMore, setHasMore] = useState(true);  const [lastDoc, setLastDoc] = useState<any>(null);  const [likedItems, setLikedItems] = useState<Set<string>>(new Set());  const observerRef = useRef<HTMLDivElement>(null);  const ITEMS_PER_PAGE = 10;  // Firestore?ì„œ ?í’ˆ ?°ì´??ê°€?¸ì˜¤ê¸?  const fetchItems = useCallback(async (isInitial = false) => {    try {      setLoading(true);            let q = query(        collection(db, 'products'),        where('isDeleted', '!=', true),  // ???Œí”„???? œ???í’ˆ ?œì™¸        orderBy('createdAt', 'desc'),        limit(ITEMS_PER_PAGE)      );      if (!isInitial && lastDoc) {        q = query(q, startAfter(lastDoc));      }      const snapshot = await getDocs(q);      const newItems = snapshot.docs.map(doc => ({        id: doc.id,        ...doc.data()      })) as Item[];      if (isInitial) {        setItems(newItems);      } else {        setItems(prev => [...prev, ...newItems]);      }      setLastDoc(snapshot.docs[snapshot.docs.length - 1]);      setHasMore(snapshot.docs.length === ITEMS_PER_PAGE);    } catch (error) {      console.error('?í’ˆ ?°ì´??ê°€?¸ì˜¤ê¸??¤íŒ¨:', error);    } finally {      setLoading(false);    }  }, [lastDoc]);  // ì´ˆê¸° ?°ì´??ë¡œë“œ  useEffect(() => {    fetchItems(true);  }, []);  // ë¬´í•œ ?¤í¬ë¡?ê´€ì°°ì  useEffect(() => {    const observer = new IntersectionObserver(      (entries) => {        if (entries[0].isIntersecting && hasMore && !loading) {          fetchItems();        }      },      { threshold: 0.1 }    );    if (observerRef.current) {      observer.observe(observerRef.current);    }    return () => observer.disconnect();  }, [fetchItems, hasMore, loading]);  // ì°œí•˜ê¸?? ê?  const toggleLike = async (itemId: string) => {    try {      const itemRef = doc(db, 'products', itemId);      const isLiked = likedItems.has(itemId);            if (isLiked) {        // ì°??´ì œ        await updateDoc(itemRef, {          likes: increment(-1)        });        setLikedItems(prev => {          const newSet = new Set(prev);          newSet.delete(itemId);          return newSet;        });      } else {        // ì°œí•˜ê¸?        await updateDoc(itemRef, {          likes: increment(1)        });        setLikedItems(prev => new Set(prev).add(itemId));      }      // ë¡œì»¬ ?íƒœ ?…ë°?´íŠ¸      setItems(prev => prev.map(item =>         item.id === itemId           ? { ...item, likes: isLiked ? item.likes - 1 : item.likes + 1 }          : item      ));    } catch (error) {      console.error('ì°œí•˜ê¸?? ê? ?¤íŒ¨:', error);    }  };  // ?œê°„ ?¬ë§·??  const formatTimeAgo = (timestamp: any) => {    if (!timestamp) return '?œê°„ ?•ë³´ ?†ìŒ';        const now = new Date();    const created = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);    const diffMs = now.getTime() - created.getTime();    const diffMins = Math.floor(diffMs / (1000 * 60));    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));    if (diffMins < 1) return 'ë°©ê¸ˆ ??;    if (diffMins < 60) return `${diffMins}ë¶???;    if (diffHours < 24) return `${diffHours}?œê°„ ??;    if (diffDays < 7) return `${diffDays}????;    return created.toLocaleDateString('ko-KR');  };  return (    <div className="market-page">      {/* ?ë‹¨ ê³ ì • ?¤ë” */}      <header className="topbar">        <button           className="loc"          onClick={() => {            console.log('?“ ?„ì¹˜ ? íƒ ë²„íŠ¼ ?´ë¦­??);            // TODO: ?„ì¹˜ ? íƒ ëª¨ë‹¬ ?´ê¸°          }}        >          <span>?¡ì‚°2??/span>          <svg viewBox="0 0 24 24" className="icon" aria-hidden><path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>        </button>        <div className="top-actions">          <button             onClick={() => document.body.classList.toggle('theme-light')}            aria-label="?Œë§ˆ ?„í™˜"             className="ghost theme-toggle"          >            <svg viewBox="0 0 24 24" className="icon">              <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" strokeWidth="2" fill="none"/>            </svg>          </button>          <button             aria-label="QR/?¤ìº”"             className="ghost"            onClick={() => {              console.log('?“± QR/?¤ìº” ë²„íŠ¼ ?´ë¦­??);              // TODO: QR ?¤ìº” ê¸°ëŠ¥ êµ¬í˜„            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M4 7V4h3M20 7V4h-3M4 17v3h3M20 17v3h-3" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>          <button             aria-label="ë©”ë‰´"             className="ghost"            onClick={() => {              console.log('??ë©”ë‰´ ë²„íŠ¼ ?´ë¦­??);              // TODO: ?¬ì´??ë©”ë‰´ ?´ê¸°            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>          <button             aria-label="ê²€??             className="ghost"            onClick={() => {              console.log('?” ê²€??ë²„íŠ¼ ?´ë¦­??);              // TODO: ê²€??ëª¨ë‹¬ ?´ê¸°            }}          >            <svg viewBox="0 0 24 24" className="icon"><circle cx="11" cy="11" r="7" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M21 21l-3.5-3.5" stroke="currentColor" strokeWidth="2"/></svg>          </button>          <button             aria-label="?Œë¦¼"             className="ghost"            onClick={() => {              console.log('?”” ?Œë¦¼ ë²„íŠ¼ ?´ë¦­??);              // TODO: ?Œë¦¼ ëª©ë¡ ?´ê¸°            }}          >            <svg viewBox="0 0 24 24" className="icon"><path d="M6 8a6 6 0 1112 0v5l2 2H4l2-2V8" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M9 19a3 3 0 006 0" stroke="currentColor" strokeWidth="2" fill="none"/></svg>          </button>        </div>      </header>      {/* ì¹´í…Œê³ ë¦¬/?„í„° ì¹?*/}      <div className="chip-scroll">        {["ì¤‘ê³ ê±°ë˜", "?Œë°”", "ì¤‘ê³ ì°?, "ë¶€?™ì‚°", "?˜ëˆ”", "?¸ê¸°", "ê°€??, "?˜ë¥˜"].map((c) => (          <button             key={c}             className="chip"            onClick={() => {              console.log(`?·ï¸?ì¹´í…Œê³ ë¦¬ "${c}" ? íƒ??);              // TODO: ì¹´í…Œê³ ë¦¬ë³??„í„°ë§?êµ¬í˜„            }}          >            {c}          </button>        ))}      </div>      {/* ë¦¬ìŠ¤??*/}      <main className="feed">        {items.map((it) => (          <article key={it.id} className="card" role="listitem">            <div className="thumb">              <img                 src={getFirstImageUrl(it)}                 alt={it.title}                 loading="lazy"               />              {it.status === "sold" && <span className="badge done">ê±°ë˜?„ë£Œ</span>}            </div>            <div className="meta">              <h2 className="title">{it.title}</h2>              <div className="meta-row">                <span className="sub">{it.location}</span>                {it.distanceKm && <span className="dot">??/span>}                {it.distanceKm && <span className="sub">{it.distanceKm}km</span>}                <span className="dot">??/span>                <span className="sub">{formatTimeAgo(it.createdAt)}</span>              </div>              <div className="price-like">                <strong className="price">{it.price.toLocaleString()}??/strong>                <button                   className={`like-btn ${likedItems.has(it.id) ? 'liked' : ''}`}                  onClick={() => toggleLike(it.id)}                  aria-label={likedItems.has(it.id) ? 'ì°??´ì œ' : 'ì°œí•˜ê¸?}                >                  <svg viewBox="0 0 24 24" className="icon-sm">                    <path                       d="M20.8 4.6a5.5 5.5 0 00-7.8 0L12 5.6l-1-1a5.5 5.5 0 10-7.8 7.8l1 1L12 22l7.8-7.6 1-1a5.5 5.5 0 000-7.8z"                       fill={likedItems.has(it.id) ? "currentColor" : "none"}                      stroke="currentColor"                      strokeWidth="2"                    />                  </svg>                  <span>{it.likes || 0}</span>                </button>              </div>            </div>            <button               className="menu ghost"               aria-label="ì¹´ë“œ ë©”ë‰´"              onClick={() => {                console.log(`??ì¹´ë“œ ë©”ë‰´ ?´ë¦­??- ?í’ˆ: ${it.title}`);                // TODO: ì¹´ë“œë³?ë©”ë‰´ (? ê³ , ê³µìœ  ?? êµ¬í˜„              }}            >              <svg viewBox="0 0 24 24" className="icon"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg>            </button>          </article>        ))}                {/* ë¬´í•œ ?¤í¬ë¡?ê´€ì°°ì */}        {hasMore && (          <div ref={observerRef} className="scroll-observer">            {loading ? (              <div className="loading-spinner">ë¡œë”© ì¤?..</div>            ) : (              <div className="scroll-hint">?¤í¬ë¡¤í•˜????ë³´ê¸°</div>            )}          </div>        )}      </main>      {/* ?Œë¡œ??ê¸€?°ê¸° ë²„íŠ¼ */}      <button className="fab" aria-label="ê¸€?°ê¸°">        <svg viewBox="0 0 24 24" className="icon"><path d="M12 5v14M5 12h14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>        <span>ê¸€?°ê¸°</span>      </button>      {/* ?˜ë‹¨ ??*/}      <nav className="tabbar" aria-label="?˜ë‹¨ ??°”">        {[          { label: "??, path: "#", svg: <path d="M3 11l9-7 9 7v9a2 2 0 01-2 2h-4a2 2 0 01-2-2V13H9v7a2 2 0 01-2 2H3z" /> },          { label: "?™ë„¤?í™œ", path: "#", svg: <path d="M4 6h16M4 12h16M4 18h16" /> },          { label: "?™ë„¤ì§€??, path: "#", svg: <><path d="M12 2v4"/><path d="M12 22v-4"/><path d="M2 12h4"/><path d="M22 12h-4"/><circle cx="12" cy="12" r="4"/></> },          { label: "ì±„íŒ…", path: "#", svg: <><path d="M21 15a4 4 0 01-4 4H7l-4 3V7a4 4 0 014-4h10a4 4 0 014 4v8z" /></> },          { label: "?˜ì˜ ?¹ê·¼", path: "#", svg: <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2M12 11a4 4 0 100-8 4 4 0 000 8z" /> },        ].map((t) => (          <a key={t.label} href={t.path} className="tab">            <svg viewBox="0 0 24 24" className="icon" aria-hidden>{t.svg}</svg>            <span className="tab-label">{t.label}</span>          </a>        ))}      </nav>    </div>  );}
