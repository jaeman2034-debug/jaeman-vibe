import { useRef, useState } from "react";
import { usePttStt } from "@/hooks/usePttStt";
export default function OneShotVoiceSignup() { const { ok, listening, partial, finalText, setFinalText, handlers } = usePttStt("ko-KR"); const [name, setName] = useState(""); const [phoneDisplay, setPhoneDisplay] = useState(""); const [digits, setDigits] = useState(""); const prevListening = useRef(false); } // ??????번만  const textSnapRef = useRef({ final: "", partial: "" });  // 최근 ?�식 문장(고정 ?�시) + ?�스?�리  const [lastUtterance, setLastUtterance] = useState("");  const [history, setHistory] = useState<Array<{ t: number; text: string }>>([]);  const [showDebug, setShowDebug] = useState(false); // ?�버�??��?(?�택)  const onDown = (e:any) => { setFinalText(""); handlers.onPointerDown?.(e); };  // ?�증 버튼 ?�성??조건  const canSubmit = !!name && digits.length >= 10;  // STT 결과가 바�??�마???�냅?�을 갱신  useEffect(() => {    textSnapRef.current = { final: finalText || "", partial: partial || "" };  }, [finalText, partial]);  // ?�샷 ?�?�밍: ?�을 ?�는 ?�간 ??번만 처리 (deps??listening�?  useEffect(() => {    if (prevListening.current && !listening) {      setTimeout(() => {        const { final, partial } = textSnapRef.current;        const text = (final.trim() || partial.trim());        if (!text) {          alert("?�성???�식?��? ?�았?�요. ?�시 ??번에 말�???주세??");          return;        }        // ??최근 ?�식 고정 + ?�스?�리 ?�적        setLastUtterance(text);        setHistory(h => [{ t: Date.now(), text }, ...h].slice(0, 10));        handleOneShot(text);      }, 150);    }    prevListening.current = listening;  }, [listening]);  function handleOneShot(text: string) {    const n = extractName(text);    const p = extractPhone(text);    if (n) setName(n);    if (p) { setPhoneDisplay(p.display); setDigits(p.digits); }    if (!p) {      // 번호�??�시 말하�??�내(?�택)      console.log("[?�샷] ?�화번호 미�?�? '010부??번호�? ?�시 말�???주세??");    }    // ?�택: ?�동 ??�� ?�?�머 (?�하�?주석 ?�제)    // setTimeout(() => setLastUtterance(""), 8000); // 8�???최근 ?�식 ?�동 ??��  }  async function onSendSms() {    if (!canSubmit) return;    try {      const confirmation = await sendSms(auth, digits);      const code = window.prompt("문자 ?�증번호 6?�리�??�력?�세??);      if (!code) return;      const cred = await verifySmsCode(confirmation, code.trim());      if (cred.user && name) await updateProfile(cred.user, { displayName: name });      await setDoc(doc(db, "users", cred.user.uid), {        uid: cred.user.uid, name, phone: phoneDisplay, createdAt: serverTimestamp(),      }, { merge: true });      alert("??가???�료!");    } catch (e: any) {      console.error(e);      alert("?�증 ?�패: " + (e?.message || e));    }  }  return (    <div style={{ maxWidth: 520, margin: "24px auto", fontFamily: "system-ui" }}>      <h2>?�� ?�성 ?�샷 가??/h2>      <label>?�름</label>      <input value={name} onChange={e=>setName(e.target.value)} placeholder="?�길?? />      <label>?�화번호</label>      <input        value={phoneDisplay}        onChange={(e) => {          const d = e.target.value.replace(/\D/g, "");          const disp = d.length >= 10            ? `${d.slice(0,3)}-${d.slice(3, d.length===10?6:7)}-${d.slice(-4)}`            : e.target.value;          setPhoneDisplay(disp);          setDigits(d);        }}        placeholder="010-1234-5678"        inputMode="numeric"      />      <button        type="button"        disabled={!ok}        {...handlers}                  // usePttStt가 주는 onPointerDown�??�용        onContextMenu={(e)=>e.preventDefault()}   // 길게?�르�?메뉴 차단        onDragStart={(e)=>e.preventDefault()}     // ?��?지 ?�래�?차단        style={{          width:"100%",           padding:14,           borderRadius:12,          background: ok ? (listening ? "#1db954" : "#1e5af9") : "#ccc",          color:"#fff",           border:"none",           touchAction: "none",         // ?�스처로 pointercancel 방�?          userSelect: "none",          WebkitUserSelect: "none",          WebkitTouchCallout: "none",  // iOS 길게?�르�?callout 차단          WebkitTapHighlightColor: "transparent",          position: "relative",          zIndex: 1,        }}        aria-pressed={listening}      >        {ok ? (listening ? "?���??�는 중�?(?�면 처리)" : "?�� 길게 ?�르�???번에 말하�?)            : "?�� ?�성 ?�식 미�???}      </button>      <div style={{ marginTop:8, fontSize:13, color:"#666" }}>        {listening ? (partial || "??) : (finalText || "?? ???�름?� ?�길?? 010-1234-5678")}      </div>      {/* 최근 ?�식(??�� ?��?) */}      <div style={{ marginTop: 8, fontSize: 14, color: "#333" }}>        <div style={{ opacity: 0.7, marginBottom: 4 }}>최근 ?�식</div>        <div style={{          padding: "10px 12px",          borderRadius: 8,          background: "#f4f6fa",          border: "1px solid #e3e8f0",          minHeight: 20,          whiteSpace: "pre-wrap"        }}>          {listening ? (partial || lastUtterance || "??) : (lastUtterance || "??)}        </div>        {/* ?�버�??��? + ?�스?�리 지?�기 */}        <div style={{ display: "flex", gap: 8, marginTop: 6 }}>          <button type="button"            onClick={()=>setShowDebug(v=>!v)}            style={{ fontSize: 12, padding: "6px 10px", borderRadius: 6, border: "1px solid #ccd5e3", background:"#fff" }}>            {showDebug ? "?�버�??�기�? : "?�버�?보기"}          </button>                    {showDebug && (            <button type="button"              onClick={()=>setHistory([])}              style={{ fontSize: 12, padding: "6px 10px", borderRadius: 6, border: "1px solid #fecaca", background:"#fef2f2", color:"#dc2626" }}>              지?�기            </button>          )}                    <button type="button"             onClick={()=>{ setLastUtterance(""); setHistory([]); }}            style={{ marginLeft: 8, fontSize: 12, padding:"6px 10px", borderRadius: 6, border:"1px solid #f0b7b7", background:"#fff0f0" }}>            로그 지?�기          </button>        </div>        {/* ?�스?�리 로그(최근 10�? */}        {showDebug && (          <div style={{ marginTop: 6, maxHeight: 160, overflow: "auto", fontSize: 12, border: "1px dashed #d1d9e6", borderRadius: 8, padding: 8, background:"#fafbfd" }}>            {history.length === 0 ? <div style={{opacity:.6}}>로그 ?�음</div> : (              <ul style={{ margin: 0, paddingLeft: 16 }}>                {history.map((h, i) => (                  <li key={h.t} style={{ margin: "6px 0" }}>                    <span style={{ opacity:.6, marginRight: 8 }}>                      {new Date(h.t).toLocaleTimeString()}                    </span>                    {h.text}                  </li>                ))}              </ul>            )}          </div>        )}      </div>      <button         onClick={onSendSms}         disabled={!canSubmit}        style={{           width:"100%",           padding:14,           marginTop:12,           borderRadius:12,          background: canSubmit ? "#0070f3" : "#b6c7e1",          color:"#fff",           border:"none"         }}      >        ?�증 문자 받기      </button>      <div id="recaptcha-container" style={{ display:"none" }} />    </div>  );} 
