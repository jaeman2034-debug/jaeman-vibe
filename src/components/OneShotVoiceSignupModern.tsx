import { useEffect, useMemo, useRef, useState } from "react";import { motion, AnimatePresence } from "framer-motion";import Mic from "lucide-react/dist/esm/icons/mic";import MicOff from "lucide-react/dist/esm/icons/mic-off";import Phone from "lucide-react/dist/esm/icons/phone";import User2 from "lucide-react/dist/esm/icons/user-2";import ShieldCheck from "lucide-react/dist/esm/icons/shield-check";import Loader2 from "lucide-react/dist/esm/icons/loader-2";import ChevronDown from "lucide-react/dist/esm/icons/chevron-down";// ?ï¿½ë¡œ?ï¿½íŠ¸?????ï¿½í‹¸ ê°€?ï¿½ì˜¤ï¿?(ê²½ë¡œ???ï¿½ë¡œ?ï¿½íŠ¸ êµ¬ì¡°??ë§ê²Œ ì¡°ì •)import { usePttStt } from "../hooks/usePttStt";import { extractName, extractPhone, digitsFromSpeech } from "../lib/parse";import { sendSms, verifySmsCode } from "../lib/sms";import { auth, db } from "@/lib/firebase";import { updateProfile } from "firebase/auth";import { doc, setDoc, serverTimestamp } from "firebase/firestore";export default function OneShotVoiceSignupModern() {  // =============== STT & PTT ===============  const {    ok, listening, partial, finalText, setFinalText,    start, stop,              // ??ì¶”ï¿½?    snapshotAfterStop,        // ???ï¿½ëƒ…???ï¿½ìˆ˜ ì¶”ï¿½?  } = usePttStt("ko-KR");  // ìµœê·¼ ?ï¿½ì‹ ê³ ì • & ë¡œê·¸  const [lastUtterance, setLastUtterance] = useState("");  const [history, setHistory] = useState<Array<{ t: number; text: string }>>([]);  const [showDebug, setShowDebug] = useState(false);  // ???ï¿½íƒœ  const [name, setName] = useState("");  const [phoneDisplay, setPhoneDisplay] = useState("");  const [digits, setDigits] = useState("");  const [busy, setBusy] = useState(false);  // ???ï¿½ì  ?ï¿½ìŠ¤???ï¿½íƒœ ì¶”ï¿½?  const ACCUM_LIMIT = 1000;                  // ìµœï¿½? ë³´ï¿½? ê¸€????  const [accumText, setAccumText] = useState("");  const [accumOn, setAccumOn] = useState(true); // ì¼œê¸°/?ï¿½ê¸° ?ï¿½ï¿½?  // ??ë¶€ï¿??ï¿½ë£Œ ?ï¿½ì–´ë°›ê¸° ?ï¿½íƒœ ì¶”ï¿½?  const [pendingDigits, setPendingDigits] = useState<string>(""); // 01xï¿??ï¿½ì‘?ï¿½ì„œ 11?ï¿½ë¦¬ ë¯¸ë§Œ??ì¤‘ê°„ ê²°ê³¼  // ?ï¿½ì—­ pointerup ë°©ì‹ (?ï¿½ì •?ï¿½ì¸ PTT)  const micOkRef = useRef(false);  const downRef = useRef(false);  const prevListening = useRef(false);  const snapRef = useRef({ final: "", partial: "" });  useEffect(() => { snapRef.current = { final: finalText || "", partial: partial || "" }; }, [finalText, partial]);  // ?ï¿½ì„ ?ï¿½ë©´ 1???ï¿½ì‹± (?ï¿½ëŸ¬ ?ï¿½ìŠ¤ ë¬¶ì–´ ?ï¿½ì‹œ??  useEffect(() => {    if (prevListening.current && !listening) {      setTimeout(() => {        const snap = snapshotAfterStop?.() ?? { final: finalText || "", partial: partial || "", alts: [] };        const text = (snap.final.trim() || snap.partial.trim() || snap.alts?.[0] || "").trim();        if (!text) { alert("?ï¿½ì„±???ï¿½ì‹?ï¿½ï¿½? ?ï¿½ì•˜?ï¿½ìš”. ?ï¿½ì‹œ ??ë²ˆì— ë§ï¿½???ì£¼ì„¸??"); return; }        // ???ï¿½ì  ?ï¿½ë°?ï¿½íŠ¸        if (accumOn && text) {          setAccumText(prev => {            // ê°™ï¿½? ë¬¸ì¥??ë°”ë¡œ ?ï¿½ì†?ï¿½ë¡œ ?ï¿½ëŠ” ï¿?ë°©ï¿½?            if (prev.endsWith(text)) return prev;            const next = prev ? `${prev}\n${text}` : text;   // ì¤„ë°”ï¿??ï¿½ì             return next.length > ACCUM_LIMIT ? next.slice(-ACCUM_LIMIT) : next;          });        }        // (ê¸°ì¡´) ìµœê·¼ 1ï¿?ê³ ì •/?ï¿½ìŠ¤?ï¿½ë¦¬/?ï¿½ì‹±        setLastUtterance(text);        setHistory(h => [{ t: Date.now(), text }, ...h].slice(0, 50));        // 1) ?ï¿½ë¦„        const n = extractName(text);        if (n) setName(n);        // 2) ?ï¿½í™”ë²ˆí˜¸???ï¿½ì–´ë°›ê¸° ë¡œì§?ï¿½ë¡œ        const okPhone = handlePhoneWithPending(text);      }, 150);    }    prevListening.current = listening;  }, [listening, snapshotAfterStop, finalText, partial]);  async function ensureMic() {    if (micOkRef.current) return;    await navigator.mediaDevices.getUserMedia({ audio: true });    micOkRef.current = true;  }  const handlers = useMemo(() => ({    onPointerDown: async (e: React.PointerEvent<HTMLButtonElement>) => {      e.preventDefault();      e.stopPropagation();      // ??await ?ï¿½ê¸° ?ï¿½ì— ?ï¿½ï¿½??ï¿½ì¸?ï¿½IDï¿?ë¨¼ï¿½? ?ï¿½ì•„?ï¿½ë‹ˆ??      const el = e.currentTarget as HTMLElement | null;      const id = (e as any).pointerId ?? 0;      // (?ï¿½íƒ) ìº¡ì²˜ï¿?ë¨¼ï¿½? ?ï¿½ë„ ??ì§€?????ï¿½ë©´ ê·¸ëƒ¥ ë¬´ì‹œ      try { el?.setPointerCapture?.(id); } catch {}      // ë§ˆì´??ê¶Œí•œ      try { await ensureMic(); } catch {        alert("ë§ˆì´??ê¶Œí•œ???ï¿½ìš©??ì£¼ì„¸??");        try { el?.releasePointerCapture?.(id); } catch {}        return;      }      // ???ï¿½ê¸°??STT ?ï¿½ì‘      console.log("[PTT] start()");      start();      const onUp = () => {        console.log("[PTT] stop()");        stop(); // ?????ï¿½ë©´ STT ì¢…ë£Œ        try { el?.releasePointerCapture?.(id); } catch {}        window.removeEventListener("pointerup", onUp, true);        window.removeEventListener("pointercancel", onUp, true);        window.removeEventListener("blur", onUp, true);        document.removeEventListener("visibilitychange", onHide, true);      };      const onHide = () => onUp();      window.addEventListener("pointerup", onUp, true);      window.addEventListener("pointercancel", onUp, true);      window.addEventListener("blur", onUp, true);      document.addEventListener("visibilitychange", onHide, true);    },    onClick: (e) => e.preventDefault(),  }), [start, stop, ok]);  // ??deps??start/stop ?ï¿½í•¨  // =============== ?ï¿½ì‹± & ?ï¿½ì¶œ ===============  // ??handleOneShot?ï¿????ï¿½ìƒ ?ï¿½ìš©?ï¿½ï¿½? ?ï¿½ìŒ (useEffect?ï¿½ì„œ ì§ì ‘ ì²˜ë¦¬)  // ?ï¿½í™”ë²ˆí˜¸ ?ï¿½í™•??UX??useEffect ?ï¿½ì—??ì²˜ë¦¬  // ??ë¶€ï¿??ï¿½ë£Œ ?ï¿½ì–´ë°›ê¸° ë¡œì§  function handlePhoneWithPending(text: string) {    // ?ï¿½ë²ˆ ë¬¸ì¥ ?ï¿½ìï¿?ë½‘ê¸°    const dsNow = digitsFromSpeech(text); // ??parse.ts?ï¿½ì„œ export ?ï¿½ë‘     let merged = dsNow;    // ?ï¿½ì „??ëª¨ì•„??ï¿??ï¿½ìœ¼ï¿??ï¿½ì–´ë¶™ì´ï¿?    if (pendingDigits) merged = pendingDigits + dsNow;    // ìµœì¢… ì¶”ì¶œ ?ï¿½ë„    const p = extractPhone(merged);    if (p && p.digits.length >= 10) {      setPhoneDisplay(p.display);      setDigits(p.digits);      setPendingDigits(""); // ?ï¿½ë£Œ      return true;    }    // ?ï¿½ì§ ë¶€ï¿? 01xï¿??ï¿½ì‘?ï¿½ê³  7~10?ï¿½ë¦¬ï¿??ï¿½ï¿½??ï¿½íƒœï¿??ï¿??    const head = merged.match(/^01[016789]\d{4,8}/)?.[0];    if (head && head.length >= 7 && head.length < 11) {      setPendingDigits(head);      // UIï¿??ï¿½ï¿½? ?ï¿½ë¦¬ ?ï¿½ë‚´(?ï¿½íƒ)      const remain = 11 - head.length;      console.log(`[?ï¿½í™”ë²ˆí˜¸] ??${head.length}?ï¿½ë¦¬ ?ï¿½ë³´. ?ï¿½ï¿½? ${remain}?ï¿½ë¦¬ï¿?ë§ï¿½???ì£¼ì„¸??`);    }    return false;  }  const canSubmit = !!name && digits.length >= 10 && !busy;  async function onSendSms() {    if (!canSubmit) return;    setBusy(true);    try {      const conf = await sendSms(auth, digits);      const code = window.prompt("ë¬¸ì ?ï¿½ì¦ë²ˆí˜¸ 6?ï¿½ë¦¬ï¿??ï¿½ë ¥?ï¿½ì„¸??);      if (!code) { setBusy(false); return; }      const cred = await verifySmsCode(conf, code.trim());      if (cred.user && name) await updateProfile(cred.user, { displayName: name });      await setDoc(doc(db, "users", cred.user.uid), {        uid: cred.user.uid, name, phone: phoneDisplay, createdAt: serverTimestamp(),      }, { merge: true });      alert("??ê°€???ï¿½ë£Œ!");      setFinalText("");    } catch (e: any) {      console.error(e);      alert("?ï¿½ì¦ ?ï¿½íŒ¨: " + (e?.message || e));    } finally {      setBusy(false);    }  }  return (    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">      <div className="mx-auto max-w-[720px] px-4 py-10">        {/* ?ï¿½ë” */}        <div className="mb-6 flex items-center gap-3">          <div className="grid h-10 w-10 place-items-center rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200">            <ShieldCheck className="h-6 w-6" />          </div>          <div>            <h1 className="text-2xl font-bold leading-6">?ï¿½ì„± ?ï¿½ìƒ· ê°€??/h1>            <p className="text-sm text-slate-500">ê¸¸ê²Œ ?ï¿½ë¥´ï¿???ë²ˆì— ë§í•˜ï¿??ï¿½ë¦„/?ï¿½í™”ê°€ ?ï¿½ë™ ?ï¿½ì‹?ï¿½ë‹ˆ??</p>          </div>        </div>        {/* ì¹´ë“œ */}        <div className="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur">          {/* ??*/}          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">            <div className="group relative">              <label className="mb-1 block text-sm text-slate-600">?ï¿½ë¦„</label>              <div className="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-inner focus-within:ring-2 focus-within:ring-indigo-500">                <User2 className="h-4 w-4 text-slate-400" />                <input                  value={name}                  onChange={(e) => setName(e.target.value)}                  placeholder="?ï¿½ê¸¸??                  className="flex-1 bg-transparent text-base outline-none placeholder:text-slate-400"                />              </div>            </div>            <div className="group relative">              <label className="mb-1 block text-sm text-slate-600">?ï¿½í™”ë²ˆí˜¸</label>              <div className="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-inner focus-within:ring-2 focus-within:ring-indigo-500">                <Phone className="h-4 w-4 text-slate-400" />                <input                  value={phoneDisplay}                  onChange={(e) => {                    const d = e.target.value.replace(/\D/g, "");                    const disp = d.length >= 10                      ? `${d.slice(0,3)}-${d.slice(3, d.length===10?6:7)}-${d.slice(-4)}`                      : e.target.value;                    setPhoneDisplay(disp);                    setDigits(d);                  }}                  inputMode="numeric"                  placeholder="010-1234-5678"                  className="flex-1 bg-transparent text-base outline-none placeholder:text-slate-400"                                 />               </div>               {/* ??ì§„í–‰?ï¿½í™© ?ï¿½ì‹œ */}               {pendingDigits && (                 <div className="mt-1 text-xs text-slate-500">                   ?ï¿½ìï¿??ï¿½ì‹?? {pendingDigits.replace(/^(\d{3})(\d{0,4})(\d{0,4})$/, (m,a,b,c)=>[a,b,c].filter(Boolean).join("-"))}                   {`  ???ï¿½ï¿½? ${Math.max(0, 11 - pendingDigits.length)}?ï¿½ë¦¬`}                 </div>               )}             </div>           </div>          {/* PTT ë²„íŠ¼ */}          <div className="mt-5">            <motion.button              type="button"              disabled={!ok}              {...handlers}              onContextMenu={(e)=>e.preventDefault()}              onDragStart={(e)=>e.preventDefault()}              aria-pressed={listening}              className={`relative flex w-full items-center justify-center gap-2 rounded-2xl px-4 py-4 text-white shadow-lg transition ${                ok ? (listening ? "bg-emerald-600" : "bg-indigo-600 hover:bg-indigo-700") : "bg-slate-300"              }`}              style={{ touchAction: "none", userSelect: "none", WebkitUserSelect: "none", WebkitTouchCallout: "none" }}            >              <AnimatePresence>                {listening && (                  <motion.span                    key="pulse"                    className="absolute inset-0 -z-10 rounded-2xl bg-emerald-500/20"                    initial={{ opacity: 0 }}                    animate={{ opacity: [0.4, 0.1, 0.4] }}                    exit={{ opacity: 0 }}                    transition={{ duration: 1.6, repeat: Infinity }}                  />                )}              </AnimatePresence>              {listening ? <Mic className="h-5 w-5" /> : <MicOff className="h-5 w-5" />}              {ok ? (listening ? "?ï¿½ëŠ” ì¤‘ï¿½?(?ï¿½ë©´ ì²˜ë¦¬)" : "ê¸¸ê²Œ ?ï¿½ë¥´ï¿???ë²ˆì— ë§í•˜ï¿?) : "ë¸Œë¼?ï¿½ï¿½?ê°€ ?ï¿½ì„± ?ï¿½ì‹??ì§€?ï¿½í•˜ì§€ ?ï¿½ìŒ"}            </motion.button>            {/* ìµœê·¼ ?ï¿½ì‹ */}            <div className="mt-3 text-sm text-slate-600">              <div className="mb-1 flex items-center gap-2 opacity-70">                <span>ìµœê·¼ ?ï¿½ì‹ (?ï¿½ì )</span>                <label className="ml-auto flex items-center gap-1 text-xs">                  <input                    type="checkbox"                    checked={accumOn}                    onChange={e => setAccumOn(e.target.checked)}                  />                  ?ï¿½ì                 </label>                <button                  type="button"                  onClick={() => setAccumText("")}                  className="rounded-md border px-2 py-1 text-xs"                >                  ì§€?ï¿½ê¸°                </button>              </div>              <div                className="min-h-[64px] rounded-xl border border-slate-200 bg-slate-50 px-3 py-2"                style={{ whiteSpace: "pre-wrap", wordBreak: "break-word" }} // ì¤„ë°”ï¿??ï¿½ï¿½?              >                {accumOn                  ? (accumText || "??)                  : (listening ? (partial || lastUtterance || "??) : (lastUtterance || "??))}              </div>              {/* ?ï¿½ë²„ï¿?ë²„íŠ¼/?ï¿½ìŠ¤?ï¿½ë¦¬ UI??ê¸°ì¡´ ê·¸ï¿½?ï¿??ï¿½ë©´ ?ï¿½ë‹ˆ??*/}              <button                type="button"                onClick={() => setShowDebug(v=>!v)}                className="mt-2 text-xs text-slate-500 underline underline-offset-4"              >                {showDebug ? "?ï¿½ë²„ï¿??ï¿½ê¸°ï¿? : "?ï¿½ë²„ï¿?ë³´ê¸°"}              </button>              {showDebug && (                <div className="mt-2 max-h-40 overflow-auto rounded-xl border border-dashed border-slate-300 bg-white p-2 text-xs">                  {history.length === 0 ? (                    <div className="opacity-60">ë¡œê·¸ ?ï¿½ìŒ</div>                  ) : (                    <ul className="space-y-1">                      {history.map(h => (                        <li key={h.t} className="flex gap-2">                          <span className="w-20 shrink-0 opacity-50">{new Date(h.t).toLocaleTimeString()}</span>                          <span>{h.text}</span>                        </li>                      ))}                    </ul>                  )}                </div>              )}            </div>          </div>          {/* ?ï¿½ì¶œ */}          <div className="mt-5">            <button              type="button"              onClick={onSendSms}              disabled={!canSubmit}              className={`flex w-full items-center justify-center gap-2 rounded-2xl px-4 py-4 text-white shadow-md transition ${                canSubmit ? "bg-blue-600 hover:bg-blue-700" : "bg-slate-300"              }`}            >              {busy && <Loader2 className="h-4 w-4 animate-spin" />} ?ï¿½ì¦ ë¬¸ì ë°›ê¸°            </button>            <div id="recaptcha-container" style={{ display: "none" }} />          </div>        </div>      </div>    </div>  );} 
