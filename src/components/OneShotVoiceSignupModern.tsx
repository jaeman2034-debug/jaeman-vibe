import { useEffect, useMemo, useRef, useState } from "react";import { motion, AnimatePresence } from "framer-motion";import Mic from "lucide-react/dist/esm/icons/mic";import MicOff from "lucide-react/dist/esm/icons/mic-off";import Phone from "lucide-react/dist/esm/icons/phone";import User2 from "lucide-react/dist/esm/icons/user-2";import ShieldCheck from "lucide-react/dist/esm/icons/shield-check";import Loader2 from "lucide-react/dist/esm/icons/loader-2";import ChevronDown from "lucide-react/dist/esm/icons/chevron-down";// ?�로?�트?????�틸 가?�오�?(경로???�로?�트 구조??맞게 조정)import { usePttStt } from "../hooks/usePttStt";import { extractName, extractPhone, digitsFromSpeech } from "../lib/parse";import { sendSms, verifySmsCode } from "../lib/sms";import { auth, db } from "@/lib/firebase";import { updateProfile } from "firebase/auth";import { doc, setDoc, serverTimestamp } from "firebase/firestore";export default function OneShotVoiceSignupModern() {  // =============== STT & PTT ===============  const {    ok, listening, partial, finalText, setFinalText,    start, stop,              // ??추�?    snapshotAfterStop,        // ???�냅???�수 추�?  } = usePttStt("ko-KR");  // 최근 ?�식 고정 & 로그  const [lastUtterance, setLastUtterance] = useState("");  const [history, setHistory] = useState<Array<{ t: number; text: string }>>([]);  const [showDebug, setShowDebug] = useState(false);  // ???�태  const [name, setName] = useState("");  const [phoneDisplay, setPhoneDisplay] = useState("");  const [digits, setDigits] = useState("");  const [busy, setBusy] = useState(false);  // ???�적 ?�스???�태 추�?  const ACCUM_LIMIT = 1000;                  // 최�? 보�? 글????  const [accumText, setAccumText] = useState("");  const [accumOn, setAccumOn] = useState(true); // 켜기/?�기 ?��?  // ??부�??�료 ?�어받기 ?�태 추�?  const [pendingDigits, setPendingDigits] = useState<string>(""); // 01x�??�작?�서 11?�리 미만??중간 결과  // ?�역 pointerup 방식 (?�정?�인 PTT)  const micOkRef = useRef(false);  const downRef = useRef(false);  const prevListening = useRef(false);  const snapRef = useRef({ final: "", partial: "" });  useEffect(() => { snapRef.current = { final: finalText || "", partial: partial || "" }; }, [finalText, partial]);  // ?�을 ?�면 1???�싱 (?�러 ?�스 묶어 ?�시??  useEffect(() => {    if (prevListening.current && !listening) {      setTimeout(() => {        const snap = snapshotAfterStop?.() ?? { final: finalText || "", partial: partial || "", alts: [] };        const text = (snap.final.trim() || snap.partial.trim() || snap.alts?.[0] || "").trim();        if (!text) { alert("?�성???�식?��? ?�았?�요. ?�시 ??번에 말�???주세??"); return; }        // ???�적 ?�데?�트        if (accumOn && text) {          setAccumText(prev => {            // 같�? 문장??바로 ?�속?�로 ?�는 �?방�?            if (prev.endsWith(text)) return prev;            const next = prev ? `${prev}\n${text}` : text;   // 줄바�??�적            return next.length > ACCUM_LIMIT ? next.slice(-ACCUM_LIMIT) : next;          });        }        // (기존) 최근 1�?고정/?�스?�리/?�싱        setLastUtterance(text);        setHistory(h => [{ t: Date.now(), text }, ...h].slice(0, 50));        // 1) ?�름        const n = extractName(text);        if (n) setName(n);        // 2) ?�화번호???�어받기 로직?�로        const okPhone = handlePhoneWithPending(text);      }, 150);    }    prevListening.current = listening;  }, [listening, snapshotAfterStop, finalText, partial]);  async function ensureMic() {    if (micOkRef.current) return;    await navigator.mediaDevices.getUserMedia({ audio: true });    micOkRef.current = true;  }  const handlers = useMemo(() => ({    onPointerDown: async (e: React.PointerEvent<HTMLButtonElement>) => {      e.preventDefault();      e.stopPropagation();      // ??await ?�기 ?�에 ?��??�인?�ID�?먼�? ?�아?�니??      const el = e.currentTarget as HTMLElement | null;      const id = (e as any).pointerId ?? 0;      // (?�택) 캡처�?먼�? ?�도 ??지?????�면 그냥 무시      try { el?.setPointerCapture?.(id); } catch {}      // 마이??권한      try { await ensureMic(); } catch {        alert("마이??권한???�용??주세??");        try { el?.releasePointerCapture?.(id); } catch {}        return;      }      // ???�기??STT ?�작      console.log("[PTT] start()");      start();      const onUp = () => {        console.log("[PTT] stop()");        stop(); // ?????�면 STT 종료        try { el?.releasePointerCapture?.(id); } catch {}        window.removeEventListener("pointerup", onUp, true);        window.removeEventListener("pointercancel", onUp, true);        window.removeEventListener("blur", onUp, true);        document.removeEventListener("visibilitychange", onHide, true);      };      const onHide = () => onUp();      window.addEventListener("pointerup", onUp, true);      window.addEventListener("pointercancel", onUp, true);      window.addEventListener("blur", onUp, true);      document.addEventListener("visibilitychange", onHide, true);    },    onClick: (e) => e.preventDefault(),  }), [start, stop, ok]);  // ??deps??start/stop ?�함  // =============== ?�싱 & ?�출 ===============  // ??handleOneShot?� ???�상 ?�용?��? ?�음 (useEffect?�서 직접 처리)  // ?�화번호 ?�확??UX??useEffect ?�에??처리  // ??부�??�료 ?�어받기 로직  function handlePhoneWithPending(text: string) {    // ?�번 문장 ?�자�?뽑기    const dsNow = digitsFromSpeech(text); // ??parse.ts?�서 export ?�둠    let merged = dsNow;    // ?�전??모아??�??�으�??�어붙이�?    if (pendingDigits) merged = pendingDigits + dsNow;    // 최종 추출 ?�도    const p = extractPhone(merged);    if (p && p.digits.length >= 10) {      setPhoneDisplay(p.display);      setDigits(p.digits);      setPendingDigits(""); // ?�료      return true;    }    // ?�직 부�? 01x�??�작?�고 7~10?�리�??��??�태�??�??    const head = merged.match(/^01[016789]\d{4,8}/)?.[0];    if (head && head.length >= 7 && head.length < 11) {      setPendingDigits(head);      // UI�??��? ?�리 ?�내(?�택)      const remain = 11 - head.length;      console.log(`[?�화번호] ??${head.length}?�리 ?�보. ?��? ${remain}?�리�?말�???주세??`);    }    return false;  }  const canSubmit = !!name && digits.length >= 10 && !busy;  async function onSendSms() {    if (!canSubmit) return;    setBusy(true);    try {      const conf = await sendSms(auth, digits);      const code = window.prompt("문자 ?�증번호 6?�리�??�력?�세??);      if (!code) { setBusy(false); return; }      const cred = await verifySmsCode(conf, code.trim());      if (cred.user && name) await updateProfile(cred.user, { displayName: name });      await setDoc(doc(db, "users", cred.user.uid), {        uid: cred.user.uid, name, phone: phoneDisplay, createdAt: serverTimestamp(),      }, { merge: true });      alert("??가???�료!");      setFinalText("");    } catch (e: any) {      console.error(e);      alert("?�증 ?�패: " + (e?.message || e));    } finally {      setBusy(false);    }  }  return (    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900">      <div className="mx-auto max-w-[720px] px-4 py-10">        {/* ?�더 */}        <div className="mb-6 flex items-center gap-3">          <div className="grid h-10 w-10 place-items-center rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-200">            <ShieldCheck className="h-6 w-6" />          </div>          <div>            <h1 className="text-2xl font-bold leading-6">?�성 ?�샷 가??/h1>            <p className="text-sm text-slate-500">길게 ?�르�???번에 말하�??�름/?�화가 ?�동 ?�식?�니??</p>          </div>        </div>        {/* 카드 */}        <div className="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur">          {/* ??*/}          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">            <div className="group relative">              <label className="mb-1 block text-sm text-slate-600">?�름</label>              <div className="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-inner focus-within:ring-2 focus-within:ring-indigo-500">                <User2 className="h-4 w-4 text-slate-400" />                <input                  value={name}                  onChange={(e) => setName(e.target.value)}                  placeholder="?�길??                  className="flex-1 bg-transparent text-base outline-none placeholder:text-slate-400"                />              </div>            </div>            <div className="group relative">              <label className="mb-1 block text-sm text-slate-600">?�화번호</label>              <div className="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-inner focus-within:ring-2 focus-within:ring-indigo-500">                <Phone className="h-4 w-4 text-slate-400" />                <input                  value={phoneDisplay}                  onChange={(e) => {                    const d = e.target.value.replace(/\D/g, "");                    const disp = d.length >= 10                      ? `${d.slice(0,3)}-${d.slice(3, d.length===10?6:7)}-${d.slice(-4)}`                      : e.target.value;                    setPhoneDisplay(disp);                    setDigits(d);                  }}                  inputMode="numeric"                  placeholder="010-1234-5678"                  className="flex-1 bg-transparent text-base outline-none placeholder:text-slate-400"                                 />               </div>               {/* ??진행?�황 ?�시 */}               {pendingDigits && (                 <div className="mt-1 text-xs text-slate-500">                   ?�자�??�식?? {pendingDigits.replace(/^(\d{3})(\d{0,4})(\d{0,4})$/, (m,a,b,c)=>[a,b,c].filter(Boolean).join("-"))}                   {`  ???��? ${Math.max(0, 11 - pendingDigits.length)}?�리`}                 </div>               )}             </div>           </div>          {/* PTT 버튼 */}          <div className="mt-5">            <motion.button              type="button"              disabled={!ok}              {...handlers}              onContextMenu={(e)=>e.preventDefault()}              onDragStart={(e)=>e.preventDefault()}              aria-pressed={listening}              className={`relative flex w-full items-center justify-center gap-2 rounded-2xl px-4 py-4 text-white shadow-lg transition ${                ok ? (listening ? "bg-emerald-600" : "bg-indigo-600 hover:bg-indigo-700") : "bg-slate-300"              }`}              style={{ touchAction: "none", userSelect: "none", WebkitUserSelect: "none", WebkitTouchCallout: "none" }}            >              <AnimatePresence>                {listening && (                  <motion.span                    key="pulse"                    className="absolute inset-0 -z-10 rounded-2xl bg-emerald-500/20"                    initial={{ opacity: 0 }}                    animate={{ opacity: [0.4, 0.1, 0.4] }}                    exit={{ opacity: 0 }}                    transition={{ duration: 1.6, repeat: Infinity }}                  />                )}              </AnimatePresence>              {listening ? <Mic className="h-5 w-5" /> : <MicOff className="h-5 w-5" />}              {ok ? (listening ? "?�는 중�?(?�면 처리)" : "길게 ?�르�???번에 말하�?) : "브라?��?가 ?�성 ?�식??지?�하지 ?�음"}            </motion.button>            {/* 최근 ?�식 */}            <div className="mt-3 text-sm text-slate-600">              <div className="mb-1 flex items-center gap-2 opacity-70">                <span>최근 ?�식 (?�적)</span>                <label className="ml-auto flex items-center gap-1 text-xs">                  <input                    type="checkbox"                    checked={accumOn}                    onChange={e => setAccumOn(e.target.checked)}                  />                  ?�적                </label>                <button                  type="button"                  onClick={() => setAccumText("")}                  className="rounded-md border px-2 py-1 text-xs"                >                  지?�기                </button>              </div>              <div                className="min-h-[64px] rounded-xl border border-slate-200 bg-slate-50 px-3 py-2"                style={{ whiteSpace: "pre-wrap", wordBreak: "break-word" }} // 줄바�??��?              >                {accumOn                  ? (accumText || "??)                  : (listening ? (partial || lastUtterance || "??) : (lastUtterance || "??))}              </div>              {/* ?�버�?버튼/?�스?�리 UI??기존 그�?�??�면 ?�니??*/}              <button                type="button"                onClick={() => setShowDebug(v=>!v)}                className="mt-2 text-xs text-slate-500 underline underline-offset-4"              >                {showDebug ? "?�버�??�기�? : "?�버�?보기"}              </button>              {showDebug && (                <div className="mt-2 max-h-40 overflow-auto rounded-xl border border-dashed border-slate-300 bg-white p-2 text-xs">                  {history.length === 0 ? (                    <div className="opacity-60">로그 ?�음</div>                  ) : (                    <ul className="space-y-1">                      {history.map(h => (                        <li key={h.t} className="flex gap-2">                          <span className="w-20 shrink-0 opacity-50">{new Date(h.t).toLocaleTimeString()}</span>                          <span>{h.text}</span>                        </li>                      ))}                    </ul>                  )}                </div>              )}            </div>          </div>          {/* ?�출 */}          <div className="mt-5">            <button              type="button"              onClick={onSendSms}              disabled={!canSubmit}              className={`flex w-full items-center justify-center gap-2 rounded-2xl px-4 py-4 text-white shadow-md transition ${                canSubmit ? "bg-blue-600 hover:bg-blue-700" : "bg-slate-300"              }`}            >              {busy && <Loader2 className="h-4 w-4 animate-spin" />} ?�증 문자 받기            </button>            <div id="recaptcha-container" style={{ display: "none" }} />          </div>        </div>      </div>    </div>  );} 