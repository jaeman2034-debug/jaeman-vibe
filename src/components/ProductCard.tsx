import React, { useEffect, useState } from 'react';import { Link, useNavigate } from 'react-router-dom';import { distanceMeters, formatDistanceKm, reverseGeocodeDong } from '@/lib/geo';import { createOrGetThread } from '@/services/chatService';import { auth } from '@/lib/firebase';import TemperatureBadge from '@/components/TemperatureBadge';import HjdBadge from '@/components/HjdBadge';import { MapPin } from "lucide-react";type Product = {  id: string;  sellerId: string;  title: string;  price: number;  description?: string;  images: (string | { url: string; path: string; filename: string; size: number; type: string; uploadedAt: any })[];  geo?: { lat: number; lng: number };  address?: { sido: string; sigungu: string; dong: string; full: string };  location?: { lat: number; lng: number; placeName?: string };  // ?”¥ ?ˆë¡œ???„ì¹˜ ?„ë“œ (?‰ì •??ì²˜ë¦¬??  loc?: { lat: number; lng: number };  addr?: {    bjd?: string;    hjd?: string;    hjdStatus?: 'pending' | 'ok' | 'fail';    hjdSource?: 'kakao' | 'naver';    hjdCheckedAt?: any;  };  createdAt?: any;  sellerStats?: { trades: number; starsSum: number; pos: number; neg: number };  status?: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ';  thumbnail?: string;  imageUrl?: string;};export default function ProductCard({  p, myCoords, index}: {  p: Product; myCoords?: {lat:number; lng:number} | null; index: number;}) {  // ??ê°„ë‹¨???´ë?ì§€ fallback: images[0].url ??imageUrl ??null  const cover = (() => {    const firstImage = p?.images?.[0];    if (firstImage && typeof firstImage === 'object' && 'url' in firstImage) {      return firstImage.url;    }    if (firstImage && typeof firstImage === 'string') {      return firstImage;    }    return p?.imageUrl ?? null;  })();    // ???”ë²„ê¹? ê°„ë‹¨???´ë?ì§€ ?•ë³´ ë¡œê¹…  if (import.meta.env.DEV) {    console.log(`[ProductCard] ${p.id}:`, {      title: p.title,      cover,      hasImages: !!p.images?.length,      hasImageUrl: !!p.imageUrl    });  }    const navigate = useNavigate();  const [addr, setAddr] = useState(p.address?.full as string | null);  const [dist, setDist] = useState<string | null>(null);  // ?‰ì •??ì£¼ì†Œ ë°?ê±°ë¦¬ ê³„ì‚°  useEffect(() => {    (async () => {      if (p.geo?.lat && p.geo?.lng) {        if (!addr) { // ë¬¸ì„œ??ì£¼ì†Œê°€ ?†ë‹¤ë©?ì¦‰ì‹œ ????¤ì½”???œì‹œ ?„ìš©)          try {            const a = await reverseGeocodeDong(p.geo.lat, p.geo.lng);            setAddr(a.full);          } catch {}        }        if (myCoords) {          setDist(formatDistanceKm(distanceMeters(myCoords, p.geo)));        }      }    })();  }, [p?.id, p.geo, addr, myCoords]);  // ?…ë¡œ???œê°„ ?œì‹œ  const getTimeAgo = (timestamp: any) => {    if (!timestamp) return '';        const now = Date.now();    const time = timestamp.toMillis ? timestamp.toMillis() : timestamp;    const diff = now - time;        if (diff < 60000) return 'ë°©ê¸ˆ ??;    if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶???;    if (diff < 86400000) return `${Math.floor(diff / 3600000)}?œê°„ ??;    return `${Math.floor(diff / 86400000)}????;  };  // ê±°ë˜?˜ê¸° ë²„íŠ¼ ?´ë¦­ ?¸ë“¤??  const onTradeClick = async (e: React.MouseEvent) => {    e.preventDefault(); // Link ê¸°ë³¸ ?™ì‘ ë°©ì?    e.stopPropagation(); // ?´ë²¤??ë²„ë¸”ë§?ë°©ì?        // ë¡œê·¸??ì²´í¬    if (!auth.currentUser) {      alert('ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??');      navigate('/login');      return;    }        try {      const threadId = await createOrGetThread(p.id, p.sellerId);      navigate(`/chat/${threadId}`);    } catch (e: any) {      alert(e.message || 'ì±„íŒ…???œì‘?????†ìŠµ?ˆë‹¤.');    }  };  return (    <Link to={`/market/${p.id}`} className="block">      <div className="rounded-xl border bg-white shadow-sm p-3 mb-3 cursor-pointer hover:shadow-md transition-shadow hover:bg-gray-50">        <div className="flex gap-3">                    <div className="w-24 h-24 bg-gray-100 rounded overflow-hidden flex-shrink-0">            {cover ? (              <img src={cover} alt={p.title} className="w-full h-full object-cover" />            ) : (              <div className="w-full h-full grid place-items-center text-gray-400">?´ë?ì§€ ?†ìŒ</div>            )}          </div>          <div className="flex-1">            {/* ?œëª© */}            <h3 className="font-semibold text-sm mb-1">{index}. {p.title}</h3>                        {/* ê°€ê²?*/}            <p className="text-indigo-700 font-bold text-lg mb-2">              {p.price > 0 ? p.price.toLocaleString() + "?? : "ê°€ê²?ë¯¸ì •"}            </p>                        {/* ?…ë¡œ???œê°„ */}            <div className="text-xs text-gray-500 mb-2">              {getTimeAgo(p.createdAt)}            </div>                        {/* ?‰ì •???œì‹œ */}            <div className="mt-1">              <HjdBadge                 status={p.addr?.hjdStatus}                 hjd={p.addr?.hjd}                showPending={true}                loc={p.loc}              />            </div>            {/* ?¤ëª… ?”ì•½ (2ì¤? */}            {p.description ? (              <p className="mt-1 text-sm text-gray-600 max-h-10 overflow-hidden text-ellipsis">                {p.description}              </p>            ) : (              <p className="mt-1 text-sm text-gray-400">?¤ëª… ?†ìŒ</p>            )}                        {/* ?ë§¤???¨ë„ ?œì‹œ */}            {p.sellerStats && (              <div className="mb-2">                <TemperatureBadge                   stats={p.sellerStats}                   showText={false}                  className="text-xs"                />              </div>            )}                        {/* ?í’ˆ ?íƒœ ë°°ì? */}            <div className="flex items-center justify-between mb-3">              <div className={`px-2 py-1 rounded-full text-xs font-medium ${                p.status === '?ë§¤ì¤? ? 'bg-green-100 text-green-800' :                p.status === '?ˆì•½ì¤? ? 'bg-yellow-100 text-yellow-800' :                'bg-gray-100 text-gray-800'              }`}>                {p.status === '?ë§¤ì¤? && '?ë§¤ì¤?}                {p.status === '?ˆì•½ì¤? && '?ˆì•½ì¤?}                {p.status === '?„ë£Œ' && '?„ë£Œ'}              </div>            </div>                        {/* ê±°ë˜?˜ê¸° ë²„íŠ¼ - ?µì‹¬ ê¸°ëŠ¥ë§?? ì? */}            <button               className="px-3 py-2 rounded border hover:bg-gray-100 transition-colors text-sm"              onClick={onTradeClick}              disabled={p.status === '?„ë£Œ'}            >              {p.status === '?„ë£Œ' ? '?ë§¤ ?„ë£Œ' : 'ê±°ë˜?˜ê¸°'}            </button>          </div>        </div>      </div>    </Link>  );}