import React, { useEffect, useMemo, useRef, useState } from 'react';type Intent =  | { type: 'OPEN_CREATE' }  | { type: 'FILTER_NEARBY'; km: number }  | { type: 'FILTER_PRICE_MAX'; max: number }  | { type: 'OPEN_DETAIL'; index: number }  | { type: 'ANALYZE_CURRENT' }  | { type: 'NEXT_PAGE' }  | { type: 'PREV_PAGE' }  | { type: 'SEARCH'; query: string }  | { type: 'FILTER_CATEGORY'; category: string }  | { type: 'SORT_BY'; field: 'price' | 'distance' | 'date' }  | { type: 'TOGGLE_FAVORITE'; index: number }  | { type: 'SHOW_FAVORITES' }  | { type: 'CLEAR_FILTERS' }  | { type: 'HELP' };type Props = {  onIntent: (intent: Intent) => void;  tts?: boolean;};const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;/** ?Œì„± ???ìŠ¤?? ê°„ë‹¨??ëª…ë ¹ ?Œì„œ ?¬í•¨ */export default function VoiceController({ onIntent, tts = true }: Props) {  const [active, setActive] = useState(false);  const [lastTranscript, setLastTranscript] = useState('');  const [showSettings, setShowSettings] = useState(false);  const [ttsVolume, setTtsVolume] = useState(1.0);  const [ttsRate, setTtsRate] = useState(1.0);  const recRef = useRef<any>(null);  const speak = (text: string) => {    if (!tts) return;    const u = new SpeechSynthesisUtterance(text);    u.lang = 'ko-KR';    u.volume = ttsVolume;    u.rate = ttsRate;    window.speechSynthesis.speak(u);  };  useEffect(() => {    if (!SpeechRecognition) {      console.warn('[VOICE] SpeechRecognition??ì§€?í•˜ì§€ ?ŠëŠ” ë¸Œë¼?°ì??…ë‹ˆ??');      return;    }    // ë§ˆì´??ê¶Œí•œ ?•ì¸    if (navigator.permissions) {      navigator.permissions.query({ name: 'microphone' as PermissionName }).then((result) => {        if (result.state === 'denied') {          console.warn('[VOICE] ë§ˆì´??ê¶Œí•œ??ê±°ë??˜ì—ˆ?µë‹ˆ??');        }        result.onchange = () => {          console.log('[VOICE] ë§ˆì´??ê¶Œí•œ ?íƒœ ë³€ê²?', result.state);        };      });    }    const rec = new SpeechRecognition();    rec.lang = 'ko-KR';    rec.interimResults = false;    rec.maxAlternatives = 1;    rec.onresult = (e: any) => {      const transcript = e.results[0][0].transcript.trim();      setLastTranscript(transcript);      const intent = parseIntent(transcript);      if (intent) {        onIntent(intent);        feedback(intent);      } else {        speak(`ì£„ì†¡?´ìš”. ?´í•´?˜ì? ëª»í–ˆ?´ìš”: ${transcript}`);      }    };    rec.onerror = (e: any) => {      console.error('[VOICE] ?Œì„± ?¸ì‹ ?¤ë¥˜:', e.error);      if (e.error === 'not-allowed') {        speak('ë§ˆì´??ê¶Œí•œ???„ìš”?©ë‹ˆ?? ë¸Œë¼?°ì? ?¤ì •?ì„œ ë§ˆì´?¬ë? ?ˆìš©?´ì£¼?¸ìš”.');      }      setActive(false);    };    rec.onend = () => setActive(false);    recRef.current = rec;  }, [onIntent]);  const feedback = (intent: Intent) => {    switch (intent.type) {      case 'OPEN_CREATE': speak('?í’ˆ ?±ë¡ ?”ë©´???´ê²Œ??'); break;      case 'FILTER_NEARBY': speak(`${intent.km}?¬ë¡œ ?´ë‚´ë¡??„í„°ë§í–ˆ?´ìš”.`); break;      case 'FILTER_PRICE_MAX': speak(`ìµœë? ${intent.max}?ìœ¼ë¡??œí•œ?ˆì–´??`); break;      case 'OPEN_DETAIL': speak(`${intent.index}ë²??ì„¸ë¥??´ê²Œ??`); break;      case 'ANALYZE_CURRENT': speak('AI ë¶„ì„???œì‘? ê²Œ??'); break;      case 'NEXT_PAGE': speak('?¤ìŒ?¼ë¡œ ?´ë™?©ë‹ˆ??'); break;      case 'PREV_PAGE': speak('?´ì „?¼ë¡œ ?´ë™?©ë‹ˆ??'); break;      case 'SEARCH': speak(`${intent.query}ë¡?ê²€?‰í–ˆ?´ìš”.`); break;      case 'FILTER_CATEGORY': speak(`${intent.category} ì¹´í…Œê³ ë¦¬ë¡??„í„°ë§í–ˆ?´ìš”.`); break;      case 'SORT_BY': speak(`${intent.field === 'price' ? 'ê°€ê²? : intent.field === 'distance' ? 'ê±°ë¦¬' : '? ì§œ'}?œìœ¼ë¡??•ë ¬?ˆì–´??`); break;      case 'TOGGLE_FAVORITE': speak(`${intent.index}ë²??í’ˆ??ì¦ê²¨ì°¾ê¸°??ì¶”ê??ˆì–´??`); break;      case 'SHOW_FAVORITES': speak('ì¦ê²¨ì°¾ê¸° ëª©ë¡??ë³´ì—¬?œë¦´ê²Œìš”.'); break;      case 'CLEAR_FILTERS': speak('ëª¨ë“  ?„í„°ë¥??´ì œ?ˆì–´??'); break;      case 'HELP': speak('?Œì„± ëª…ë ¹ ?„ì?ë§ì„ ë³´ì—¬?œë¦´ê²Œìš”.'); break;    }  };  const onToggle = () => {    if (!recRef.current) return;    if (active) {      recRef.current.stop();      setActive(false);    } else {      recRef.current.start();      setActive(true);      speak('?£ê³  ?ˆì–´??');    }  };  return (    <div className="fixed right-4 bottom-5 z-40">      {/* ë©”ì¸ ë§ˆì´??ë²„íŠ¼ */}      <button        onClick={onToggle}        className={`rounded-full shadow-lg px-6 py-5 text-white transition text-lg ${          active ? 'bg-red-500 animate-pulse' : 'bg-indigo-600 hover:bg-indigo-700'        }`}        aria-pressed={active}        aria-label="?Œì„± ?œì–´"      >        ?™ï¸?{active ? '?„ê¸°' : 'ë§í•˜ê¸?}      </button>      {/* ?¤ì • ë²„íŠ¼ */}      <button        onClick={() => setShowSettings(!showSettings)}        className="mt-3 w-full rounded-full shadow-lg px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm transition"        aria-label="TTS ?¤ì •"      >        ?™ï¸ ?¤ì •      </button>      {/* TTS ?¤ì • ?¨ë„ */}      {showSettings && (        <div className="mt-3 p-4 bg-white rounded-lg shadow-lg border min-w-[280px]">          <h3 className="text-sm font-medium text-gray-700 mb-3">TTS ?¤ì •</h3>                    <div className="space-y-3">            <div>              <label className="text-xs text-gray-600">ë³¼ë¥¨</label>              <input                type="range"                min="0"                max="1"                step="0.1"                value={ttsVolume}                onChange={(e) => setTtsVolume(Number(e.target.value))}                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"              />              <span className="text-xs text-gray-500">{Math.round(ttsVolume * 100)}%</span>            </div>                        <div>              <label className="text-xs text-gray-600">?ë„</label>              <input                type="range"                min="0.5"                max="2"                step="0.1"                value={ttsRate}                onChange={(e) => setTtsRate(Number(e.target.value))}                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"              />              <span className="text-xs text-gray-500">{ttsRate}x</span>            </div>          </div>          <button            onClick={() => speak('?¤ì •???€?¥ë˜?ˆìŠµ?ˆë‹¤.')}            className="mt-3 w-full text-xs px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded transition"          >            ?ŒìŠ¤??          </button>        </div>      )}      {/* ?Œì„± ?¸ì‹ ê²°ê³¼ */}      {lastTranscript && (        <div className="mt-2 text-xs text-gray-600 bg-white/80 backdrop-blur rounded px-2 py-1 shadow">          "{lastTranscript}"        </div>      )}    </div>  );}/** ?œê? ëª…ë ¹ ê°„ë‹¨ ?Œì„œ */function parseIntent(t: string): Intent | null {  const s = t.replace(/\s+/g, '');  // ê¸°ë³¸ ëª…ë ¹  if (s.includes('?í’ˆ?±ë¡')) return { type: 'OPEN_CREATE' };  if (s.includes('?¤ìŒ')) return { type: 'NEXT_PAGE' };  if (s.includes('?´ì „')) return { type: 'PREV_PAGE' };  if (s.includes('ë¶„ì„')) return { type: 'ANALYZE_CURRENT' };  if (s.includes('?„ì?ë§?) || s.includes('help')) return { type: 'HELP' };  if (s.includes('ì¦ê²¨ì°¾ê¸°') || s.includes('ê´€?¬ìƒ??)) return { type: 'SHOW_FAVORITES' };  if (s.includes('?„í„°?´ì œ') || s.includes('ì´ˆê¸°??)) return { type: 'CLEAR_FILTERS' };  // ê±°ë¦¬ ?„í„°  const mKm = s.match(/(\d+)\s*??ë¡?);  if (mKm) return { type: 'FILTER_NEARBY', km: Number(mKm[1]) };  // ê°€ê²??„í„°  const mWon = s.match(/(\d+)\s*(??ë§Œì›)/);  if (mWon && s.includes('?´í•˜')) {    const num = Number(mWon[1]) * (s.includes('ë§Œì›') ? 10000 : 1);    return { type: 'FILTER_PRICE_MAX', max: num };  }  // ?ì„¸ ë³´ê¸°  const mDetail = s.match(/(\d+)\s*ë²??ì„¸|?´ì–´ì¤?ë³´ê¸°)/);  if (mDetail) return { type: 'OPEN_DETAIL', index: Number(mDetail[1]) };  // ì¹´í…Œê³ ë¦¬ ?„í„°  const categories = ['ì¶•êµ¬', '?êµ¬', '?¼êµ¬', '?Œë‹ˆ??, 'ê°€ë°?, '?´ë™??, '?˜ë¥˜', '?„ì'];  for (const category of categories) {    if (s.includes(category)) {      return { type: 'FILTER_CATEGORY', category };    }  }  // ?•ë ¬  if (s.includes('ê°€ê²©ìˆœ') || s.includes('ê°€ê²©ìˆœ??)) return { type: 'SORT_BY', field: 'price' };  if (s.includes('ê±°ë¦¬??) || s.includes('ê°€ê¹Œìš´??)) return { type: 'SORT_BY', field: 'distance' };  if (s.includes('ìµœì‹ ??) || s.includes('? ì§œ??)) return { type: 'SORT_BY', field: 'date' };  // ì¦ê²¨ì°¾ê¸°  const mFavorite = s.match(/(\d+)\s*ë²?ì¦ê²¨ì°¾ê¸°|ê´€??ì°?/);  if (mFavorite) return { type: 'TOGGLE_FAVORITE', index: Number(mFavorite[1]) };  // ê²€??(ê¸°ë³¸)  if (t.length >= 2) return { type: 'SEARCH', query: t };  return null;}