import React, { useState, useRef, useEffect, useCallback } from 'react';import { useCameraCapture } from '../../lib/useCameraCapture';import { getQualityLevel, getQualityColorClass, getQualityIcon } from '../../lib/qualityUtils';import CameraSelector from '../ui/CameraSelector';import CameraErrorGuide from '../ui/CameraErrorGuide';interface AICameraCaptureProps {  onCapture: (images: File[]) => void;  onClose: () => void;}export default function AICameraCapture({ onCapture, onClose }: AICameraCaptureProps) {  const [capturedImages, setCapturedImages] = useState<File[]>([]);  const [isAnalyzing, setIsAnalyzing] = useState(false);  const [error, setError] = useState<string | null>(null);  const [showErrorGuide, setShowErrorGuide] = useState(false);  const [currentCameraId, setCurrentCameraId] = useState<string>('');  // useCameraCapture ???¬ìš©  const {     videoRef,     canvasRef,     start,     stop,     takeShot,     quality,     setQuality,    getAvailableCameras,     switchCamera   } = useCameraCapture();  // ì¹´ë©”???œì‘  const startCamera = useCallback(async () => {    try {      setError(null);      setShowErrorGuide(false);      await start();    } catch (err) {      console.error('ì¹´ë©”???œì‘ ?¤íŒ¨:', err);      const errorMessage = err instanceof Error ? err.message : 'ì¹´ë©”?¼ë? ?œì‘?????†ìŠµ?ˆë‹¤.';      setError(errorMessage);      setShowErrorGuide(true);    }  }, [start]);  // ì¹´ë©”???•ì?  const stopCamera = useCallback(() => {    stop();  }, [stop]);  // ì¹´ë©”??ë³€ê²?ì²˜ë¦¬  const handleCameraChange = async (deviceId: string) => {    try {      setError(null);      setShowErrorGuide(false);      await switchCamera(deviceId);      setCurrentCameraId(deviceId);    } catch (error) {      console.error('ì¹´ë©”???„í™˜ ?¤íŒ¨:', error);      const errorMessage = error instanceof Error ? error.message : 'ì¹´ë©”???„í™˜???¤íŒ¨?ˆìŠµ?ˆë‹¤.';      setError(errorMessage);      setShowErrorGuide(true);    }  };  // ?ëŸ¬ ê°€?´ë“œ ?«ê¸°  const handleCloseErrorGuide = () => {    setShowErrorGuide(false);    setError(null);  };  // ?Œì¼ ?…ë¡œ???€??  const handleFileUpload = () => {    // ?Œì¼ ?…ë¡œ??ëª¨ë“œë¡??„í™˜?˜ê±°??ë¶€ëª?ì»´í¬?ŒíŠ¸???Œë¦¼    onClose(); // ?„ì¬ ì¹´ë©”??ëª¨ë“œë¥??«ê³  ?Œì¼ ?…ë¡œ??ëª¨ë“œë¡??„í™˜  };  // ?ˆì§ˆ ?ìˆ˜???°ë¥¸ UI ?•ë³´  const qualityInfo = getQualityLevel(quality);  // ì´¬ì˜  const captureImage = useCallback(async () => {    if (!videoRef.current || !canvasRef.current) return;    const canvas = canvasRef.current;    const ctx = canvas.getContext('2d');    if (!ctx) return;    canvas.width = videoRef.current.videoWidth;    canvas.height = videoRef.current.videoHeight;    ctx.drawImage(videoRef.current, 0, 0);    // ?ˆì§ˆ ì²´í¬ - useCameraCapture??takeShot ?¬ìš©    const dataURL = takeShot();    if (!dataURL) {      setError('ì´¬ì˜???¤íŒ¨?ˆìŠµ?ˆë‹¤.');      return;    }    // ?ˆì§ˆ??ì¢‹ì? ?Šìœ¼ë©?ê²½ê³     if (quality < 0.4) {      setError('?ˆì§ˆ????Šµ?ˆë‹¤. ??? ëª…?˜ê²Œ ì´¬ì˜?´ì£¼?¸ìš”.');      return;    }    // dataURL??Fileë¡?ë³€??    fetch(dataURL)      .then(res => res.blob())      .then(blob => {        const file = new File([blob], `capture_${Date.now()}.webp`, { type: 'image/webp' });        setCapturedImages(prev => [...prev, file]);        setError(null);      })      .catch(err => {        console.error('?Œì¼ ë³€???¤íŒ¨:', err);        setError('?Œì¼ ë³€?˜ì— ?¤íŒ¨?ˆìŠµ?ˆë‹¤.');      });  }, [takeShot, quality]);  // ì»´í¬?ŒíŠ¸ ë§ˆìš´????ì¹´ë©”???œì‘  useEffect(() => {    startCamera();    return () => stopCamera();  }, [startCamera, stopCamera]);  // ì´¬ì˜ ?„ë£Œ  const handleComplete = () => {    if (capturedImages.length > 0) {      onCapture(capturedImages);    }  };  // ?ˆì§ˆ ?ìˆ˜???°ë¥¸ ?‰ìƒ  const getQualityColor = (score: number) => {    if (score >= 0.8) return '#10b981'; // green    if (score >= 0.6) return '#f59e0b'; // yellow    return '#ef4444'; // red  };  return (    <div className="fixed inset-0 bg-black z-50 flex flex-col">      {/* ?¤ë” */}      <div className="bg-black text-white p-4 flex justify-between items-center">        <button onClick={onClose} className="text-white text-xl">??/button>        <h2 className="text-lg font-semibold">AI ?í’ˆ ì´¬ì˜</h2>        <button           onClick={handleComplete}          disabled={capturedImages.length === 0}          className="bg-blue-600 px-4 py-2 rounded disabled:opacity-50"        >          ?„ë£Œ ({capturedImages.length})        </button>      </div>      {/* ì¹´ë©”???„ë¦¬ë·??ëŠ” ?ëŸ¬ ê°€?´ë“œ */}      <div className="flex-1 relative">        {showErrorGuide ? (          // ?ëŸ¬ ê°€?´ë“œ ?œì‹œ          <div className="flex items-center justify-center h-full p-6">            <CameraErrorGuide              error={error || '?????†ëŠ” ?¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.'}              onRetry={startCamera}              onSwitchCamera={handleCameraChange}              onFileUpload={handleFileUpload}              onClose={handleCloseErrorGuide}              className="max-w-md"            />          </div>        ) : (          // ?•ìƒ ì¹´ë©”???„ë¦¬ë·?          <>            <video              ref={videoRef}              autoPlay              playsInline              muted              className="w-full h-full object-cover"            />                        {/* ê°€?´ë“œ ?¤ë²„?ˆì´ */}            <div className="absolute inset-0 pointer-events-none">              <div className="border-2 border-white border-dashed m-8 rounded-lg">                <div className="text-white text-center p-4">                  <div className="text-sm">?í’ˆ???„ë ˆ???ˆì— ë°°ì¹˜?˜ì„¸??/div>                  <div className="text-xs opacity-75">?•ë©´, ì¸¡ë©´, ?¼ë²¨ ê°ë„ë¡?ì´¬ì˜</div>                </div>              </div>            </div>            {/* ?ˆì§ˆ ?œì‹œ */}            {quality > 0 && (              <div className="absolute top-4 right-4 bg-black bg-opacity-75 text-white p-3 rounded">                <div className="text-sm font-semibold mb-2">ì¹´ë©”???ˆì§ˆ</div>                <div className="space-y-1 text-xs">                  <div className="flex items-center gap-2">                    <span>{getQualityIcon(qualityInfo.level)}</span>                    <span>{qualityInfo.percentage}%</span>                  </div>                  <div className="text-xs opacity-75">{qualityInfo.message}</div>                </div>              </div>            )}          </>        )}      </div>      {/* ì»¨íŠ¸ë¡?- ?ëŸ¬ ê°€?´ë“œê°€ ?œì‹œ???ŒëŠ” ?¨ê? */}      {!showErrorGuide && (        <div className="bg-black p-4">          {/* ì¹´ë©”??? íƒê¸?*/}          <div className="mb-4">            <CameraSelector              onCameraChange={handleCameraChange}              currentDeviceId={currentCameraId}              theme="dark"            />          </div>                    <div className="flex justify-center space-x-4">            <button              onClick={captureImage}              disabled={!videoRef.current || isAnalyzing}              className="bg-red-600 text-white w-16 h-16 rounded-full disabled:opacity-50"            >              ?“¸            </button>          </div>                    {/* ì´¬ì˜???´ë?ì§€ ë¯¸ë¦¬ë³´ê¸° */}          {capturedImages.length > 0 && (            <div className="mt-4">              <div className="text-white text-sm mb-2">ì´¬ì˜???´ë?ì§€ ({capturedImages.length}/5)</div>              <div className="flex space-x-2 overflow-x-auto">                {capturedImages.map((file, index) => (                  <div key={index} className="relative">                    <img                      src={URL.createObjectURL(file)}                      alt={`ì´¬ì˜ ${index + 1}`}                      className="w-16 h-16 object-cover rounded"                    />                    <button                      onClick={() => setCapturedImages(prev => prev.filter((_, i) => i !== index))}                      className="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full text-xs"                    >                      Ã—                    </button>                  </div>                ))}              </div>            </div>          )}        </div>      )}      {/* ?¨ê²¨ì§?Canvas (?ˆì§ˆ ì²´í¬?? */}      <canvas ref={canvasRef} className="hidden" />    </div>  );} 
