import { useState } from 'react';
export default function LocationBasedSearch({ onLocationSet, onClose }) { const [location, setLocation] = useState(null); const [isLoading, setIsLoading] = useState(false); const [error, setError] = useState(null); const [permission, setPermission] = useState('prompt'); const [showConsent, setShowConsent] = useState(true); const [consentGiven, setConsentGiven] = useState(false); } // GeoFire 기반 지?�해???�성 (?�제로는 ?�버?�서 처리)  const generateGeohash = (lat: number, lng: number): string => {    // ?�제로는 GeoFire ?�이브러�??�용    // ?�기?�는 간단??구현?�로 ?��?    const latInt = Math.floor((lat + 90) * 1000);    const lngInt = Math.floor((lng + 180) * 1000);    return `${latInt.toString(36)}${lngInt.toString(36)}`.substring(0, 8);  };  // 주소 ????�코??(OpenStreetMap Nominatim ?�용)  const reverseGeocode = async (lat: number, lng: number): Promise<string> => {    try {      const response = await fetch(        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko`      );      const data = await response.json();      return data.display_name || '?�치 ?�보 ?�음';    } catch (err) {      console.warn('????�코???�패:', err);      return '?�치 ?�보 ?�음';    }  };  // ?�치 권한 ?�인  const checkPermission = useCallback(async () => {    if (navigator.permissions && navigator.permissions.query) {      try {        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });        setPermission(permissionStatus.state);                // 권한 ?�태 변�?감�?        permissionStatus.onchange = () => {          setPermission(permissionStatus.state);        };      } catch (err) {        console.warn('권한 ?�인 ?�패:', err);        setPermission('prompt');      }    }  }, []);  // ?�재 ?�치 가?�오�?  const getCurrentLocation = useCallback(async () => {    if (!consentGiven) {      setError('?�치 ?�용 ?�의가 ?�요?�니??');      return;    }    setIsLoading(true);    setError(null);    try {      // ?�치 권한 ?�확??      if (navigator.permissions && navigator.permissions.query) {        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });        if (permissionStatus.state === 'denied') {          throw new Error('?�치 권한??거�??�었?�니?? 브라?��? ?�정?�서 권한???�용?�주?�요.');        }      }      // ?�재 ?�치 가?�오�?(?�용???�안 ?�정 ?�용)      const position = await new Promise<GeolocationPosition>((resolve, reject) => {        navigator.geolocation.getCurrentPosition(resolve, reject, {          enableHighAccuracy: true,          timeout: 8000,          maximumAge: 60000        });      });      const { latitude, longitude } = position.coords;      const geohash = generateGeohash(latitude, longitude);      const address = await reverseGeocode(latitude, longitude);      const newLocation: Location = {        latitude,        longitude,        geohash,        address      };      setLocation(newLocation);      setPermission('granted');    } catch (err: any) {      console.error('?�치 가?�오�??�패:', err);            if (err.code === 1) {        setError('?�치 권한??거�??�었?�니?? 브라?��? ?�정?�서 권한???�용?�주?�요.');        setPermission('denied');      } else if (err.code === 2) {        setError('?�치�?찾을 ???�습?�다. GPS가 ?�성?�되???�는지 ?�인?�주?�요.');      } else if (err.code === 3) {        setError('?�치 ?�청 ?�간??초과?�었?�니?? ?�시 ?�도?�주?�요.');      } else {        setError('?�치�?가?�오??�??�류가 발생?�습?�다. ?�시 ?�도?�주?�요.');      }    } finally {      setIsLoading(false);    }  }, [consentGiven]);  // ?�동?�로 ?�치 ?�정 (지???�택 ?��??�이??  const setManualLocation = () => {    if (!consentGiven) {      setError('?�치 ?�용 ?�의가 ?�요?�니??');      return;    }    // ?�제로는 지???�택 UI ?�공    const mockLocation: Location = {      latitude: 37.5665,      longitude: 126.9780,      geohash: generateGeohash(37.5665, 126.9780),      address: '?�울?�별??강남�?    };    setLocation(mockLocation);  };  // ?�치 ?�정 ?�료  const handleLocationSet = () => {    if (location) {      onLocationSet(location);    }  };  // ?�치 ?�용 ?�의  const handleConsent = (agreed: boolean) => {    setConsentGiven(agreed);    setShowConsent(false);        if (agreed) {      // ?�의 ??바로 ?�치 가?�오�?      getCurrentLocation();    }  };  // 컴포?�트 마운????권한 ?�태 ?�인  useEffect(() => {    checkPermission();  }, [checkPermission]);  return (    <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">      <div className="bg-white rounded-lg max-w-md w-full mx-4">        {/* ?�더 */}        <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 rounded-t-lg">          <h2 className="text-xl font-semibold">?�� ?�치 ?�정</h2>          <p className="text-green-100 text-sm mt-1">            ?�품 검?�과 추천???�한 ?�치 ?�보�??�정?�주?�요          </p>        </div>        <div className="p-6">          {/* ?�치 ?�용 ?�의 */}          {showConsent && (            <div className="mb-6 p-4 bg-blue-50 rounded border border-blue-200">              <h3 className="font-medium text-blue-900 mb-3">?�치 ?�보 ?�용 ?�의</h3>              <p className="text-sm text-blue-800 mb-4">                ?�품 검?�과 추천???�해 ?�치 ?�보가 ?�요?�니??                 ?�치 ?�보???�품 검?�에�??�용?�며, 개인?�보?� ?�결?��? ?�습?�다.              </p>              <div className="flex space-x-3">                <button                  onClick={() => handleConsent(true)}                  className="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"                >                  ?�의?�고 ?�치 ?�정                </button>                <button                  onClick={() => handleConsent(false)}                  className="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400"                >                  거�?                </button>              </div>            </div>          )}          {/* 권한 ?�태 ?�시 */}          {!showConsent && (            <div className="mb-6">              <div className="flex items-center space-x-2 mb-2">                <div className={`w-3 h-3 rounded-full ${                  permission === 'granted' ? 'bg-green-500' :                  permission === 'denied' ? 'bg-red-500' : 'bg-yellow-500'                }`}></div>                <span className="text-sm font-medium">                  {permission === 'granted' ? '?�치 권한 ?�용?? :                   permission === 'denied' ? '?�치 권한 거�??? : '?�치 권한 ?�인 �?}                </span>              </div>                            {permission === 'denied' && (                <div className="text-sm text-red-600 bg-red-50 p-3 rounded">                  브라?��? ?�정?�서 ?�치 권한???�용?�주?�요.                  <br />                  ?�정 ??개인?�보 보호 ???�치 ?�비??                </div>              )}            </div>          )}          {/* ?�치 ?�정 ?�션 */}          {!showConsent && consentGiven && (            <>              {/* ?�재 ?�치 가?�오�?*/}              <div className="mb-4">                <button                  onClick={getCurrentLocation}                  disabled={isLoading || permission === 'denied'}                  className="w-full bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"                >                  {isLoading ? (                    <>                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>                      <span>?�치 ?�인 �?..</span>                    </>                  ) : (                    <>                      <span>?��</span>                      <span>?�재 ?�치 ?�용</span>                    </>                  )}                </button>              </div>              {/* ?�는 구분??*/}              <div className="relative my-6">                <div className="absolute inset-0 flex items-center">                  <div className="w-full border-t border-gray-300"></div>                </div>                <div className="relative flex justify-center text-sm">                  <span className="px-2 bg-white text-gray-500">?�는</span>                </div>              </div>              {/* ?�동 ?�치 ?�정 */}              <div className="mb-6">                <button                  onClick={setManualLocation}                  className="w-full bg-gray-600 text-white py-3 px-4 rounded hover:bg-gray-700 flex items-center justify-center space-x-2"                >                  <span>?���?/span>                  <span>지?�에???�택</span>                </button>              </div>            </>          )}          {/* ?�치 ?�보 ?�시 */}          {location && (            <div className="mb-6 p-4 bg-green-50 rounded border border-green-200">              <h3 className="font-medium text-green-900 mb-2">?�정???�치</h3>              <div className="text-sm text-green-800 space-y-1">                <div>?�� {location.address}</div>                <div>?�도: {location.latitude.toFixed(6)}</div>                <div>경도: {location.longitude.toFixed(6)}</div>                <div>지?�해?? <code className="bg-green-100 px-1 rounded">{location.geohash}</code></div>              </div>                            {/* ?�치 ?�보 ?�내 */}              <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700">                <strong>?�️ ?�내:</strong> ???�치 ?�보???�품 ?�록 ???�버?�서 ?�전?�게 처리?�며,                 ?�라?�언?�에???�의�??�정?????�습?�다.              </div>            </div>          )}          {/* ?�러 메시지 */}          {error && (            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">              {error}            </div>          )}          {/* ?�션 버튼 */}          <div className="flex space-x-3">            <button              onClick={onClose}              className="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400"            >              취소            </button>            <button              onClick={handleLocationSet}              disabled={!location || !consentGiven}              className="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"            >              ?�치 ?�정 ?�료            </button>          </div>          {/* 보안 ?�보 */}          <div className="mt-4 text-xs text-gray-500 text-center">            <div className="mb-2">              <strong>?�� 보안:</strong> ?�치 ?�보???�버?�서�??�정?�며,               ?�라?�언?�에???�의 ?�정??불�??�합?�다.            </div>            <div>              <strong>?�� ?�도:</strong> ?�품 검?? 근접 ?�품 추천, 지??�� ?�터�?            </div>          </div>        </div>      </div>    </div>  );} 
