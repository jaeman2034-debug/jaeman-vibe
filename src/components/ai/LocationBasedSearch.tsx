import React, { useState, useEffect, useCallback } from 'react';interface Location {  latitude: number;  longitude: number;  geohash: string;  address?: string;}interface LocationBasedSearchProps {  onLocationSet: (location: Location) => void;  onClose: () => void;}export default function LocationBasedSearch({ onLocationSet, onClose }: LocationBasedSearchProps) {  const [location, setLocation] = useState<Location | null>(null);  const [isLoading, setIsLoading] = useState(false);  const [error, setError] = useState<string | null>(null);  const [permission, setPermission] = useState<'granted' | 'denied' | 'prompt'>('prompt');  const [showConsent, setShowConsent] = useState(true);  const [consentGiven, setConsentGiven] = useState(false);  // GeoFire ê¸°ë°˜ ì§€?¤í•´???ì„± (?¤ì œë¡œëŠ” ?œë²„?ì„œ ì²˜ë¦¬)  const generateGeohash = (lat: number, lng: number): string => {    // ?¤ì œë¡œëŠ” GeoFire ?¼ì´ë¸ŒëŸ¬ë¦??¬ìš©    // ?¬ê¸°?œëŠ” ê°„ë‹¨??êµ¬í˜„?¼ë¡œ ?€ì²?    const latInt = Math.floor((lat + 90) * 1000);    const lngInt = Math.floor((lng + 180) * 1000);    return `${latInt.toString(36)}${lngInt.toString(36)}`.substring(0, 8);  };  // ì£¼ì†Œ ????¤ì½”??(OpenStreetMap Nominatim ?¬ìš©)  const reverseGeocode = async (lat: number, lng: number): Promise<string> => {    try {      const response = await fetch(        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko`      );      const data = await response.json();      return data.display_name || '?„ì¹˜ ?•ë³´ ?†ìŒ';    } catch (err) {      console.warn('????¤ì½”???¤íŒ¨:', err);      return '?„ì¹˜ ?•ë³´ ?†ìŒ';    }  };  // ?„ì¹˜ ê¶Œí•œ ?•ì¸  const checkPermission = useCallback(async () => {    if (navigator.permissions && navigator.permissions.query) {      try {        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });        setPermission(permissionStatus.state);                // ê¶Œí•œ ?íƒœ ë³€ê²?ê°ì?        permissionStatus.onchange = () => {          setPermission(permissionStatus.state);        };      } catch (err) {        console.warn('ê¶Œí•œ ?•ì¸ ?¤íŒ¨:', err);        setPermission('prompt');      }    }  }, []);  // ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?  const getCurrentLocation = useCallback(async () => {    if (!consentGiven) {      setError('?„ì¹˜ ?¬ìš© ?™ì˜ê°€ ?„ìš”?©ë‹ˆ??');      return;    }    setIsLoading(true);    setError(null);    try {      // ?„ì¹˜ ê¶Œí•œ ?¬í™•??      if (navigator.permissions && navigator.permissions.query) {        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });        if (permissionStatus.state === 'denied') {          throw new Error('?„ì¹˜ ê¶Œí•œ??ê±°ë??˜ì—ˆ?µë‹ˆ?? ë¸Œë¼?°ì? ?¤ì •?ì„œ ê¶Œí•œ???ˆìš©?´ì£¼?¸ìš”.');        }      }      // ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?(?¬ìš©???œì•ˆ ?¤ì • ?ìš©)      const position = await new Promise<GeolocationPosition>((resolve, reject) => {        navigator.geolocation.getCurrentPosition(resolve, reject, {          enableHighAccuracy: true,          timeout: 8000,          maximumAge: 60000        });      });      const { latitude, longitude } = position.coords;      const geohash = generateGeohash(latitude, longitude);      const address = await reverseGeocode(latitude, longitude);      const newLocation: Location = {        latitude,        longitude,        geohash,        address      };      setLocation(newLocation);      setPermission('granted');    } catch (err: any) {      console.error('?„ì¹˜ ê°€?¸ì˜¤ê¸??¤íŒ¨:', err);            if (err.code === 1) {        setError('?„ì¹˜ ê¶Œí•œ??ê±°ë??˜ì—ˆ?µë‹ˆ?? ë¸Œë¼?°ì? ?¤ì •?ì„œ ê¶Œí•œ???ˆìš©?´ì£¼?¸ìš”.');        setPermission('denied');      } else if (err.code === 2) {        setError('?„ì¹˜ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤. GPSê°€ ?œì„±?”ë˜???ˆëŠ”ì§€ ?•ì¸?´ì£¼?¸ìš”.');      } else if (err.code === 3) {        setError('?„ì¹˜ ?”ì²­ ?œê°„??ì´ˆê³¼?˜ì—ˆ?µë‹ˆ?? ?¤ì‹œ ?œë„?´ì£¼?¸ìš”.');      } else {        setError('?„ì¹˜ë¥?ê°€?¸ì˜¤??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„?´ì£¼?¸ìš”.');      }    } finally {      setIsLoading(false);    }  }, [consentGiven]);  // ?˜ë™?¼ë¡œ ?„ì¹˜ ?¤ì • (ì§€??? íƒ ?œë??ˆì´??  const setManualLocation = () => {    if (!consentGiven) {      setError('?„ì¹˜ ?¬ìš© ?™ì˜ê°€ ?„ìš”?©ë‹ˆ??');      return;    }    // ?¤ì œë¡œëŠ” ì§€??? íƒ UI ?œê³µ    const mockLocation: Location = {      latitude: 37.5665,      longitude: 126.9780,      geohash: generateGeohash(37.5665, 126.9780),      address: '?œìš¸?¹ë³„??ê°•ë‚¨êµ?    };    setLocation(mockLocation);  };  // ?„ì¹˜ ?¤ì • ?„ë£Œ  const handleLocationSet = () => {    if (location) {      onLocationSet(location);    }  };  // ?„ì¹˜ ?¬ìš© ?™ì˜  const handleConsent = (agreed: boolean) => {    setConsentGiven(agreed);    setShowConsent(false);        if (agreed) {      // ?™ì˜ ??ë°”ë¡œ ?„ì¹˜ ê°€?¸ì˜¤ê¸?      getCurrentLocation();    }  };  // ì»´í¬?ŒíŠ¸ ë§ˆìš´????ê¶Œí•œ ?íƒœ ?•ì¸  useEffect(() => {    checkPermission();  }, [checkPermission]);  return (    <div className="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">      <div className="bg-white rounded-lg max-w-md w-full mx-4">        {/* ?¤ë” */}        <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 rounded-t-lg">          <h2 className="text-xl font-semibold">?“ ?„ì¹˜ ?¤ì •</h2>          <p className="text-green-100 text-sm mt-1">            ?í’ˆ ê²€?‰ê³¼ ì¶”ì²œ???„í•œ ?„ì¹˜ ?•ë³´ë¥??¤ì •?´ì£¼?¸ìš”          </p>        </div>        <div className="p-6">          {/* ?„ì¹˜ ?¬ìš© ?™ì˜ */}          {showConsent && (            <div className="mb-6 p-4 bg-blue-50 rounded border border-blue-200">              <h3 className="font-medium text-blue-900 mb-3">?„ì¹˜ ?•ë³´ ?¬ìš© ?™ì˜</h3>              <p className="text-sm text-blue-800 mb-4">                ?í’ˆ ê²€?‰ê³¼ ì¶”ì²œ???„í•´ ?„ì¹˜ ?•ë³´ê°€ ?„ìš”?©ë‹ˆ??                 ?„ì¹˜ ?•ë³´???í’ˆ ê²€?‰ì—ë§??¬ìš©?˜ë©°, ê°œì¸?•ë³´?€ ?°ê²°?˜ì? ?ŠìŠµ?ˆë‹¤.              </p>              <div className="flex space-x-3">                <button                  onClick={() => handleConsent(true)}                  className="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"                >                  ?™ì˜?˜ê³  ?„ì¹˜ ?¤ì •                </button>                <button                  onClick={() => handleConsent(false)}                  className="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400"                >                  ê±°ë?                </button>              </div>            </div>          )}          {/* ê¶Œí•œ ?íƒœ ?œì‹œ */}          {!showConsent && (            <div className="mb-6">              <div className="flex items-center space-x-2 mb-2">                <div className={`w-3 h-3 rounded-full ${                  permission === 'granted' ? 'bg-green-500' :                  permission === 'denied' ? 'bg-red-500' : 'bg-yellow-500'                }`}></div>                <span className="text-sm font-medium">                  {permission === 'granted' ? '?„ì¹˜ ê¶Œí•œ ?ˆìš©?? :                   permission === 'denied' ? '?„ì¹˜ ê¶Œí•œ ê±°ë??? : '?„ì¹˜ ê¶Œí•œ ?•ì¸ ì¤?}                </span>              </div>                            {permission === 'denied' && (                <div className="text-sm text-red-600 bg-red-50 p-3 rounded">                  ë¸Œë¼?°ì? ?¤ì •?ì„œ ?„ì¹˜ ê¶Œí•œ???ˆìš©?´ì£¼?¸ìš”.                  <br />                  ?¤ì • ??ê°œì¸?•ë³´ ë³´í˜¸ ???„ì¹˜ ?œë¹„??                </div>              )}            </div>          )}          {/* ?„ì¹˜ ?¤ì • ?µì…˜ */}          {!showConsent && consentGiven && (            <>              {/* ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?*/}              <div className="mb-4">                <button                  onClick={getCurrentLocation}                  disabled={isLoading || permission === 'denied'}                  className="w-full bg-green-600 text-white py-3 px-4 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"                >                  {isLoading ? (                    <>                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>                      <span>?„ì¹˜ ?•ì¸ ì¤?..</span>                    </>                  ) : (                    <>                      <span>?“</span>                      <span>?„ì¬ ?„ì¹˜ ?¬ìš©</span>                    </>                  )}                </button>              </div>              {/* ?ëŠ” êµ¬ë¶„??*/}              <div className="relative my-6">                <div className="absolute inset-0 flex items-center">                  <div className="w-full border-t border-gray-300"></div>                </div>                <div className="relative flex justify-center text-sm">                  <span className="px-2 bg-white text-gray-500">?ëŠ”</span>                </div>              </div>              {/* ?˜ë™ ?„ì¹˜ ?¤ì • */}              <div className="mb-6">                <button                  onClick={setManualLocation}                  className="w-full bg-gray-600 text-white py-3 px-4 rounded hover:bg-gray-700 flex items-center justify-center space-x-2"                >                  <span>?—ºï¸?/span>                  <span>ì§€?„ì—??? íƒ</span>                </button>              </div>            </>          )}          {/* ?„ì¹˜ ?•ë³´ ?œì‹œ */}          {location && (            <div className="mb-6 p-4 bg-green-50 rounded border border-green-200">              <h3 className="font-medium text-green-900 mb-2">?¤ì •???„ì¹˜</h3>              <div className="text-sm text-green-800 space-y-1">                <div>?“ {location.address}</div>                <div>?„ë„: {location.latitude.toFixed(6)}</div>                <div>ê²½ë„: {location.longitude.toFixed(6)}</div>                <div>ì§€?¤í•´?? <code className="bg-green-100 px-1 rounded">{location.geohash}</code></div>              </div>                            {/* ?„ì¹˜ ?•ë³´ ?ˆë‚´ */}              <div className="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700">                <strong>?¹ï¸ ?ˆë‚´:</strong> ???„ì¹˜ ?•ë³´???í’ˆ ?±ë¡ ???œë²„?ì„œ ?ˆì „?˜ê²Œ ì²˜ë¦¬?˜ë©°,                 ?´ë¼?´ì–¸?¸ì—???„ì˜ë¡??˜ì •?????†ìŠµ?ˆë‹¤.              </div>            </div>          )}          {/* ?ëŸ¬ ë©”ì‹œì§€ */}          {error && (            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">              {error}            </div>          )}          {/* ?¡ì…˜ ë²„íŠ¼ */}          <div className="flex space-x-3">            <button              onClick={onClose}              className="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400"            >              ì·¨ì†Œ            </button>            <button              onClick={handleLocationSet}              disabled={!location || !consentGiven}              className="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"            >              ?„ì¹˜ ?¤ì • ?„ë£Œ            </button>          </div>          {/* ë³´ì•ˆ ?•ë³´ */}          <div className="mt-4 text-xs text-gray-500 text-center">            <div className="mb-2">              <strong>?”’ ë³´ì•ˆ:</strong> ?„ì¹˜ ?•ë³´???œë²„?ì„œë§??¤ì •?˜ë©°,               ?´ë¼?´ì–¸?¸ì—???„ì˜ ?˜ì •??ë¶ˆê??¥í•©?ˆë‹¤.            </div>            <div>              <strong>?“ ?©ë„:</strong> ?í’ˆ ê²€?? ê·¼ì ‘ ?í’ˆ ì¶”ì²œ, ì§€??³„ ?„í„°ë§?            </div>          </div>        </div>      </div>    </div>  );} 