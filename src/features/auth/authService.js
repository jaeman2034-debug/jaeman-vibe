"use strict";
// src/features/auth/authService.tsimport { FirebaseError } from 'firebase/app';import { auth, isUsingEmulators } from '../../firebase';import {  signInWithEmailAndPassword,  createUserWithEmailAndPassword,  signInWithPopup,  signOut,  onAuthStateChanged,  GoogleAuthProvider,  type User,  AuthErrorCodes,} from 'firebase/auth';// ?�?��? ?�요?�면 ?�렇게만 ?�용// import type { AuthError } from 'firebase/auth';// isUsingEmulators �?로그로만 ?�거?? 조건 분기???�용 가??console.log('[AUTH] using emulators?', isUsingEmulators);// Google provider ?�스?�스 ?�성const googleProvider = new GoogleAuthProvider();googleProvider.setCustomParameters({ prompt: 'select_account' });// Firebase ?�증 ?�류 분석 �??�용??친화??메시지 ?�성function analyzeAuthError(error: FirebaseError): {  code: string;  message: string;  userMessage: string;  solution: string;  severity: 'info' | 'warning' | 'error';} {  const { code, message } = error;    console.group(`[AUTH ERROR] ${code}`);  console.error('Error details:', error);  console.error('Error code:', code);  console.error('Error message:', message);  console.error('Stack trace:', error.stack);  console.groupEnd();  // ?�러 코드�??�세 분석  switch (code) {    // ?�메??비�?번호 로그??관???�류    case AuthErrorCodes.INVALID_EMAIL:      return {        code,        message,        userMessage: '?�메???�식???�바르�? ?�습?�다.',        solution: '?�바�??�메??주소�??�력?�주?�요. (?? user@example.com)',        severity: 'warning'      };        case AuthErrorCodes.USER_DELETED:      return {        code,        message,        userMessage: '존재?��? ?�는 계정?�니??',        solution: '?�원가?�을 먼�? 진행?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.INVALID_PASSWORD:      return {        code,        message,        userMessage: '비�?번호가 ?�바르�? ?�습?�다.',        solution: '비�?번호�??�시 ?�인?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.WEAK_PASSWORD:      return {        code,        message,        userMessage: '비�?번호가 ?�무 ?�합?�다.',        solution: '?�문, ?�자, ?�수문자�??�함?�여 8???�상?�로 ?�정?�주?�요.',        severity: 'warning'      };        case AuthErrorCodes.EMAIL_ALREADY_IN_USE:      return {        code,        message,        userMessage: '?��? ?�용 중인 ?�메?�입?�다.',        solution: '?�른 ?�메??주소�??�용?�거??로그?�을 ?�도?�주?�요.',        severity: 'warning'      };        case AuthErrorCodes.INVALID_LOGIN_CREDENTIALS:      return {        code,        message,        userMessage: '?�메???�는 비�?번호가 ?�바르�? ?�습?�다.',        solution: '?�력???�보�??�시 ?�인?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.TOO_MANY_ATTEMPTS_TRY_LATER:      return {        code,        message,        userMessage: '로그???�도가 ?�무 많습?�다.',        solution: '?�시 ???�시 ?�도?�주?�요. (보통 15�????�제)',        severity: 'warning'      };        case AuthErrorCodes.OPERATION_NOT_ALLOWED:      return {        code,        message,        userMessage: '??로그??방식???�용?��? ?�습?�다.',        solution: '관리자?�게 문의?�거???�른 로그??방식???�용?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.USER_DISABLED:      return {        code,        message,        userMessage: '비활?�화??계정?�니??',        solution: '관리자?�게 문의?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.ACCOUNT_EXISTS_WITH_DIFFERENT_CREDENTIAL:      return {        code,        message,        userMessage: '?�른 로그??방식?�로 가?�된 계정?�니??',        solution: 'Google 로그?????�른 방식???�도?�보?�요.',        severity: 'warning'      };        // ?�트?�크 �?기�? ?�류    case AuthErrorCodes.NETWORK_REQUEST_FAILED:      return {        code,        message,        userMessage: '?�트?�크 ?�결???�인?�주?�요.',        solution: '?�터???�결 ?�태�??�인?�고 ?�시 ?�도?�주?�요.',        severity: 'warning'      };        case AuthErrorCodes.TIMEOUT:      return {        code,        message,        userMessage: '?�청 ?�간??초과?�었?�니??',        solution: '?�트?�크 ?�태�??�인?�고 ?�시 ?�도?�주?�요.',        severity: 'warning'      };        case AuthErrorCodes.INVALID_APP_CREDENTIAL:      return {        code,        message,        userMessage: '???�증 ?�보가 ?�바르�? ?�습?�다.',        solution: '?�을 ?�시 ?�작?�거??관리자?�게 문의?�주?�요.',        severity: 'error'      };        case AuthErrorCodes.INVALID_USER_TOKEN:      return {        code,        message,        userMessage: '로그???�션??만료?�었?�니??',        solution: '?�시 로그?�해주세??',        severity: 'warning'      };        case AuthErrorCodes.USER_TOKEN_EXPIRED:      return {        code,        message,        userMessage: '로그???�션??만료?�었?�니??',        solution: '?�시 로그?�해주세??',        severity: 'warning'      };        case AuthErrorCodes.REQUIRES_RECENT_LOGIN:      return {        code,        message,        userMessage: '보안???�해 ?�시 로그?�이 ?�요?�니??',        solution: '?�재 비�?번호�??�시 로그?�해주세??',        severity: 'warning'      };        // 기본 ?�류    default:      return {        code,        message,        userMessage: '로그??�??�류가 발생?�습?�다.',        solution: '?�시 ???�시 ?�도?�거??관리자?�게 문의?�주?�요.',        severity: 'error'      };  }}// ---- Email/Password ----export async function emailLogin(email: string, password: string) {  try {    const cred = await signInWithEmailAndPassword(auth, email, password);    return cred.user;  } catch (e: unknown) {    if (isFirebaseError(e)) {      console.error('[AUTH] login failed', e.code, e.message);      // ?�출 측에??코드 기반?�로 메시지 매핑 가?�하?�록 ?�러 코드 ?�달      throw new Error(e.code);    }    console.error('[AUTH] unknown error', e);    throw new Error('auth/unknown');  }}export async function signInWithEmail(email: string, password: string) {  try {    console.log('[AUTH] Attempting email login for:', email);        // ?�력�?검�?    if (!email || !email.trim()) {      throw new Error('?�메?�을 ?�력?�주?�요.');    }    if (!password || !password.trim()) {      throw new Error('비�?번호�??�력?�주?�요.');    }        // ?�메???�식 검�?    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;    if (!emailRegex.test(email.trim())) {      throw new Error('?�바�??�메???�식???�력?�주?�요.');    }        const result = await signInWithEmailAndPassword(auth, email.trim(), password);    console.log('[AUTH] Email login successful for:', email);    return result;  } catch (error) {    console.error('[AUTH] Email login failed for:', email);        if (isFirebaseError(error)) {      // Firebase ?�류 코드/메시지�?로깅 (민감 ?�보 ?�외)      console.error('[AUTH] Firebase login error:', error.code, error.message);            const analyzedError = analyzeAuthError(error);      console.error('[AUTH] Analyzed error:', analyzedError);            // ?�용??친화?�인 ?�류 객체 ?�성      const userFriendlyError = new Error(analyzedError.userMessage);      (userFriendlyError as any).authError = analyzedError;      (userFriendlyError as any).originalError = error;            throw userFriendlyError;    }        // ?�반 ?�류 처리    if (error instanceof Error) {      throw error;    }        throw new Error('?????�는 ?�류가 발생?�습?�다.');  }}export const loginWithEmail = signInWithEmail; // aliasexport async function registerWithEmail(email: string, password: string) {  try {    console.log('[AUTH] Attempting email registration for:', email);        // ?�력�?검�?    if (!email || !email.trim()) {      throw new Error('?�메?�을 ?�력?�주?�요.');    }    if (!password || !password.trim()) {      throw new Error('비�?번호�??�력?�주?�요.');    }        // ?�메???�식 검�?    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;    if (!emailRegex.test(email.trim())) {      throw new Error('?�바�??�메???�식???�력?�주?�요.');    }        // 비�?번호 강도 검�?    if (password.length < 8) {      throw new Error('비�?번호??8???�상?�어???�니??');    }        const result = await createUserWithEmailAndPassword(auth, email.trim(), password);    console.log('[AUTH] Email registration successful for:', email);    return result;  } catch (error) {    console.error('[AUTH] Email registration failed for:', email);        if (isFirebaseError(error)) {      const analyzedError = analyzeAuthError(error);      console.error('[AUTH] Analyzed error:', analyzedError);            // ?�용??친화?�인 ?�류 객체 ?�성      const userFriendlyError = new Error(analyzedError.userMessage);      (userFriendlyError as any).authError = analyzedError;      (userFriendlyError as any).originalError = error;            throw userFriendlyError;    }        // ?�반 ?�류 처리    if (error instanceof Error) {      throw error;    }        throw new Error('?????�는 ?�류가 발생?�습?�다.');  }}export const signUpWithEmail = registerWithEmail; // alias// ---- Google ----export async function signInWithGoogle() {  try {    if (isUsingEmulators) {      // ?��??�이?�에??구�? ?�업 로그??불편/미�???케?�스가 ?�어 ?�메??비번 권장      throw new Error('?��??�이?�에?�는 ?�메??비�?번호 로그?�을 ?�용?�세??');    }        console.log('[AUTH] Attempting Google login');    // ?�로??모바??친화??Google 로그???�용    const { loginWithGoogle: mobileFriendlyLogin } = await import('../../lib/auth/google');    await mobileFriendlyLogin();    console.log('[AUTH] Google login successful');    return { user: auth.currentUser };  } catch (error) {    console.error('[AUTH] Google login failed');        if (isFirebaseError(error)) {      const analyzedError = analyzeAuthError(error);      console.error('[AUTH] Analyzed error:', analyzedError);            // ?�용??친화?�인 ?�류 객체 ?�성      const userFriendlyError = new Error(analyzedError.userMessage);      (userFriendlyError as any).authError = analyzedError;      (userFriendlyError as any).originalError = error;            throw userFriendlyError;    }        // ?�반 ?�류 처리    if (error instanceof Error) {      throw error;    }        throw new Error('Google 로그??�??�류가 발생?�습?�다.');  }}export const loginWithGoogle = signInWithGoogle; // alias// ---- Session helpers ----export function logout() {  return signOut(auth);}export function subscribeAuth(cb: (u: User | null) => void) {  return onAuthStateChanged(auth, cb);}// ---- ?�류 처리 ?�틸리티 ----function isFirebaseError(e: unknown): e is FirebaseError {  return e instanceof FirebaseError || (    typeof e === 'object' && e !== null && 'code' in e  );}export function isAuthError(error: any): error is { code: string; message: string } {  return error && typeof error === 'object' && 'code' in error;}export function getAuthErrorInfo(error: any) {  if (isFirebaseError(error)) {    return analyzeAuthError(error);  }  return null;}export function formatAuthErrorForUser(error: any): {  message: string;  solution: string;  severity: 'info' | 'warning' | 'error';} {  if (isAuthError(error)) {    const analyzedError = analyzeAuthError(error);    return {      message: analyzedError.userMessage,      solution: analyzedError.solution,      severity: analyzedError.severity    };  }    // ?�반 ?�류 처리  if (error instanceof Error) {    return {      message: error.message,      solution: '?�시 ???�시 ?�도?�거??관리자?�게 문의?�주?�요.',      severity: 'error'    };  }    return {    message: '?????�는 ?�류가 발생?�습?�다.',    solution: '?�시 ???�시 ?�도?�거??관리자?�게 문의?�주?�요.',    severity: 'error'  };}// ?�류 로깅???�한 ?�퍼 ?�수export function logAuthError(context: string, error: any, additionalInfo?: any) {  console.group(`[AUTH ERROR] ${context}`);  console.error('Error:', error);  console.error('Error type:', typeof error);  console.error('Error constructor:', error?.constructor?.name);    if (additionalInfo) {    console.error('Additional info:', additionalInfo);  }    if (isFirebaseError(error)) {    const analyzedError = analyzeAuthError(error);    console.error('Analyzed error:', analyzedError);  }    console.groupEnd();} 
