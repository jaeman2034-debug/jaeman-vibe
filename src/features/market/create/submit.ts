// src/features/market/create/submit.tsimport { addDoc, collection, serverTimestamp, GeoPoint } from 'firebase/firestore';import { db } from '@/lib/firebase';import { getCurrentLocation, reverseGeocode } from '@/features/location/locationService';import type { ProductDoc, RegionInfo } from '@/types/product';// geohash ?°ë©´ ê±°ë¦¬/ì£¼ë?ê²€?‰ì— ? ë¦¬import { geohashForLocation } from 'geofire-common';export interface MarketItemPayload {  title: string;  price: number;  description?: string;  category: string;  condition: 'new' | 'used' | 'refurbished';  images?: string[];  tags?: string[];  sellerId: string;  status: "active" | "sold";}export async function createMarketItem(payload: MarketItemPayload): Promise<string> {  try {    // 1. ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?(? íƒ?¬í•­)    let location = null;    let address = null;    let geohash = null;        try {      console.log('?“ ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤??ì¤?..');      location = await getCurrentLocation();            if (location.lat && location.lng) {        // 2. ????¤ì½”?©ìœ¼ë¡?ì£¼ì†Œ ?•ë³´ ê°€?¸ì˜¤ê¸?        console.log('?  ì£¼ì†Œ ?•ë³´ ë³€??ì¤?..');        address = await reverseGeocode(location.lat, location.lng);                // 3. geohash ?ì„±        geohash = geohashForLocation([location.lat, location.lng]);      }    } catch (locationError) {      console.warn('? ï¸ ?„ì¹˜ ?œë¹„???¤íŒ¨ (ê³„ì† ì§„í–‰):', locationError);      // ?„ì¹˜ ?œë¹„???¤íŒ¨?´ë„ ?í’ˆ ?±ë¡?€ ê³„ì† ì§„í–‰    }        // 4. Firestore???€?¥í•  ?°ì´??êµ¬ì„± (ProductDoc ?€?…ì— ë§ì¶¤)    const productData: Partial<ProductDoc> = {      title: payload.title,      price: payload.price,      description: payload.description,      images: payload.images,      sellerId: payload.sellerId,      status: payload.status,      createdAt: serverTimestamp(),      updatedAt: serverTimestamp()    };        // ?„ì¹˜ ?•ë³´ê°€ ?ˆìœ¼ë©?ProductDoc ?€?…ì— ë§ê²Œ ì¶”ê?    if (location && address && geohash) {      productData.location = new GeoPoint(location.lat, location.lng);      // ?”¥ loc ?„ë“œ ì¶”ê? (?‰ì •??ì²˜ë¦¬??      productData.loc = {        lat: location.lat,        lng: location.lng,      };      productData.region = {        si: address.sido,        gu: address.sigungu,        dong: address.dong,        full: address.full,        provider: "kakao"      };    } else {      // ?„ì¹˜ ?•ë³´ê°€ ?†ëŠ” ê²½ìš°      productData.region = {        provider: "none"      };    }        // ?”¥ ê¸°ë³¸ ì£¼ì†Œ ?íƒœ ?¤ì • (?‰ì •??ì²˜ë¦¬??    productData.addr = {      hjdStatus: 'pending' as const    };        // 5. Firestore???€??    console.log('?’¾ ?í’ˆ ?•ë³´ ?€??ì¤?..');    const docRef = await addDoc(collection(db, 'products'), productData);        if (location && address) {      console.log('???í’ˆ ?±ë¡ ?„ë£Œ (?„ì¹˜ ?¬í•¨):', {        id: docRef.id,        location: `${location.lat}, ${location.lng}`,        address: address.full,        geohash: geohash?.substring(0, 8) + '...'      });    } else {      console.log('???í’ˆ ?±ë¡ ?„ë£Œ (?„ì¹˜ ?†ìŒ):', {        id: docRef.id      });    }        return docRef.id;      } catch (error) {    console.error('???í’ˆ ?±ë¡ ?¤íŒ¨:', error);    throw new Error(`?í’ˆ ?±ë¡???¤íŒ¨?ˆìŠµ?ˆë‹¤: ${error instanceof Error ? error.message : '?????†ëŠ” ?¤ë¥˜'}`);  }}// ?„ì¹˜ ?•ë³´ë§??…ë°?´íŠ¸?˜ëŠ” ?¨ìˆ˜export async function updateItemLocation(itemId: string): Promise<void> {  try {    const location = await getCurrentLocation();    const address = await reverseGeocode(location.lat, location.lng);    const geohash = geohashForLocation([location.lat, location.lng]);        // Firestore ?…ë°?´íŠ¸ ë¡œì§ (êµ¬í˜„ ?„ìš”)    console.log('?“ ?„ì¹˜ ?•ë³´ ?…ë°?´íŠ¸ ?„ë£Œ:', address.full);      } catch (error) {    console.error('???„ì¹˜ ?•ë³´ ?…ë°?´íŠ¸ ?¤íŒ¨:', error);    throw error;  }} 
