"use strict";
// 배경 ?�거 ?�틸리티// @imgly/background-removal???�적 import�??�용export interface BackgroundRemovalOptions {  quality?: number; // 0.1 ~ 1.0  outputFormat?: 'image/png' | 'image/jpeg' | 'image/webp';  outputSize?: {    width: number;    height: number;  };}export interface BackgroundRemovalResult {  success: boolean;  dataUrl?: string;  blob?: Blob;  error?: string;  processingTime?: number;}// 배경 ?�거 ?�이브러�??�적 로드let backgroundRemovalModule: any = null;const loadBackgroundRemovalModule = async () => {  if (backgroundRemovalModule) {    return backgroundRemovalModule;  }  try {    // ?�적 import�?배경 ?�거 ?�이브러�?로드    const module = await import('@imgly/background-removal');    backgroundRemovalModule = module;    return module;  } catch (error) {    console.error('배경 ?�거 ?�이브러�?로드 ?�패:', error);    throw new Error('배경 ?�거 기능???�용?????�습?�다.');  }};// File??dataURL�?변??const fileToDataURL = (file: File): Promise<string> => {  return new Promise((resolve, reject) => {    const reader = new FileReader();    reader.onload = () => resolve(reader.result as string);    reader.onerror = reject;    reader.readAsDataURL(file);  });};// dataURL??Blob?�로 변??const dataURLToBlob = (dataURL: string): Blob => {  const arr = dataURL.split(',');  const mime = arr[0].match(/:(.*?);/)?.[1] || 'image/png';  const bstr = atob(arr[1]);  let n = bstr.length;  const u8arr = new Uint8Array(n);    while (n--) {    u8arr[n] = bstr.charCodeAt(n);  }    return new Blob([u8arr], { type: mime });};// ?��?지 ?�질 ?�수 계산 (간단???�리?�틱)export const calculateImageQuality = (file: File): Promise<number> => {  return new Promise((resolve) => {    const img = new Image();    const canvas = document.createElement('canvas');    const ctx = canvas.getContext('2d')!;        img.onload = () => {      canvas.width = img.width;      canvas.height = img.height;      ctx.drawImage(img, 0, 0);            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);      const data = imageData.data;            let totalBrightness = 0;      let totalContrast = 0;      let edgeCount = 0;            // 밝기?� ?��?계산      for (let i = 0; i < data.length; i += 4) {        const r = data[i];        const g = data[i + 1];        const b = data[i + 2];                const brightness = (r + g + b) / 3;        totalBrightness += brightness;                // 간단???��? 감�?        if (i > 0 && i < data.length - 4) {          const prevBrightness = (data[i - 4] + data[i - 3] + data[i - 2]) / 3;          const contrast = Math.abs(brightness - prevBrightness);          totalContrast += contrast;                    if (contrast > 30) {            edgeCount++;          }        }      }            const avgBrightness = totalBrightness / (data.length / 4);      const avgContrast = totalContrast / (data.length / 4);      const edgeDensity = edgeCount / (data.length / 4);            // ?�질 ?�수 계산 (0-100)      let quality = 0;            // 밝기 ?�수 (20??      if (avgBrightness > 50 && avgBrightness < 200) {        quality += 20;      } else if (avgBrightness > 30 && avgBrightness < 220) {        quality += 15;      } else {        quality += 10;      }            // ?��??�수 (30??      if (avgContrast > 20) {        quality += 30;      } else if (avgContrast > 10) {        quality += 20;      } else {        quality += 10;      }            // ?��? 밀???�수 (30??      if (edgeDensity > 0.1) {        quality += 30;      } else if (edgeDensity > 0.05) {        quality += 20;      } else {        quality += 10;      }            // ?�일 ?�기 ?�수 (20??      const fileSizeMB = file.size / (1024 * 1024);      if (fileSizeMB > 0.5 && fileSizeMB < 5) {        quality += 20;      } else if (fileSizeMB > 0.1 && fileSizeMB < 10) {        quality += 15;      } else {        quality += 10;      }            resolve(Math.min(100, Math.max(0, quality)));    };        img.onerror = () => resolve(0);    img.src = URL.createObjectURL(file);  });};// 배경 ?�거 ?�행export const removeBackground = async (  file: File,  options: BackgroundRemovalOptions = {}): Promise<BackgroundRemovalResult> => {  const startTime = Date.now();    try {    // 배경 ?�거 ?�이브러�?로드    const module = await loadBackgroundRemovalModule();        // 기본 ?�션 ?�정    const defaultOptions = {      quality: 0.8,      outputFormat: 'image/png' as const,      ...options    };        // File??dataURL�?변??    const dataURL = await fileToDataURL(file);        // 배경 ?�거 ?�행    const result = await module.removeBackground(dataURL, {      output: {        format: defaultOptions.outputFormat,        quality: defaultOptions.quality      }    });        // 결과�?Blob?�로 변??    const blob = dataURLToBlob(result);        const processingTime = Date.now() - startTime;        return {      success: true,      dataUrl: result,      blob,      processingTime    };      } catch (error: any) {    console.error('배경 ?�거 ?�패:', error);        return {      success: false,      error: error.message || '배경 ?�거???�패?�습?�다.',      processingTime: Date.now() - startTime    };  }};// 배경 ?�거 + 리사?�즈 ?�합 ?�수export const removeBackgroundAndResize = async (  file: File,  backgroundOptions: BackgroundRemovalOptions = {},  resizeOptions: {    maxWidth?: number;    maxHeight?: number;    quality?: number;  } = {}): Promise<BackgroundRemovalResult> => {  try {    // 배경 ?�거 ?�행    const removalResult = await removeBackground(file, backgroundOptions);        if (!removalResult.success || !removalResult.blob) {      return removalResult;    }        // Blob??File�?변??    const processedFile = new File([removalResult.blob], file.name, {      type: removalResult.blob.type    });        // 리사?�즈 ?�틸리티 import �??�행    const { resizeImage } = await import('./imageUtils');        const resizedFile = await resizeImage(      processedFile,      resizeOptions.maxWidth || 1600,      resizeOptions.maxHeight || 1600,      resizeOptions.quality || 0.86    );        // 최종 결과 반환    return {      success: true,      dataUrl: removalResult.dataUrl,      blob: resizedFile,      processingTime: removalResult.processingTime    };      } catch (error: any) {    console.error('배경 ?�거 + 리사?�즈 ?�패:', error);        return {      success: false,      error: error.message || '?��?지 처리???�패?�습?�다.'    };  }};// 배경 ?�거 가???��? ?�인export const isBackgroundRemovalAvailable = async (): Promise<boolean> => {  try {    await loadBackgroundRemovalModule();    return true;  } catch {    return false;  }};// 배경 ?�거 ?�션 ?�리??export const BACKGROUND_REMOVAL_PRESETS = {  fast: {    quality: 0.6,    outputFormat: 'image/jpeg' as const  },  balanced: {    quality: 0.8,    outputFormat: 'image/png' as const  },  high: {    quality: 0.95,    outputFormat: 'image/png' as const  }} as const;// 배경 ?�거 진행�?콜백 ?�??export type ProgressCallback = (progress: number) => void;// 배경 ?�거 진행�??�함 ?�수export const removeBackgroundWithProgress = async (  file: File,  options: BackgroundRemovalOptions = {},  onProgress?: ProgressCallback): Promise<BackgroundRemovalResult> => {  if (onProgress) {    onProgress(0);  }    try {    // 배경 ?�거 ?�행    const result = await removeBackground(file, options);        if (onProgress) {      onProgress(100);    }        return result;      } catch (error: any) {    if (onProgress) {      onProgress(0);    }        return {      success: false,      error: error.message || '배경 ?�거???�패?�습?�다.'    };  }}; 
