// ë°°ê²½ ?œê±° ? í‹¸ë¦¬í‹°// @imgly/background-removal???™ì  importë¡??¬ìš©export interface BackgroundRemovalOptions {  quality?: number; // 0.1 ~ 1.0  outputFormat?: 'image/png' | 'image/jpeg' | 'image/webp';  outputSize?: {    width: number;    height: number;  };}export interface BackgroundRemovalResult {  success: boolean;  dataUrl?: string;  blob?: Blob;  error?: string;  processingTime?: number;}// ë°°ê²½ ?œê±° ?¼ì´ë¸ŒëŸ¬ë¦??™ì  ë¡œë“œlet backgroundRemovalModule: any = null;const loadBackgroundRemovalModule = async () => {  if (backgroundRemovalModule) {    return backgroundRemovalModule;  }  try {    // ?™ì  importë¡?ë°°ê²½ ?œê±° ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë“œ    const module = await import('@imgly/background-removal');    backgroundRemovalModule = module;    return module;  } catch (error) {    console.error('ë°°ê²½ ?œê±° ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë“œ ?¤íŒ¨:', error);    throw new Error('ë°°ê²½ ?œê±° ê¸°ëŠ¥???¬ìš©?????†ìŠµ?ˆë‹¤.');  }};// File??dataURLë¡?ë³€??const fileToDataURL = (file: File): Promise<string> => {  return new Promise((resolve, reject) => {    const reader = new FileReader();    reader.onload = () => resolve(reader.result as string);    reader.onerror = reject;    reader.readAsDataURL(file);  });};// dataURL??Blob?¼ë¡œ ë³€??const dataURLToBlob = (dataURL: string): Blob => {  const arr = dataURL.split(',');  const mime = arr[0].match(/:(.*?);/)?.[1] || 'image/png';  const bstr = atob(arr[1]);  let n = bstr.length;  const u8arr = new Uint8Array(n);    while (n--) {    u8arr[n] = bstr.charCodeAt(n);  }    return new Blob([u8arr], { type: mime });};// ?´ë?ì§€ ?ˆì§ˆ ?ìˆ˜ ê³„ì‚° (ê°„ë‹¨???´ë¦¬?¤í‹±)export const calculateImageQuality = (file: File): Promise<number> => {  return new Promise((resolve) => {    const img = new Image();    const canvas = document.createElement('canvas');    const ctx = canvas.getContext('2d')!;        img.onload = () => {      canvas.width = img.width;      canvas.height = img.height;      ctx.drawImage(img, 0, 0);            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);      const data = imageData.data;            let totalBrightness = 0;      let totalContrast = 0;      let edgeCount = 0;            // ë°ê¸°?€ ?€ë¹?ê³„ì‚°      for (let i = 0; i < data.length; i += 4) {        const r = data[i];        const g = data[i + 1];        const b = data[i + 2];                const brightness = (r + g + b) / 3;        totalBrightness += brightness;                // ê°„ë‹¨???£ì? ê°ì?        if (i > 0 && i < data.length - 4) {          const prevBrightness = (data[i - 4] + data[i - 3] + data[i - 2]) / 3;          const contrast = Math.abs(brightness - prevBrightness);          totalContrast += contrast;                    if (contrast > 30) {            edgeCount++;          }        }      }            const avgBrightness = totalBrightness / (data.length / 4);      const avgContrast = totalContrast / (data.length / 4);      const edgeDensity = edgeCount / (data.length / 4);            // ?ˆì§ˆ ?ìˆ˜ ê³„ì‚° (0-100)      let quality = 0;            // ë°ê¸° ?ìˆ˜ (20??      if (avgBrightness > 50 && avgBrightness < 200) {        quality += 20;      } else if (avgBrightness > 30 && avgBrightness < 220) {        quality += 15;      } else {        quality += 10;      }            // ?€ë¹??ìˆ˜ (30??      if (avgContrast > 20) {        quality += 30;      } else if (avgContrast > 10) {        quality += 20;      } else {        quality += 10;      }            // ?£ì? ë°€???ìˆ˜ (30??      if (edgeDensity > 0.1) {        quality += 30;      } else if (edgeDensity > 0.05) {        quality += 20;      } else {        quality += 10;      }            // ?Œì¼ ?¬ê¸° ?ìˆ˜ (20??      const fileSizeMB = file.size / (1024 * 1024);      if (fileSizeMB > 0.5 && fileSizeMB < 5) {        quality += 20;      } else if (fileSizeMB > 0.1 && fileSizeMB < 10) {        quality += 15;      } else {        quality += 10;      }            resolve(Math.min(100, Math.max(0, quality)));    };        img.onerror = () => resolve(0);    img.src = URL.createObjectURL(file);  });};// ë°°ê²½ ?œê±° ?¤í–‰export const removeBackground = async (  file: File,  options: BackgroundRemovalOptions = {}): Promise<BackgroundRemovalResult> => {  const startTime = Date.now();    try {    // ë°°ê²½ ?œê±° ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë“œ    const module = await loadBackgroundRemovalModule();        // ê¸°ë³¸ ?µì…˜ ?¤ì •    const defaultOptions = {      quality: 0.8,      outputFormat: 'image/png' as const,      ...options    };        // File??dataURLë¡?ë³€??    const dataURL = await fileToDataURL(file);        // ë°°ê²½ ?œê±° ?¤í–‰    const result = await module.removeBackground(dataURL, {      output: {        format: defaultOptions.outputFormat,        quality: defaultOptions.quality      }    });        // ê²°ê³¼ë¥?Blob?¼ë¡œ ë³€??    const blob = dataURLToBlob(result);        const processingTime = Date.now() - startTime;        return {      success: true,      dataUrl: result,      blob,      processingTime    };      } catch (error: any) {    console.error('ë°°ê²½ ?œê±° ?¤íŒ¨:', error);        return {      success: false,      error: error.message || 'ë°°ê²½ ?œê±°???¤íŒ¨?ˆìŠµ?ˆë‹¤.',      processingTime: Date.now() - startTime    };  }};// ë°°ê²½ ?œê±° + ë¦¬ì‚¬?´ì¦ˆ ?µí•© ?¨ìˆ˜export const removeBackgroundAndResize = async (  file: File,  backgroundOptions: BackgroundRemovalOptions = {},  resizeOptions: {    maxWidth?: number;    maxHeight?: number;    quality?: number;  } = {}): Promise<BackgroundRemovalResult> => {  try {    // ë°°ê²½ ?œê±° ?¤í–‰    const removalResult = await removeBackground(file, backgroundOptions);        if (!removalResult.success || !removalResult.blob) {      return removalResult;    }        // Blob??Fileë¡?ë³€??    const processedFile = new File([removalResult.blob], file.name, {      type: removalResult.blob.type    });        // ë¦¬ì‚¬?´ì¦ˆ ? í‹¸ë¦¬í‹° import ë°??¤í–‰    const { resizeImage } = await import('./imageUtils');        const resizedFile = await resizeImage(      processedFile,      resizeOptions.maxWidth || 1600,      resizeOptions.maxHeight || 1600,      resizeOptions.quality || 0.86    );        // ìµœì¢… ê²°ê³¼ ë°˜í™˜    return {      success: true,      dataUrl: removalResult.dataUrl,      blob: resizedFile,      processingTime: removalResult.processingTime    };      } catch (error: any) {    console.error('ë°°ê²½ ?œê±° + ë¦¬ì‚¬?´ì¦ˆ ?¤íŒ¨:', error);        return {      success: false,      error: error.message || '?´ë?ì§€ ì²˜ë¦¬???¤íŒ¨?ˆìŠµ?ˆë‹¤.'    };  }};// ë°°ê²½ ?œê±° ê°€???¬ë? ?•ì¸export const isBackgroundRemovalAvailable = async (): Promise<boolean> => {  try {    await loadBackgroundRemovalModule();    return true;  } catch {    return false;  }};// ë°°ê²½ ?œê±° ?µì…˜ ?„ë¦¬??export const BACKGROUND_REMOVAL_PRESETS = {  fast: {    quality: 0.6,    outputFormat: 'image/jpeg' as const  },  balanced: {    quality: 0.8,    outputFormat: 'image/png' as const  },  high: {    quality: 0.95,    outputFormat: 'image/png' as const  }} as const;// ë°°ê²½ ?œê±° ì§„í–‰ë¥?ì½œë°± ?€??export type ProgressCallback = (progress: number) => void;// ë°°ê²½ ?œê±° ì§„í–‰ë¥??¬í•¨ ?¨ìˆ˜export const removeBackgroundWithProgress = async (  file: File,  options: BackgroundRemovalOptions = {},  onProgress?: ProgressCallback): Promise<BackgroundRemovalResult> => {  if (onProgress) {    onProgress(0);  }    try {    // ë°°ê²½ ?œê±° ?¤í–‰    const result = await removeBackground(file, options);        if (onProgress) {      onProgress(100);    }        return result;      } catch (error: any) {    if (onProgress) {      onProgress(0);    }        return {      success: false,      error: error.message || 'ë°°ê²½ ?œê±°???¤íŒ¨?ˆìŠµ?ˆë‹¤.'    };  }}; 
