import { collection, query, where, orderBy, limit, getDocs } from "firebase/firestore";import { db } from "@/lib/firebase";// ???µê³„ ê³„ì‚° ? í‹¸ë¦¬í‹°function median(xs: number[]) {  const a = [...xs].sort((x, y) => x - y);  const m = Math.floor(a.length / 2);  return a.length % 2 ? a[m] : (a[m - 1] + a[m]) / 2;}function percentile(xs: number[], p: number) {  const a = [...xs].sort((x, y) => x - y);  const i = Math.floor((a.length - 1) * p);  return a[i];}// ??Firestore?ì„œ ? ì‚¬ ê°€ê²??˜ì§‘async function fetchComparablePrices(category: string, dongCode?: string) {  let prices: number[] = [];    console.log(`?” [ê°€ê²©ì¶”ì²? ?œì‘ - ì¹´í…Œê³ ë¦¬: ${category}, ?™ë„¤ì½”ë“œ: ${dongCode || "?†ìŒ"}`);  // 1) ?™ì¼ ?™ë„¤ + ?ë§¤ì¤?active  try {    const qs = query(      collection(db, "products"),      where("category", "==", category),      where("status", "in", ["?ë§¤ì¤?, "active"]),      ...(dongCode ? [where("dongCode", "==", dongCode)] : []),      orderBy("createdAt", "desc"),      limit(120)    );    console.log(`?” [ê°€ê²©ì¶”ì²? ì¿¼ë¦¬ 1 ?¤í–‰: category=${category}, status in ["?ë§¤ì¤?, "active"], dongCode=${dongCode || "?†ìŒ"}`);        const snap = await getDocs(qs);    prices = snap.docs.map(d => Number((d.data() as any).price)).filter(n => n > 0);    console.log(`[ê°€ê²©ì¶”ì²? ?™ì¼ ?™ë„¤(${dongCode || "?„ì???}) ?ë§¤ì¤?active: ${prices.length}ê°?);        if (snap.size > 0) {      console.log(`?“‹ [ê°€ê²©ì¶”ì²? ì²?ë²ˆì§¸ ê²°ê³¼:`, {        id: snap.docs[0].id,        title: snap.docs[0].data().title,        price: snap.docs[0].data().price,        category: snap.docs[0].data().category,        status: snap.docs[0].data().status      });    }  } catch (error) {    console.warn(`[ê°€ê²©ì¶”ì²? ?™ì¼ ?™ë„¤ ì¿¼ë¦¬ ?¤íŒ¨ (?¸ë±???„ìš”?????ˆìŒ):`, error);  }  // 2) ?„ì???+ ?ë§¤ì¤?active  if (prices.length < 20) {    try {      console.log(`?” [ê°€ê²©ì¶”ì²? ì¿¼ë¦¬ 2 ?¤í–‰: category=${category}, status in ["?ë§¤ì¤?, "active"] (?„ì???`);            const snap = await getDocs(query(        collection(db, "products"),        where("category", "==", category),        where("status", "in", ["?ë§¤ì¤?, "active"]),        orderBy("createdAt", "desc"),        limit(200)      ));      const globalPrices = snap.docs.map(d => Number((d.data() as any).price)).filter(n => n > 0);      prices = prices.concat(globalPrices);      console.log(`[ê°€ê²©ì¶”ì²? ?„ì????ë§¤ì¤?active ì¶”ê?: ${globalPrices.length}ê°?);            if (snap.size > 0) {        console.log(`?“‹ [ê°€ê²©ì¶”ì²? ?„ì???ì²?ë²ˆì§¸ ê²°ê³¼:`, {          id: snap.docs[0].id,          title: snap.docs[0].data().title,          price: snap.docs[0].data().price        });      }    } catch (error) {      console.warn(`[ê°€ê²©ì¶”ì²? ?„ì???ì¿¼ë¦¬ ?¤íŒ¨:`, error);    }  }  // 3) ?„ì²´ ì¹´í…Œê³ ë¦¬?ì„œ ê°€ê²??˜ì§‘ (ë§ˆì?ë§??˜ë‹¨)  if (prices.length < 10) {    try {      console.log(`?” [ê°€ê²©ì¶”ì²? ì¿¼ë¦¬ 3 ?¤í–‰: ?„ì²´ ì¹´í…Œê³ ë¦¬?ì„œ ê°€ê²??˜ì§‘`);            const snap = await getDocs(query(        collection(db, "products"),        where("status", "in", ["?ë§¤ì¤?, "active"]),        orderBy("createdAt", "desc"),        limit(200)      ));      const allPrices = snap.docs.map(d => Number((d.data() as any).price)).filter(n => n > 0);      prices = prices.concat(allPrices);      console.log(`[ê°€ê²©ì¶”ì²? ?„ì²´ ì¹´í…Œê³ ë¦¬?ì„œ ì¶”ê?: ${allPrices.length}ê°?);            if (snap.size > 0) {        console.log(`?“‹ [ê°€ê²©ì¶”ì²? ?„ì²´ ì²?ë²ˆì§¸ ê²°ê³¼:`, {          id: snap.docs[0].id,          title: snap.docs[0].data().title,          price: snap.docs[0].data().price,          status: snap.docs[0].data().status        });      }    } catch (error) {      console.warn(`[ê°€ê²©ì¶”ì²? ?„ì²´ ì¹´í…Œê³ ë¦¬ ì¿¼ë¦¬ ?¤íŒ¨:`, error);    }  }  console.log(`[ê°€ê²©ì¶”ì²? ìµœì¢… ?˜ì§‘??ê°€ê²? ${prices.length}ê°?);  return prices;}// ??ê°€ê²?ë²”ìœ„ ?œì•ˆ (ë©”ì¸ ?¨ìˆ˜)export async function suggestPriceRange(category: string, dongCode?: string) {  try {    const prices = await fetchComparablePrices(category, dongCode);    if (prices.length < 5) return null;    const med = median(prices);    const p25 = percentile(prices, 0.25);    const p75 = percentile(prices, 0.75);    const low = Math.round(p25);    const mid = Math.round(med);    const high = Math.round(p75);    const confidence = Math.max(0.3, Math.min(0.95, Math.log10(prices.length) / 2));    return {       low,       mid,       high,       confidence,      count: prices.length,      range: `${Math.round(low / 1000)}ë§Œì› ~ ${Math.round(high / 1000)}ë§Œì›`    };  } catch (error) {    console.error("ê°€ê²?ë²”ìœ„ ?œì•ˆ ?¤íŒ¨:", error);    return null;  }}// ???ì„¸ ê°€ê²??µê³„ (?•ì¥ ê¸°ëŠ¥)export async function getDetailedPriceStats(category: string, dongCode?: string) {  try {    const prices = await fetchComparablePrices(category, dongCode);    if (prices.length === 0) return null;    const sortedPrices = prices.sort((a, b) => a - b);    const min = sortedPrices[0];    const max = sortedPrices[sortedPrices.length - 1];    const med = median(prices);    const q1 = percentile(prices, 0.25);    const q3 = percentile(prices, 0.75);    return {      min: Math.round(min / 1000) * 1000,        // 1000???¨ìœ„ë¡?ë°˜ì˜¬ë¦?      median: Math.round(med / 1000) * 1000,     // ì¤‘ì•™ê°?      max: Math.round(max / 1000) * 1000,        // ìµœë?ê°?      q1: Math.round(q1 / 1000) * 1000,         // 1?¬ë¶„?„ìˆ˜      q3: Math.round(q3 / 1000) * 1000,         // 3?¬ë¶„?„ìˆ˜      count: prices.length,                       // ?°ì´??ê°œìˆ˜      range: `${Math.round(min / 1000)}ë§Œì› ~ ${Math.round(max / 1000)}ë§Œì›`, // ë²”ìœ„ ë¬¸ì??      location: dongCode ? "?™ì¼ ?™ë„¤" : "?„ì???, // ì§€???•ë³´      confidence: prices.length >= 20 ? "?’ìŒ" : prices.length >= 10 ? "ë³´í†µ" : "??Œ" // ? ë¢°??    };  } catch (error) {    console.error("?ì„¸ ê°€ê²??µê³„ ì¡°íšŒ ?¤íŒ¨:", error);    return null;  }}
