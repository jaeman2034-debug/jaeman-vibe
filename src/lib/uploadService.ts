import { ref, uploadBytes, getDownloadURL } from "firebase/storage";import { collection, addDoc, serverTimestamp } from "firebase/firestore";import { storage, db, auth } from "@/lib/firebase";     // ??getStorage() ÏßÅÏ†ë ?∏Ï∂ú Í∏àÏ?import { getCurrentLocation } from "@/features/location/locationService";export type UploadedFile = { file: File; url: string };const BUCKET = 'jaeman-vibe-platform.firebasestorage.app';// ??Storage Î≤ÑÌÇ∑ ?ïÏù∏ Î°úÍ∑∏ Ï∂îÍ?console.log("[UPLOAD SERVICE] Storage instance bucket:", storage.app.options.storageBucket);console.log("[UPLOAD SERVICE] Storage instance:", storage);console.log("[UPLOAD SERVICE] BUCKET constant:", BUCKET);// ?¥Î?ÏßÄ ?ÖÎ°ú??(Storage) - contentType Ï∂îÍ? Î∞?market/ Í≤ΩÎ°ú ?òÏ†ïexport async function uploadImages(files: File[], folder: string): Promise<string[]> {  const uploadPromises = files.map(async (file) => {    // Í∑úÏπô: market/**, ?¥Î?ÏßÄ, 5MB ?¥Ìïò    if (!file.type.startsWith("image/")) {      throw new Error(`?¥Î?ÏßÄ ?Ä???ÑÎãò: ${file.name} (${file.type})`);    }    if (file.size > 5 * 1024 * 1024) {      throw new Error(`5MB Ï¥àÍ≥º: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);    }    const fileName = `${crypto.randomUUID()}-${file.name}`;    // ??gs:// ?ÄÍ≤ΩÎ°úÎ°?ref ?ùÏÑ±    const full = `gs://${BUCKET}/${folder}/${fileName}`;    const storageRef = ref(storage, full);        try {      // ??contentType ?ÑÏàò - CORS Î¨∏Ï†ú ?¥Í≤∞      const snapshot = await uploadBytes(storageRef, file, { contentType: file.type });      const downloadURL = await getDownloadURL(snapshot.ref);      return downloadURL;    } catch (error) {      console.error("Image upload failed:", error);      throw new Error(`?¥Î?ÏßÄ ?ÖÎ°ú???§Ìå®: ${file.name}`);    }  });  return Promise.all(uploadPromises);}// ÎßàÏºì ?ÑÏö© ?¥Î?ÏßÄ ?ÖÎ°ú???®Ïàò Ï∂îÍ?export async function uploadMarketImages(files: File[]): Promise<string[]> {  const urls: string[] = [];  for (const file of files) {    // Í∑úÏπô: market/**, ?¥Î?ÏßÄ, 5MB ?¥Ìïò    if (!file.type.startsWith("image/")) {      throw new Error(`?¥Î?ÏßÄ ?Ä???ÑÎãò: ${file.name} (${file.type})`);    }    if (file.size > 5 * 1024 * 1024) {      throw new Error(`5MB Ï¥àÍ≥º: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);    }    const key = `market/${crypto.randomUUID()}-${file.name}`;    // ??gs:// ?ÄÍ≤ΩÎ°úÎ°?ref ?ùÏÑ±    const full = `gs://${BUCKET}/${key}`;    const storageRef = ref(storage, full);    // ?îÎ≤ÑÍπ?Î°úÍ∑∏ Ï∂îÍ?    console.log("[UPLOAD] file:", file.name, file.type, (file.size/1024/1024).toFixed(2)+"MB");    console.log("[UPLOAD] storage path:", key);    console.log("[UPLOAD] full gs path:", full);    console.log("[UPLOAD] storage instance:", !!storage);    console.log("[UPLOAD] auth current user:", !!auth.currentUser);    try {      // ???¨Î∞îÎ•?Î≤ÑÌÇ∑ ?¨Ïö©?ºÎ°ú CORS Î¨∏Ï†ú ?¥Í≤∞      console.log("[UPLOAD] Starting uploadBytes...");      const uploadOptions = {        contentType: file.type      };            console.log("[UPLOAD] Upload options:", uploadOptions);            await uploadBytes(storageRef, file, uploadOptions)        .then((snapshot) => {          console.log("[UPLOAD] uploadBytes success:", snapshot);        })        .catch((e) => {          console.error("[UPLOAD ERROR]", {            name: file.name,            type: file.type,            size: file.size,            path: key,            fullGsPath: full,            error: e.message,            code: e.code          }, e);          throw e;        });      console.log("[UPLOAD] Getting download URL...");      const url = await getDownloadURL(storageRef);      console.log("[UPLOAD SUCCESS]", file.name, "??, url);      urls.push(url);    } catch (error: any) {      console.error("[UPLOAD FAILED]", file.name, error);            // ?ºÎ∞ò?ÅÏù∏ ?ÖÎ°ú???§Î•ò Ï≤òÎ¶¨      if (error.code === 'storage/unauthorized') {        console.error("[AUTH ERROR] Firebase Storage Í∂åÌïú???ÜÏäµ?àÎã§!");        throw new Error(`Í∂åÌïú ?§Î•ò: Î°úÍ∑∏?∏Ïù¥ ?ÑÏöî?©Îãà??`);      }            throw new Error(`?¥Î?ÏßÄ ?ÖÎ°ú???§Ìå®: ${file.name} - ${error.message || error}`);    }  }  return urls;}// ?ÅÌíà ?±Î°ù (Storage + Firestore) - products Ïª¨Î†â???¨Ïö©export async function createProduct(data: {  title: string;  price: number;  category: string;  desc: string;  location?: string;  lat?: number;  lng?: number;  images: File[];  sellerId: string; // ?ÑÏàò: ?êÎß§??UID}) {  try {    // 1. ?¥Î?ÏßÄ ?ÖÎ°ú??    const imageUrls = await uploadImages(data.images, "products");        // ?î• ?ÑÏû¨ ?ÑÏπò Í∞Ä?∏Ïò§Í∏?(lat/lng???ÜÏúºÎ©??êÎèô?ºÎ°ú Í∞Ä?∏Ïò¥)    let currentLocation = null;    if (!data.lat || !data.lng) {      try {        currentLocation = await getCurrentLocation();        console.log("[CREATE] ?ÑÏû¨ ?ÑÏπò ?êÎèô Í∞Ä?∏Ïò¥:", currentLocation);      } catch (error) {        console.warn("[CREATE] ?ÑÏπò Í∞Ä?∏Ïò§Í∏??§Ìå®:", error);      }    }        // 2. Firestore Î¨∏ÏÑú ?ùÏÑ± (products Ïª¨Î†â??    const docRef = await addDoc(collection(db, "products"), {      sellerId: data.sellerId,        // ?ÑÏàò: ?êÎß§??UID      title: data.title,              // ?ÑÏàò: ?ÅÌíàÎ™?      price: data.price,              // ?ÑÏàò: Í∞ÄÍ≤?      status: '?êÎß§Ï§? as const,      // ?ÑÏàò: ?ÅÌÉú (Í∏∞Î≥∏Í∞? ?êÎß§Ï§?            // ?†ÌÉù???ÑÎìú      category: data.category,      desc: data.desc,      location: data.location,      // ?î• Ï¢åÌëú ?ïÎ≥¥ (?ÑÎã¨Î∞õÏ? Í∞??∞ÏÑ†, ?ÜÏúºÎ©??ÑÏû¨ ?ÑÏπò)      lat: data.lat || (currentLocation?.lat ?? null),      lng: data.lng || (currentLocation?.lng ?? null),      // ?î• ?ÑÏû¨ ?ÑÏπòÎ•?loc ?ÑÎìúÎ°úÎèÑ ?Ä??(?âÏ†ï??Ï≤òÎ¶¨??      loc: (data.lat && data.lng) ? { lat: data.lat, lng: data.lng } :            (currentLocation ? { lat: currentLocation.lat, lng: currentLocation.lng } : null),      images: imageUrls,            // ?î• Í∏∞Î≥∏ Ï£ºÏÜå ?ÅÌÉú ?§Ï†ï      addr: {        hjdStatus: 'pending' as const      },            // Î©îÌ??∞Ïù¥??      createdAt: serverTimestamp(),      updatedAt: serverTimestamp(),      views: 0,      likes: 0,    });    return { id: docRef.id, imageUrls };  } catch (error) {    console.error("Product creation failed:", error);    throw error;  }}// ÎßàÏºì ?ÅÌíà ?±Î°ù (backward compatibility)export async function createMarketItem(data: {  title: string;  price: number;  category: string;  desc: string;  location?: string;  lat?: number;  lng?: number;  images: File[];}) {  // sellerIdÍ∞Ä ?ÜÏúºÎ©??ÑÏû¨ Î°úÍ∑∏?∏Îêú ?¨Ïö©???¨Ïö©  if (!auth.currentUser) {    throw new Error("Î°úÍ∑∏?∏Ïù¥ ?ÑÏöî?©Îãà??");  }    return createProduct({    ...data,    sellerId: auth.currentUser.uid  });}// Íµ¨Ïù∏Íµ¨ÏßÅ Í≥µÍ≥† ?±Î°ùexport async function createJobPosting(data: {  role: string;  org: string;  location: string;  pay?: string;  desc: string;  lat: number;  lng: number;  images: File[];}) {  try {    // 1. ?¥Î?ÏßÄ ?ÖÎ°ú??(?†ÌÉù??    const imageUrls = data.images.length > 0       ? await uploadImages(data.images, "jobs")      : [];        // 2. Firestore Î¨∏ÏÑú ?ùÏÑ±    const docRef = await addDoc(collection(db, "jobs"), {      ...data,      images: imageUrls,      createdAt: serverTimestamp(),      updatedAt: serverTimestamp(),      status: "active", // active, closed, filled      views: 0,      applications: 0,    });    return { id: docRef.id, imageUrls };  } catch (error) {    console.error("Job posting creation failed:", error);    throw error;  }}// Î™®ÏûÑ ?ùÏÑ±export async function createGroup(data: {  name: string;  schedule: string;  place: string;  desc: string;  lat: number;  lng: number;  images: File[];}) {  try {    // 1. ?¥Î?ÏßÄ ?ÖÎ°ú??(?†ÌÉù??    const imageUrls = data.images.length > 0       ? await uploadImages(data.images, "groups")      : [];        // 2. Firestore Î¨∏ÏÑú ?ùÏÑ±    const docRef = await addDoc(collection(db, "groups"), {      ...data,      images: imageUrls,      createdAt: serverTimestamp(),      updatedAt: serverTimestamp(),      status: "active", // active, full, cancelled      members: 0,      maxMembers: 20, // Í∏∞Î≥∏Í∞?      views: 0,    });    return { id: docRef.id, imageUrls };  } catch (error) {    console.error("Group creation failed:", error);    throw error;  }}// Ï±ÑÌåÖ Í¥Ä???®Ïàò??export async function createChatThread(data: {  productId: string;  buyerUid: string;  sellerUid: string;  initialMessage?: string;  productTitle?: string;  productImage?: string;  productPrice?: number;}) {  try {    const threadRef = await addDoc(collection(db, "threads"), {      members: [data.buyerUid, data.sellerUid],      productId: data.productId,      status: 'negotiating' as const,      lastMessage: data.initialMessage || '',      lastMessageAt: serverTimestamp(),      createdAt: serverTimestamp(),      productTitle: data.productTitle,      productImage: data.productImage,      productPrice: data.productPrice,    });    // Ï¥àÍ∏∞ Î©îÏãúÏßÄÍ∞Ä ?àÏúºÎ©?Î©îÏãúÏßÄ???ùÏÑ±    if (data.initialMessage) {      await addDoc(collection(db, "threads", threadRef.id, "messages"), {        threadId: threadRef.id,        senderId: data.buyerUid,        content: data.initialMessage,        type: 'text' as const,        createdAt: serverTimestamp(),      });    }    return { id: threadRef.id };  } catch (error) {    console.error("Chat thread creation failed:", error);    throw error;  }}export async function sendMessage(data: {  threadId: string;  content: string;  type: 'text' | 'image' | 'offer';  imageUrl?: string;  offerAmount?: number;}) {  if (!auth.currentUser) {    throw new Error("Î°úÍ∑∏?∏Ïù¥ ?ÑÏöî?©Îãà??");  }  try {    const messageRef = await addDoc(collection(db, "threads", data.threadId, "messages"), {      threadId: data.threadId,      senderId: auth.currentUser.uid,      content: data.content,      type: data.type,      imageUrl: data.imageUrl,      offerAmount: data.offerAmount,      createdAt: serverTimestamp(),    });    // Ï±ÑÌåÖÎ∞©Ïùò ÎßàÏ?Îß?Î©îÏãúÏßÄ ?ïÎ≥¥ ?ÖÎç∞?¥Ìä∏    const { doc, updateDoc } = await import('firebase/firestore');    await updateDoc(doc(db, "threads", data.threadId), {      lastMessage: data.content,      lastMessageAt: serverTimestamp(),    });    return { id: messageRef.id };  } catch (error) {    console.error("Message sending failed:", error);    throw error;  }}// ?åÏùº ?¨Í∏∞ Î∞??Ä??Í≤ÄÏ¶?export function validateFile(file: File): { valid: boolean; error?: string } {  const maxSize = 5 * 1024 * 1024; // 5MB  const allowedTypes = ["image/jpeg", "image/png", "image/webp"];    if (file.size > maxSize) {    return { valid: false, error: "?åÏùº ?¨Í∏∞??5MB ?¥Ìïò?¨Ïïº ?©Îãà??" };  }    if (!allowedTypes.includes(file.type)) {    return { valid: false, error: "JPG, PNG, WebP ?åÏùºÎß??ÖÎ°ú??Í∞Ä?•Ìï©?àÎã§." };  }    return { valid: true };}// ?¨Îü¨ ?åÏùº Í≤ÄÏ¶?export function validateFiles(files: File[]): { valid: boolean; errors: string[] } {  const errors: string[] = [];    files.forEach((file, index) => {    const result = validateFile(file);    if (!result.valid) {      errors.push(`?åÏùº ${index + 1}: ${result.error}`);    }  });    return {    valid: errors.length === 0,    errors  };}