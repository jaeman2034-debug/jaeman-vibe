import { redirect, LoaderFunctionArgs } from "react-router-dom";import { getFirestore, doc, getDoc, collection, query, where, limit, getDocs } from "firebase/firestore";/** * data.idë¡???¡°??(?ˆì „ ì½”ë“œ ?¸í™˜?? * products, market ì»¬ë ‰?˜ì—??data.id ?„ë“œê°€ ?¼ì¹˜?˜ëŠ” ë¬¸ì„œ ì°¾ê¸° */async function reverseLookupByDataId(badId: string) {  const db = getFirestore();  const qs = [    query(collection(db, "products"), where("id", "==", badId), limit(1)),    query(collection(db, "market"),   where("id", "==", badId), limit(1)),  ];  for (const q of qs) {    const s = await getDocs(q);    if (!s.empty) return s.docs[0].id; // ?¤ì œ ë¬¸ì„œ ID  }  return null;}/** * ?í’ˆ ?ì„¸ ?˜ì´ì§€ ë¡œë” * ?œë²„ ?¬ì´?œì—??ë¦¬ë‹¤?´ë ‰?¸ë? ì²´í¬?˜ê³  ì²˜ë¦¬ */export async function productDetailLoader({ params }: LoaderFunctionArgs) {  const id = params.id;    if (!id) {    throw new Error("?í’ˆ IDê°€ ?„ìš”?©ë‹ˆ??");  }  // ???¹ìˆ˜??ID ê°?ì²˜ë¦¬  if (id === "create" || id === "new") {    console.log("[LOADER] ?¹ìˆ˜ ID ê°ì?, ?±ë¡ ?˜ì´ì§€ë¡?ë¦¬ë‹¤?´ë ‰??", id);    throw redirect("/market/create");  }  try {    const db = getFirestore();        // ??ë¦¬ë‹¤?´ë ‰??ì²´í¬ (IDê°€ ë³€ê²½ëœ ê²½ìš°)    console.log(`[LOADER] ë¦¬ë‹¤?´ë ‰??ì²´í¬: ${id}`);    const rSnap = await getDoc(doc(db, "redirects", id));        if (rSnap.exists()) {      const to = (rSnap.data() as any)?.to as string | undefined;      if (to && to !== id) {        console.log(`[LOADER] ë¦¬ë‹¤?´ë ‰??ë°œê²¬: ${id} ??${to}`);        throw redirect(`/market/${to}`);      }    }        // ??ë¦¬ë‹¤?´ë ‰?¸ê? ?†ìœ¼ë©??´ë°± ì²´í¬ ?œì‘    console.log(`[LOADER] ?´ë°± ì²´í¬ ?œì‘: ${id}`);        // 1ï¸âƒ£ products?ì„œ ?í’ˆ ?•ì¸    const productSnap = await getDoc(doc(db, "products", id));    if (productSnap.exists()) {      console.log(`[LOADER] products?ì„œ ?í’ˆ ë°œê²¬: ${id}`);      return null; // ì»´í¬?ŒíŠ¸?ì„œ loadItem ?¸ì¶œ    }        // 2ï¸âƒ£ market?ì„œ ?í’ˆ ?•ì¸    const marketSnap = await getDoc(doc(db, "market", id));    if (marketSnap.exists()) {      console.log(`[LOADER] market?ì„œ ?í’ˆ ë°œê²¬: ${id}`);      return null; // ì»´í¬?ŒíŠ¸?ì„œ loadItem ?¸ì¶œ    }        // 3ï¸âƒ£ data.id ??¡°??(?ˆì „ ì½”ë“œ ?¸í™˜)    console.log(`[LOADER] data.id ??¡°???œë„: ${id}`);    const real = await reverseLookupByDataId(id);    if (real) {      console.log(`[LOADER] ??¡°???±ê³µ: ${id} ??${real}`);      throw redirect(`/market/${real}`, {         replace: true,         state: { redirectedFrom: id, fixedBy: "data.id" }       });    }        // 4ï¸âƒ£ ìµœì¢… 404    console.log(`[LOADER] ëª¨ë“  ?´ë°± ?¤íŒ¨, 404: ${id}`);    throw new Response("?í’ˆ??ì°¾ì„ ???†ìŠµ?ˆë‹¤.", { status: 404 });      } catch (error) {    if (error instanceof Response) {      // redirect()ë¡??¸í•œ ?ëŸ¬??ê·¸ë?ë¡??„íŒŒ      throw error;    }        console.warn(`[LOADER] ë¦¬ë‹¤?´ë ‰??ì²´í¬ ?¤íŒ¨:`, error);    // ë¦¬ë‹¤?´ë ‰??ì²´í¬ ?¤íŒ¨?´ë„ ê³„ì† ì§„í–‰    return null;  }}
