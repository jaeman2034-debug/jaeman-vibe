import React, { useEffect, useState } from 'react';import { useNavigate } from 'react-router-dom';import { auth } from '@/lib/firebase';import { getUserThreads } from '@/services/chatService';import { doc, getDoc } from 'firebase/firestore';import { db } from '@/lib/firebase';interface Thread {  id: string;  members: string[];  productId: string;  status: string;  lastMessage: string;  lastMessageAt: any;  createdAt: any;}interface Product {  id: string;  title: string;  price: number;  images: string[];  sellerId: string;}export default function ChatList() {  const [threads, setThreads] = useState<Thread[]>([]);  const [products, setProducts] = useState<Record<string, Product>>({});  const [loading, setLoading] = useState(true);  const navigate = useNavigate();  useEffect(() => {    const loadThreads = async () => {      try {        const userThreads = await getUserThreads();        setThreads(userThreads);        // ê°??¤ë ˆ?œì˜ ?í’ˆ ?•ë³´ ë¡œë“œ        const productMap: Record<string, Product> = {};        for (const thread of userThreads) {          if (thread.productId) {            try {              const productDoc = await getDoc(doc(db, 'market', thread.productId));              if (productDoc.exists()) {                productMap[thread.productId] = {                  id: productDoc.id,                  ...productDoc.data()                } as Product;              }            } catch (error) {              console.error('?í’ˆ ?•ë³´ ë¡œë“œ ?¤íŒ¨:', error);            }          }        }        setProducts(productMap);      } catch (error) {        console.error('ì±„íŒ… ëª©ë¡ ë¡œë“œ ?¤íŒ¨:', error);        alert('ì±„íŒ… ëª©ë¡??ë¶ˆëŸ¬?????†ìŠµ?ˆë‹¤.');      } finally {        setLoading(false);      }    };    if (auth.currentUser) {      loadThreads();    } else {      setLoading(false);    }  }, []);  // ?ë?ë°?ID ê°€?¸ì˜¤ê¸?  const getOpponentId = (thread: Thread) => {    if (!auth.currentUser) return null;    return thread.members.find(id => id !== auth.currentUser?.uid);  };  // ?œê°„ ?¬ë§·??  const formatTime = (timestamp: any) => {    if (!timestamp) return '';        const now = new Date();    const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);    const diff = now.getTime() - time.getTime();        if (diff < 60000) return 'ë°©ê¸ˆ ??;    if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶???;    if (diff < 86400000) return `${Math.floor(diff / 3600000)}?œê°„ ??;    return `${Math.floor(diff / 86400000)}????;  };  if (loading) {    return (      <div className="flex items-center justify-center min-h-screen">        <div className="text-center">          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>          <p className="text-gray-600">ì±„íŒ… ëª©ë¡??ë¶ˆëŸ¬?¤ëŠ” ì¤?..</p>        </div>      </div>    );  }  if (!auth.currentUser) {    return (      <div className="text-center py-8">        <p className="text-red-600">ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??</p>        <button          onClick={() => navigate('/')}          className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"        >          ë¡œê·¸?¸í•˜ê¸?        </button>      </div>    );  }  if (threads.length === 0) {    return (      <div className="text-center py-8">        <p className="text-gray-600">ì§„í–‰ ì¤‘ì¸ ì±„íŒ…???†ìŠµ?ˆë‹¤.</p>        <button          onClick={() => navigate('/market')}          className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"        >          ë§ˆì¼“ ?˜ëŸ¬ë³´ê¸°        </button>      </div>    );  }  return (    <div className="max-w-4xl mx-auto p-4">      {/* ?¤ë” */}      <div className="flex items-center justify-between mb-6">        <h1 className="text-2xl font-bold">ì±„íŒ… ëª©ë¡</h1>        <button          onClick={() => navigate('/market')}          className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"        >          ë§ˆì¼“?¼ë¡œ        </button>      </div>      {/* ì±„íŒ… ëª©ë¡ */}      <div className="space-y-3">        {threads.map((thread) => {          const product = products[thread.productId];          const opponentId = getOpponentId(thread);                    return (            <div              key={thread.id}              onClick={() => navigate(`/chat/${thread.id}`)}              className="bg-white border rounded-lg p-4 cursor-pointer hover:shadow-md transition-shadow"            >              <div className="flex items-center gap-4">                {/* ?í’ˆ ?´ë?ì§€ */}                <div className="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">                  {product?.images?.[0] ? (                    <img                      src={product.images[0]}                      alt={product.title}                      className="w-full h-full object-cover"                    />                  ) : (                    <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs">                      ?´ë?ì§€ ?†ìŒ                    </div>                  )}                </div>                {/* ì±„íŒ… ?•ë³´ */}                <div className="flex-1 min-w-0">                  <div className="flex items-start justify-between">                    <div className="flex-1 min-w-0">                      <h3 className="font-semibold text-gray-900 truncate">                        {product?.title || '?í’ˆ ?•ë³´ ?†ìŒ'}                      </h3>                      <p className="text-sm text-gray-600 mt-1">                        ?ë?ë°? {opponentId ? `${opponentId.slice(0, 8)}...` : '?????†ìŒ'}                      </p>                      {thread.lastMessage && (                        <p className="text-sm text-gray-500 mt-1 truncate">                          {thread.lastMessage}                        </p>                      )}                    </div>                                        <div className="text-right text-sm text-gray-500 ml-4">                      <div className="mb-1">                        {formatTime(thread.lastMessageAt)}                      </div>                      <div className={`px-2 py-1 rounded-full text-xs font-medium ${                        thread.status === 'negotiating' ? 'bg-blue-100 text-blue-800' :                        thread.status === 'booked' ? 'bg-yellow-100 text-yellow-800' :                        'bg-green-100 text-green-800'                      }`}>                        {thread.status === 'negotiating' && '?‘ì˜ ì¤?}                        {thread.status === 'booked' && '?ˆì•½ ?•ì •'}                        {thread.status === 'done' && 'ê±°ë˜ ?„ë£Œ'}                      </div>                    </div>                  </div>                                    {product && (                    <div className="mt-2">                      <span className="text-lg font-bold text-blue-600">                        {product.price?.toLocaleString()}??                      </span>                    </div>                  )}                </div>              </div>            </div>          );        })}      </div>    </div>  );}