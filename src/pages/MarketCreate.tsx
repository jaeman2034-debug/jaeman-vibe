import { useState, useEffect, useCallback } from "react";import { useNavigate } from "react-router-dom";import { createMarketItem } from "@/lib/collections";import { uploadMarketImages } from "@/lib/uploadService";import ImageUploader, { Uploaded } from "@/components/ImageUploader";import { auth, googleProvider } from "@/lib/firebase";import { signInWithPopup } from "firebase/auth";import { autoReverseGeocoding, GeocodingResult } from "@/utils/geocoding";import useGeolocation from "@/hooks/useGeolocation";import { reverseGeocodeDong } from "@/lib/geo";export default function MarketCreate() {  const nav = useNavigate();  const [form, setForm] = useState({    title: "",    price: "",    category: "",    desc: "",    location: "",    lat: "",    lng: ""  });  // ???ï¿½ï¿½? 'images'?ï¿½ëŠ” ?ï¿½ë¦„???ï¿½íƒœ/ê°ì²´ï¿??ï¿½ì„ ë¬¶ï¿½? ë§ˆì„¸??  // ?ï¿½ì¼ ?ï¿½íƒœ??photos ê°™ï¿½? ?ï¿½ë¥¸ ?ï¿½ë¦„???ï¿½ê³ ,  const [photos, setPhotos] = useState<{file: File; preview: string}[]>([]);  const [loading, setLoading] = useState(false);  const [locationLoading, setLocationLoading] = useState(false);    // useGeolocation ???ï¿½ìš©  const { coords: userLocation, requestPermission } = useGeolocation();  // photos state ë³€ï¿?ê°ï¿½?  useEffect(() => {    console.log("[MARKET_CREATE] photos state changed:", photos.length, photos.map(p => ({ name: p.file.name, size: p.file.size })));  }, [photos]);  const onChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {    setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));  };  // ?ï¿½ì¹˜ ?ï¿½ë™ ì±„ìš°ï¿?(????ï¿½ì½”???ï¿½í•¨)  const useMyLocation = async () => {    if (!userLocation) {      // ?ï¿½ì¹˜ ê¶Œí•œ ?ï¿½ì²­      await requestPermission();      return;    }    setLocationLoading(true);    try {      // ????ï¿½ì½”?ï¿½ìœ¼ï¿?ì£¼ì†Œ ?ï¿½ë³´ ê°€?ï¿½ì˜¤ï¿?      const geocodingResult = await autoReverseGeocoding(        userLocation.lat,        userLocation.lng,        import.meta.env.VITE_KAKAO_REST_API_KEY,        import.meta.env.VITE_GOOGLE_MAPS_API_KEY      );      if (geocodingResult) {        setForm(prev => ({          ...prev,          lat: String(geocodingResult.lat),          lng: String(geocodingResult.lng),          location: geocodingResult.placeName || geocodingResult.address        }));                console.log('[LOCATION] ?ï¿½ì¹˜ ?ï¿½ë™ ì±„ìš°ï¿??ï¿½ë£Œ:', geocodingResult);      }    } catch (error) {      console.error('[LOCATION] ????ï¿½ì½”???ï¿½ë¥˜:', error);      // ê¸°ë³¸ ì¢Œí‘œï¿??ï¿½ì •      setForm(prev => ({        ...prev,        lat: String(userLocation.lat),        lng: String(userLocation.lng)      }));    } finally {      setLocationLoading(false);    }  };  // ??useCallback?ï¿½ë¡œ ê°ì‹¸ï¿?photosï¿??ï¿½ì¡´??ë°°ì—´??ì¶”ï¿½?  const onSubmit = useCallback(async (e: React.FormEvent) => {    e.preventDefault(); // ??form ê¸°ë³¸ ?ï¿½ì‘ ë§‰ê¸°    if (loading) return;        console.log("?? [SUBMIT] ?ï¿½ì‘");        // ?ï¿½ï¿½ ?ï¿½ë²„ï¿? onSubmit ?ï¿½ì‘ ??photos ?ï¿½íƒœ ?ï¿½ì¸    console.log("[SUBMIT] photos:", photos, photos.length);    console.log("[SUBMIT] photos length:", photos.length);    console.log("[SUBMIT] names:", photos.map(p => p.file.name));    console.log("[SUBMIT] photos type:", typeof photos);    console.log("[SUBMIT] photos isArray:", Array.isArray(photos));        // ?ï¿½ì¼ ê²€ï¿?    if (photos.length === 0) {      alert("?ï¿½ï¿½?ì§€ï¿??ï¿½íƒ?ï¿½ì„¸??);      return;    }        setLoading(true);    console.log("?ï¿½ï¿½ [SUBMIT] ë¡œë”© ?ï¿½ì‘");    try {      // 1) ë¡œê·¸??ë³´ì¥ (ê·œì¹™??auth ?ï¿½ìš”?ï¿½ë©´ ?ï¿½ìˆ˜)      console.log("?ï¿½ï¿½ [SUBMIT] ë¡œê·¸???ï¿½íƒœ ?ï¿½ì¸:", !!auth.currentUser);      if (!auth.currentUser) {        console.log("?ï¿½ï¿½ [SUBMIT] ë¡œê·¸???ï¿½ë„");        await signInWithPopup(auth, googleProvider);        console.log("?ï¿½ï¿½ [SUBMIT] ë¡œê·¸???ï¿½ë£Œ");      }      // 1) Storage ?ï¿½ë¡œ?????ï¿½ìš´ë¡œë“œ URL ë°°ì—´ (uploadMarketImages ?ï¿½ìš©)      console.log("?ï¿½ï¿½ [SUBMIT] ?ï¿½ï¿½?ì§€ ?ï¿½ë¡œ???ï¿½ì‘");      const files = photos.map(p => p.file);  // ???ï¿½ë¡œ???ï¿?ï¿½ì— ë§ê²Œ ?ï¿½ì •      console.log("?ï¿½ï¿½ [SUBMIT] ?ï¿½ë¡œ?ï¿½í•  ?ï¿½ì¼??", files.map(f => ({         name: f.name,         type: f.type,         size: (f.size/1024/1024).toFixed(2)+"MB"       })));            // ?ï¿½ì¼ ê²€ï¿?ë¡œê·¸      files.forEach((file, index) => {        console.log(`?ï¿½ï¿½ [FILE ${index + 1}]`, {          name: file.name,          type: file.type,          size: (file.size/1024/1024).toFixed(2)+"MB",          isImage: file.type.startsWith("image/"),          isUnder5MB: file.size <= 5 * 1024 * 1024        });      });            const urls = await uploadMarketImages(files); // ??uploadMarketImages ?ï¿½ìš©      console.log("?ï¿½ï¿½ [SUBMIT] ?ï¿½ï¿½?ì§€ ?ï¿½ë¡œ???ï¿½ë£Œ:", urls);      // ?ï¿½ï¿½ ?ï¿½ë²„ï¿? ?ï¿½ë¡œ?ï¿½ëœ URL ?ï¿½ì¸      console.log("[MARKET_CREATE] ?ï¿½ë¡œ?ï¿½ëœ ?ï¿½ï¿½?ì§€ ??", photos.length);      console.log("[MARKET_CREATE] ?ï¿½ì„±??URL ë°°ì—´:", urls);      console.log("[MARKET_CREATE] URL ë°°ì—´ ?ï¿??", Array.isArray(urls) ? "ë°°ì—´" : typeof urls);      // 2) ?ï¿½ì •???ï¿½ë³´ ê°€?ï¿½ì˜¤ï¿?(lat/lngê°€ ?ï¿½ëŠ” ê²½ìš°)      let address = null;      if (form.lat && form.lng) {        try {          console.log("?ï¿½ï¿½ [SUBMIT] ?ï¿½ì •???ï¿½ë³´ ê°€?ï¿½ì˜¤ï¿??ï¿½ì‘");          address = await reverseGeocodeDong(Number(form.lat), Number(form.lng));          console.log("?ï¿½ï¿½ [SUBMIT] ?ï¿½ì •???ï¿½ë³´ ?ï¿½ë£Œ:", address);        } catch (geoError) {          console.error("?ï¿½ï¿½ [SUBMIT] ?ï¿½ì •???ï¿½ë³´ ?ï¿½íŒ¨:", geoError);          // ?ï¿½ì •???ï¿½ë³´ ?ï¿½íŒ¨?ï¿½ë„ ?ï¿½í’ˆ ?ï¿½ë¡?ï¿?ê³„ì† ì§„í–‰        }      }      // 3) Firestore?ï¿½ëŠ” 'images'??URL ë°°ì—´ï¿?      console.log("?ï¿½ï¿½ [SUBMIT] Firestore ?ï¿???ï¿½ì‘");      const productData = {        title: form.title.trim(),        desc: form.desc.trim(),        category: form.category,        price: Number(form.price),        location: form.location?.trim() || undefined,        lat: form.lat ? Number(form.lat) : null,        lng: form.lng ? Number(form.lng) : null,        images: urls,                 // ???ï¿½ê¸°ê°€ ?ï¿½ï¿½?. ê°ì‹¸ì§€ ë§ˆì„¸??        // ?ï¿½ì •???ï¿½ë³´ ì¶”ï¿½?        geo: form.lat && form.lng ? {           lat: Number(form.lat),           lng: Number(form.lng)         } : null,        address: address,             // ?ï¿½ì‹œ??(sido/sigungu/dong/full)        status: '?ï¿½ë§¤ï¿?,        sellerId: auth.currentUser?.uid,        createdAt: new Date(),      };      const productRef = await createMarketItem(productData);      console.log("[MARKET_CREATE] Firestore ?ï¿???ï¿½ë£Œ:", productRef.id);      // AI ë¶„ì„ ?ï¿½ë™ ?ï¿½í–‰ (ï¿?ë²ˆì§¸ ?ï¿½ï¿½?ì§€ï¿?      if (urls.length > 0) {        try {          console.log('[AI] ?ï¿½ë™ ë¶„ì„ ?ï¿½ì‘:', productRef.id);          const { callMockAnalyzeAPI } = await import('@/mock/api');          const analysisResult = await callMockAnalyzeAPI({            imageUrl: urls[0],            productId: productRef.id          });          // ë¶„ì„ ê²°ê³¼ï¿?products ì»¬ë ‰?ï¿½ì— ?ï¿??          const { doc, updateDoc } = await import('firebase/firestore');          const { db } = await import('@/lib/firebase');          await updateDoc(doc(db, 'products', productRef.id), {            analysis: analysisResult,            analyzedAt: new Date()          });          console.log('[AI] ?ï¿½ë™ ë¶„ì„ ?ï¿½ë£Œ ï¿??ï¿??', analysisResult);        } catch (analysisError) {          console.error('[AI] ?ï¿½ë™ ë¶„ì„ ?ï¿½íŒ¨:', analysisError);          // ë¶„ì„ ?ï¿½íŒ¨?ï¿½ë„ ?ï¿½í’ˆ ?ï¿½ë¡?ï¿??ï¿½ê³µ        }      }      // ???ï¿½ë¡œ???ï¿???ï¿½ë£Œ ?ï¿½ì—ï¿?ì´ˆê¸°??      setPhotos([]);      setForm({        title: "",        price: "",        category: "",        desc: "",        location: "",        lat: "",        lng: ""      });      alert("?ï¿½ë¡ ?ï¿½ë£Œ!");      nav("/market", { replace: true });    } catch (err: any) {      console.error("??[SUBMIT] ?ï¿½ë¥˜ ë°œìƒ:", err);      console.error("[MARKET_CREATE] error:", err, err?.code, err?.message);      alert("?ï¿½ë¡ ?ï¿½íŒ¨: " + (err?.code || err?.message || String(err)));    } finally {      setLoading(false);      console.log("?ï¿½ï¿½ [SUBMIT] ë¡œë”© ì¢…ë£Œ");    }  }, [photos, loading, form, nav]); // ??photosï¿??ï¿½ì¡´??ë°°ì—´??ì¶”ï¿½?  return (    <form onSubmit={onSubmit} className="space-y-6">      <h2 className="text-2xl font-extrabold">?ï¿½í’ˆ ?ï¿½ë¡</h2>      <div className="card space-y-4">        <div className="grid gap-4 md:grid-cols-2">          <div>            <label className="text-sm text-slate-600">?ï¿½ëª©</label>            <input name="title" value={form.title} onChange={onChange}              placeholder="?? ?ï¿½ë””?ï¿½ìŠ¤ ì¶•êµ¬ï¿?Pro"              className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5" required />          </div>          <div>            <label className="text-sm text-slate-600">ê°€ï¿???</label>            <input name="price" type="number" value={form.price} onChange={onChange}              placeholder="35000" className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5" required />          </div>          <div>            <label className="text-sm text-slate-600">ì¹´í…Œê³ ë¦¬</label>            <select name="category" value={form.category} onChange={onChange}              className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5 bg-white" required>              <option value="" disabled>?ï¿½íƒ</option>              <option value="ì¶•êµ¬">ì¶•êµ¬</option>              <option value="?ï¿½êµ¬">?ï¿½êµ¬</option>              <option value="?ï¿½êµ¬">?ï¿½êµ¬</option>              <option value="?ï¿½ë‹ˆ??>?ï¿½ë‹ˆ??/option>              <option value="ê¸°ï¿½?">ê¸°ï¿½?</option>            </select>          </div>          <div>            <label className="text-sm text-slate-600">ê±°ë˜ ì§€??/label>            <input name="location" value={form.location} onChange={onChange}              placeholder="?ï¿½ìš¸??ê°•ë‚¨ï¿? className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5" />          </div>        </div>        <div>          <label className="text-sm text-slate-600">?ï¿½ëª…</label>          <textarea name="desc" value={form.desc} onChange={onChange}            placeholder="?ï¿½ì„¸ ?ï¿½íƒœ, ?ï¿½ìš©ï¿??ï¿½ì„ ?ï¿½ì–´ì£¼ì„¸??"            className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5 h-28" />        </div>        <ImageUploader           multiple           value={photos}          onChange={(next) => {            console.log("[MARKET_CREATE] photos state changed:", next.length, next);            setPhotos(next);          }}        />        {/* ?ï¿½ï¿½ ?ï¿½ë²„ï¿? ?ï¿½ì¬ ?ï¿½íƒœ ?ï¿½ì¸ (ê°œë°œ ëª¨ë“œ?ï¿½ì„œï¿? */}        {import.meta.env.DEV && (          <div className="card bg-blue-50 border-blue-200">            <div className="text-sm text-blue-700">              <strong>ê°œë°œ ëª¨ë“œ ?ï¿½ë²„ï¿?</strong>              <div>?ï¿½íƒ???ï¿½ï¿½?ì§€: {photos.length}ï¿?/div>              <div>photos ?ï¿½íƒœ: {JSON.stringify(photos.map(p => ({ name: p.file.name, size: p.file.size })))}</div>            </div>          </div>        )}        <div className="grid gap-4 md:grid-cols-2">          <div>            <label className="text-sm text-slate-600">?ï¿½ë„(lat)</label>            <input name="lat" value={form.lat} onChange={onChange}              className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5" />          </div>          <div>            <label className="text-sm text-slate-600">ê²½ë„(lng)</label>            <input name="lng" value={form.lng} onChange={onChange}              className="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2.5" />          </div>        </div>        <button           type="button"           onClick={useMyLocation}           disabled={locationLoading}          className="btn-ghost flex items-center gap-2"        >          {locationLoading ? (            <>              <div className="w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>              ?ï¿½ì¹˜ ?ï¿½ë³´ ê°€?ï¿½ì˜¤??ï¿?..            </>          ) : (            <>              ?ï¿½ï¿½ ?ï¿½ì¬ ?ï¿½ì¹˜ï¿?ì±„ìš°ï¿?            </>          )}        </button>        <div className="flex justify-end gap-3">          <button type="button" onClick={() => nav(-1)} className="btn-ghost">ì·¨ì†Œ</button>          <button type="submit" className="btn-primary" disabled={loading}>            {loading ? "?ï¿½ë¡ ï¿?.." : "?ï¿½ë¡?ï¿½ê¸°"}          </button>        </div>      </div>    </form>  );}
