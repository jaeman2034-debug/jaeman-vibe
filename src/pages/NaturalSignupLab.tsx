import React, { useRef, useState, useCallback, useEffect, useMemo } from "react";import { useNavigate } from "react-router-dom";import { parseNaturalSignup } from "../utils/naturalSignupParser";import { parseSignupFromText } from "../utils/voiceSignupParser";import { Telemetry, sanitizeRawForLogs } from "../lib/telemetry";import { normalizeEmail } from "../lib/parse-ko";import { extractName } from "../lib/koNlu";import { extractEmail } from "../lib/parse-ko-email";import ChatDock from "../components/ChatDock";import { parseSignupUtterance } from "../lib/nlu/parseSignup";import type { Parsed } from "../lib/nlu/parseSignup";import { FLAGS } from "../lib/flags";import { createUserWithEmailAndPassword, updateProfile } from "firebase/auth";import { doc, setDoc, serverTimestamp } from "firebase/firestore";import { auth, db } from "@/lib/firebase";import { toKoMessage } from "@/lib/authErrors";import { useSettings } from "../settings/SettingsContext";// ?œë²„ ?†ì´???µí•˜ê²??˜ëŠ” ?¤ìœ„ì¹?const USE_LOCAL_BOT = true;// ?„í™”/ë¹„ë?ë²ˆí˜¸ ê°„ë‹¨ ?Œì„œfunction extractPhone(raw: string) {  const d = raw.replace(/[^0-9]/g, '');  const m = d.match(/(01[016789])(\d{3,4})(\d{4})/);  return m ? { ok: true, value: `${m[1]}-${m[2]}-${m[3]}` } : { ok: false, value: '' };}function extractPassword(raw: string) {  const m = raw.match(/(?:ë¹„ë?\s*ë²ˆí˜¸|ë¹„ë²ˆ)\s*(?:?€|:)?\s*([A-Za-z0-9!@#$%^&*_.-]{8,})/);  return { ok: !!m, value: m?.[1] ?? '' };}// TypeScript ?„ì—­ ?€??? ì–¸declare global {  interface Window {    setEmail?: (v: string) => void;    setName?: (v: string) => void;    setPhone?: (v: string) => void;  }}/** Natural Signup Parser ?°ëª¨: ?œêµ­???ì¸ ?ì—°?´ì—??name/email/phone/password ì¶”ì¶œ */function NaturalSignupLab() {  const navigate = useNavigate();  const { autoFillWhileListening } = useSettings();    // [ADD] ?”ë ˆë©”íŠ¸ë¦??¸ìŠ¤?´ìŠ¤  const tmRef = React.useRef<Telemetry | null>(null);  if (!tmRef.current) tmRef.current = new Telemetry("/api/telemetry");  const tm = tmRef.current!;  const [userConsented, setUserConsented] = React.useState(false);  const [sessionStartTime, setSessionStartTime] = React.useState<number>(Date.now());    const [raw, setRaw] = useState("");  const [name, setName] = useState("");  const [email, setEmail] = useState("");  const [phone, setPhone] = useState("");  const [password, setPassword] = useState("");  const [pwStatus, setPwStatus] = useState<"ok"|"weak"|"missing">("missing");  const [messages, setMessages] = useState<Array<{role: 'user' | 'assistant', text: string}>>([]);  const [enStrict, setEnStrict] = useState(false);  const [autoReprompt, setAutoReprompt] = useState(false); // ê¸°ë³¸: êº¼ì§(?˜ë™ë§?  const [autoParse, setAutoParse] = useState(false); // ?£ëŠ” ?™ì•ˆ ?ë™ ?Œì‹±(ê¸°ë³¸: êº¼ì§)  const [stickyListen, setStickyListen] = useState(true); // ?Šê²¨???ë™ ?¬ì‹œ??  const [listening, setListening] = useState(false);  const [isSpeaking, setIsSpeaking] = useState(false);  const [autoContinue, setAutoContinue] = useState(false); // ë§??ë‚˜ë©??ë™?¼ë¡œ ?¤ì‹œ ?£ê¸°  const [inlineAppend, setInlineAppend] = useState(true); // ??ê°€ë¡??´ì–´?°ê¸° ? ê?  const [pwOrder, setPwOrder] = useState<"as_spoken"|"letters_first"|"digits_first">("as_spoken");  const [localMsg, setLocalMsg] = useState(""); // ë¡œì»¬ ì±—ë´‡ ?ŒìŠ¤???…ë ¥ ?íƒœ  const [submitting, setSubmitting] = useState(false); // ???œì¶œ ?íƒœ  const recRef = useRef<any>(null);  const textareaRef = useRef<HTMLTextAreaElement>(null);    // [ADD] ì¤‘ë³µ ?Œì‹± ë°©ì???ref  const parsedRef = useRef({ name: false, email: false, last: '' });    // [ADD] ?¬ìš©???¸ì§‘ ?¬ë? ì¶”ì   const touchedRef = React.useRef({ name: false, email: false, phone: false, pw: false });  // [ADD] ?ë™ ì±„ì? ?œì–´ ?¨ìˆ˜  const maybeFillFields = (parsed: any) => {    if (autoFillWhileListening) {      // ?ë™ ì±„ì? ?ˆìš©: ê¸°ì¡´ ë¡œì§      if (parsed.name && !touchedRef.current.name) setName(parsed.name);      if (parsed.email && !touchedRef.current.email) setEmail(parsed.email);      if (parsed.phone && !touchedRef.current.phone) setPhone(parsed.phone);      if (parsed.password && !touchedRef.current.pw) setPassword(parsed.password);    }    // ?ë™ ì±„ì? ê¸ˆì?: ë²„íŠ¼ ?Œë????Œë§Œ  };  // [ADD] ?¬ìš©???¸ì§‘ ?¸ë“¤??  const onNameChange = (v: string) => { setName(v); touchedRef.current.name = true; };  const onEmailChange = (v: string) => { setEmail(v); touchedRef.current.email = true; };  const onPhoneChange = (v: string) => { setPhone(v); touchedRef.current.phone = true; };  const onPasswordChange = (v: string) => { setPassword(v); touchedRef.current.pw = true; };  // [ADD] ? íš¨??ê²€ì¦??¨ìˆ˜??  const isNonEmpty = (s = '') => s.trim().length > 0;  const isEmail = (s = '') => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);  const isPhone = (s = '') => /^\d{2,3}-\d{3,4}-\d{4}$/.test(s);  // [ADD] ?„í™”ë²ˆí˜¸ ?¬ë§·??  const formatPhone = (s: string) =>    s.replace(/\D/g, "").replace(/^(\d{3})(\d{3,4})(\d{4}).*$/, "$1-$2-$3");  // [ADD] fillForm ?¨ìˆ˜ ?•ì˜  const fillForm = (p: {name?: string; email?: string; phone?: string; password?: string}) => {    if (p.name) {      setName(p.name);      touchedRef.current.name = true;    }    if (p.email) {      setEmail(p.email);      touchedRef.current.email = true;    }    if (p.phone) {      setPhone(formatPhone(p.phone));      touchedRef.current.phone = true;    }    if (p.password) {      setPassword(p.password);      touchedRef.current.pw = true;    }    // ???¨ê»˜ ?°ì¹˜/?„ë£Œ ì²˜ë¦¬    // ëª¨ë“  ?„ë“œê°€ ì±„ì›Œì¡Œë‹¤ë©??°ì¹˜ ?íƒœë¥?trueë¡??¤ì •    if (p.name || p.email || p.phone || p.password) {      const updates: any = {};      if (p.name) updates.name = true;      if (p.email) updates.email = true;      if (p.phone) updates.phone = true;      if (p.password) updates.pw = true;            // ?°ì¹˜ ?íƒœ ?…ë°?´íŠ¸      Object.assign(touchedRef.current, updates);    }  };  // [ADD] ?ˆë„?°ë¡œ ?Œì„œ ?¸ì¶œ (ì½˜ì†”/ë²„íŠ¼ ?????‘ê·¼ ê°€??  useEffect(() => {    (window as any).parseSignupUtterance = parseSignupUtterance;    // ì½˜ì†”?ì„œ ?í´ë¦??Œì‹±/ì±„ì????ŒìŠ¤?¸í•  ???ˆë„ë¡??¬í¼ ?˜ë‚˜ ??    (window as any).parseSignupNow = () => {      const raw = textareaRef.current?.value ?? "";      const p = parseSignupUtterance(raw);      fillForm(p);      console.log("[parsed]", p);      return p;    };  }, []);  // [ADD] 30ì´?ì§„ë‹¨ - ???íƒœ ëª¨ë‹ˆ?°ë§  useEffect(() => {    const interval = setInterval(() => {      console.log("[ì§„ë‹¨] ???íƒœ:", {        name: { value: name, touched: touchedRef.current.name },        email: { value: email, touched: touchedRef.current.email },        phone: { value: phone, touched: touchedRef.current.phone },        password: { value: password, touched: touchedRef.current.pw },        timestamp: new Date().toISOString()      });    }, 30000); // 30ì´ˆë§ˆ??    return () => clearInterval(interval);  }, [name, email, phone, password]);  // [ADD] ë¡œì»¬ ì±—ë´‡ ?ŒìŠ¤???„ì†¡ ?¸ë“¤??  const onLocalSend = () => {    const raw = localMsg.trim();    if (!raw) return;    const parsed: Parsed = parseSignupUtterance(raw);    console.log("[LocalBot] parsed:", parsed);    // ?¼ìœ¼ë¡?ë¸Œë¡œ?œìº?¤íŠ¸ (STT ëª¨ë“ˆ ?„ìš©)    window.__setSignupFields?.(parsed);    // (? íƒ) ì±„íŒ…ì°½ì— "?ìš©?ˆì–´???? ê°™ì? ë©”ì‹œì§€ ì¶œë ¥?˜ëŠ” ê¸°ì¡´ ì½”ë“œ ?¸ì¶œ    // addBotMessage(makeAppliedText(parsed));    setLocalMsg("");  };  // [ADD] Firebase ?Œì›ê°€???œì¶œ ?¸ë“¤??  async function handleSubmit(e: React.FormEvent) {    e.preventDefault();    const nameValue = name?.trim();    const emailValue = email?.trim();    const phoneValue = phone?.trim();    const passwordValue = password;    if (!nameValue || !emailValue || !phoneValue || !passwordValue) {      alert("?´ë¦„/?´ë©”???„í™”/ë¹„ë?ë²ˆí˜¸ë¥?ëª¨ë‘ ?…ë ¥??ì£¼ì„¸??");      return;    }    setSubmitting(true);    try {              // auth?€ db???´ë? ?„ì—???•ì˜??      const { user } = await createUserWithEmailAndPassword(auth, emailValue, passwordValue);      await updateProfile(user, { displayName: nameValue });      await setDoc(doc(db, "users", user.uid), {        name: nameValue,         email: emailValue,         phone: phoneValue,         phoneRaw: phoneValue.replace(/\D/g, ""),         createdAt: serverTimestamp()      });      alert("?Œì›ê°€???„ë£Œ!");    } catch (err: any) {      alert(`?Œì›ê°€???¤íŒ¨: ${toKoMessage(err?.code, err?.message)}`);    } finally {      setSubmitting(false);    }  }  // [ADD] ?„ë½ ?„ë“œ ê³„ì‚°  const missing = useMemo(() => {    const arr: Array<"email"|"phone"|"password"> = [];    if (!email) arr.push("email");    if (!phone) arr.push("phone");    if (!password || pwStatus === "missing") arr.push("password");    return arr;  }, [email, phone, password, pwStatus]);  // [ADD] ?ë¬¸(raw)??ë°”ë€???300ms ???ë™ ?Œì‹±  React.useEffect(() => {    if (!raw) return;    const timer = setTimeout(() => {      const n = extractName(raw);      const e = extractEmail(raw);      // ?ë™ ì±„ì? ?¤ìœ„ì¹˜ì— ?°ë¼ ??ì±„ìš°ê¸?      const parsed = {        name: n.ok ? n.value : undefined,        email: e.ok ? e.value : (!e?.ok ? normalizeEmail(raw) : undefined),        phone: extractPhone(raw).ok ? extractPhone(raw).value : undefined,        password: extractPassword(raw).ok ? extractPassword(raw).value : undefined      };            maybeFillFields(parsed);      setPwStatus(extractPassword(raw).ok ? "ok" : "missing");      // ?”ë ˆë©”íŠ¸ë¦?(?˜í”Œë§ì? ?œë²„/?´ë¼?´ì–¸??ì¤??œìª½?ì„œë§?      fetch("/api/telemetry", {        method: "POST",        headers: { "Content-Type": "application/json" },        body: JSON.stringify({          schema: 1,          events: [{            type: 'parse',            ts: Date.now(),            data: { rawLen: raw.length, nameOk: n.ok, emailOk: e.ok }          }]        })      }).catch(() => {}); // ?¤íŒ¨?´ë„ ??ì§„í–‰ ë°©í•´ ê¸ˆì?    }, 300);    return () => clearTimeout(timer);  }, [raw]);  // [ADD] NLU ?´ë²¤??ë¦¬ìŠ¤??- ì±—ë´‡?ì„œ ?Œì‹±??ê²°ê³¼ë¥??¼ì— ?ë™ ì±„ìš°ê¸?  useEffect(() => {    const fill = (p: Parsed) => {      // ?ë™ ì±„ì? ?¤ìœ„ì¹˜ì— ?°ë¼ ??ì±„ìš°ê¸?      maybeFillFields(p);      // ?¬ìš©???¸ì§‘ ?¬ë? ì¶”ì       if (p.name) touchedRef.current.name = true;      if (p.email) touchedRef.current.email = true;      if (p.phone) touchedRef.current.phone = true;      if (p.password) touchedRef.current.pw = true;    };    const onFill = (e: Event) => {      const p = (e as CustomEvent<Parsed>).detail;      console.log("[Form] nlu:fill received:", p);      if (p) fill(p);    };    window.addEventListener("nlu:fill", onFill);    window.__setSignupFields = (parsed: Parsed) => {      // STT ëª¨ë“ˆ ?„ìš©: ?¼ë§Œ ?…ë°?´íŠ¸ (ì±„íŒ…ê³??„ì „ ë¶„ë¦¬)      // ?ë™ ì±„ì? ?¤ìœ„ì¹˜ì— ?°ë¼ ??ì±„ìš°ê¸?      maybeFillFields(parsed);      // ?¬ìš©???¸ì§‘ ?¬ë? ì¶”ì       if (parsed.name) touchedRef.current.name = true;      if (parsed.email) touchedRef.current.email = true;      if (parsed.phone) touchedRef.current.phone = true;      if (parsed.password) touchedRef.current.pw = true;    };    console.log("[debug] setters\nattached:", { set: true });    return () => {      window.removeEventListener("nlu:fill", onFill);      delete window.__setSignupFields;    };  }, []);  // [ADD] STT ê²°ê³¼ ë¡œê¹…  const logStt = React.useCallback(async (bestText: string, parsed: any, altsCount: number) => {    if (!userConsented) return;    const fail = isFailure(parsed);    // ?¤íŒ¨ë©?100%, ?±ê³µ?´ë©´ 1%    if (!fail && !sample(0.01)) return;    const salt = tm.getSalt();    tm.push({      type: "stt_result",      data: {        ts: Date.now(),        alts_count: altsCount,        raw_sanitized: await sanitizeRawForLogs(bestText, salt),        email_found: !!parsed.email,        phone_found: !!parsed.phone,        pw_found: !!parsed.password,        toggles: { strictEN: enStrict, autoParse }      }    });    tm.flush();  }, [userConsented, enStrict, autoParse]);  // [ADD] ?Œì‹± ê²°ê³¼ ë¡œê¹…  const logParse = React.useCallback(async (parsed: any, rawText: string) => {    if (!userConsented) return;    const fail = isFailure(parsed);    if (!fail && !sample(0.01)) return; // ?±ê³µ 1%ë§?    const salt = tm.getSalt();    const emailDomain = parsed.email?.split("@")[1]?.toLowerCase() ?? null;    tm.push({      type: "parse_result",      data: {        ts: Date.now(),        email_status: parsed.email ? "ok" : "missing",        email_domain: emailDomain ?? "none",        phone_status: parsed.phone ? "ok" : "missing",        pw_status: parsed.password ? "ok" : "missing",        raw_len: rawText.length,        raw_sanitized: await sanitizeRawForLogs(rawText, salt),      }    });    tm.flush();  }, [userConsented]);  // ?¤íŒ¨ ?ë‹¨ ?¬í¼  function isFailure(parsed: any) {    return !(parsed?.email && parsed?.phone && parsed?.password && parsed?.name);  }  // ?˜í”Œë§??¬í¼  function sample(prob: number) {    return Math.random() < prob;  }  // [ADD] ?œì¶œ ??ë¡œê¹…(?ˆìœ¼ë©??¸ì¶œ)  const logSubmit = React.useCallback((allOk: boolean, durationMs: number) => {    if (!userConsented) return;    if (allOk && !sample(0.01)) return; // ?±ê³µ 1%    tm.push({ type: "submit", data: { ts: Date.now(), all_ok: allOk, duration_ms: durationMs } });    tm.flush();  }, [userConsented]);  // ???´ë²¤???¸ë“¤?¬ì—??ìµœì‹ ê°’ì„ ?½ê¸° ?„í•œ ref??  const stickyRef  = React.useRef(stickyListen);  const speakRef   = React.useRef(isSpeaking);  const autoParseRef = React.useRef(autoParse);  React.useEffect(() => { stickyRef.current = stickyListen; }, [stickyListen]);  React.useEffect(() => { speakRef.current  = isSpeaking;   }, [isSpeaking]);  React.useEffect(() => { autoParseRef.current = autoParse; }, [autoParse]);  // ?ë¬¸ ?…ë ¥ ë°•ìŠ¤ ?ë™ ?¤í¬ë¡?(ìµœì‹  ?´ìš©????ƒ ë³´ì´ê²?  useEffect(() => {    if (textareaRef.current && raw) {      textareaRef.current.scrollTop = textareaRef.current.scrollHeight;    }  }, [raw]);  // [ADD] ê°œë°œ???ŒìŠ¤????- ë¸Œë¼?°ì? ì½˜ì†”?ì„œ __testName, __testEmail ?¬ìš© ê°€??  React.useEffect(() => {    (window as any).__testName = extractName;    (window as any).__testEmail = extractEmail;  }, []);  // [ADD] ê°œë°œ ì¤?ì½˜ì†”?ì„œ ?íƒœë¥?ë°”ê? ???ˆë„ë¡?window???¸í„°ë¥?ë¶™ì—¬ ?¡ë‹ˆ??  React.useEffect(() => {    // React StrictModeë¡?ë§ˆìš´???¸ë§ˆ?´íŠ¸ê°€ ??ë²??¼ì–´?????ˆìœ¼ë¯€ë¡?    // ?´ë? ?ˆìœ¼ë©???–´?°ì? ?Šê³ , ?†ì„ ?Œë§Œ ?¬ì•„ ?¡ë‹ˆ??    if (!window.setEmail) window.setEmail = (v: string) => setEmail(v);    if (!window.setName) window.setName = (v: string) => setName(v);    if (!window.setPhone) window.setPhone = (v: string) => setPhone(v);    console.log('[debug] setters attached:', {      setEmail: typeof window.setEmail,      setName: typeof window.setName,      setPhone: typeof window.setPhone,    });    // ê°œë°œ ?¸ì˜???•ë¦¬(cleanup)???ëµ (StrictMode?ì„œ ì§€?Œì¡Œ?¤ê? ?¤ì‹œ ?¬ë¦¬??ë¬¸ì œ ë°©ì?)  }, []); // <-- ?˜ì¡´??ë¹„ì?  let rec: any = null; // STT ?¸ìŠ¤?´ìŠ¤ ì§ì ‘ ì°¸ì¡° (SpeechRecognition | webkitSpeechRecognition)    // === Mic guardian refs ===  let keepAliveTimer: number | null = null;   // 60ì´??œí•œ ?Œí”¼??  let restartLock = false;                    // ?™ì‹œ ?¬ì‹œ??ë°©ì?  let sessionStartedAt = 0;  let backoffMs = 400;                        // ?ëŸ¬???ì¦ ?€ê¸?  // ê¶Œì¥ê°? Chrome??continuous?¬ë„ ~60s ?œí•œ ??55ì´ˆë§ˆ???Œì „  const MAX_SESSION_MS = 55_000;    // === STT ê²°ê³¼ ?„ì  + ?„ë“œ ì±„ìš°ê¸?ë¶„ë¦¬ ===  // raw: ?Œì„± ?¸ì‹ ê²°ê³¼ ?„ì  ?€??(?„ë“œ ?ë™ ì±„ìš°ê¸??„ë‹˜)  // autoParse: ?£ëŠ” ?™ì•ˆ ?ë™ ?Œì‹± ?¬ë? (ê¸°ë³¸: êº¼ì§)  // stickyListen: ?Šê²¨???ë™ ?¬ì‹œ??(ë§ˆì´???Šê? ë°©ì?)  // autoContinue: ë§??ë‚˜ë©??ë™?¼ë¡œ ?¤ì‹œ ?£ê¸° ?œì‘  // inlineAppend: ê°€ë¡??´ì–´?°ê¸° ëª¨ë“œ (ê¸°ë³¸: ON, ê³µë°± ?•ë¦¬)  // appendRaw: ê°€ë¡??¸ë¡œ ëª¨ë“œ???°ë¼ êµ¬ë¶„??? íƒ (ê³µë°±/ì¤„ë°”ê¿?  // normalizeInline: ê°€ë¡?ëª¨ë“œ?ì„œ ê³µë°±/êµ¬ë‘???•ë¦¬  // flattenRaw: ê¸°ì¡´ ?ë¬¸????ë²ˆì— ê°€ë¡œë¡œ ë³€??  // blurActive: ?œì„± ?¸í’‹ ë¸”ëŸ¬?˜ì—¬ ?Œì„± ?€?´í•‘ ë°©í•´ ë°©ì?  // ensureRecognizer: continuous=trueë¡?ê¸?êµ¬ê°„???Šê¸°ì§€ ?Šê²Œ, resultIndexë¶€???˜ì§‘    // === STTÂ·TTS ë£¨í”„ ì°¨ë‹¨ + ?˜ë™ ?¬ì§ˆë¬?===  // autoReprompt: false = ?˜ë™ ?¬ì§ˆë¬¸ë§Œ (ê¸°ë³¸ê°?, true = ?ë™ ?¬ì§ˆë¬?ë£¨í”„  // isSpeaking: TTS ì¤‘ì¼ ??STT ì°¨ë‹¨?˜ì—¬ ë£¨í”„ ë°©ì?  // startListen/stopListen: TTS ì¤‘ì¼ ??STT ì°¨ë‹¨?˜ëŠ” ?˜í¼ ?¨ìˆ˜  // startListen: ?¬ì»¤???´ì œ + STT ?œì‘ + sticky ëª¨ë“œ ?œì„±??  // stopListen: sticky ëª¨ë“œ ë¹„í™œ?±í™” + STT ì¤‘ë‹¨  // say(): TTS ?„ì— STT ì¤‘ë‹¨, TTS ???¬ì²­ì·?(?ì½” ë°©ì?)  // onClickRepromptOnce: ?˜ë™ ?¬ì§ˆë¬?ë²„íŠ¼ (?£ê¸° ì¤‘ë‹¨ ???ˆë‚´ ???¬ì²­ì·?  // ???„í™˜/?¬ì»¤???´ë²¤?¸ì—?œë„ ?ë™ ?Œë³µ  useEffect(() => {    const onVis = () => {      if (document.visibilityState === "visible" && stickyRef.current && !speakRef.current) {        // ??ë³µê? ??ì¦‰ì‹œ ?Œë³µ        gracefulRestart("visibility");      } else {        stopKeepAlive();      }    };    document.addEventListener("visibilitychange", onVis);    window.addEventListener("focus", onVis);    window.addEventListener("blur", stopListen);    return () => {      document.removeEventListener("visibilitychange", onVis);      window.removeEventListener("focus", onVis);      window.removeEventListener("blur", stopListen);    };  }, [stickyListen, isSpeaking]);    // ê³µë°±/êµ¬ë‘???•ë¦¬(ê°€ë¡?ëª¨ë“œ?ì„œë§??¬ìš©)  function normalizeInline(s: string) {    return s      .replace(/\s+/g, " ")            // ?¬ëŸ¬ ê³µë°± ??1ì¹?      .replace(/\s+([.,!?;:])/g, "$1") // êµ¬ë‘????ê³µë°± ?œê±°      .replace(/([@/])\s+/g, "$1")     // @, / ??ê³µë°± ?œê±°(?´ë©”??URL ë³´í˜¸)      .trim();  }  // ???ë¬¸ ?„ì  ?¨ìˆ˜ (ê°€ë¡??¸ë¡œ ëª¨ë“œ ì§€??  function appendRaw(t: string) {    setRaw(prev => {      const sep = inlineAppend ? " " : "\n";      const next = prev ? prev + sep + t : t;      return inlineAppend ? normalizeInline(next) : next;    });    // ?¤ìŒ ?˜ì¸???´í›„ ?¤í¬ë¡¤ì„ ë§??„ë˜ë¡?    setTimeout(() => {      if (textareaRef.current) textareaRef.current.scrollTop = textareaRef.current.scrollHeight;    }, 0);  }  // [ADD] STT ì½œë°±?ì„œ ?ë¬¸ ?„ì  ë°??¤ì‹œê°??Œì‹±  function onSpeechChunk(text: string) {    if (!text) return;    setRaw(prev => (prev ? prev + " " : "") + text);        // ?¤ì‹œê°??Œì‹±?¼ë¡œ ì¦‰ì‹œ ???…ë°?´íŠ¸ (STT ëª¨ë“ˆ ?„ìš©)    const parsed = parseSignupUtterance(text);    if (Object.keys(parsed).length > 0) {      window.__setSignupFields?.(parsed); // STT ëª¨ë“ˆë§??¬ìš©    }  }  // (? íƒ) ê¸°ì¡´ ?ë¬¸????ë²ˆì— ê°€ë¡œë¡œ ë³€?˜í•˜??ë²„íŠ¼??  function flattenRaw() {    setRaw(prev => normalizeInline(prev.replace(/\s*[\r\n]+\s*/g, " ")));  }  // ?„ì¬ ?œì„± ?¸í’‹???Œì„± ?€?´í•‘??ê°€ë¡œì±„ì§€ ?Šë„ë¡?  const blurActive = () => (document.activeElement as HTMLElement | null)?.blur();    // ë§ˆì´???Šê? ë°©ì? STT ë¸”ë¡  const userStopRef = useRef(false);  const restartTimerRef = useRef<number | null>(null);  const lastStartAtRef = useRef(0);  const MIN_RESTART_INTERVAL = 600; // ms  // ? íš¨??ê²€???¨ìˆ˜??  const isValidEmail = (s: string) => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(s.trim());  const isValidPw = (s: string) => /^(?=.*[A-Za-z])(?=.*\d).{8,}$/.test(s);  const isValidName = (s: string) => s.trim().length >= 2;  const isValidPhone = (s: string) => s.replace(/\D/g, "").length >= 10; // 010 ?¬í•¨ 10~11?ë¦¬  const allValid = isValidName(name) && isValidEmail(email) && isValidPw(password) && isValidPhone(phone);  function applyToSignup() {    if (!allValid) return;        // [ADD] ?œì¶œ ??ë¡œê¹…    const durationMs = Date.now() - sessionStartTime;    logSubmit(true, durationMs);        localStorage.setItem("vibe:preset", JSON.stringify({ name, email, password, phone }));    navigate("/signup?from=nat");  }  // ?¤ì½”?´ëŸ¬/?ìš© ?¨ìˆ˜ ì¶”ê?  function scoreParsed(r: ReturnType<typeof parseSignupFromText>) {    let s = 0;    if (r.email) s += 3;    if (r.phone) s += 2;    if (r.password) s += 2;    if (r.name) s += 1;    return s;  }  function pickBestParse(candidates: string[]) {    // ?„ë³´ë§ˆë‹¤ mixed / strict EN ??ëª¨ë“œë¡?ëª¨ë‘ ?Œì‹± ??ìµœê³ ??ì±„íƒ    let bestText = "", bestParsed: any = null, bestScore = -1;    for (const t of candidates) {      const p1 = parseSignupFromText(t, { emailMode: "mixed",      passwordMode: "mixed",      emailPick: "last" });      const p2 = parseSignupFromText(t, { emailMode: "en_strict",  passwordMode: "en_strict",  emailPick: "first" });      const s1 = scoreParsed(p1);      const s2 = scoreParsed(p2);      const pick = s2 > s1 ? p2 : p1;      const sc   = Math.max(s1, s2);      if (sc > bestScore) { bestScore = sc; bestText = t; bestParsed = pick; }    }    return { text: bestText, parsed: bestParsed };  }  // ?ˆë¡œ???Œì„œ v1.1 ?ìš© (emitFillOnceë¡?ì¤‘ë³µ ë°©ì?)function applyNewParser(raw: string) {  const parsed: Parsed = {};    const email = normalizeEmail(raw) ?? "";  const phone = extractPhone(raw);  const pw = extractPassword(raw);    if (email) parsed.email = email;  if (phone.ok) parsed.phone = phone.value;  if (pw.ok) parsed.password = pw.value;        // STT ëª¨ë“ˆ ?„ìš©: ?¼ë§Œ ?…ë°?´íŠ¸    if (Object.keys(parsed).length > 0) {      window.__setSignupFields?.(parsed);    }    // ê¸°ì¡´ ?íƒœ ?…ë°?´íŠ¸??? ì? (?¸í™˜??  if (email) setEmail(email);  if (phone.ok) setPhone(phone.value);  if (pw.ok) setPassword(pw.value);  setPwStatus(pw.ok ? "ok" : "missing");}async function handleSend(text: string) {  setMessages(prev => [...prev, { role: 'user', text }]);  if (USE_LOCAL_BOT) {    // ?´ë? ì½˜ì†”?©ìœ¼ë¡?ë§Œë“  ?Œì„œê°€ ?ˆìœ¼ë©??¬ì‚¬??    const testName = (window as any).__testName;    const testEmail = (window as any).__testEmail;    const parts: string[] = [];    // ?´ë¦„    const n = testName ? testName(text) : { ok: false };    if (n.ok) { setName(n.value); parts.push(`?´ë¦„=${n.value}`); }    // ?´ë©”??    const e = testEmail ? testEmail(text) : { ok: false };    if (e?.ok) { setEmail(e.value); parts.push(`?´ë©”??${e.value}`); }    // ?„í™”ë²ˆí˜¸    const p = extractPhone(text);    if (p.ok) { setPhone(p.value); parts.push(`?„í™”ë²ˆí˜¸=${p.value}`); }    // ë¹„ë?ë²ˆí˜¸    const pw = extractPassword(text);    if (pw.ok) { setPassword(pw.value); parts.push(`ë¹„ë?ë²ˆí˜¸=?â—?â—`); }        // STT ëª¨ë“ˆ ?„ìš©: ?¼ë§Œ ?…ë°?´íŠ¸    const parsed: Parsed = {};    if (n.ok) parsed.name = n.value;    if (e?.ok) parsed.email = e.value;    if (p.ok) parsed.phone = p.value;    if (pw.ok) parsed.password = pw.value;        if (Object.keys(parsed).length > 0) {      window.__setSignupFields?.(parsed);    }    const reply = parts.length      ? `?ìš©?ˆì–´?? ${parts.join(', ')}`      : `"?´ë¦„?€ ?? ?´ë©”?¼ì? ?? ?„í™”ë²ˆí˜¸???? ë¹„ë?ë²ˆí˜¸???? ?•ì‹?¼ë¡œ ë§ì???ì£¼ì„¸??`;    setMessages(prev => [...prev, { role: 'assistant', text: reply }]);    return;  }  // ???¤ì œ ?œë²„ ëª¨ë“œ???µì…˜ B?ì„œ ?œì„±??  try {    const r = await fetch('/api/chat', {      method: 'POST',      headers: { 'Content-Type': 'application/json' },      body: JSON.stringify({ text }),    });    const data = await r.json();    setMessages(prev => [...prev, { role: 'assistant', text: data.reply }]);  } catch {    setMessages(prev => [...prev, { role: 'assistant', text: '?œë²„ ?‘ë‹µ???†ì–´??' }]);  }}// ?¤íŒ¨ ???¬ë¡¯ë³??¬ì§ˆë¬??¬ì²­ì·? ?ë™??function repromptMissing(r: any) {  const wants: string[] = [];  if (!r.name)     wants.push("?´ë¦„");  if (!r.email)    wants.push("?´ë©”??);  if (!r.phone)    wants.push("?„í™”ë²ˆí˜¸");  if (!r.password) wants.push("ë¹„ë?ë²ˆí˜¸");  if (!wants.length) return;  const msg = wants.join(", ") + "ë¥??¤ì‹œ ??ë²??ë°•?ë°• ë§ì???ì£¼ì„¸?? ?? ?´ë©”?¼ì? jae man ê³¨ë±…??ì§€ë©”ì¼ ??ì»?;  say(msg); // TTS ì¤‘ì¼ ??STT ì°¨ë‹¨?˜ëŠ” say ?¨ìˆ˜ ?¬ìš©}// "?„ë½ ?¬ì§ˆë¬??€ ?˜ë™ ë²„íŠ¼ë§?ë§í•˜ê¸?(?ë™ ? ê??€ ê¸°ë³¸ OFF)function buildReprompt(r: any) {  const wants: string[] = [];  if (!r.name)     wants.push("?´ë¦„");  if (!r.email)    wants.push("?´ë©”??);  if (!r.phone)    wants.push("?„í™”ë²ˆí˜¸");  if (!r.password) wants.push("ë¹„ë?ë²ˆí˜¸");  if (!wants.length) return "";  return `${wants.join(", ")}ë¥??¤ì‹œ ?œë²ˆ ?ë°•?ë°• ë§ì???ì£¼ì„¸?? ?ˆë? ?¤ì–´, ?´ë©”?¼ì? j a e ê³¨ë±…??ì§€ë©”ì¼ ??ì»?`;}function onClickRepromptOnce() {  // ?˜ë™ 1???ˆë‚´ (?£ê¸° ì¤‘ì´ë©??„ê³ , ?ˆë‚´ ???¤ì‹œ ?£ê¸° ì¼?  const r = parseSignupFromText(raw, {    emailMode: enStrict ? "en_strict" : "mixed",    passwordMode: enStrict ? "en_strict" : "mixed",    emailPick: enStrict ? "first" : "last",  });  const msg = buildReprompt(r);  if (msg) say(msg, { resumeListen: true });}  // TTS ?˜í¼ (ë§í•  ???£ì? ?Šê¸°)  function say(text: string, opts: { resumeListen?: boolean } = {}) {    stopListen();                    // ??ë§í•  ???£ê¸° ??    window.speechSynthesis.cancel();    const u = new SpeechSynthesisUtterance(text);    setIsSpeaking(true);    u.onend = () => {      setIsSpeaking(false);      if (opts.resumeListen) setTimeout(() => startListen(), 300);    };    window.speechSynthesis.speak(u);  }  // === ë§ˆì´??ìº¡ì²˜ ?ˆì§ˆ ë³´ê°• ===  // ?¸ì´ì¦??µì œ, ?ì½” ìº”ìŠ¬?ˆì´?? ?ë™ ê²Œì¸ ì»¨íŠ¸ë¡??±ìœ¼ë¡?STT ?¸ì‹ë¥??¥ìƒ    // ?¸ì‹ê¸??ì„±/ì´ˆê¸°???¨ìˆ˜ êµì²´  function newRecognizer(): any {    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;    if (!SR) return null;    const r = new SR();    r.lang = "ko-KR";    r.interimResults = false;   // ?„ì„±ë³¸ë§Œ    r.continuous = true;        // ê¸¸ê²Œ ?£ê¸°    (r as any).maxAlternatives = 5;    return r;  }  function attachHandlers(r: any) {    r.onstart = () => {      sessionStartedAt = Date.now();      setListening(true);      startKeepAlive();    };    r.onresult = (e: any) => {      const texts: string[] = [];      for (let i = e.resultIndex; i < e.results.length; i++) {        texts.push(e.results[i][0].transcript);      }      if (!texts.length) return;      const best = pickBestParse(texts);      appendRaw(best.text);      // [ADD] STT ?„ì  ?ìŠ¤???ë™ ?Œì‹±???„í•œ onSpeechChunk ?¸ì¶œ      onSpeechChunk(best.text);      if (autoParseRef.current) applyNewParser(best.text);  // ???ˆë¡œ???Œì„œ v1.1 ?ìš©      // [ADD]      logStt(best.text, best.parsed, texts.length);    };    r.onend = () => {      setListening(false);      stopKeepAlive();      if (stickyRef.current && !speakRef.current) gracefulRestart("onend");    };    r.onerror = () => {      setListening(false);      stopKeepAlive();      gracefulRestart("onerror");    };    // Safari ?¼ë??ì„œ ë°œìƒ?˜ëŠ” no-match    (r as any).onnomatch = () => {      if (stickyRef.current && !speakRef.current) gracefulRestart("onnomatch");    };  }  // Keep-alive ë°?graceful restart ?¨ìˆ˜??  function startKeepAlive() {    stopKeepAlive();    keepAliveTimer = window.setInterval(() => {      // ?¸ì…˜??55ì´??˜ê¸°ë©?ë¸Œë¼?°ì?ê°€ ê³??Šìœ¼??ë¨¼ì? ?Œì „      if (Date.now() - sessionStartedAt > MAX_SESSION_MS - 500) {        gracefulRestart("keepAlive");      }    }, 3_000);  }  function stopKeepAlive() {    if (keepAliveTimer) { clearInterval(keepAliveTimer); keepAliveTimer = null; }  }  function gracefulRestart(reason: string) {    if (restartLock) return;    restartLock = true;    const delay = Math.min(backoffMs, 5000);    backoffMs = Math.min(backoffMs * 2, 5000);    try { rec?.abort(); } catch {}    rec = newRecognizer();    if (!rec) { restartLock = false; return; }    attachHandlers(rec);    setTimeout(() => {      // ??ìµœì‹  ?íƒœ(ref)ë¡?ê²€??      if (!stickyRef.current || speakRef.current) { restartLock = false; return; }      try { rec!.start(); backoffMs = 400; } finally { restartLock = false; }    }, delay);  }    // ?¸ì‹ê¸?ì´ˆê¸°??& ì½œë°± (?µì‹¬)  function ensureRecognizer() {    if (rec) return rec;    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;    if (!SR) return null;    rec = new SR();    rec.lang = "ko-KR";    rec.interimResults = false;   // ì¤‘ê°„ ê²°ê³¼???„ì ?˜ì? ?ŠìŒ    rec.continuous = true;        // ??êµ¬ê°„ ê¸¸ê²Œ ë°›ì•„???Šê¸°ì§€ ?Šë„ë¡?    (rec as any).maxAlternatives = 5;    rec.onstart = () => {      sessionStartedAt = Date.now();      setListening(true);      startKeepAlive();   // ???¸ì…˜ ê°ì‹œ ?œì‘    };    rec.onresult = (e: any) => {      // 1) ?„ë³´ ?ìŠ¤??ëª¨ë‘ ?˜ì§‘      const texts: string[] = [];      for (let i = e.resultIndex; i < e.results.length; i++) {        texts.push(e.results[i][0].transcript);      }      if (!texts.length) return;      // 2) ê°€?????Œì‹±?˜ëŠ” ?„ë³´ ? íƒ(ê¸°ì¡´ pickBestParse ?¬ìš©)      const best = pickBestParse(texts);      // 3) ???ë¬¸ ?…ë ¥ì°½ì—ë§??„ì  (ê°€ë¡??¸ë¡œ ëª¨ë“œ ì§€??      appendRaw(best.text);          // ??ì¤„ë°”ê¿??€??ê°€ë¡œë¡œ ?´ì–´ë¶™ì„            // [ADD] STT ?„ì  ?ìŠ¤???ë™ ?Œì‹±???„í•œ onSpeechChunk ?¸ì¶œ      onSpeechChunk(best.text);      // 4) ?ë™ ?Œì‹±??ì¼œì ¸ ?ˆì„ ?Œë§Œ ?„ë“œ??ì±„ì? (ê¸°ë³¸?€ êº¼ì§)      if (autoParseRef.current) {        // ?ˆë¡œ???Œì„œ v1.1 ?ìš©        applyNewParser(best.text);                // ?„ë½ ?¬ë¡¯???ˆê³  autoRepromptê°€ ì¼œì ¸ ?ˆìœ¼ë©? TTSë¡?1???ˆë‚´ ??ì¢…ë£Œ ???¬ì²­ì·?        if (autoReprompt) {          const msg = buildReprompt(best.parsed);          if (msg) say(msg, { resumeListen: true }); // TTS ?ë‚˜ë©??¤ì‹œ ?£ê¸°        }      }      // [ADD]      logStt(best.text, best.parsed, texts.length);    };    // ë§ˆì´?¬ê? ?¤ìŠ¤ë¡?ì¢…ë£Œ?˜ì—ˆ????ì¹¨ë¬µ ?? sticky ëª¨ë“œë©??ë™ ?¬ì‹œ??    rec.onend = () => {      setListening(false);      stopKeepAlive();      // ?¬ìš©???˜ë„(stopListen)ë¡???ê²??„ë‹ˆê³?sticky?¼ë©´ ?¬ì‹œ??      if (stickyListen && !isSpeaking) gracefulRestart("onend");    };    // ?ëŸ¬ ì¼€?´ìŠ¤??stickyë©??¬ì‹œ??    rec.onerror = (ev: any) => {      setListening(false);      stopKeepAlive();      // ?¤íŠ¸?Œí¬/ë¬´ìŒ/?¤ë””???¤ë¥˜ ëª¨ë‘ ?Œë³µ ?œë„      gracefulRestart(`onerror:${ev?.error || "unknown"}`);    };    // Safari ?¼ë??ì„œ ë°œìƒ?˜ëŠ” no-match    (rec as any).onnomatch = () => {      if (stickyListen && !isSpeaking) gracefulRestart("onnomatch");    };    return rec;  }function startListen() {  if (speakRef.current) return;  blurActive();  setStickyListen(true);          // ??state ?…ë°?´íŠ¸ë¡œë§Œ ?œì–´  const r = ensureRecognizer();  if (!r) return;  try { r.start(); } catch {}}function stopListen() {  setStickyListen(false);         // ??state ?…ë°?´íŠ¸  stopKeepAlive();  try { rec?.abort(); } catch {}  setListening(false);}  // ë§ˆì´??ìº¡ì²˜ ?ˆì§ˆ(?¸ì´ì¦??µì œ) ë³´ê°•  async function getEnhancedAudioStream() {    try {      const stream = await navigator.mediaDevices.getUserMedia({        audio: {          channelCount: 1,              // ëª¨ë…¸ ì±„ë„ (?¤í…Œ?ˆì˜¤ ë¶ˆí•„??          sampleRate: 48000,            // ê³ í’ˆì§??˜í”Œë§?          noiseSuppression: true,       // ?¸ì´ì¦??µì œ ?œì„±??          echoCancellation: true,       // ?ì½” ìº”ìŠ¬?ˆì´???œì„±??          autoGainControl: true,        // ?ë™ ê²Œì¸ ì»¨íŠ¸ë¡?          // Chrome ?„ìš© ê³ ê¸‰ ?¤ì • (?€???ˆì „?±ì„ ?„í•´ anyë¡?ìºìŠ¤??          ...(navigator.userAgent.includes('Chrome') ? {            googEchoCancellation: true,   // Chrome ?„ìš© ?ì½” ìº”ìŠ¬?ˆì´??            googAutoGainControl: true,    // Chrome ?„ìš© ?ë™ ê²Œì¸            googNoiseSuppression: true,   // Chrome ?„ìš© ?¸ì´ì¦??µì œ            googHighpassFilter: true,     // Chrome ?„ìš© ê³ ì—­ ?µê³¼ ?„í„°          } as any : {})        }      });      return stream;    } catch (error) {      console.warn("Enhanced audio settings failed, falling back to basic:", error);      // ê¶Œì¥ ê¸°ë³¸ ?¤ì •?¼ë¡œ ?´ë°±      return await navigator.mediaDevices.getUserMedia({        audio: {          channelCount: 1,          sampleRate: 48000,          noiseSuppression: true,          echoCancellation: true,          autoGainControl: true,        }      });    }  }  // ê¸°ì¡´ ensureRec ?¨ìˆ˜???œê±°?˜ê³  ?ˆë¡œ??ë¡œì§?¼ë¡œ êµì²´  function startListening() {    if (isSpeaking) return; // TTS ì¤‘ì—” STT ê¸ˆì?        const rec = ensureRecognizer();    if (!rec) return alert("??ë¸Œë¼?°ì????Œì„± ?¸ì‹??ì§€?í•˜ì§€ ?ŠìŠµ?ˆë‹¤.");    userStopRef.current = false;                  rec.onresult = (e: any) => {                // ?„ë³´ ?„ë? ?‰ê??´ì„œ ê°€?????Œì‹±?˜ëŠ” ë¬¸ì¥??ì±„íƒ                const alts: string[] = [];                for (let i = 0; i < e.results[0].length; i++) {                  alts.push(e.results[0][i].transcript);              }                // ?„ë³´ + ê¸°ì¡´ ?„ì (raw)???€???Œì‹± ?¤ì½”?´ë§                const best = pickBestParse(alts);                // best.text: ì±„íƒ ë¬¸ì¥, best.parsed: parse ê²°ê³¼                applyNewParser(best.text); // ???ˆë¡œ???Œì„œ v1.1 ?ìš©                // ì±„íƒ??ë¬¸ì¥??raw??ì¶”ê? (ì¤„ë°”ê¿ˆìœ¼ë¡?êµ¬ë¶„)                appendRaw(best.text.trim());                                // [ADD] STT ?„ì  ?ìŠ¤???ë™ ?Œì‹±???„í•œ onSpeechChunk ?¸ì¶œ                onSpeechChunk(best.text.trim());                                // ?¤íŒ¨???„ë“œê°€ ?ˆìœ¼ë©??ë™ ?¬ì§ˆë¬?                repromptMissing(best.parsed);                // [ADD]                logStt(best.text, best.parsed, alts.length);              };    rec.onerror = () => {      setListening(false);      // ?ëŸ¬?¼ë„ ?¬ìš©?ê? ë©ˆì¶”ì§€ ?Šì•˜?¤ë©´ ?¬ì‹œ??      if (!userStopRef.current) scheduleRestart();    };    rec.onend = () => {      setListening(false);      if (!userStopRef.current) scheduleRestart();    };    try {      const now = Date.now();      if (now - lastStartAtRef.current < MIN_RESTART_INTERVAL) return; // ?ˆë¬´ ë¹ ë¥¸ ?¬ì‹œ??ë°©ì?      rec.start();      lastStartAtRef.current = now;      setListening(true);    } catch (e) {      // InvalidStateError ??ë¬´ì‹œ    }  }  function scheduleRestart() {    if (restartTimerRef.current) window.clearTimeout(restartTimerRef.current);    restartTimerRef.current = window.setTimeout(() => {      if (!userStopRef.current) startListening();    }, 250); // ?½ê°„??ì§€?????¬ì‹œ??  }  function stopListening() {    userStopRef.current = true;    if (restartTimerRef.current) {      window.clearTimeout(restartTimerRef.current);      restartTimerRef.current = null;    }    try {      recRef.current?.stop();      recRef.current?.abort();    } catch {}    setListening(false);  }  // ì»´í¬?ŒíŠ¸ ?¸ë§ˆ?´íŠ¸ ???•ë¦¬  React.useEffect(() => {    return () => {      userStopRef.current = true;      if (restartTimerRef.current) {        window.clearTimeout(restartTimerRef.current);      }      try {        recRef.current?.stop();        recRef.current?.abort();      } catch {}    };  }, []);  // "?Œì‹±?˜ê¸°"???ë¬¸ ???˜ë™ ?Œì‹±?¼ë¡œë§??™ì‘  const onParse = () => {    const text = (document.getElementById("rawInput") as HTMLTextAreaElement)?.value.trim() ?? "";    if (!text) return alert("?ë¬¸??ë¹„ì—ˆ?µë‹ˆ??");    const parsed = parseSignupUtterance(text) || {};    console.log("[parsed]", parsed);    fillForm(parsed);  };  const pwv = { ok: isValidPw(password), msg: isValidPw(password) ? "??ê·œì¹™ ì¶©ì¡±" : "?¹ï¸ 8???´ìƒ, ë¬¸ì+?«ì ?¬í•¨" };  return (    <div style={{maxWidth: 860, margin: "24px auto", padding: 16}}>      <h2 style={{marginTop:0}}>Natural Signup Lab</h2>      <p style={{opacity:.8, marginTop:8}}>        ??ë²ˆì— ë§í•˜?¸ìš”: ?œì????´ì¬ë§Œì´ê³??´ë©”?¼ì? {`id ê³¨ë±…???„ë©”????com`} ë¹„ë?ë²ˆí˜¸??<i>OO</i> ?…ë‹ˆ?? ?„í™”??010?¦â€?      </p>      {/* ê¸°ë³¸ ?¡ì…˜ ë²„íŠ¼??*/}      <div style={{display:"flex", gap:8, marginTop:12}}>        <button onClick={() => setRaw("")}>?…ë ¥ ì§€?°ê¸°</button>        <button type="button" onClick={onParse}>?” ?Œì‹±?˜ê¸°</button>        <button          disabled={!allValid}          onClick={applyToSignup}        >          /signup???ìš©        </button>                <label style={{display:"inline-flex", gap:8, alignItems:"center", marginLeft:8}}>          <input type="checkbox" checked={userConsented} onChange={e=>setUserConsented(e.target.checked)} />          ?Œì„± ?ˆì§ˆ ê°œì„ ???™ì˜(?µëª… ë¡œê·¸)        </label>      </div>                  {/* UI ? ê?/ë²„íŠ¼(ê¶Œì¥ ?ˆì´?„ì›ƒ) */}            <label style={{display:"inline-flex",gap:8,alignItems:"center"}}>              <input type="checkbox" checked={enStrict} onChange={e=>setEnStrict(e.target.checked)} />              ?ë¬¸ ?„ì£¼(Strict EN)            </label>            <label style={{display:"inline-flex",gap:8,alignItems:"center",marginLeft:12}}>              <input type="checkbox" checked={autoReprompt} onChange={e=>setAutoReprompt(e.target.checked)} />              ?ë™ ?¬ì§ˆë¬??ë°•?ë°• ?ˆë‚´)            </label>            <label style={{display:"inline-flex",gap:8,alignItems:"center",marginLeft:12}}>              <input                type="checkbox"                checked={autoContinue}                onChange={e=>setAutoContinue(e.target.checked)}              />              ?ë™ ?´ì–´?£ê¸°(êµ¬ê°„ë§ˆë‹¤ ?ë¬¸ ?„ì )            </label>            <label style={{display:"inline-flex",gap:8,alignItems:"center",marginLeft:12}}>              <input                type="checkbox"                checked={inlineAppend}                onChange={e => {                  setInlineAppend(e.target.checked);                  if (e.target.checked) flattenRaw();    // ê°€ë¡?ëª¨ë“œ ì¼œì§ˆ ??ê¸°ì¡´ ?´ìš©????ì¤„ë¡œ ?•ë¦¬                }}              />              ?ë¬¸ ê°€ë¡??´ì–´?°ê¸°            </label>            <button onClick={flattenRaw} style={{ marginLeft: 8 }}>              ?„ì¬ ?ë¬¸ ê°€ë¡œë¡œ ?•ë¦¬            </button>            {/* ë¹„ë?ë²ˆí˜¸ ?•ë ¬ ? ê? */}            <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginLeft:12}}>              <span>ë¹„ë?ë²ˆí˜¸ ?•ë ¬:</span>              <label><input type="radio" checked={pwOrder==="as_spoken"} onChange={()=>setPwOrder("as_spoken")} /> ë§í•œ ?œì„œ</label>              <label><input type="radio" checked={pwOrder==="letters_first"} onChange={()=>setPwOrder("letters_first")} /> ?ë¬¸ ë¨¼ì?</label>              <label><input type="radio" checked={pwOrder==="digits_first"} onChange={()=>setPwOrder("digits_first")} /> ?«ì ë¨¼ì?</label>            </div>            <label style={{display:"inline-flex",gap:8,alignItems:"center"}}>              <input type="checkbox" checked={autoParse} onChange={e=>setAutoParse(e.target.checked)} />              ?£ëŠ” ?™ì•ˆ ?ë™?¼ë¡œ ?„ë“œ ì±„ìš°ê¸?            </label>            <label style={{display:"inline-flex",gap:8,alignItems:"center",marginLeft:12}}>              <input type="checkbox" checked={stickyListen} onChange={e=>setStickyListen(e.target.checked)} />              ?Šê? ë°©ì?(?ë™ ?¬ì‹œ??            </label>            <button onClick={startListen}>?£ê¸° ?œì‘</button>            <button onClick={stopListen}>?£ê¸° ì¢…ë£Œ</button>            <button type="button" onClick={onParse}>?” ?Œì‹±?˜ê¸°</button>            <button onClick={onClickRepromptOnce}>?„ë½????ª© ?¬ì§ˆë¬?1??</button>                      <div style={{marginTop:12}}>                  <label style={{display:"block", marginBottom:6}}>?ë¬¸ ?…ë ¥(?Œì„± ?¸ì‹ ?„ì /ì§ì ‘ ?…ë ¥ ê°€??</label>                  <textarea                    id="rawInput"                    ref={textareaRef}                    value={raw}                    onChange={(e) => setRaw(e.target.value)}                    rows={6}                    wrap="soft"                    style={{                      width: "100%",                      whiteSpace: "pre-wrap",                      overflowWrap: "anywhere",                      wordBreak: "break-word",                      overflowX: "hidden",                      overflowY: "auto",                    }}                    placeholder="?¬ê¸°???¸ì‹??ë¬¸ì¥?¤ì´ ?„ì ?©ë‹ˆ??.."                  />                </div>            {/* ?„ì„±???œì‹œ */}      <div style={{marginTop:16, padding: "12px", backgroundColor: "#f8f9fa", borderRadius: "8px", border: "1px solid #e9ecef"}}>        <h4 style={{margin: "0 0 8px 0", fontSize: "14px"}}>?“Š ?„ì„±??/h4>        <div style={{display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: "8px"}}>          {(() => {            const done = {              name: isNonEmpty(name),              email: isEmail(email),              phone: isPhone(phone),              password: isNonEmpty(password),            };                        return (              <>                <div style={{textAlign: "center", padding: "8px", backgroundColor: done.name ? "#d4edda" : "#f8d7da", borderRadius: "4px"}}>                  <div style={{fontSize: "12px", fontWeight: "bold"}}>?´ë¦„</div>                  <div style={{fontSize: "10px"}}>{done.name ? "???„ì„±" : "???„ë½"}</div>                </div>                <div style={{textAlign: "center", padding: "8px", backgroundColor: done.email ? "#d4edda" : "#f8d7da", borderRadius: "4px"}}>                  <div style={{fontSize: "12px", fontWeight: "bold"}}>?´ë©”??/div>                  <div style={{fontSize: "10px"}}>{done.email ? "???„ì„±" : "???„ë½"}</div>                </div>                <div style={{textAlign: "center", padding: "8px", backgroundColor: done.phone ? "#d4edda" : "#f8d7da", borderRadius: "4px"}}>                  <div style={{fontSize: "12px", fontWeight: "bold"}}>?„í™”ë²ˆí˜¸</div>                  <div style={{fontSize: "10px"}}>{done.phone ? "???„ì„±" : "???„ë½"}</div>                </div>                <div style={{textAlign: "center", padding: "8px", backgroundColor: done.password ? "#d4edda" : "#f8d7da", borderRadius: "4px"}}>                  <div style={{fontSize: "12px", fontWeight: "bold"}}>ë¹„ë?ë²ˆí˜¸</div>                  <div style={{fontSize: "10px"}}>{done.password ? "???„ì„±" : "???„ë½"}</div>                </div>              </>            );          })()}        </div>                {/* ???„ì„±??ê³„ì‚°??ê°??ì²´ë¡?*/}        {(() => {          const done = {            name: isNonEmpty(name),            email: isEmail(email),            phone: isPhone(phone),            password: isNonEmpty(password),          };          const totalCompleted = Object.values(done).filter(Boolean).length;          const totalFields = Object.keys(done).length;                    return (            <div style={{marginTop: "8px", fontSize: "12px", color: "#6c757d"}}>              ?’¡ ?„ì„±?? {totalCompleted}/{totalFields} ({Math.round(totalCompleted/totalFields*100)}%)              {totalCompleted < totalFields && (                <span> - "?„ë½????ª© ?¬ì§ˆë¬? ë²„íŠ¼???´ë¦­?˜ê±°???Œì„±?¼ë¡œ ?¤ì‹œ ë§ì???ì£¼ì„¸??</span>              )}            </div>          );        })()}      </div>      <form onSubmit={handleSubmit} style={{display:"grid", gap:8, marginTop:16}}>        <div>          <label style={{display:"block", marginBottom:6}}>            ?´ë¦„ {!name && <span style={{color: "#ff6b6b", fontSize: "12px"}}>? ï¸ ?„ë½??/span>}          </label>          <input             id="name"            type="text"            value={name ?? ""}             onChange={(e) => {              touchedRef.current.name = true;              setName(e.target.value);            }}            style={{              width:"100%",               padding:8,               border: name ? "1px solid #ccc" : "2px solid #ff6b6b",               borderRadius:4,              backgroundColor: name ? "white" : "#fff5f5"            }}            placeholder="?´ë¦„???…ë ¥?˜ì„¸??            autoComplete="name"            required          />        </div>        <div>          <label style={{display:"block", marginBottom:6}}>            ?´ë©”??{!email && <span style={{color: "#ff6b6b", fontSize: "12px"}}>? ï¸ ?„ë½??/span>}          </label>          <input             id="email"            type="email"            value={email ?? ""}             onChange={(e) => {              touchedRef.current.email = true;              setEmail(e.target.value);            }}            style={{              width:"100%",               padding:8,               border: email ? "1px solid #ccc" : "2px solid #ff6b6b",               borderRadius:4,              backgroundColor: email ? "white" : "#fff5f5"            }}            placeholder="?´ë©”?¼ì„ ?…ë ¥?˜ì„¸??            autoComplete="username"            required          />        </div>        <div>          <label style={{display:"block", marginBottom:6}}>            ?„í™”ë²ˆí˜¸ {!phone && <span style={{color: "#ff6b6b", fontSize: "12px"}}>? ï¸ ?„ë½??/span>}          </label>          <input             type="tel"            value={phone ?? ""}             onChange={(e) => setPhone(e.target.value)}             style={{              width:"100%",               padding:8,               border: phone ? "1px solid #ccc" : "2px solid #ff6b6b",               borderRadius:4,              backgroundColor: phone ? "white" : "#fff5f5"            }}            placeholder="?„í™”ë²ˆí˜¸ë¥??…ë ¥?˜ì„¸??            autoComplete="tel"            required          />        </div>        <div>          <label style={{display:"block", marginBottom:6}}>            ë¹„ë?ë²ˆí˜¸ {!password && <span style={{color: "#ff6b6b", fontSize: "12px"}}>? ï¸ ?„ë½??/span>}          </label>          <input             type="password"            value={password ?? ""}             onChange={(e) => setPassword(e.target.value)}             style={{              width:"100%",               padding:8,               border: password ? "1px solid #ccc" : "2px solid #ff6b6b",               borderRadius:4,              backgroundColor: password ? "white" : "#fff5f5"            }}            placeholder="ë¹„ë?ë²ˆí˜¸ë¥??…ë ¥?˜ì„¸??            autoComplete="new-password"            required          />          <div style={{fontSize:12, opacity:.8, marginTop:4}}>            {pwStatus === "ok" && <span style={{color: "#28a745"}}>??ê°•í•¨</span>}            {pwStatus === "weak" && <span style={{color: "#ffc107"}}>? ï¸ ?½í•¨ (8???´ìƒ ê¶Œì¥)</span>}            {pwStatus === "missing" && <span style={{color: "#6c757d"}}>?¹ï¸ ?…ë ¥ ?„ìš”</span>}          </div>        </div>                {/* ?Œì›ê°€???œì¶œ ë²„íŠ¼ */}        <div style={{marginTop: "16px"}}>          <button             type="submit"             disabled={submitting || !name || !email || !phone || !password}            style={{              width: "100%",              padding: "12px 24px",              fontSize: "16px",              fontWeight: "bold",              backgroundColor: submitting || !name || !email || !phone || !password ? "#6c757d" : "#007bff",              color: "white",              border: "none",              borderRadius: "8px",              cursor: submitting || !name || !email || !phone || !password ? "not-allowed" : "pointer"            }}          >            {submitting ? "ê°€??ì¤?.." : "ê°€?…í•˜ê¸?}          </button>        </div>      </form>      <hr style={{margin:"16px 0", opacity:.2}}/>      <div style={{fontSize:12, opacity:.75}}>        ???°ëª¨ ?Œì„œ??ê·œì¹™ ê¸°ë°˜ ê°„ì†Œ??ë²„ì „?…ë‹ˆ?? ?•í™•?„ë? ?¬ë¦¬?¤ë©´ ê¸°ì¡´ ëª¨ë“ˆ(?? speechEmail, nluParser)ê³??¨ê³„ë³??Œì´?„ë¼?¸ì„ ?°ê²°?˜ì„¸??        {FLAGS.CHAT ? (          <span style={{color: "#28a745"}}> ?’¬ ì±„íŒ… ê¸°ëŠ¥: ON</span>        ) : (          <span style={{color: "#6c757d"}}> ?’¬ ì±„íŒ… ê¸°ëŠ¥: OFF</span>        )}      </div>      {/* [ADD] ChatDock ì»´í¬?ŒíŠ¸ */}      {FLAGS.CHAT && (        <ChatDock          missing={missing}          pwStatus={pwStatus}          onAsk={(text) => setRaw(prev => (prev ? prev + " " : "") + text)}        />      )}      {/* [ADD] ?…ë¦½?ì¸ ì±„íŒ… UI - STT?€ ?„ì „ ë¶„ë¦¬ */}      {FLAGS.CHAT && (        <div style={{marginTop: "16px", padding: "16px", backgroundColor: "#f8f9fa", borderRadius: "8px", border: "1px solid #e9ecef"}}>          <h4 style={{margin: "0 0 16px 0", fontSize: "16px"}}>?’¬ ?…ë¦½ ì±„íŒ…</h4>          <div style={{fontSize: "14px", color: "#6c757d"}}>            ì±„íŒ… ê¸°ëŠ¥???œì„±?”ë˜???ˆìŠµ?ˆë‹¤.            <br />            STT?€ ?„ì „??ë¶„ë¦¬?˜ì–´ ?…ë¦½?ìœ¼ë¡??™ì‘?©ë‹ˆ??          </div>        </div>      )}      {/* ë¡œì»¬ ì±—ë´‡ ?ŒìŠ¤??UI */}      {FLAGS.CHAT && (        <>          <hr style={{margin:"24px 0", opacity:.2}}/>          <div style={{marginTop:24, padding: "16px", backgroundColor: "#f8f9fa", borderRadius: "8px", border: "1px solid #e9ecef"}}>            <h4 style={{margin: "0 0 16px 0", fontSize: "16px"}}>?¤– ë¡œì»¬ ì±—ë´‡ ?ŒìŠ¤??/h4>            <div style={{marginBottom: "16px", fontSize: "14px", opacity: 0.8}}>              USE_LOCAL_BOT: {USE_LOCAL_BOT ? "??ON (ë¡œì»¬ ê·œì¹™)" : "??OFF (?œë²„ ?°ê²°)"}            </div>                        {/* ë©”ì‹œì§€ ëª©ë¡ */}            <div style={{marginBottom: "16px", maxHeight: "200px", overflowY: "auto", border: "1px solid #dee2e6", borderRadius: "4px", padding: "8px", backgroundColor: "white"}}>              {messages.length === 0 ? (                <div style={{textAlign: "center", color: "#6c757d", fontSize: "14px", padding: "20px"}}>                  ë©”ì‹œì§€ê°€ ?†ìŠµ?ˆë‹¤. ?„ë˜ ?…ë ¥ì°½ì— ?ŒìŠ¤?¸í•´ë³´ì„¸??                </div>              ) : (                messages.map((msg, idx) => (                  <div key={idx} style={{                    marginBottom: "8px",                    padding: "8px 12px",                    borderRadius: "8px",                    backgroundColor: msg.role === 'user' ? "#007bff" : "#e9ecef",                    color: msg.role === 'user' ? "white" : "black",                    alignSelf: msg.role === 'user' ? "flex-end" : "flex-start",                    maxWidth: "80%",                    marginLeft: msg.role === 'user' ? "auto" : "0"                  }}>                    <div style={{fontSize: "12px", opacity: 0.8, marginBottom: "4px"}}>                      {msg.role === 'user' ? '?¬ìš©?? : 'ì±—ë´‡'}                    </div>                    <div>{msg.text}</div>                  </div>                ))              )}            </div>            {/* ë©”ì‹œì§€ ?…ë ¥ */}            <div style={{display: "flex", gap: "8px"}}>              <input                type="text"                value={localMsg}                onChange={(e) => setLocalMsg(e.target.value)}                placeholder="?? ?´ë¦„?€ ?´ì¬ë§Œì´ê³??´ë©”?¼ì? jae@gmail.com?…ë‹ˆ??                style={{                  flex: 1,                  padding: "8px 12px",                  border: "1px solid #ced4da",                  borderRadius: "4px",                  fontSize: "14px"                }}                onKeyPress={(e) => {                  if (e.key === 'Enter') {                    onLocalSend();                  }                }}              />              <button                onClick={onLocalSend}                style={{                  padding: "8px 16px",                  backgroundColor: "#007bff",                  color: "white",                  border: "none",                  borderRadius: "4px",                  cursor: "pointer"                }}              >                ?„ì†¡              </button>            </div>            <div style={{marginTop: "12px", fontSize: "12px", color: "#6c757d"}}>              ?’¡ ?ŒìŠ¤???ˆì‹œ: "?´ë¦„?€ ê¹€ì² ìˆ˜?´ê³  ?´ë©”?¼ì? kim@naver.com ?„í™”ë²ˆí˜¸??010-1234-5678 ë¹„ë?ë²ˆí˜¸??password123?…ë‹ˆ??            </div>          </div>        </>      )}    </div>  );}export default NaturalSignupLab;
