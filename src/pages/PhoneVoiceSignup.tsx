import React, { useCallback, useState, useEffect, useRef } from 'react';import { useNavigate } from 'react-router-dom';import { finishSignup } from '../features/auth/phoneService';import { extractPhoneKO } from '../features/voice/phoneParser';import { auth, db } from '@/lib/firebase';import { getUid } from '@/lib/auth';import { usePttStt } from '@/hooks/usePttStt';import { sendSms, verifySmsCode, toE164KR } from '../lib/sms';import { doc, setDoc, serverTimestamp } from 'firebase/firestore';import { updateProfile } from 'firebase/auth';import { PhoneAuthProvider, signInWithCredential } from 'firebase/auth';import { RecaptchaVerifier } from 'firebase/auth';type Step = 'phone' | 'code' | 'name';// ê°„ë‹¨???„í™”ë²ˆí˜¸ ? íš¨??ê²€??function isValidPhone(phone: string): boolean {  const digits = phone.replace(/[^\d]/g, '');  return digits.length >= 10 && digits.startsWith('010');}const PhoneVoiceSignup = () => {  const nav = useNavigate();  const [step, setStep] = useState<Step>('phone');  const [phone, setPhone] = useState('');  const [code, setCode] = useState('');  const [name, setName] = useState('');  const [err, setErr] = useState('');  const [busy, setBusy] = useState(false);  const confirmRef = React.useRef<any>(null);  // ?Œì„± ?¸ì‹ ê²°ê³¼ ì²˜ë¦¬  const onPhoneResult = useCallback((txt: string) => {    // ?œê? ?«ì ???«ìë§?ì¶”ì¶œ ??010-XXXX-XXXX ?¬ë§·    const { formatted } = extractPhoneKO(txt);    if (formatted) setPhone(formatted);  }, []);  const onCodeResult = useCallback((txt: string) => {    const digits = txt.replace(/[^\d]/g, '').slice(0, 6);    if (digits) setCode(digits);  }, []);  const onNameResult = useCallback((txt: string) => {    const nameText = txt.trim();    if (nameText.length >= 2) setName(nameText);  }, []);  // ?„ì¬ ?¨ê³„???°ë¥¸ ê²°ê³¼ ì½œë°±  const getCurrentResultCallback = useCallback(() => {    switch (step) {      case 'phone': return onPhoneResult;      case 'code': return onCodeResult;      case 'name': return onNameResult;      default: return onPhoneResult;    }  }, [step, onPhoneResult, onCodeResult, onNameResult]);  // PTT STT ???¬ìš©  const { ok: sttSupport, listening: isListening, partial, finalText, handlers } = usePttStt("ko-KR", (text) => {    const callback = getCurrentResultCallback();    callback(text);  });  // ?¸ì¦ ë¬¸ì ?”ì²­  async function requestCode(e?: React.FormEvent) {    e?.preventDefault();    setErr('');        try {      const e164 = toE164KR(phone);      if (!e164 || !/^\+\d{8,15}$/.test(e164)) {        setErr('?„í™”ë²ˆí˜¸ ?•ì‹???•ì¸??ì£¼ì„¸??');        return;      }            setBusy(true);      const confirmation = await sendSms(auth, phone);      confirmRef.current = confirmation;      setStep('code');    } catch (e: any) {      console.error('[CODE] request error:', e);      setErr('?¸ì¦ ë¬¸ì ?„ì†¡ ?¤íŒ¨: ' + (e?.message || '?????†ëŠ” ?¤ë¥˜'));    } finally {      setBusy(false);    }  }  // ?¸ì¦ë²ˆí˜¸ ?•ì¸  async function verifyCode(e?: React.FormEvent) {    e?.preventDefault();    setErr('');        try {      if (!code || code.length !== 6) {        setErr('6?ë¦¬ ì½”ë“œë¥??…ë ¥??ì£¼ì„¸??');        return;      }            if (!confirmRef.current) {        setErr('?¸ì¦ ?•ë³´ê°€ ?†ìŠµ?ˆë‹¤. ì²˜ìŒë¶€???¤ì‹œ ?œë„?´ì£¼?¸ìš”.');        return;      }            setBusy(true);      await verifySmsCode(confirmRef.current, code);      setStep('name');    } catch (e: any) {      console.error('[CODE] verify error:', e);      setErr('?¸ì¦ë²ˆí˜¸ê°€ ?¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤. ?¤ì‹œ ?•ì¸?´ì£¼?¸ìš”.');    } finally {      setBusy(false);    }  }  // ê°€???„ë£Œ  async function finish(e?: React.FormEvent) {    e?.preventDefault();    setErr('');        try {      if (!name || name.trim().length < 2) {        setErr('?´ë¦„??2???´ìƒ ?…ë ¥??ì£¼ì„¸??');        return;      }            setBusy(true);      const user = auth.currentUser;      if (!user) {        setErr('?¬ìš©???•ë³´ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„?´ì£¼?¸ìš”.');        return;      }            await finishSignup(user, name.trim());      nav('/home');    } catch (e: any) {      console.error('[PROFILE] save error:', e);      setErr('?„ë¡œ???€?¥ì— ?¤íŒ¨?ˆìŠµ?ˆë‹¤: ' + (e?.message || '?????†ëŠ” ?¤ë¥˜'));    } finally {      setBusy(false);    }  }  async function saveProfile() {    try {      if (!name.trim()) {        setErr('?´ë¦„???…ë ¥?´ì£¼?¸ìš”.');        return;      }            setBusy(true);      const uid = getUid();      if (!uid) {        setErr('?¬ìš©???•ë³´ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„?´ì£¼?¸ìš”.');        return;      }            await finishSignup({ uid } as any, name.trim());      nav('/home');    } catch (e: any) {      console.error('[PROFILE] save error:', e);      setErr('?„ë¡œ???€?¥ì— ?¤íŒ¨?ˆìŠµ?ˆë‹¤: ' + (e?.message || '?????†ëŠ” ?¤ë¥˜'));    } finally {      setBusy(false);    }  }  return (    <div style={{ maxWidth: 480, margin: '40px auto', padding: 16 }}>      <h2>?“± ?„í™”ë²ˆí˜¸ + ?™ï¸??Œì„± ë³´ì¡° ê°€??/h2>      {/* ?¨ê³„ë³??…ë ¥ ??*/}      {step === 'phone' && (        <form onSubmit={requestCode} style={{ display: 'grid', gap: 16 }}>          <div>            <label style={{ display: 'block', marginBottom: 8, fontWeight: 600 }}>              ?„í™”ë²ˆí˜¸            </label>            <input              value={phone}              onChange={e => setPhone(e.target.value)}              placeholder="010-1234-5678"              style={{                width: '100%',                padding: '12px',                border: '1px solid #ddd',                borderRadius: 8,                fontSize: 16              }}            />          </div>          {/* ?Œì„± ?…ë ¥ ë²„íŠ¼ */}          <button            type="button"            disabled={!sttSupport.ok}            onPointerDown={() => startSTT()}            onPointerUp={() => stopSTT()}            onPointerCancel={() => stopSTT()}            onPointerLeave={() => stopSTT()}            style={{              padding: '16px',              borderRadius: 8,              border: 'none',              background: sttSupport.ok ? '#2563eb' : '#ccc',              color: 'white',              fontSize: 16,              fontWeight: 600,              cursor: sttSupport.ok ? 'pointer' : 'not-allowed',              opacity: sttSupport.ok ? 1 : 0.6            }}          >            {sttSupport.ok ? '?¤ ê¸¸ê²Œ ?ŒëŸ¬ ë§í•˜ê¸? : '?¤ ?Œì„± ?¸ì‹ ë¯¸ì???}          </button>          {/* ë¸Œë¼?°ì? ë¯¸ì????ˆë‚´ */}          {!sttSupport && (            <div style={{              padding: '12px',              background: '#fef3c7',              border: '1px solid #f59e0b',              borderRadius: 6,              color: '#92400e',              textAlign: 'center'            }}>              ??ë¸Œë¼?°ì???Web Speech(?Œì„± ?¸ì‹)ë¥??œê³µ?˜ì? ?ŠìŠµ?ˆë‹¤. ?¤ë³´?œë¡œ ?…ë ¥??ì£¼ì„¸??            </div>          )}          {/* ?Œì„± ?¸ì‹ ?ëŸ¬ */}          {false && (            <div style={{              padding: '12px',              background: '#fef2f2',              border: '1px solid #fecaca',              borderRadius: 6,              color: '#dc2626',              textAlign: 'center'            }}>            </div>          )}          <button            type="submit"            disabled={busy || !isValidPhone(phone)}            style={{              padding: '16px',              borderRadius: 8,              border: 'none',              background: isValidPhone(phone) ? '#10b981' : '#ccc',              color: 'white',              fontSize: 16,              fontWeight: 600,              cursor: isValidPhone(phone) ? 'pointer' : 'not-allowed'            }}          >            {busy ? '?„ì†¡ ì¤‘â€? : '?¸ì¦ ë¬¸ì ë°›ê¸°'}          </button>        </form>      )}      {step === 'code' && (        <form onSubmit={verifyCode} style={{ display: 'grid', gap: 16 }}>          <div>            <label style={{ display: 'block', marginBottom: 8, fontWeight: 600 }}>              ?¸ì¦ë²ˆí˜¸ 6?ë¦¬            </label>            <input              value={code}              onChange={e => setCode(e.target.value.replace(/[^\d]/g, '').slice(0, 6))}              placeholder="123456"              inputMode="numeric"              maxLength={6}              style={{                width: '100%',                padding: '12px',                border: '1px solid #ddd',                borderRadius: 8,                fontSize: 16,                textAlign: 'center',                letterSpacing: 4              }}            />          </div>          {/* ?Œì„± ?…ë ¥ ë²„íŠ¼ */}          <button            type="button"            disabled={!sttSupport.ok}            onPointerDown={() => startSTT()}            onPointerUp={() => stopSTT()}            onPointerCancel={() => stopSTT()}            onPointerLeave={() => stopSTT()}            style={{              padding: '16px',              borderRadius: 8,              border: 'none',              background: sttSupport.ok ? '#2563eb' : '#ccc',              color: 'white',              fontSize: 16,              fontWeight: 600,              cursor: sttSupport.ok ? 'pointer' : 'not-allowed',              opacity: sttSupport.ok ? 1 : 0.6            }}          >            {sttSupport.ok ? '?¤ ê¸¸ê²Œ ?ŒëŸ¬ ë§í•˜ê¸? : '?¤ ?Œì„± ?¸ì‹ ë¯¸ì???}          </button>          <div style={{ display: 'flex', gap: 8 }}>            <button              type="button"              onClick={() => setStep('phone')}              style={{                padding: '12px 16px',                borderRadius: 8,                border: '1px solid #ddd',                background: 'white',                color: '#666',                cursor: 'pointer'              }}            >              ë²ˆí˜¸ ?˜ì •            </button>            <button              type="submit"              disabled={busy || code.length !== 6}              style={{                padding: '12px 16px',                borderRadius: 8,                border: 'none',                background: code.length === 6 ? '#10b981' : '#ccc',                color: 'white',                cursor: code.length === 6 ? 'pointer' : 'not-allowed',                marginLeft: 'auto'              }}            >              {busy ? '?•ì¸ ì¤‘â€? : '?•ì¸'}            </button>          </div>        </form>      )}      {step === 'name' && (        <form onSubmit={finish} style={{ display: 'grid', gap: 16 }}>          <div>            <label style={{ display: 'block', marginBottom: 8, fontWeight: 600 }}>              ?´ë¦„(?‰ë„¤??            </label>            <input              value={name}              onChange={e => setName(e.target.value)}              placeholder="?ê¸¸??              style={{                width: '100%',                padding: '12px',                border: '1px solid #ddd',                borderRadius: 8,                fontSize: 16              }}            />          </div>          {/* ?Œì„± ?…ë ¥ ë²„íŠ¼ */}          <button            type="button"            disabled={!sttSupport.ok}            onPointerDown={() => startSTT()}            onPointerUp={() => stopSTT()}            onPointerCancel={() => stopSTT()}            onPointerLeave={() => stopSTT()}            style={{              padding: '16px',              borderRadius: 8,              border: 'none',              background: sttSupport.ok ? '#2563eb' : '#ccc',              color: 'white',              fontSize: 16,              fontWeight: 600,              cursor: sttSupport.ok ? 'pointer' : 'not-allowed',              opacity: sttSupport.ok ? 1 : 0.6            }}          >            {sttSupport.ok ? '?¤ ê¸¸ê²Œ ?ŒëŸ¬ ë§í•˜ê¸? : '?¤ ?Œì„± ?¸ì‹ ë¯¸ì???}          </button>          <button            type="submit"            disabled={busy || !name.trim()}            style={{              padding: '16px',              borderRadius: 8,              border: 'none',              background: name.trim() ? '#10b981' : '#ccc',              color: 'white',              fontSize: 16,              fontWeight: 600,              cursor: name.trim() ? 'pointer' : 'not-allowed'            }}          >            {busy ? '?€??ì¤‘â€? : '?„ë£Œ'}          </button>        </form>      )}      {/* ?ëŸ¬ ë©”ì‹œì§€ */}      {err && (        <div style={{          color: 'crimson',          marginTop: 16,          padding: '12px 16px',          background: '#fef2f2',          border: '1px solid #fecaca',          borderRadius: 8,          fontSize: 14        }}>          ? ï¸ {err}        </div>      )}      {/* reCAPTCHA ì»¨í…Œ?´ë„ˆ */}      <div id="recaptcha-container" />    </div>  );};export default PhoneVoiceSignup; 
