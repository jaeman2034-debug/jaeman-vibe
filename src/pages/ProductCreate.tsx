import { useState, useRef, useEffect } from "react";import { auth } from "@/lib/firebase";import { useNavigate } from "react-router-dom";import { createProduct } from "@/services/productService";import AiInspector from "@/components/AiInspector";import { suggestPriceRange } from "@/lib/priceSuggest";// ??AI ëª¨ë“œ ?€???•ì˜type AiMode = "auto" | "manual";// ??AI ?œì•ˆ ê²°ê³¼ ?€???•ì˜type AiSuggest = {  title?: string;  category?: string;  priceHint?: number;  descDraft?: string;  quality?: { sharpness: number; brightness: number; clutter: number };  priceRange?: any; // ??priceRange ?ì„± ì¶”ê?};export default function ProductCreate() {  const nav = useNavigate();  const [title, setTitle] = useState("");  const [price, setPrice] = useState<number | "">("");  const [description, setDescription] = useState("");  const [category, setCategory] = useState("ê¸°í?");  const [files, setFiles] = useState<FileList | null>(null);  const [saving, setSaving] = useState(false);    // ???Œì¼ ë¯¸ë¦¬ë³´ê¸° ?íƒœ ì¶”ê?  const [previews, setPreviews] = useState<string[]>([]);    // ??AI ëª¨ë“œ ?íƒœ ê´€ë¦?  const [aiMode, setAiMode] = useState<AiMode>("manual");      // ê¸°ë³¸ê°’ì„ manualë¡?ë³€ê²?  const abortRef = useRef<AbortController|null>(null);    // ??AI ë¶„ì„ ê´€???íƒœ  const [showCamera, setShowCamera] = useState(false);  const [analyzing, setAnalyzing] = useState(false);  const [cameraError, setCameraError] = useState("");  const [analysisResult, setAnalysisResult] = useState<any>(null);  const videoRef = useRef<HTMLVideoElement>(null);  const canvasRef = useRef<HTMLCanvasElement>(null);  const streamRef = useRef<MediaStream | null>(null);  // ??AI ?œì•ˆ ê´€ë¦??íƒœ  const [ai, setAi] = useState<AiSuggest | null>(null);  // ???˜ëŒë¦?ê°’ì„ ë³´ê?  const [prevValues, setPrevValues] = useState<{    title: string;    category: string;    price: number | "";    description: string;  } | null>(null);  // ???ìˆ˜ ?•ì˜  const MIN_PRICE = 1000; // ê¸°ë³¸ ìµœì†Œ ê¸ˆì•¡(?? ???€ ?•ì±…??ë§ê²Œ ì¡°ì •  // ???ë™ ê°€ê²?ì¶”ì²œ (ì¹´í…Œê³ ë¦¬ ë³€ê²???  useEffect(() => {    (async () => {      if (!category || category === "ê¸°í?") return;            try {        const myDongCode = "12345"; // profile?.dongCode || formDongCode        const suggestion = await suggestPriceRange(category, myDongCode);                if (suggestion) {          setAi(prev => ({             ...(prev || {}),             priceHint: suggestion.mid,            priceRange: suggestion          }));          console.log(`[ê°€ê²©ì¶”ì²? ${category} ì¹´í…Œê³ ë¦¬: ${suggestion.range} (? ë¢°?? ${Math.round(suggestion.confidence * 100)}%)`);        }      } catch (error) {        console.warn("?ë™ ê°€ê²?ì¶”ì²œ ?¤íŒ¨:", error);      }    })();  }, [category]);  // ??AI ëª¨ë“œ ?¤ì • ë¶ˆëŸ¬?¤ê¸° (ìµœì´ˆ ë¡œë“œ ??  useEffect(() => {    const local = localStorage.getItem("ai.autoMode") as AiMode | null;    if (local) setAiMode(local);    // Firestore???€?¥í–ˆ?¤ë©´ ??–´?°ê¸°    // (? íƒ) try { const snap = await getDoc(doc(db,"users",uid)); setAiMode(snap.data()?.settings?.aiAutoMode ?? local ?? "auto"); } catch {}  }, []);  // ??AI ëª¨ë“œ ?¤ì • ?€??  async function saveAiMode(mode: AiMode) {    setAiMode(mode);    localStorage.setItem("ai.autoMode", mode);    // (? íƒ) await updateDoc(doc(db,"users",uid), {"settings.aiAutoMode": mode}).catch(()=>{});  }  // ??ì»´í¬?ŒíŠ¸ unmount ??URL ?´ì œ(ë©”ëª¨ë¦??„ìˆ˜ ë°©ì?)  useEffect(() => {    return () => previews.forEach((u) => URL.revokeObjectURL(u));  }, [previews]);  // ??ê°œë³„ ?´ë?ì§€ ?? œ ê¸°ëŠ¥  function removePreview(idx: number) {    setPreviews((prev) => {      URL.revokeObjectURL(prev[idx]);      return prev.filter((_, i) => i !== idx);    });    // files ?íƒœ???¨ê»˜ ?•ë¦¬    if (files) {      const arr = Array.from(files);      arr.splice(idx, 1);      const dt = new DataTransfer();      arr.forEach((f) => dt.items.add(f));      setFiles(dt.files);    }  }  // ??AI ?œì•ˆ ?ìš©  function applyAISuggest(s: AiSuggest, { force = false } = {}) {    if (force || !title?.trim()) setTitle(s.title ?? title ?? "");    if (force || !description?.trim()) setDescription(s.descDraft ?? description ?? "");    if (force || !category || category === "ê¸°í?")      setCategory(s.category ?? category ?? "ê¸°í?");    const hinted = s.priceHint && s.priceHint > 0 ? Math.round(s.priceHint) : undefined;    if (force || !price || Number(price) <= 0) setPrice(hinted ?? MIN_PRICE); // ????ƒ ì±„ì?  }  // ??AI ?œì•ˆ ?˜ëŒë¦¬ê¸°  function undoAISuggest() {    if (!prevValues) return;        setTitle(prevValues.title);    setCategory(prevValues.category);    setPrice(prevValues.price);    setPrevValues(null);  }  // ì¹´ë©”???œì‘  const startCamera = async () => {    try {      setCameraError("");      const stream = await navigator.mediaDevices.getUserMedia({         video: { facingMode: 'environment' }       });      if (videoRef.current) {        videoRef.current.srcObject = stream;        streamRef.current = stream;        setShowCamera(true);      }    } catch (error) {      console.error('ì¹´ë©”???‘ê·¼ ?¤íŒ¨:', error);      setCameraError('ì¹´ë©”?¼ì— ?‘ê·¼?????†ìŠµ?ˆë‹¤. ê¶Œí•œ???•ì¸?´ì£¼?¸ìš”.');    }  };  // ì¹´ë©”??ì¤‘ì?  const stopCamera = () => {    if (streamRef.current) {      streamRef.current.getTracks().forEach(track => track.stop());      streamRef.current = null;    }    setShowCamera(false);  };  // ?¬ì§„ ì´¬ì˜ ë°?AI ë¶„ì„  const captureAndAnalyze = async () => {    if (!videoRef.current || !canvasRef.current) return;    try {      setAnalyzing(true);      const canvas = canvasRef.current;      const video = videoRef.current;      const context = canvas.getContext('2d');      if (!context) return;      canvas.width = video.videoWidth;      canvas.height = video.videoHeight;      context.drawImage(video, 0, 0);            const blob = await new Promise<Blob>((resolve) => {        canvas.toBlob((blob) => { if (blob) resolve(blob); }, 'image/jpeg', 0.8);      });      const file = new File([blob], `ai_capture_${Date.now()}.jpg`, { type: 'image/jpeg' });            // ??ì´¬ì˜???´ë?ì§€ë¥??Œì¼ ëª©ë¡??ì¶”ê? (AiInspectorê°€ ë¶„ì„)      const dataTransfer = new DataTransfer();      if (files) { Array.from(files).forEach(f => dataTransfer.items.add(f)); }      dataTransfer.items.add(file);      setFiles(dataTransfer.files);            // ??ë¯¸ë¦¬ë³´ê¸°???¨ê»˜ ?…ë°?´íŠ¸      const newPreviews = Array.from(dataTransfer.files).map(f => URL.createObjectURL(f));      setPreviews(prev => {        prev.forEach(URL.revokeObjectURL); // ê¸°ì¡´ URL ?•ë¦¬        return newPreviews;      });            // ì¹´ë©”??ì¤‘ì?      stopCamera();    } catch (error) {      console.error('ì´¬ì˜ ?¤íŒ¨:', error);      alert('ì´¬ì˜ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.');    } finally {      setAnalyzing(false);    }  };  // ???Œì¼ ? íƒ ??ë¯¸ë¦¬ë³´ê¸°ë§??ì„±  function handleFilesChange(e: React.ChangeEvent<HTMLInputElement>) {    const list = e.target.files;    setFiles(list);    // ?´ì „ URL ?•ë¦¬    setPreviews((prev) => {       prev.forEach(URL.revokeObjectURL);       return [];     });    if (!list || list.length === 0) return;        // ???„ë¦¬ë·?URL ?ì„±    const urls = Array.from(list).map((f) => URL.createObjectURL(f));    setPreviews(urls);    // ???ë™ ëª¨ë“œ???Œë§Œ AI ë¶„ì„ ?¤í–‰    if (aiMode === "auto") {      const file = list[0];      scheduleQuickAnalysis(file);    }  }  // ??ë¹ ë¥¸ AI ë¶„ì„ ?¤ì?ì¤„ë§  function scheduleQuickAnalysis(file: File) {    // ?´ì „ ë¶„ì„ ì·¨ì†Œ + ?”ë°”?´ìŠ¤    abortRef.current?.abort();    const ac = new AbortController();    abortRef.current = ac;    setTimeout(() => {      runAnalysis(file, { quick: true, apply: true }); // ?¨ë””ë°”ì´??ê²½ëŸ‰ ë¶„ì„    }, 250);  }  // ??AI ë¶„ì„ ?¤í–‰ ?¨ìˆ˜  type RunOpts = { quick?: boolean; apply?: boolean; signal?: AbortSignal };  // ??ë³´ì¡° ? í‹¸ ?¨ìˆ˜??  function suggestCategoryFromLabels(labels: string[]) {    const L = labels.map(s => s.toLowerCase());    // ê°€ë°©ë¥˜    if (L.some(x => /(back ?pack|knapsack|packsack|rucksack|haversack|bag)/.test(x)))      return "ê°€ë°??©í’ˆ";    // ì¶•êµ¬    if (L.some(x => /(soccer|football|cleats|shin guard|goalkeeper|futsal)/.test(x)))      return "ì¶•êµ¬";    // ?¼ì¼“/êµ¬ê¸° ê³µí†µ    if (L.some(x => /(sports|equipment|ball|racket|bat|glove)/.test(x)))      return "?¤í¬ì¸ ìš©??;    return null; // ?†ìœ¼ë©??ìš© ìª½ì—??ê¸°ì¡´ ê°?? ì?  }  function generateTitleFromLabels(labels: string[], cat: string) {    const main = (labels[0] ?? "").toLowerCase().replace(/_/g, " ");    return `${cat} ${main}`.trim();  }  function buildDescription(qa: {    labels: string[];    quality: { sharpness: number; brightness: number; clutter: number };  }) {    const { sharpness, brightness, clutter } = qa.quality;    const tips: string[] = [];    if (sharpness < 0.35) tips.push("?¬ì§„???¤ì†Œ ?ë¦¼");    if (brightness < 0.40) tips.push("ì¡°ëª…???´ë‘?€");    if (clutter > 0.65) tips.push("ë°°ê²½ ë³µì¡");    return [      "?ë™ ?ì„± ?¤ëª…(?˜ì • ê°€??:",      qa.labels && qa.labels.length > 0         ? `???¸ì‹??ê°ì²´: ${qa.labels.slice(0,5).join(", ")}`        : "???¸ì‹??ê°ì²´: ë¶„ì„ ?„ìš”",      `??ì´¬ì˜ ?ˆì§ˆ: ? ëª…??${Math.round(sharpness*100)} / ë°ê¸° ${Math.round(brightness*100)} / ë³µì¡??${Math.round(clutter*100)}`,      tips.length ? `??ì´¬ì˜ ?? ${tips.join(", ")}` : "",    ].filter(Boolean).join("\n");  }  // ???´ë?ì§€ ?ˆì§ˆ ë°??¼ë²¨ ë¶„ì„ ?¨ìˆ˜ (ê°„ë‹¨ ë²„ì „)  async function analyzeQualityAndLabels(file: File, signal?: AbortSignal) {    // ê°„ë‹¨???ˆì§ˆ ë¶„ì„ (?¤ì œë¡œëŠ” AiInspector?ì„œ ì²˜ë¦¬)    const quality = {      sharpness: 0.7,  // ê¸°ë³¸ê°?      brightness: 0.6,      clutter: 0.3    };        // ???¤ì œ AI ë¶„ì„???†ì„ ?ŒëŠ” ë¹?ë°°ì—´ ë°˜í™˜ (?ë™ ê°??…ë ¥ ë°©ì?)    // const labels = ["sports", "equipment"]; // ???˜ë“œì½”ë”© ?œê±°        // ?¤ì œ AI ë¶„ì„???°ê²°?˜ë©´ ?¬ê¸°??ì²˜ë¦¬    // const labels = await analyzeImageWithAI(file, signal);        return { quality, labels: [] }; // ë¹?ë°°ì—´ë¡?ë°˜í™˜?˜ì—¬ ?ë™ ê°??…ë ¥ ë°©ì?  }  async function runAnalysis(file: File, opts: RunOpts = {}) {    setAnalyzing(true);    try {      console.log(`[AI] ë¶„ì„ ?œì‘: ${opts.quick ? 'ë¹ ë¥¸' : '?„ì²´'} ë¶„ì„, apply: ${opts.apply}`);            // 1) ?¨ë””ë°”ì´??ê²½ëŸ‰ ë¶„ì„ (?¼í”Œ?¼ì‹œ??ë°ê¸°/ë³µì¡??+ ëª¨ë°”?¼ë„· ?¼ë²¨)      const qa = await analyzeQualityAndLabels(file, opts.signal); // ?´ë? ?ˆëŠ” ?¨ìˆ˜ë©?ê·¸ë?ë¡??¬ìš©      // qa: { quality:{sharpness,brightness,clutter}, labels:string[] }      // 2) ?¼ë²¨?’ì¹´?Œê³ ë¦??œëª© ?„ë³´      // ???¼ë²¨???†ìœ¼ë©?ê¸°ì¡´ ê°?? ì? (?ë™ ê°??…ë ¥ ë°©ì?)      let cat = category ?? "ê¸°í?";      let ttl = title ?? "";            if (qa.labels && qa.labels.length > 0) {        cat = suggestCategoryFromLabels(qa.labels) ?? category ?? "ê¸°í?";        ttl = generateTitleFromLabels(qa.labels, cat);      }      // 3) ê°€ê²?ë²”ìœ„ ì¶”ì²œ(ë² í?) ???™ì¼ ì¹´í…Œê³ ë¦¬(+?‰ì •?? ì¤‘ì•™ê°?      const priceSugg = await suggestPriceRange(cat, "12345"); // profile?.dongCode      const priceHint = priceSugg?.mid;      // 4) ?¤ëª… ì´ˆì•ˆ(?¼ë²¨/?ˆì§ˆ ?”ì•½)      const descDraft = buildDescription(qa);      // ?”ë©´??ë¯¸ë¦¬ë³´ê¸°(?¨ë„)??ê°±ì‹ ?˜ê³ ??      const aiSuggest: AiSuggest = {        category: cat,        title: ttl,        priceHint,        descDraft,        quality: qa.quality,      };      setAi(aiSuggest);      // ???µì…˜: ë²„íŠ¼???„ë¥´ë©?ê³§ë°”ë¡??¼ì— **?ìš©**      if (opts.apply) {        setPrevValues({ title, category, price, description }); // ?˜ëŒë¦¬ê¸° ?€ë¹?        applyAISuggest(aiSuggest, { force: true });        console.log(`[AI] ë¶„ì„ ê²°ê³¼ ì¦‰ì‹œ ?ìš©:`, aiSuggest);      }            return aiSuggest;    } catch (e) {      console.error("[AI] analyze error", e);      alert("AI ë¶„ì„ ì¤?ë¬¸ì œê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");      throw e;    } finally {      setAnalyzing(false);    }  }  // AI ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬  const handleAISuggestion = (suggestion: {    labels: string[],    category?: string,    title?: string,    tips: string[],    quality: { sharpness: number, brightness: number, clutter: number },    priceRange?: any  }) => {    setAnalysisResult(suggestion);        // AI ?œì•ˆ ?íƒœ ?…ë°?´íŠ¸    setAi({      category: suggestion.category,      title: suggestion.title,      quality: suggestion.quality,      priceRange: suggestion.priceRange    });  };  // ???œì¶œ  const onSubmit = async (e: React.FormEvent) => {    e.preventDefault();    if (saving) return;        // ???„ìˆ˜ ?„ë“œ ê²€??    if (!title || !price || !description) {      alert("?œëª©, ê°€ê²? ?¤ëª…??ëª¨ë‘ ?…ë ¥?´ì£¼?¸ìš”.");      return;    }        setSaving(true);        try {      const uid = auth.currentUser?.uid;      if (!uid) throw new Error("ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??");      // ??ê°„ë‹¨???œë¹„???¸ì¶œ: createProduct(values, file)      const docId = await createProduct(        {          title,          category,          description,          price: Number(price) || MIN_PRICE,          sellerId: uid,        },        files?.[0] ?? undefined  // ì²?ë²ˆì§¸ ?Œì¼ë§??„ë‹¬      );      alert("?±ë¡ ?„ë£Œ!");      nav(`/market/${docId}`);    } catch (error: any) {      console.error("?í’ˆ ?±ë¡ ?¤íŒ¨:", error);      alert(error?.message || "?±ë¡ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");    } finally {      setSaving(false);    }  };  // ??ê°„ë‹¨?????œì¶œ ì²˜ë¦¬  const handleSubmit = async (e: React.FormEvent) => {    e.preventDefault();    await onSubmit(e);  };  return (    <div className="max-w-2xl mx-auto p-4">      <div className="flex items-center justify-between mb-4">        <h1 className="text-2xl font-bold">?í’ˆ ?±ë¡</h1>                         {/* ???¤ë”??AI ë¶„ì„ ëª¨ë“œ ? ê? */}         <div className="flex items-center gap-2 text-sm">           <span className="text-gray-600">AI ë¶„ì„ ëª¨ë“œ:</span>           <select             value={aiMode}             onChange={(e) => saveAiMode(e.target.value as AiMode)}             className="border rounded px-2 py-1 text-xs"           >             <option value="auto">?ë™</option>             <option value="manual">?˜ë™</option>           </select>         </div>      </div>            {/* AI ì´¬ì˜ë¶„ì„ ?¹ì…˜ */}      <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">        <h2 className="text-lg font-semibold text-blue-800 mb-3">?¤– AI ì´¬ì˜ë¶„ì„</h2>        <p className="text-sm text-blue-600 mb-3">          ?í’ˆ??ì´¬ì˜?˜ë©´ AIê°€ ?ë™?¼ë¡œ ?œëª©, ì¹´í…Œê³ ë¦¬, ê°€ê²©ì„ ë¶„ì„?´ë“œë¦½ë‹ˆ??        </p>                {!showCamera ? (          <button onClick={startCamera} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">            ?“¸ AI ì´¬ì˜ë¶„ì„ ?œì‘          </button>        ) : (          <div className="space-y-3">            <div className="relative">              <video ref={videoRef} autoPlay playsInline className="w-full h-64 bg-black rounded-lg" />              <canvas ref={canvasRef} className="hidden" />            </div>            <div className="flex gap-2">              <button                 onClick={captureAndAnalyze}                 disabled={analyzing}                 className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"              >                {analyzing ? "?“¸ ì´¬ì˜ ì¤?.." : "?“¸ ì´¬ì˜"}              </button>              <button onClick={stopCamera} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">                ??ì·¨ì†Œ              </button>            </div>            {cameraError && (<p className="text-red-600 text-sm">{cameraError}</p>)}          </div>        )}                 {/* ??AI ë¶„ì„ ëª¨ë“œ ? íƒ */}         <div className="mt-3 flex items-center gap-2 text-sm">           <span className="text-blue-700 font-medium">AI ë¶„ì„ ëª¨ë“œ:</span>           <select             value={aiMode}             onChange={(e) => saveAiMode(e.target.value as AiMode)}             className="border rounded px-2 py-1 text-xs"           >             <option value="auto">?ë™</option>             <option value="manual">?˜ë™</option>           </select>           <button             type="button"             disabled={!files?.[0] || analyzing}             onClick={async () => {               if (!files?.[0]) return;               const s = await runAnalysis(files[0]);               applyAISuggest(s, { force: true });             }}             className="px-3 py-2 rounded bg-indigo-600 text-white text-xs hover:bg-indigo-700 disabled:opacity-50"           >             {analyzing ? "AI ë¶„ì„ ì¤?.." : "?” AI ë¶„ì„ + ì¦‰ì‹œ ?ìš©"}           </button>                      {/* ???˜ëŒë¦¬ê¸° ë²„íŠ¼ */}           {prevValues && (             <button                type="button"                onClick={undoAISuggest}                className="px-2 py-1 border rounded text-xs hover:bg-gray-50"             >               ?©ï¸ ?˜ëŒë¦¬ê¸°             </button>           )}         </div>      </div>            <form onSubmit={handleSubmit} className="space-y-4">        <div>          <label className="block text-sm mb-1">?œëª©</label>          <input            type="text"            value={title}            onChange={(e) => setTitle(e.target.value)}            className="w-full p-2 border rounded"            placeholder="?í’ˆ ?œëª©???…ë ¥?˜ì„¸??          />        </div>                <div>          <label className="block text-sm mb-1">ê°€ê²?(??</label>          <input            type="number"            value={price}            onChange={(e) => setPrice(e.target.value ? Number(e.target.value) : "")}            className="w-full p-2 border rounded"            placeholder="ê°€ê²©ì„ ?…ë ¥?˜ì„¸??          />        </div>                <div>          <label className="block text-sm mb-1">ì¹´í…Œê³ ë¦¬</label>          <select            value={category}            onChange={(e) => setCategory(e.target.value)}            className="w-full p-2 border rounded"          >            <option value="ê¸°í?">ê¸°í?</option>            <option value="ì¶•êµ¬">ì¶•êµ¬</option>            <option value="?êµ¬">?êµ¬</option>            <option value="?¼êµ¬">?¼êµ¬</option>            <option value="?¬ë‹">?¬ë‹</option>            <option value="?Œë‹ˆ??>?Œë‹ˆ??/option>            <option value="ê³¨í”„">ê³¨í”„</option>            <option value="?˜ì˜">?˜ì˜</option>            <option value="ê°€ë°?>ê°€ë°?/option>            <option value="?˜ë¥˜">?˜ë¥˜</option>            <option value="ë³´í˜¸?¥ë¹„">ë³´í˜¸?¥ë¹„</option>          </select>        </div>                <div>          <label className="block text-sm mb-1">?¤ëª…</label>          <textarea            value={description}            onChange={(e) => setDescription(e.target.value)}            className="w-full p-2 border rounded"            rows={4}            placeholder="?í’ˆ???€???ì„¸???¤ëª…???…ë ¥?˜ì„¸??          />        </div>                <div>          <label className="block text-sm mb-1">?´ë?ì§€</label>          <input type="file" accept="image/*" multiple onChange={handleFilesChange} />          {files && (<p className="text-sm text-gray-600 mt-1">{files.length}ê°??Œì¼ ? íƒ??/p>)}        </div>                {/* ???Œì¼ ë¯¸ë¦¬ë³´ê¸° ?¹ì…˜ */}        <div className="mt-3">          <h4 className="text-sm font-medium text-gray-700 mb-2">?“¸ ?´ë?ì§€ ë¯¸ë¦¬ë³´ê¸°</h4>                                        {/* ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬??*/}          {previews.length > 0 ? (            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">              <div className="grid grid-cols-3 gap-3">                {previews.map((src, i) => (                  <div key={i} className="aspect-square rounded-lg border border-gray-300 overflow-hidden relative group">                    <img                      src={src}                      alt={`?¬ì§„ ${i + 1}`}                      className="w-full h-full object-cover transition-transform group-hover:scale-105"                      loading="eager"                    />                    <button                      type="button"                      onClick={() => removePreview(i)}                      className="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors opacity-0 group-hover:opacity-100"                      title="?´ë?ì§€ ?? œ"                    >                      ?–ï¸                    </button>                    <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs px-2 py-1 text-center">                      ?¬ì§„ {i + 1}                    </div>                  </div>                ))}              </div>            </div>          ) : (            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center text-gray-500">              ?´ë?ì§€ë¥?? íƒ?˜ë©´ ?¬ê¸°??ë¯¸ë¦¬ë³´ê¸°ê°€ ?œì‹œ?©ë‹ˆ??            </div>          )}        </div>                {/* AI ë¶„ì„ ê²°ê³¼ ?œì‹œ */}        {analysisResult && (          <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">            <h3 className="text-lg font-semibold text-green-800 mb-3">?” AI ë¶„ì„ ê²°ê³¼</h3>            <div className="mb-4">              <h4 className="font-medium text-green-700 mb-2">?´ë?ì§€ ?ˆì§ˆ ?ìˆ˜</h4>              <div className="grid grid-cols-3 gap-4">                <div className="text-center">                  <div className="text-xl font-bold text-green-600">{Math.round(analysisResult.quality.sharpness * 100)}</div>                  <div className="text-sm text-green-600">? ëª…??/div>                </div>                <div className="text-center">                  <div className="text-xl font-bold text-green-600">{Math.round(analysisResult.quality.brightness * 100)}</div>                  <div className="text-sm text-green-600">ë°ê¸°</div>                </div>                <div className="text-center">                  <div className="text-xl font-bold text-green-600">{Math.round(analysisResult.quality.clutter * 100)}</div>                  <div className="text-sm text-green-600">ë³µì¡??/div>                </div>              </div>            </div>            <div className="mb-4">              <h4 className="font-medium text-green-700 mb-2">?¸ì‹??ê°ì²´</h4>              <div className="flex flex-wrap gap-2">                {analysisResult.labels.map((label: string, index: number) => (                  <span key={index} className="px-2 py-1 bg-green-100 text-green-700 rounded text-sm">                    {label}                  </span>                ))}              </div>            </div>            <div className="mb-4">              <h4 className="font-medium text-green-700 mb-2">?¬ì´¬????/h4>              <div className="space-y-1">                {analysisResult.tips.map((tip: string, index: number) => (                  <div key={index} className="text-sm text-green-600">??{tip}</div>                ))}              </div>            </div>          </div>        )}        {/* ??AI ì¶”ì²œ ?•ë³´ ?¹ì…˜ */}        {ai && (          <div className="mb-6 rounded-lg border p-4 bg-green-50">            <div className="text-sm text-gray-600 mb-3 font-medium">??AI ì¶”ì²œ</div>            <div className="space-y-2 mb-4">              <div className="text-sm">ì¹´í…Œê³ ë¦¬: <b className="text-green-700">{ai.category ?? "-"}</b></div>              <div className="text-sm">?œëª©: <b className="text-green-700">{ai.title ?? "-"}</b></div>              {ai.priceHint && <div className="text-sm">ê°€ê²??ŒíŠ¸: <b className="text-green-700">{ai.priceHint.toLocaleString()}??/b></div>}            </div>                        {/* ???¨ë„??'??ê°€ê²©ìœ¼ë¡? ë²„íŠ¼ ?¸ì¶œ */}            {ai.priceHint && (              <div className="mt-1 text-sm mb-4">                ì¶”ì²œ ê°€ê²? <b>{ai.priceHint.toLocaleString()}??/b>                <button                   type="button"                  onClick={() => setPrice(ai.priceHint!)}                  className="ml-2 px-2 py-1 rounded border hover:bg-green-100"                >                  ??ê°€ê²©ìœ¼ë¡?                </button>              </div>            )}                        {/* ??ê°€ê²?ë²”ìœ„ ?•ë³´ ì¶”ê? */}            {(ai as any).priceRange && (              <div className="mb-4 p-3 bg-blue-50 rounded border border-blue-200">                <div className="text-sm font-medium text-blue-800 mb-2">?’° ê°€ê²?ë²”ìœ„ ì¶”ì²œ</div>                <div className="text-sm text-blue-700 mb-2">                  ë²”ìœ„: <b>{(ai as any).priceRange.range}</b><br/>                  ì¤‘ì•™ê°? <b>{(ai as any).priceRange.mid.toLocaleString()}??/b><br/>                  ?°ì´?? <b>{(ai as any).priceRange.count}ê°?/b> ??? ë¢°?? <b>{Math.round((ai as any).priceRange.confidence * 100)}%</b>                </div>                <div className="flex gap-2">                  <button                     onClick={() => setPrice((ai as any).priceRange.mid)}                     className="px-3 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700"                  >                    ?’° ì¤‘ì•™ê°??ìš©                  </button>                  <button                     onClick={() => setPrice((ai as any).priceRange.low)}                     className="px-3 py-1 rounded border border-blue-300 text-blue-700 text-sm hover:bg-blue-50"                  >                    ?“‰ ìµœì?ê°€ ?ìš©                  </button>                </div>              </div>            )}                        <div className="flex gap-2">              <button                 type="button"                onClick={() => ai && applyAISuggest(ai, { force: false })}                 className="px-3 py-1 rounded bg-indigo-600 text-white"              >                ??ì¶”ì²œ ?ìš©              </button>              {prevValues && (                <button                   type="button"                  onClick={undoAISuggest}                   className="px-3 py-1 rounded border"                >                  ?©ï¸ ?˜ëŒë¦¬ê¸°                </button>              )}            </div>          </div>        )}                <button disabled={saving} className="px-5 py-2 rounded bg-indigo-600 text-white disabled:opacity-50">          {saving ? "?±ë¡ ì¤?.." : "?±ë¡"}        </button>              </form>      {/* ??AI ë¶„ì„ê¸?(?Œì¼ ? íƒ ?„ë˜??ë°°ì¹˜) */}      {files && files.length > 0 && (        <AiInspector           file={files[0]}           onSuggest={handleAISuggestion}        />      )}          </div>  );}