import React, { useEffect, useState, useMemo } from 'react';import { useParams, useNavigate, useLocation } from 'react-router-dom';import { doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs, deleteDoc } from 'firebase/firestore';import { onAuthStateChanged } from 'firebase/auth';import { db, auth } from '@/lib/firebase';import { createOrGetThread } from '@/services/chatService';import { calcTemperature } from '@/services/reviewService';import { distanceMeters, formatDistanceKm, reverseGeocodeDong } from '@/lib/geo';import TemperatureBadge from '@/components/TemperatureBadge';import HjdBadge from '@/components/HjdBadge';import { pickSellerId } from '@/utils/helpers';import { quickBackfill } from '@/utils/quickBackfill';import { checkAdminDong } from '@/lib/adminDong';// ê°œë°œ ?˜ê²½ ?œì–´ (ìµœì†Œ?œìœ¼ë¡?? ì?)const DEV = import.meta.env.DEV;// ê°„ë‹¨ ?œë¡­?¤ìš´ ë©”ë‰´ ì»´í¬?ŒíŠ¸function MoreMenu({ isOwner, onEdit, onDelete, onReport, onShare, itemStatus }: any) {  const [open, setOpen] = useState(false);    // ?? œ ê°€???¬ë? ?•ì¸  const canDelete = itemStatus !== "?ˆì•½ì¤?;    return (    <div className="relative">      <button         className="w-8 h-8 rounded hover:bg-black/5 flex items-center justify-center text-xl font-bold"         onClick={() => setOpen(v => !v)}      >        ??      </button>      {open && (        <div className="absolute right-0 mt-2 w-36 rounded-lg border bg-white shadow-lg z-10">          {isOwner ? (            <>              <button                 className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-t-lg"                 onClick={() => { onEdit(); setOpen(false); }}              >                ?˜ì •              </button>              <button                 className={`w-full text-left px-3 py-2 rounded-b-lg ${                  canDelete                     ? "text-red-600 hover:bg-gray-50"                     : "text-gray-400 cursor-not-allowed"                }`}                onClick={() => {                   if (canDelete) {                    onDelete();                     setOpen(false);                  }                }}                disabled={!canDelete}                title={canDelete ? "?í’ˆ ?? œ" : "?ˆì•½ ì¤‘ì¸ ?í’ˆ?€ ?? œ?????†ìŠµ?ˆë‹¤"}              >                ?? œ              </button>            </>          ) : (            <>              <button                 className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-t-lg"                 onClick={() => { onReport(); setOpen(false); }}              >                ? ê³               </button>              <button                 className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-b-lg"                 onClick={() => { onShare(); setOpen(false); }}              >                ê³µìœ               </button>            </>          )}        </div>      )}    </div>  );}interface ProductData {  id: string;  title: string;  description?: string;  price: number;  images: Array<string | { url: string; path: string }>;  imageUrl?: string;  category?: string;  status: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ';  sellerId: string;  createdAt: any;  geo?: { lat: number; lng: number };  address?: { sido: string; sigungu: string; dong: string; full: string };  location?: {    lat: number;    lng: number;    placeName?: string;  };  // ?”¥ ?ˆë¡œ???„ì¹˜ ë°?ì£¼ì†Œ ?„ë“œ  loc?: { lat: number; lng: number };  addr?: {    bjd?: string;    hjd?: string;    hjdStatus?: 'pending' | 'ok' | 'fail';    hjdSource?: 'kakao' | 'naver';    hjdCheckedAt?: any;  };  sellerStats?: {    trades: number;    starsSum: number;    pos: number;    neg: number;  };}export default function ProductDetail() {  const { id } = useParams();  const [item, setItem] = useState<ProductData | null>(null);  const [loading, setLoading] = useState(true);  const [error, setError] = useState<string | null>(null);  const [updatingStatus, setUpdatingStatus] = useState(false);  const [addr, setAddr] = useState<string | null>(null);  const [dist, setDist] = useState<string | null>(null);  const [user, setUser] = useState(auth.currentUser);  const navigate = useNavigate();  const location = useLocation();        // Auth ?íƒœ êµ¬ë…  useEffect(() => {    const unsubscribe = onAuthStateChanged(auth, (user) => {      console.log('[DETAIL] Auth state changed:', user?.uid);      setUser(user);    });    return () => unsubscribe();  }, []);  useEffect(() => {    let alive = true;    (async () => {      if (!id) return;            // ???ˆì „ ê°€?? ?¹ìˆ˜??ID ê°?ì²˜ë¦¬      if (id === "create" || id === "new") {        console.log("[DETAIL] ?¹ìˆ˜ ID ê°ì?, ?±ë¡ ?˜ì´ì§€ë¡?ë¦¬ë‹¤?´ë ‰??", id);        navigate("/market/create", { replace: true });        return;      }            // ??1) redirects/{oldId} ??{to} ë§¤í•‘ ?ˆìœ¼ë©???IDë¡?ì¦‰ì‹œ ?´ë™      try {        const rSnap = await getDoc(doc(db, "redirects", id));        if (!alive) return;                const to = (rSnap.data() as any)?.to;        if (rSnap.exists() && to && to !== id) {          console.log(`[DETAIL] ë¦¬ë‹¤?´ë ‰??ë°œê²¬: ${id} ??${to}`);          navigate(`/market/${to}`, {             replace: true,             state: { redirectedFrom: id }           });          return; // ë¦¬ë‹¤?´ë ‰???ˆìœ¼??ê¸°ì¡´ ë¡œë”© ì¤‘ë‹¨        }      } catch (redirectError) {        console.warn(`[DETAIL] ë¦¬ë‹¤?´ë ‰??ì²´í¬ ?¤íŒ¨:`, redirectError);        // ë¦¬ë‹¤?´ë ‰??ì²´í¬ ?¤íŒ¨?´ë„ ê³„ì† ì§„í–‰      }            // ??2) ?¤ì œ ?„ì´??ë¡œë“œ(?†ìœ¼ë©?falseë¥?ë°˜í™˜?˜ê²Œ êµ¬í˜„)      // ID ë³€ê²????íƒœ ë¦¬ì…‹      setError(null);      setItem(null);            const ok = await loadItem(id);      if (!alive) return;            // ??3) ëª?ì°¾ìœ¼ë©??ë™?¼ë¡œ ë§ˆì¼“?¼ë¡œ      if (!ok) {        navigate("/market", { replace: true, state: { notFound: id } });      }    })();    return () => { alive = false; };  }, [id, navigate]); // location.pathname ?œê±° (ë¶ˆí•„?”í•œ ?¬ì‹¤??ë°©ì?)  // ?‰ì •??ì£¼ì†Œ ë°?ê±°ë¦¬ ê³„ì‚°  useEffect(() => {    (async () => {      if (item?.geo?.lat && item?.geo?.lng) {        if (!addr) {          try {            const a = await reverseGeocodeDong(item.geo.lat, item.geo.lng);            setAddr(a.full);          } catch {}        }        // ?„ì¬ ?¬ìš©???„ì¹˜ê°€ ?ˆë‹¤ë©?ê±°ë¦¬ ê³„ì‚°        if (navigator.geolocation) {          navigator.geolocation.getCurrentPosition((pos) => {            const myCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };            setDist(formatDistanceKm(distanceMeters(myCoords, item.geo!)));          });        }      }    })();  }, [item?.id, item?.geo, addr]);  // ?‰ì •???ë™ ?•ì¸ (?ì„¸ ?˜ì´ì§€ ì§„ì… ??1??ì§€???¤í–‰)  useEffect(() => {    let t = setTimeout(() => {       if (item?.addr?.hjdStatus !== 'ok' && item?.id) {        console.log('[HJD] ?ì„¸ ?˜ì´ì§€ ì§„ì… ???‰ì •???ë™ ?•ì¸ ?œì‘:', item.id);        checkAdminDong(item.id);      }    }, 1000);    return () => clearTimeout(t);  }, [item?.id]);  // isOwner ?ë³„ - useMemoë¡?ìµœì ??  const isOwner = useMemo(() => {    const sellerUid = pickSellerId(item);    const result = !!user?.uid && !!sellerUid && user.uid === sellerUid;        return result;  }, [user?.uid, item]);  const loadItem = async (id: string): Promise<boolean> => {    try {      setLoading(true);            // 1) ID ? íš¨??ê²€??      if (!id || id.trim() === '') {        setError('?˜ëª»???í’ˆ ID?…ë‹ˆ??');        return false;      }            // 2) products ?°ì„       let snap = await getDoc(doc(db, "products", id));      let collectionSource = 'products';      // 3) ?†ìœ¼ë©?market?ì„œ ?´ë°± + ?ë™ ?…ì„œ??      if (!snap.exists()) {        console.log("[DETAIL] products???†ìŒ ??market ?´ë°± + ?ë™ ?…ì„œ??);        const ms = await getDoc(doc(db, "market", id));        if (ms.exists()) {          const d = ms.data() as any;          console.log("[DETAIL] market ??products ?ë™ ë§ˆì´ê·¸ë ˆ?´ì…˜:", id);          await setDoc(doc(db, "products", id), {             ...d,             migratedFrom: "detail-auto",            migratedAt: serverTimestamp()          }, { merge: true });          snap = await getDoc(doc(db, "products", id)); // ?¤ì‹œ ?½ê¸°          collectionSource = 'products (migrated)';        }      }      // 4) ê·¸ë˜???†ìœ¼ë©?false ë°˜í™˜      if (!snap.exists()) {        console.warn(`[DETAIL] ?í’ˆ??ì°¾ì„ ???†ìŒ: ${id}`);        setError('?í’ˆ??ì°¾ì„ ???†ìŠµ?ˆë‹¤.');        return false;      }      const productData = snap.data() as ProductData;            // ?ˆë¡œ??geo?€ address ?„ë“œ ?°ì„  ?¬ìš©, ê¸°ì¡´ location?€ ?˜ìœ„ ?¸í™˜??? ì?      if (productData.geo?.lat && productData.geo?.lng) {        // geo ?„ë“œê°€ ?ˆìœ¼ë©??¬ìš©        productData.location = {          lat: productData.geo.lat,          lng: productData.geo.lng,          placeName: productData.address?.full || productData.address?.dong || ''        };      } else if (productData.location?.lat && productData.location?.lng) {        // ê¸°ì¡´ location ?„ë“œ ?¬ìš©        productData.geo = {          lat: productData.location.lat,          lng: productData.location.lng        };      }      setItem({        ...productData,        id: snap.id      });            return true; // ?±ê³µ ??true ë°˜í™˜    } catch (err) {      console.error('?í’ˆ ë¡œë“œ ?¤íŒ¨:', err);      setError('?í’ˆ??ë¶ˆëŸ¬?¤ëŠ” ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.');      return false; // ?¤íŒ¨ ??false ë°˜í™˜    } finally {      setLoading(false);    }  };  const handleTradeClick = async () => {    if (!item || !user) return;    // sellerIdê°€ ?†ìœ¼ë©??„ì‹œë¡??¬ìš©??UID ?¬ìš© (?¤ì œë¡œëŠ” sellerIdê°€ ?ˆì–´????    const sellerId = item.sellerId || user.uid;    try {      const threadId = await createOrGetThread(item.id, sellerId);      navigate(`/chat/${threadId}`);    } catch (err: any) {      console.error('ì±„íŒ… ?œì‘ ?¤íŒ¨:', err);      alert(err.message || 'ì±„íŒ…???œì‘?????†ìŠµ?ˆë‹¤.');    }  };  // ?ì„¸ ?˜ì • ?€??  const saveProduct = async (id: string, form: any) => {    const uid = auth.currentUser!.uid;    const payload = {      title: form.title.trim(),      price: Number(form.price) || 0,      description: form.description ?? "",      category: form.category ?? "",      status: form.status ?? "?ë§¤ì¤?,      sellerId: form.sellerId ?? uid,              // rules ?µê³¼      updatedAt: serverTimestamp(),    };    await setDoc(doc(db, "products", id), { createdAt: serverTimestamp(), ...payload }, { merge: true });    // â¬‡ï¸ ?„ì‹œ ?™ê¸°??ëª©ë¡??market??ë³????€ë¹?    try { await setDoc(doc(db, "market", id), { ...payload }, { merge: true }); } catch {}        // ???€????ê°™ì? IDë¡??´ë™ (addDocë¡??ˆë¡œ ë§Œë“¤ì§€ ?Šìœ¼??id ê·¸ë?ë¡?? ì?)    navigate(`/market/${id}`);  };  // ?íƒœ ?€??  const handleStatusSave = async (id: string, next: "?ë§¤ì¤?|"?ˆì•½ì¤?|"?„ë£Œ", sellerId: string) => {    const payload = { status: next, sellerId, updatedAt: serverTimestamp() };    await updateDoc(doc(db, "products", id), payload);    try { await updateDoc(doc(db, "market", id), payload); } catch {}  };  const handleStatusChange = async (newStatus: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ') => {    if (!item || !id) return;    try {      setUpdatingStatus(true);            const uid = auth.currentUser?.uid;      if (!uid) return alert("ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??");            const pRef = doc(db, "products", id);      const pSnap = await getDoc(pRef);      // ê·œì¹™ ?µê³¼?? sellerId ?¬í•¨(ë¶ˆë?)      const baseSellerId = pSnap.exists() ? (pSnap.data() as any).sellerId : uid;      const payload = {         status: newStatus,         sellerId: baseSellerId,         updatedAt: serverTimestamp()       };            if (pSnap.exists()) {        await updateDoc(pRef, payload);      // ??update ?œì—??sellerId ?™ë´‰      } else {        // products ë¬¸ì„œê°€ ?†ìœ¼ë©??…ì„œ??        const mSnap = await getDoc(doc(db, "market", id));        const m = mSnap.exists() ? (mSnap.data() as any) : {};        await setDoc(pRef, {           ...m,           ...payload,           createdAt: m.createdAt ?? serverTimestamp()         }, { merge: true });      }      // â¬‡ï¸ ?„ì‹œ ?™ê¸°??ëª©ë¡??market??ë³????€ë¹?      try {         await updateDoc(doc(db, "market", id), {           status: newStatus,           updatedAt: serverTimestamp()         });       } catch {}      // ?™ê???UI ê°±ì‹       setItem((prev:any) => ({ ...prev, status: newStatus }));            // ?±ê³µ ?Œë¦¼      console.log("???íƒœ ë³€ê²??„ë£Œ:", newStatus);            // ?€?????¤ì œ ê°??•ì¸ (?ˆì‹¬??      try {        const snap = await getDoc(doc(db, "products", id));        console.log("?“Š products ?€???•ì¸ - status =", snap.data()?.status);      } catch (e) {        console.warn("?€???•ì¸ ?¤íŒ¨:", e);      }    } catch (err) {      console.error('?íƒœ ë³€ê²??¤íŒ¨:', err);      alert('?íƒœ ë³€ê²½ì— ?¤íŒ¨?ˆìŠµ?ˆë‹¤.');    } finally {      setUpdatingStatus(false);    }  };  // MoreMenu ?¸ë“¤?¬ë“¤  const handleEdit = () => {    if (!item) return;    navigate(`/market/${item.id}/edit`);  };  const handleDelete = async () => {    if (!item || !id) return;        // ?ˆì•½ ì¤‘ì´ê±°ë‚˜ ì§„í–‰ ì¤?ì±„íŒ…???ˆëŠ”ì§€ ?•ì¸    if (item.status === "?ˆì•½ì¤?) {      alert("? ï¸ ?ˆì•½ ì¤‘ì¸ ?í’ˆ?€ ?? œ?????†ìŠµ?ˆë‹¤.\n\n?í’ˆ??'?„ë£Œ' ?íƒœë¡?ë³€ê²½í•˜ê±°ë‚˜, ?ˆì•½??ì·¨ì†Œ?????? œ?´ì£¼?¸ìš”.");      return;    }        // 2ì°??•ì¸    if (!confirm("?•ë§ ?? œ? ê¹Œ?? ?˜ëŒë¦????†ìŠµ?ˆë‹¤.")) return;        try {      // ???¨ìˆœ ?˜ë“œ ?? œ: products + market ë¬¸ì„œë§??? œ      await deleteDoc(doc(db, "products", item.id));      try { await deleteDoc(doc(db, "market", item.id)); } catch {}            alert("?? œ?˜ì—ˆ?µë‹ˆ??");      navigate("/market");    } catch (e: any) {      alert(e.message || "?? œ???¤íŒ¨?ˆìŠµ?ˆë‹¤.");    }  };  const handleReport = () => {    // TODO: ? ê³  ëª¨ë‹¬ ?ëŠ” ?˜ì´ì§€ë¡??´ë™    alert('? ê³  ê¸°ëŠ¥?€ ?„ì§ êµ¬í˜„?˜ì? ?Šì•˜?µë‹ˆ??');  };  const handleShare = async () => {    if (!item) return;        try {      if (navigator.share) {        await navigator.share({          title: item.title,          text: `${item.title} - ${item.price?.toLocaleString()}??,          url: window.location.href        });      } else {        // Web Share APIê°€ ì§€?ë˜ì§€ ?ŠëŠ” ê²½ìš° ?´ë¦½ë³´ë“œ??ë³µì‚¬        await navigator.clipboard.writeText(window.location.href);        alert('ë§í¬ê°€ ?´ë¦½ë³´ë“œ??ë³µì‚¬?˜ì—ˆ?µë‹ˆ??');      }    } catch (err) {      console.error('ê³µìœ  ?¤íŒ¨:', err);    }  };  const getTimeAgo = (timestamp: any) => {    if (!timestamp) return '';        const now = Date.now();    const time = timestamp.toMillis ? timestamp.toMillis() : timestamp;    const diff = now - time;        if (diff < 60000) return 'ë°©ê¸ˆ ??;    if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶???;    if (diff < 86400000) return `${Math.floor(diff / 3600000)}?œê°„ ??;    return `${Math.floor(diff / 86400000)}????;  };  if (loading) {    return (      <div className="p-4 max-w-3xl mx-auto">        <div className="animate-pulse space-y-4">          <div className="h-8 bg-gray-200 rounded"></div>          <div className="h-96 bg-gray-200 rounded"></div>          <div className="h-4 bg-gray-200 rounded"></div>          <div className="h-4 bg-gray-200 rounded"></div>        </div>      </div>    );  }  // 404 ?íƒœ?????´ìƒ ?¬ìš©?˜ì? ?ŠìŒ (?ë™ ë¦¬ë‹¤?´ë ‰?¸ë¡œ ?€ì²?  // ?¼ë°˜ ?ëŸ¬ ?íƒœ ì²˜ë¦¬ - ?í’ˆ???†ìœ¼ë©?ë§ˆì¼“?¼ë¡œ ?ë™ ë¦¬ë‹¤?´ë ‰??  if (error || !item) {    // ?ëŸ¬ ?íƒœ???Œë§Œ ê°„ë‹¨??UI ?œì‹œ (?ë™ ë¦¬ë‹¤?´ë ‰?¸ëŠ” useEffect?ì„œ ì²˜ë¦¬)    return (      <div className="p-4 max-w-3xl mx-auto text-center">        <p className="text-red-600">{error || '?í’ˆ??ë¶ˆëŸ¬?¤ëŠ” ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.'}</p>        <button          onClick={() => navigate('/market')}          className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"        >          ë§ˆì¼“?¼ë¡œ ?Œì•„ê°€ê¸?        </button>      </div>    );  }  return (    <div className="p-4 max-w-3xl mx-auto">      {/* ?¤ë” */}      <div className="mb-6">                <div className="flex items-start justify-between mb-3">          <div className="flex-1">            <h1 className="text-2xl font-bold mb-1">{item.title}</h1>            <div className="text-3xl font-bold text-indigo-600">              {item.price > 0 ? item.price.toLocaleString() + "?? : "ê°€ê²?ë¯¸ì •"}            </div>            <div className="text-sm text-gray-500 mt-1">{getTimeAgo(item.createdAt)}</div>            <div className="text-sm text-gray-600 mt-1">?“ {addr ?? "?‰ì •???•ì¸ ì¤?}{dist ? ` Â· ${dist}` : ""}</div>                        {/* ??ë¦¬ë‹¤?´ë ‰???íƒœ ?œì‹œ */}            {location.state?.redirectedFrom && (              <div className="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">                <div className="text-sm text-blue-700">                  ?”„ <strong>ë¦¬ë‹¤?´ë ‰?¸ë¨</strong>:                   <code className="ml-1 bg-blue-100 px-2 py-1 rounded text-xs">                    {location.state.redirectedFrom}                  </code>                  ???„ì¬ ?í’ˆ                </div>                <div className="text-xs text-blue-600 mt-1">                  ?´ì „ ë§í¬ê°€ ?ë™?¼ë¡œ ???í’ˆ?¼ë¡œ ?´ë™?˜ì—ˆ?µë‹ˆ??                </div>              </div>            )}                        {/* ê°„ë‹¨???ˆë‚´ ë¬¸êµ¬ (?¬ìš©???œì•ˆ) */}            {location.state?.redirectedFrom && (              <p className="text-xs text-gray-500 mt-1">                ?´ì „ ë§í¬?ì„œ ?ë™ ?´ë™??              </p>            )}          </div>          <div className="flex items-center gap-2">            <span className={`px-3 py-1 rounded-full text-sm font-medium ${              item.status === "?ë§¤ì¤? ? "bg-green-100 text-green-700"              : item.status === "?ˆì•½ì¤? ? "bg-yellow-100 text-yellow-700"              : "bg-gray-100 text-gray-700"            }`}>              {item.status}            </span>            {/* MoreMenu: ??• ë³?ë©”ë‰´ */}            <MoreMenu              isOwner={!!isOwner}              onEdit={() => navigate(`/market/${item.id}/edit`)}              onDelete={handleDelete}              onReport={handleReport}              onShare={handleShare}              itemStatus={item.status}            />          </div>        </div>        {/* ?¡ì…˜: ?¤ë„ˆ/êµ¬ë§¤??ë¶„ê¸° ???íƒœ ë³€ê²½ê³¼ ?ì„¸ ?˜ì • ë¶„ë¦¬ */}        {isOwner ? (          <div className="flex flex-wrap items-center gap-3">            {/* ?íƒœ ë³€ê²??¹ì…˜ */}            <div className="flex items-center gap-2">              <label className="text-sm text-gray-600">?íƒœ ë³€ê²?/label>              <select                value={item.status}                onChange={(e) => handleStatusChange(e.target.value as "?ë§¤ì¤?|"?ˆì•½ì¤?|"?„ë£Œ")}                className="px-3 py-2 border rounded-lg text-sm"                disabled={updatingStatus}              >                <option value="?ë§¤ì¤?>?ë§¤ì¤?/option>                <option value="?ˆì•½ì¤?>?ˆì•½ì¤?/option>                <option value="?„ë£Œ">?„ë£Œ</option>              </select>              <button                onClick={() => handleStatusChange(item.status)}                disabled={updatingStatus}                className="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"              >                {updatingStatus ? '?€??ì¤?..' : '?íƒœ ?€??}              </button>            </div>            {/* ?ì„¸ ?˜ì • / ?? œ(?¤ë„ˆ ?„ìš©) */}            <button              onClick={() => navigate(`/market/${item.id}/edit`)}              className="px-5 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700"            >              ?ì„¸ ?˜ì •            </button>            <button               onClick={handleDelete}              disabled={item.status === "?ˆì•½ì¤?}              className={`px-5 py-2.5 rounded-lg border ${                item.status === "?ˆì•½ì¤?                  ? "border-gray-300 text-gray-400 cursor-not-allowed bg-gray-50"                  : "border-red-300 text-red-600 hover:bg-red-50 hover:border-red-400"              }`}              title={item.status === "?ˆì•½ì¤? ? "?ˆì•½ ì¤‘ì¸ ?í’ˆ?€ ?? œ?????†ìŠµ?ˆë‹¤" : "?í’ˆ ?? œ"}            >              ?? œ            </button>          </div>        ) : (          <button            onClick={handleTradeClick}            disabled={item.status === "?„ë£Œ"}            className={`px-6 py-3 rounded-lg font-semibold ${              item.status === "?„ë£Œ"                ? "bg-gray-300 text-gray-500 cursor-not-allowed"                : "bg-indigo-600 text-white hover:bg-indigo-700"            }`}          >            {item.status === "?„ë£Œ" ? "?ë§¤ ?„ë£Œ" : "ê±°ë˜?˜ê¸°"}          </button>        )}      </div>      {/* ?í’ˆ ?´ë?ì§€ */}      {(() => {        const firstImage = item?.images?.[0];        const cover = (() => {          if (firstImage && typeof firstImage === 'object' && 'url' in firstImage) {            return firstImage.url;          }          if (firstImage && typeof firstImage === 'string') {            return firstImage;          }          return item?.imageUrl ?? null;        })();        return cover ? (          <div className="mb-6">            <div className="relative aspect-[4/3] w-full max-w-2xl mx-auto overflow-hidden rounded-xl bg-gray-100 shadow-lg">              <img                src={cover}                alt={item.title}                className="absolute inset-0 h-full w-full object-cover"                onError={(e) => {                  console.warn(`[ProductDetail] ?´ë?ì§€ ë¡œë“œ ?¤íŒ¨: ${cover}`);                  e.currentTarget.src = "/img/placeholder.png";                }}              />            </div>          </div>        ) : (          <div className="mb-6">            <div className="relative aspect-[4/3] w-full max-w-2xl mx-auto overflow-hidden rounded-xl bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center">              <div className="text-gray-400 text-center">                <div className="text-2xl mb-2">?“·</div>                <div>?´ë?ì§€ ?†ìŒ</div>              </div>            </div>          </div>        );      })()}      {/* ?ë§¤???•ë³´ ?¤ë‹ˆ??*/}      {item.sellerStats && (        <div className="mb-6 p-4 bg-gray-50 rounded-lg">          <div className="flex items-center gap-3">            <div className="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center">              <span className="text-gray-600 text-lg">?‘¤</span>            </div>            <div className="flex-1">              <div className="font-medium">?ë§¤??/div>              <div className="text-sm text-gray-600">                ê±°ë˜ {item.sellerStats.trades}??              </div>            </div>            <TemperatureBadge stats={item.sellerStats} />          </div>        </div>      )}      {/* ?í’ˆ ?¤ëª… */}      {item.description && (        <div className="mb-6">          <h3 className="text-lg font-semibold mb-2">?í’ˆ ?¤ëª…</h3>          <p className="text-gray-700 whitespace-pre-wrap leading-relaxed">            {item.description}          </p>        </div>      )}      {/* ì¹´í…Œê³ ë¦¬ ë°??‰ì •???íƒœ */}      <div className="mt-3 flex flex-wrap items-center gap-2">        {item.category && (          <span className="text-sm text-gray-500">ì¹´í…Œê³ ë¦¬: {item.category}</span>        )}        {/* ?‰ì •???íƒœ ë±ƒì? - ì¢Œí‘œê°€ ?ˆì„ ?Œë§Œ ?œì‹œ */}        {item.loc && (          <HjdBadge status={item.addr?.hjdStatus} showPending={true} />        )}      </div>      {/* ëª¨ë°”?¼ì—?œë§Œ ?¸ì¶œ */}      {!isOwner && item.status !== "?„ë£Œ" && (        <div className="fixed bottom-0 inset-x-0 bg-white/95 border-t p-3 md:hidden">          <button onClick={handleTradeClick} className="w-full py-3 rounded-lg bg-indigo-600 text-white">            ê±°ë˜?˜ê¸°          </button>        </div>      )}    </div>  );}
