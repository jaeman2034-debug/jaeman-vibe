import { useEffect, useState } from "react";import { useNavigate, useParams } from "react-router-dom";import { doc, getDoc, setDoc, updateDoc, serverTimestamp, deleteDoc } from "firebase/firestore";import { db, auth } from "@/lib/firebase";import { updateProduct, updateProductImages } from "@/services/productService";export default function ProductEdit() {  const params = useParams();  const { id } = params;  const nav = useNavigate();  const [loading, setLoading] = useState(true);  const [saving, setSaving] = useState(false);  const [form, setForm] = useState<{    title: string;    price: number;    description: string;    category: string;    status: "?ë§¤ì¤? | "?ˆì•½ì¤? | "?„ë£Œ";  }>({    title: "",    price: 0,    description: "",    category: "",    status: "?ë§¤ì¤?, // ??ê¸°ë³¸ê°?ê°•ì œ ?¤ì •  });    // ?´ë?ì§€ ê´€???íƒœ  const [selectedFiles, setSelectedFiles] = useState<FileList | null>(null);  const [currentImages, setCurrentImages] = useState<any[]>([]);    // ë¬¸ì„œê°€ ?´ëŠ ì»¬ë ‰?˜ì— ?ˆëŠ”ì§€ ì¶”ì   const [documentCollection, setDocumentCollection] = useState<'products' | 'market'>('products');  useEffect(() => {    if (!id) return;    (async () => {      // 1. products ì»¬ë ‰?˜ì—??ë¨¼ì? ì°¾ê¸°      let productDoc = await getDoc(doc(db, "products", id));      let collectionName: 'products' | 'market' = 'products';            // 2. products???†ìœ¼ë©?market ì»¬ë ‰?˜ì—???´ë°±      if (!productDoc.exists()) {        console.log('[EDIT] products?ì„œ ì°¾ì„ ???†ìŒ, market?ì„œ ?´ë°± ?œë„...');        productDoc = await getDoc(doc(db, "market", id));        collectionName = 'market';      }            if (!productDoc.exists()) {        alert('?í’ˆ??ì°¾ì„ ???†ìŠµ?ˆë‹¤.');        nav('/market');        return;      }            // ì»¬ë ‰???•ë³´ ?€??      setDocumentCollection(collectionName);      console.log('[EDIT] ë¬¸ì„œ ?„ì¹˜:', collectionName, 'ì»¬ë ‰??);            const d = productDoc.data() as any || {};      setForm({        title: d.title ?? "",        price: d.price ?? 0,        description: d.description ?? "",        category: d.category ?? "",        status: (["?ë§¤ì¤?,"?ˆì•½ì¤?,"?„ë£Œ"] as const).includes(d.status) ? d.status : "?ë§¤ì¤?, // ??      });            // ?„ì¬ ?´ë?ì§€ ?•ë³´ ?€??      if (d.images && Array.isArray(d.images)) {        setCurrentImages(d.images);      }            setLoading(false);    })();  }, [id, nav]);  // ?Œì¼ ? íƒ ?¸ë“¤??  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {    if (e.target.files && e.target.files.length > 0) {      setSelectedFiles(e.target.files);    }  };  async function onSave(e: React.FormEvent) {    e.preventDefault();    if (saving) return;        const id = params.id!;    const uid = auth.currentUser?.uid;    if (!uid) return alert("ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??");    setSaving(true);        try {      // 1) ?„ì¬ products/market ?´ë””???ˆë“  ?½ê¸°      const pRef = doc(db, "products", id);      const pSnap = await getDoc(pRef);      const mRef = doc(db, "market", id);      const mSnap = pSnap.exists() ? null : await getDoc(mRef);      // 2) ê·œì¹™ ?µê³¼ë¥??„í•œ ?ˆì „??payload      const allowed = ["?ë§¤ì¤?,"?ˆì•½ì¤?,"?„ë£Œ"] as const;      const status = allowed.includes(form.status as any) ? form.status : "?ë§¤ì¤?;      const payload = {        title: (form.title ?? "").trim(),        price: Number(form.price) || 0,        description: form.description ?? "",        category: form.category ?? "",        status,                                // ??rules??ê±¸ë¦¬ì§€ ?Šë„ë¡???ƒ ?¬í•¨        sellerId: (pSnap.data() as any)?.sellerId ?? uid, // ??create ???„ìš”, update ??ë¶ˆë?        updatedAt: serverTimestamp(),      };      if (!pSnap.exists()) {        // 3) products??ë¬¸ì„œê°€ ?†ìœ¼ë©??…ì„œ???ì„±)        const base = (mSnap?.data() as any) ?? {};        await setDoc(pRef, {          ...base,          ...payload,          createdAt: base.createdAt ?? serverTimestamp(),          migratedFrom: mSnap ? "market" : "manual-empty",        }, { merge: true });        // (? íƒ) market ë¬¸ì„œ ?•ë¦¬        try { if (mSnap) await deleteDoc(mRef); } catch {}      } else {        // 4) ?´ë? ?ˆìœ¼ë©?update        await updateProduct(id, payload);      }      // 5) ?´ë?ì§€ ?…ë°?´íŠ¸ (???Œì¼??? íƒ??ê²½ìš°)      if (selectedFiles && selectedFiles.length > 0) {        console.log('[EDIT] ?´ë?ì§€ ?…ë°?´íŠ¸ ?œì‘...');        await updateProductImages(id, selectedFiles, (current, total, fileName) => {          console.log(`[EDIT] ?´ë?ì§€ ?…ë¡œ??ì§„í–‰ë¥? ${current}/${total} - ${fileName}`);        });        console.log('[EDIT] ?´ë?ì§€ ?…ë°?´íŠ¸ ?„ë£Œ');      }      // 6) ?€?????ì„¸ë¡??´ë™      alert('?í’ˆ???˜ì •?˜ì—ˆ?µë‹ˆ??');      nav(`/market/${id}`);          } catch (error) {      console.error('[EDIT] ?€???¤ë¥˜:', error);      alert('?€??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤: ' + (error as Error).message);    } finally {      setSaving(false);    }  }  if (loading) return <div className="p-4">ë¶ˆëŸ¬?¤ëŠ” ì¤‘â€?/div>;  return (    <form onSubmit={onSave} className="p-4 max-w-xl mx-auto space-y-3">      <h1 className="text-xl font-bold mb-3">?í’ˆ ?˜ì •</h1>            {/* ?„ì¬ ?´ë?ì§€ ?œì‹œ */}      {currentImages.length > 0 && (        <div className="mb-4">          <h3 className="text-sm font-medium mb-2">?„ì¬ ?´ë?ì§€</h3>          <div className="flex gap-2 overflow-x-auto">            {currentImages.map((img, index) => (              <img                key={index}                src={typeof img === 'string' ? img : img.url}                alt={`?´ë?ì§€ ${index + 1}`}                className="w-20 h-20 object-cover rounded border"              />            ))}          </div>        </div>      )}            {/* ???´ë?ì§€ ? íƒ */}      <div className="mb-4">        <label className="block text-sm font-medium mb-2">          ???´ë?ì§€ ì¶”ê? (ê¸°ì¡´ ?´ë?ì§€?€ ?¨ê»˜ ?€?¥ë©?ˆë‹¤)        </label>        <input          type="file"          multiple          accept="image/*"          onChange={handleFileSelect}          className="w-full border rounded px-3 py-2"        />        {selectedFiles && (          <p className="text-sm text-gray-600 mt-1">            {selectedFiles.length}ê°??Œì¼ ? íƒ??          </p>        )}      </div>            <input        className="w-full border rounded px-3 py-2"        placeholder="?œëª©"        value={form.title || ""}        onChange={(e) => setForm((f:any) => ({ ...f, title: e.target.value }))}      />      <input        className="w-full border rounded px-3 py-2"        type="number"        placeholder="ê°€ê²?        value={form.price || 0}        onChange={(e) => setForm((f:any) => ({ ...f, price: e.target.value }))}      />      <textarea        className="w-full border rounded px-3 py-2 min-h-[120px]"        placeholder="?¤ëª…"        value={form.description || ""}        onChange={(e) => setForm((f:any) => ({ ...f, description: e.target.value }))}      />      <div className="flex gap-2">        <select          value={form.status ?? "?ë§¤ì¤?}          // ????ƒ ê°?ë³´ì¥          onChange={(e) => setForm((f:any) => ({ ...f, status: e.target.value }))}          className="px-3 py-2 border rounded-lg text-sm disabled:opacity-50"        >          <option value="?ë§¤ì¤?>?ë§¤ì¤?/option>          <option value="?ˆì•½ì¤?>?ˆì•½ì¤?/option>          <option value="?„ë£Œ">?„ë£Œ</option>        </select>        <input          className="flex-1 border rounded px-3 py-2"          placeholder="ì¹´í…Œê³ ë¦¬"          value={form.category || ""}          onChange={(e) => setForm((f:any) => ({ ...f, category: e.target.value }))}        />      </div>      <button         type="submit"        disabled={saving}        className="w-full px-4 py-3 rounded bg-blue-600 text-white disabled:opacity-50 disabled:cursor-not-allowed"      >        {saving ? '?€??ì¤?..' : '?€??}      </button>    </form>  );}
