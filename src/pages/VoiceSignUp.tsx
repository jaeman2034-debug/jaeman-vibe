import { useEffect, useRef, useState } from "react";import { useSettings } from "../settings/SettingsContext";import { ensureMicPermission, listenOnceP, startMicLevelMeter, forceKillMic } from "../utils/mic";import {  cleanName,  normalizeEmail,  isValidEmail,  isStrongPassword,} from "../utils/normalize";type Step = 0 | 1 | 2 | 3; // 0:?´ë¦„, 1:?´ë©”?? 2:ë¹„ë²ˆ, 3:ê²€???œì¶œexport default function VoiceSignUp() {  const { locale } = useSettings();  const safeLocale = locale || "ko-KR"; // ??ë³´ê°•  const [step, setStep] = useState<Step>(0);  const [name, setName] = useState("");  const [email, setEmail] = useState("");  const [pw, setPw] = useState("");  const [listening, setListening] = useState(false);  const [error, setError] = useState<string | null>(null);  const mounted = useRef(true);    // ?‘‡ ì¶”ê?: ?”ë©´??SR ë¡œê·¸ë¥??„ì›Œ??ì½˜ì†” ??ë´ë„ ?ì¸ ë³´ì´ê²?  const [srLog, setSrLog] = useState<string[]>([]);  const log = (m: string) => setSrLog((xs) => [...xs.slice(-50), m]);    // ë§ˆì´???ˆë²¨ ë¯¸í„° ê´€???íƒœ  const [micLevel, setMicLevel] = useState(0);   // 0~1  const meterStopRef = useRef<null | (() => void)>(null);  const [meterOn, setMeterOn] = useState(false);  useEffect(() => {    return () => {      mounted.current = false;      try { meterStopRef.current?.(); } catch {}      forceKillMic(); // ?˜ì´ì§€ ? ë‚  ???„ì „ ì¢…ë£Œ    };  }, []);  // ë¯¸í„° ?œì‘/ì¢…ë£Œ ?¬í¼  async function startMeter() {    try {      // ê¶Œí•œ ?†ìœ¼ë©??”ì²­      await navigator.mediaDevices.getUserMedia({ audio: true });      meterStopRef.current = await startMicLevelMeter((v) => setMicLevel(v));      setMeterOn(true);    } catch {      setError("ë§ˆì´??ê¶Œí•œ???„ìš”?©ë‹ˆ?? ì£¼ì†Œì°??¼ìª½ ?”’?ì„œ ?ˆìš©?¼ë¡œ ë³€ê²½í•˜?¸ìš”.");    }  }    function stopMeter() {    try { meterStopRef.current?.(); } catch {}    meterStopRef.current = null;    setMeterOn(false);    setMicLevel(0);  }  /** ê³µìš©: STT ê²°ê³¼ë¥??„ë“œë³„ë¡œ ë°˜ì˜ */  const applyResult = (field: "name" | "email" | "pw", rawText: string) => {    console.log("?¯ applyResult ?¸ì¶œ:", field, rawText);        const text = (rawText || "").trim();    console.log("?“ ?•ë¦¬???ìŠ¤??", text);    if (field === "name") {      const v = cleanName(text);      console.log("?‘¤ ?´ë¦„ ?¤ì •:", v);      setName(v);      if (v.length < 2) setError("?´ë¦„???ˆë¬´ ì§§ìŠµ?ˆë‹¤. ?ë ·??ë§ì???ì£¼ì„¸??");    } else if (field === "email") {      const fixed = normalizeEmail(text);      console.log("?“§ ?´ë©”???¤ì •:", fixed);      setEmail(fixed);      if (!isValidEmail(fixed)) {        setError("?´ë©”???•ì‹???¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤. \"ê³¨ë±…?????·ì»´\"ì²˜ëŸ¼ ë§ì???ë³´ì„¸??");      }    } else {      const v = text.replace(/\s+/g, "");      console.log("?”’ ë¹„ë?ë²ˆí˜¸ ?¤ì •:", v);      setPw(v);      if (!isStrongPassword(v)) {        setError("ë¹„ë?ë²ˆí˜¸??8???´ìƒ?´ì–´???©ë‹ˆ??");      }    }        console.log("??applyResult ?„ë£Œ");  };  // >>> @VOICE_SIGNUP_DO_LISTEN_DIRECT  // ?”¥ ?¬í¼/ë¯¸í„° ??ë¹¼ê³ , ë¸Œë¼?°ì? SRë§?ì§ì ‘ êµ¬ë™  const doListen = (field: "name" | "email" | "pw") => {    if (listening) return;    setError(null);    setListening(true);    try {      const SR: any = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;      if (!SR) {        setListening(false);        setError("??ë¸Œë¼?°ì????Œì„± ?¸ì‹??ì§€?í•˜ì§€ ?ŠìŠµ?ˆë‹¤. Chrome/Edge ?¬ìš©??ì£¼ì„¸??");        return;      }      // ?‘‰ ì¤‘ìš”: ë²„íŠ¼ ?´ë¦­ ì»¨í…?¤íŠ¸?ì„œ ì¦‰ì‹œ ?ì„±/?œì‘ (await ?ˆë? ê¸ˆì?)      const r: any = new SR();      r.lang = (locale || "ko-KR");      r.interimResults = true;       // ì¤‘ê°„ ê²°ê³¼??ë°›ê¸°      r.maxAlternatives = 2;      r.continuous = false;      let finalText = "";      let interimText = "";      r.onstart = () => log("??onstart");      r.onaudiostart = () => log("??onaudiostart");      r.onsoundstart = () => log("??onsoundstart");      r.onspeechstart = () => log("??onspeechstart");      r.onresult = (e: any) => {        try {          for (let i = e.resultIndex; i < e.results.length; i++) {            const res = e.results[i];            const alt = res && res[0];            const t = (alt?.transcript || "").trim();            if (!t) continue;            if (res.isFinal) finalText = t;            else interimText = t;          }          log(`?¯ onresult: "${finalText || interimText}"`);        } catch {}      };      r.onerror = (e: any) => {        const code = e?.error;        log(`??onerror: ${code || "unknown"}`);        setError(          code === "not-allowed" ? "ë§ˆì´??ê¶Œí•œ??ê±°ë??˜ì—ˆ?µë‹ˆ?? ì£¼ì†Œì°??¼ìª½ ?”’?ì„œ ?ˆìš©?¼ë¡œ ë³€ê²½í•˜?¸ìš”."          : code === "audio-capture" ? "ë§ˆì´???¥ì¹˜ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤. OS???…ë ¥ ?¥ì¹˜ë¥??•ì¸?˜ì„¸??"          : code === "no-speech" ? "ë§ì†Œë¦¬ê? ê°ì??˜ì? ?Šì•˜?µë‹ˆ?? ì¡°ê¸ˆ ???¬ê²Œ ?ë ·?˜ê²Œ ë§ì???ì£¼ì„¸??"          : "?Œì„± ?¸ì‹ ?¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„??ì£¼ì„¸??"        );      };      r.onend = () => {        log("??onend");        setListening(false);        // ìµœì¢… ?†ìœ¼ë©?ì¤‘ê°„?´ë¼???¬ìš©        const text = finalText || interimText || "";        if (!text) return; // ?„ë¬´ê²ƒë„ ëª??¤ì? ê²½ìš°        if (field === "name") {          setName(cleanName(text));        } else if (field === "email") {          const fixed = normalizeEmail(text);          setEmail(fixed);          if (!isValidEmail(fixed)) setError("?´ë©”???•ì‹???¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤. ?¤ì‹œ ë§ì???ì£¼ì„¸??");        } else {          const val = text.replace(/\s+/g, "");          setPw(val);          if (!isStrongPassword(val)) setError("ë¹„ë?ë²ˆí˜¸??8???´ìƒ?´ì–´???©ë‹ˆ??");        }      };      // ? ï¸ ?ˆë? ê¸°ë‹¤ë¦¬ì? ë§ê³  ì¦‰ì‹œ ?œì‘      r.start();      log(`?™ start(lang=${r.lang})`);    } catch (err: any) {      setListening(false);      setError(err?.message || "?Œì„± ?¸ì‹ ì´ˆê¸°???¤íŒ¨");    }  };  // <<< @VOICE_SIGNUP_DO_LISTEN_DIRECT  // ?¨ê³„ ê²€ì¦?(?¸ë¦¼ ë°˜ì˜)  const stepValid =    (step === 0 && cleanName(name.trim()).length >= 2) ||    (step === 1 && isValidEmail(email.trim())) ||    (step === 2 && isStrongPassword(pw)) ||    step === 3;  const next = () => setStep((s) => (Math.min(3, s + 1) as Step));  const prev = () => setStep((s) => (Math.max(0, s - 1) as Step));  // ê°€???œì¶œ (?°ëª¨)  async function submitSignUp() {    setError(null);    try {      await new Promise((r) => setTimeout(r, 400));      alert(`ê°€???„ë£Œ!\n?´ë¦„: ${name}\n?´ë©”?? ${email}`);      // TODO: navigate("/welcome")    } catch (e: any) {      setError(e?.message || "ê°€??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");    }  }  // ?¸ë¼???¤í???(ê¸°ì¡´ ? ì?)  const wrap: React.CSSProperties = {    maxWidth: 560,    margin: "32px auto",    padding: "0 16px",    fontFamily:      "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",  };  const barBox: React.CSSProperties = {    height: 8,    background: "#e2e8f0",    borderRadius: 6,    overflow: "hidden",    margin: "12px 0 24px",  };  const title: React.CSSProperties = {    fontSize: 22,    fontWeight: 800,    margin: "12px 0 4px",  };  const sub: React.CSSProperties = { color: "#64748b", marginBottom: 16 };  const row: React.CSSProperties = { display: "flex", gap: 8, alignItems: "center" };  const btn: React.CSSProperties = {    border: 0,    background: "#2563eb",    color: "#fff",    padding: "10px 14px",    borderRadius: 10,    cursor: "pointer",    fontWeight: 700,  };  const ghost: React.CSSProperties = {    border: "2px solid #e2e8f0",    background: "#fff",    color: "#334155",    padding: "8px 12px",    borderRadius: 10,    cursor: "pointer",    fontWeight: 700,  };  const input: React.CSSProperties = {    flex: 1,    border: "2px solid #e2e8f0",    borderRadius: 10,    padding: "10px 12px",    outline: "none" as const,  };  return (    <div style={wrap}>      <h2 style={title}>?Œì„± ?Œì›ê°€??/h2>      <div style={sub}>?¸ì–´: {safeLocale}</div>            {/* ë§ˆì´???…ë ¥ ?ˆë²¨ ?œì‹œ */}      <div style={{margin: "8px 0 16px"}}>        <div style={{fontSize: 12, color: "#64748b", marginBottom: 4}}>          ë§ˆì´???…ë ¥ ?ˆë²¨ {listening ? "?¤ ?Œì„± ?¸ì‹ ì¤? : meterOn ? (micLevel > 0.1 ? "?¤ ?…ë ¥ ê°ì?" : "???ê¸°ì¤‘") : "(êº¼ì§)"}        </div>        <div style={{height: 8, background:"#e2e8f0", borderRadius: 6, overflow:"hidden"}}>          <div style={{height:"100%", width: `${listening ? 100 : Math.round(micLevel*100)}%`, background: listening ? "#2563eb" : "#10b981", transition:"width .08s"}}/>        </div>      </div>      {/* ì§„í–‰ ë°?*/}      <div style={barBox}>        <div          style={{            height: "100%",            width: `${(step + 1) * 25}%`,            background: "#2563eb",            transition: "width .15s",          }}        />      </div>      {step === 0 && (        <section>          <h3 style={title}>1/4 ?´ë¦„ ë§í•˜ê¸?/h3>          <p style={sub}>?? ?œì´ë¦„ì? ?´ì¬ë§Œâ€?/ ?œë°±?¹ê¶Œ??/p>          <div style={row}>            <input              style={input}              aria-label="?´ë¦„"              placeholder="?´ë¦„"              value={name}              onChange={(e) => setName(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("name")}              disabled={listening}              title="?´ë¦„???Œì„±?¼ë¡œ ?…ë ¥"            >              {listening ? "?£ëŠ” ì¤?.." : "?™ ë§í•˜ê¸?}            </button>                      </div>        </section>      )}      {step === 1 && (        <section>          <h3 style={title}>2/4 ?´ë©”??ë§í•˜ê¸?/h3>          <p style={sub}>?? ?œì´ë©”ì¼?€ jaeman ê³¨ë±…??ì§€ë©”ì¼ ??ì»´â€?/p>          <div style={row}>            <input              style={input}              aria-label="?´ë©”??              placeholder="?´ë©”??              value={email}              onChange={(e) => setEmail(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("email")}              disabled={listening}              title="?´ë©”?¼ì„ ?Œì„±?¼ë¡œ ?…ë ¥"            >              {listening ? "?£ëŠ” ì¤?.." : "?™ ë§í•˜ê¸?}            </button>          </div>          {!isValidEmail(email) && email && (            <div style={{ color: "#dc2626", marginTop: 8 }}>              ?¬ë°”ë¥??´ë©”???•ì‹???„ë‹™?ˆë‹¤.            </div>          )}        </section>      )}      {step === 2 && (        <section>          <h3 style={title}>3/4 ë¹„ë?ë²ˆí˜¸ ë§í•˜ê¸?/h3>          <p style={sub}>8???´ìƒ ê¶Œì¥. (ê³µê°œ ?¥ì†Œ?ì„œ??ì§ì ‘ ?…ë ¥ ê¶Œì¥)</p>          <div style={row}>            <input              style={input}              type="password"              aria-label="ë¹„ë?ë²ˆí˜¸"              placeholder="ë¹„ë?ë²ˆí˜¸"              value={pw}              onChange={(e) => setPw(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("pw")}              disabled={listening}              title="ë¹„ë?ë²ˆí˜¸ë¥??Œì„±?¼ë¡œ ?…ë ¥"            >              {listening ? "?£ëŠ” ì¤?.." : "?™ ë§í•˜ê¸?}            </button>          </div>          {!isStrongPassword(pw) && pw && (            <div style={{ color: "#dc2626", marginTop: 8 }}>              ë¹„ë?ë²ˆí˜¸??8???´ìƒ?´ì–´???©ë‹ˆ??            </div>          )}        </section>      )}      {step === 3 && (        <section>          <h3 style={title}>4/4 ?•ì¸ ??ê°€??/h3>          <ul style={{ lineHeight: 1.8, color: "#334155" }}>            <li>              <b>?´ë¦„</b>: {name || "-"}            </li>            <li>              <b>?´ë©”??/b>: {email || "-"}            </li>          </ul>          <p style={{ color: "#64748b" }}>            ??ë¹„ë?ë²ˆí˜¸??ë³´ì•ˆ???œì‹œ?˜ì? ?ŠìŠµ?ˆë‹¤.          </p>        </section>      )}             {/* ?˜ë‹¨ ?´ë¹„ê²Œì´??*/}       {error && <div style={{ color: "#dc2626", marginTop: 8 }}>{error}</div>}       {/* STT ë¡œê·¸ ?ì—­ */}       <div style={{ marginTop: 16, padding: 12, background: "#f8fafc", borderRadius: 8, border: "1px solid #e2e8f0" }}>         <div style={{ fontSize: 12, fontWeight: 600, color: "#475569", marginBottom: 8 }}>?¤ STT ë¡œê·¸:</div>         <div style={{            height: 120,            overflow: "auto",            fontSize: 11,            fontFamily: "monospace",           background: "#0f172a",           color: "#e2e8f0",           padding: 8,           borderRadius: 4         }}>           {srLog.length === 0 ? (             <span style={{ color: "#64748b" }}>?Œì„± ?¸ì‹???œì‘?˜ë©´ ë¡œê·¸ê°€ ?œì‹œ?©ë‹ˆ??..</span>           ) : (             srLog.map((msg, i) => (               <div key={i} style={{ marginBottom: 2 }}>{msg}</div>             ))           )}         </div>       </div>       <div style={{ display: "flex", gap: 8, marginTop: 16 }}>        <button style={ghost} onClick={prev} disabled={step === 0}>          ?´ì „        </button>        {step < 3 ? (          <button            style={{ ...btn, opacity: stepValid ? 1 : 0.6 }}            onClick={next}            disabled={!stepValid}          >            ?¤ìŒ          </button>        ) : (          <button            style={{ ...btn, opacity: stepValid ? 1 : 0.6 }}            onClick={submitSignUp}            disabled={!stepValid}          >            ê°€?…í•˜ê¸?          </button>        )}      </div>    </div>  );}
