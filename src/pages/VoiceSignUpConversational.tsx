import { useEffect, useRef, useState } from "react";import { auth, db } from "@/lib/firebase";import {  createUserWithEmailAndPassword,  fetchSignInMethodsForEmail,  updateProfile,} from "firebase/auth";// ---- SpeechRecognition ?€??ë³´ê°• ----type SRLike = SpeechRecognition & {};declare global {  interface Window {    webkitSpeechRecognition?: { new (): SRLike };    SpeechRecognition?: { new (): SRLike };  }}// ---- ? í‹¸: ?•ê·œ??ê²€ì¦?----function cleanName(raw: string): string {  return (raw || "").replace(/[^a-zA-Zê°€-??s]/g, "").replace(/\s+/g, " ").trim();}function normalizeEmail(raw: string): string {  let t = (raw || "").toLowerCase().trim();  t = t    .replace(/\s+/g, " ")    .replace(/ê³¨ë±…?????ì´??g, "@")    .replace(/??s?/g, ".")    .replace(/?·ì»´|??ì½???ì»?g, ".com")    .replace(/\s+/g, "");  t = t    .replace(/ì§€ë©”ì¼|gmail\.?com/g, "gmail.com")    .replace(/?¤ì´ë²?naver\.?com/g, "naver.com")    .replace(/?¤ìŒ|daum\.?net/g, "daum.net")    .replace(/?¼í›„|yahoo\.?com/g, "yahoo.com");  return t;}function isValidEmail(v: string) {  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v || "");}function isStrongPassword(v: string) {  return (v || "").length >= 8;}// ---- ? í‹¸: TTS ----function speak(text: string, lang = "ko-KR") {  try {    const u = new SpeechSynthesisUtterance(text);    u.lang = lang;    window.speechSynthesis.cancel();    window.speechSynthesis.speak(u);  } catch {}}// ---- ?íƒœ ?€??----type Step = "name" | "email" | "password" | "confirm" | "done";// ---- ë©”ì¸ ì»´í¬?ŒíŠ¸ ----export default function VoiceSignUpConversational() {  const locale = "ko-KR";  const [step, setStep] = useState<Step>("name");  const [name, setName] = useState("");  const [email, setEmail] = useState("");  const [pw, setPw] = useState("");  const [listening, setListening] = useState(false);  const [busy, setBusy] = useState(false);  const [error, setError] = useState<string | null>(null);  const [log, setLog] = useState<string[]>([]);  const pushLog = (m: string) => setLog((xs) => [...xs.slice(-80), m]);  const recognitionRef = useRef<SRLike | null>(null);  // HTTPS ê°€??  useEffect(() => {    if (location.protocol !== "https:" && location.hostname !== "localhost") {      setError("? ï¸ ë§ˆì´???¬ìš©???„í•´ HTTPSê°€ ?„ìš”?©ë‹ˆ??");    }  }, []);  // ?¨ê³„ ì§„ì… ?ˆë‚´ (TTS)  useEffect(() => {    const prompts: Record<Step, string> = {      name: "?´ë¦„??ë§ì???ì£¼ì„¸?? ?? ?´ì¬ë§?,      email: "?´ë©”?¼ì„ ë§ì???ì£¼ì„¸?? ?? ?œì´ë©”ë‹ˆ ì§€ë©”ì¼ ??ì»?,      password: "ë¹„ë?ë²ˆí˜¸ë¥?ë§ì???ì£¼ì„¸?? ê³µê°œ ?¥ì†Œ?ì„œ??ì§ì ‘ ?…ë ¥??ê¶Œì¥?©ë‹ˆ??",      confirm: "?…ë ¥ ?´ìš©???•ì¸?ˆìŠµ?ˆë‹¤. ê°€?…í•˜?œë ¤ë©?ê°€?…í•˜ê¸°ë¼ê³?ë§ì??˜ê±°??ë²„íŠ¼???ŒëŸ¬ ì£¼ì„¸??",      done: "?Œì›ê°€?…ì´ ?„ë£Œ?˜ì—ˆ?µë‹ˆ?? ?˜ì˜?©ë‹ˆ??",    };    speak(prompts[step], locale);  }, [step]);  // ê³µí†µ: ëª…ë ¹??ì²˜ë¦¬  function parseCommand(t: string) {    const s = t.replace(/\s+/g, "").toLowerCase();    if (/(ì´ˆê¸°??ë¦¬ì…‹|reset)/.test(s)) return "reset";    if (/(ì·¨ì†Œ|ìº”ìŠ¬|cancel)/.test(s)) return "cancel";    if (/(?¤ì‹œ|ë¦¬í”¼??repeat)/.test(s)) return "repeat";    if (/(?´ì „|?¤ë¡œ|ë°?back)/.test(s)) return "back";    if (/(?¤ìŒ|?¥ìŠ¤??next)/.test(s)) return "next";    if (/(ê°€???„ë£Œ|?•ì¸|submit|sign)/.test(s)) return "submit";    return null;  }  // ?Œì„± ?£ê¸°(?„ì¬ step??ë§ì¶° ì²˜ë¦¬)  const listen = () => {    if (listening) return;    setError(null);    const SR = window.webkitSpeechRecognition || window.SpeechRecognition;    if (!SR) {      setError("??ë¸Œë¼?°ì????Œì„± ?¸ì‹??ì§€?í•˜ì§€ ?ŠìŠµ?ˆë‹¤. Chrome/Edgeë¥?ê¶Œì¥?©ë‹ˆ??");      return;    }    const r: SRLike = new SR();    recognitionRef.current = r;    r.lang = locale;    r.interimResults = true;    r.maxAlternatives = 2;    r.continuous = false;    let finalText = "";    let interimText = "";    r.onstart = () => {      setListening(true);      pushLog("??onstart");    };    r.onresult = (e: SpeechRecognitionEvent) => {      for (let i = e.resultIndex; i < e.results.length; i++) {        const res = e.results[i];        const t = (res?.[0]?.transcript || "").trim();        if (!t) continue;        if (res.isFinal) finalText = t;        else interimText = t;      }      pushLog(`?¯ onresult: "${finalText || interimText}"`);    };    r.onerror = (e: any) => {      pushLog(`??onerror: ${e?.error || "unknown"}`);      setError(        e?.error === "not-allowed"          ? "ë§ˆì´??ê¶Œí•œ??ê±°ë??˜ì—ˆ?µë‹ˆ?? ì£¼ì†Œì°??¼ìª½ ?”’?ì„œ ?ˆìš©??ì£¼ì„¸??"          : e?.error === "no-speech"          ? "ë§ì†Œë¦¬ê? ê°ì??˜ì? ?Šì•˜?µë‹ˆ?? ì¡°ê¸ˆ ???¬ê²Œ ?ë ·?˜ê²Œ ë§ì???ì£¼ì„¸??"          : "?Œì„± ?¸ì‹ ?¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„??ì£¼ì„¸??"      );    };    r.onend = () => {      pushLog("??onend");      setListening(false);      const text = (finalText || interimText || "").trim();      if (!text) return;      // ê³µí†µ ëª…ë ¹???°ì„  ì²˜ë¦¬      const cmd = parseCommand(text);      if (cmd === "reset") {        setName(""); setEmail(""); setPw(""); setStep("name");        speak("ëª¨ë“  ?…ë ¥??ì´ˆê¸°?”í–ˆ?µë‹ˆ?? ?´ë¦„ë¶€???¤ì‹œ ì§„í–‰?©ë‹ˆ??", locale);        return;      }      if (cmd === "cancel") {        speak("ì·¨ì†Œ?ˆìŠµ?ˆë‹¤. ?„ìš”?˜ì‹œë©??¤ì‹œ ?œì‘??ì£¼ì„¸??", locale);        return;      }      if (cmd === "repeat") {        // ?„ì¬ ?¨ê³„ ?ˆë‚´ ?¬ìƒë§?        const prompts: Record<Step, string> = {          name: "?´ë¦„??ë§ì???ì£¼ì„¸??",          email: "?´ë©”?¼ì„ ë§ì???ì£¼ì„¸?? ?? ì§€ë©”ì¼ ??ì»?,          password: "ë¹„ë?ë²ˆí˜¸ë¥?ë§ì???ì£¼ì„¸??",          confirm: "ê°€?…í•˜?œë ¤ë©?ê°€?…í•˜ê¸°ë¼ê³?ë§ì???ì£¼ì„¸??",          done: "?Œì›ê°€?…ì´ ?„ë£Œ?˜ì—ˆ?µë‹ˆ??",        };        speak(prompts[step], locale);        return;      }      if (cmd === "back") {        setStep((s) => (s === "email" ? "name" : s === "password" ? "email" : s === "confirm" ? "password" : s));        return;      }      if (cmd === "next") {        // ?„ì¬ ê°’ì´ ? íš¨?˜ë©´ ?¤ìŒ?¼ë¡œ        if (step === "name" && cleanName(name).length >= 2) setStep("email");        else if (step === "email" && isValidEmail(email)) setStep("password");        else if (step === "password" && isStrongPassword(pw)) setStep("confirm");        else speak("?„ì¬ ?¨ê³„???…ë ¥??? íš¨?˜ì? ?ŠìŠµ?ˆë‹¤.", locale);        return;      }      if (cmd === "submit" && step === "confirm") {        handleSignup();        return;      }      // ?¨ê³„ë³??…ë ¥ ì²˜ë¦¬      if (step === "name") {        const v = cleanName(text);        setName(v);        if (v.length < 2) {          setError("?´ë¦„???ˆë¬´ ì§§ìŠµ?ˆë‹¤. ?¤ì‹œ ë§ì???ì£¼ì„¸??");          speak("?´ë¦„???ˆë¬´ ì§§ìŠµ?ˆë‹¤. ?¤ì‹œ ë§ì???ì£¼ì„¸??", locale);        } else {          speak(`?´ë¦„ ${v} ?•ì¸?ˆìŠµ?ˆë‹¤. ?´ë©”???¨ê³„ë¡??´ë™?˜ì‹œ?¤ë©´ ?¤ìŒ?´ë¼ê³?ë§ì???ì£¼ì„¸??`, locale);        }      } else if (step === "email") {        const fixed = normalizeEmail(text);        setEmail(fixed);        if (!isValidEmail(fixed)) {          setError("?´ë©”???•ì‹???¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤. ê³¨ë±…?? ?? ?·ì»´ ?•íƒœë¡?ë§ì???ì£¼ì„¸??");          speak("?´ë©”???•ì‹???¬ë°”ë¥´ì? ?ŠìŠµ?ˆë‹¤.", locale);        } else {          speak(`?´ë©”??${fixed} ?•ì¸?ˆìŠµ?ˆë‹¤. ë¹„ë?ë²ˆí˜¸ ?¨ê³„ë¡??´ë™?˜ì‹œ?¤ë©´ ?¤ìŒ?´ë¼ê³?ë§ì???ì£¼ì„¸??`, locale);        }      } else if (step === "password") {        const v = text.replace(/\s+/g, "");        setPw(v);        if (!isStrongPassword(v)) {          setError("ë¹„ë?ë²ˆí˜¸??8???´ìƒ?´ì–´???©ë‹ˆ??");          speak("ë¹„ë?ë²ˆí˜¸??8???´ìƒ?´ì–´???©ë‹ˆ??", locale);        } else {          speak("ë¹„ë?ë²ˆí˜¸ë¥??€?¥í–ˆ?µë‹ˆ?? ?•ì¸ ?¨ê³„ë¡??´ë™?˜ì‹œ?¤ë©´ ?¤ìŒ?´ë¼ê³?ë§ì???ì£¼ì„¸??", locale);        }      }    };    // ?œì‘    r.start();    pushLog(`?™ start(lang=${r.lang})`);  };  // ê°€??ì²˜ë¦¬  async function handleSignup() {    if (!(cleanName(name).length >= 2 && isValidEmail(email) && isStrongPassword(pw))) {      setError("?…ë ¥??? íš¨?˜ì? ?ŠìŠµ?ˆë‹¤. ê°???ª©???¤ì‹œ ?•ì¸??ì£¼ì„¸??");      speak("?…ë ¥??? íš¨?˜ì? ?ŠìŠµ?ˆë‹¤.", locale);      return;    }    setBusy(true);    setError(null);    try {      const methods = await fetchSignInMethodsForEmail(auth, email);      if (methods && methods.length > 0) {        setError("?´ë? ê°€?…ëœ ?´ë©”?¼ì…?ˆë‹¤. ?¤ë¥¸ ?´ë©”?¼ì„ ?¬ìš©??ì£¼ì„¸??");        speak("?´ë? ê°€?…ëœ ?´ë©”?¼ì…?ˆë‹¤.", locale);        setBusy(false);        return;      }      const cred = await createUserWithEmailAndPassword(auth, email, pw);      try {        await updateProfile(cred.user, { displayName: cleanName(name) });      } catch {}      setStep("done");      speak("?Œì›ê°€?…ì´ ?„ë£Œ?˜ì—ˆ?µë‹ˆ?? ?˜ì˜?©ë‹ˆ??", locale);      alert(`ê°€???„ë£Œ! ?˜ì˜?©ë‹ˆ?? ${name}??);    } catch (e: any) {      setError(e?.message || "ê°€??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");      speak("ê°€??ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.", locale);    } finally {      setBusy(false);    }  }  const wrap: React.CSSProperties = {    maxWidth: 620,    margin: "32px auto",    padding: "0 16px",    fontFamily: "system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif",  };  const title: React.CSSProperties = { fontSize: 22, fontWeight: 900, margin: "12px 0 6px" };  const row: React.CSSProperties = { display: "flex", gap: 8, alignItems: "center", marginBottom: 10 };  const btn: React.CSSProperties = {    border: 0, background: "#2563eb", color: "#fff",    padding: "10px 14px", borderRadius: 10, cursor: "pointer", fontWeight: 800,  };  const ghost: React.CSSProperties = {    border: "2px solid #e2e8f0", background: "#fff", color: "#334155",    padding: "8px 12px", borderRadius: 10, cursor: "pointer", fontWeight: 700,  };  const pill = (ok: boolean) => ({    padding: "6px 10px", borderRadius: 999, fontSize: 12,    background: ok ? "rgba(16,185,129,.15)" : "rgba(239,68,68,.15)",    color: ok ? "#10B981" : "#EF4444", border: `1px solid ${ok ? "#10B981" : "#EF4444"}`  } as React.CSSProperties);  return (    <div style={wrap}>      <h2 style={title}>?—£ï¸??€?”í˜• ?Œì„± ?Œì›ê°€??/h2>      <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 12 }}>        <span style={pill(true)}>HTTPS/localhost {location.protocol === "https:" || location.hostname === "localhost" ? "OK" : "ê¶Œì¥"}</span>        <span style={pill(!!(window.webkitSpeechRecognition || window.SpeechRecognition))}>SpeechRecognition {window.webkitSpeechRecognition || window.SpeechRecognition ? "OK" : "ë¯¸ì???}</span>      </div>      {/* ì§„í–‰ ?•ë³´ */}      <div style={{ marginBottom: 10, color: "#64748b" }}>        ?¨ê³„: {step === "name" ? "?´ë¦„" : step === "email" ? "?´ë©”?? : step === "password" ? "ë¹„ë?ë²ˆí˜¸" : step === "confirm" ? "?•ì¸" : "?„ë£Œ"}      </div>      {/* ?…ë ¥ ì¹´ë“œ */}      <div style={{ border: "1px solid #e2e8f0", borderRadius: 12, padding: 14, marginBottom: 12 }}>        <div style={{ marginBottom: 8 }}>          <b>?´ë¦„</b>: {name || <span style={{ opacity: .6 }}>-</span>}        </div>        <div style={{ marginBottom: 8 }}>          <b>?´ë©”??/b>: {email || <span style={{ opacity: .6 }}>-</span>}        </div>        <div style={{ marginBottom: 8 }}>          <b>ë¹„ë?ë²ˆí˜¸</b>: {pw ? "?â—?â—?â—" : <span style={{ opacity: .6 }}>-</span>}        </div>        {step !== "done" && (          <div style={row}>            <button style={ghost} onClick={listen} disabled={listening}>              {listening ? "?™ ?£ëŠ” ì¤?.." : "?™ ë§í•˜ê¸?}            </button>            {step !== "name" && (              <button                style={ghost}                onClick={() => setStep(step === "email" ? "name" : step === "password" ? "email" : "password")}                disabled={listening}              >                â¬…ï¸ ?´ì „ ?¨ê³„              </button>            )}            {step !== "confirm" && (              <button                style={ghost}                onClick={() => {                  if (step === "name" && cleanName(name).length >= 2) setStep("email");                  else if (step === "email" && isValidEmail(email)) setStep("password");                  else if (step === "password" && isStrongPassword(pw)) setStep("confirm");                  else speak("?„ì¬ ?¨ê³„???…ë ¥??? íš¨?˜ì? ?ŠìŠµ?ˆë‹¤.", locale);                }}                disabled={listening}              >                ?¡ï¸ ?¤ìŒ ?¨ê³„              </button>            )}          </div>        )}      </div>      {/* ?•ì¸ & ê°€??*/}      {step === "confirm" && (        <div style={{ marginBottom: 12, color: "#334155" }}>          ?…ë ¥???•ë³´ë¡?ê°€?…í•©?ˆë‹¤. "ê°€?…í•˜ê¸??¼ê³  ë§í•˜ê±°ë‚˜ ë²„íŠ¼???„ë¥´?¸ìš”.        </div>      )}      <div style={{ display: "flex", gap: 8 }}>        {step !== "done" && (          <button            style={{ ...btn, opacity: step === "confirm" && !busy ? 1 : 0.7 }}            onClick={handleSignup}            disabled={step !== "confirm" || busy}          >            {busy ? "ê°€??ì¤?.." : "ê°€?…í•˜ê¸?}          </button>        )}        <button          style={ghost}          onClick={() => { setName(""); setEmail(""); setPw(""); setStep("name"); }}          disabled={busy || listening}        >          ì´ˆê¸°??        </button>      </div>      {/* ?¤ë¥˜ */}      {error && <div style={{ color: "#dc2626", marginTop: 10 }}>{error}</div>}      {/* ë¡œê·¸ */}      <div style={{ marginTop: 14, padding: 12, background: "#f8fafc", borderRadius: 8, border: "1px solid #e2e8f0" }}>        <div style={{ fontSize: 12, fontWeight: 700, color: "#475569", marginBottom: 8 }}>?¤ STT ë¡œê·¸</div>        <div style={{ height: 140, overflow: "auto", fontSize: 11, fontFamily: "monospace", background: "#0f172a", color: "#e2e8f0", padding: 8, borderRadius: 4 }}>          {log.length === 0 ? <span style={{ color: "#64748b" }}>?Œì„± ?¸ì‹???œì‘?˜ë©´ ë¡œê·¸ê°€ ?œì‹œ?©ë‹ˆ?¤â€?/span> :            log.map((m, i) => <div key={i} style={{ marginBottom: 2 }}>{m}</div>)}        </div>      </div>    </div>  );}