"use strict";
// src/pages/VoiceSignUpPage.tsximport { useEffect, useRef, useState } from "react";import {   createUserWithEmailAndPassword,   signInWithEmailAndPassword} from "firebase/auth";import type {   UserCredential} from "firebase/auth";import { auth, db } from "@/lib/firebase";/** * ?????�일 ?�나�??�나??"?�복" 버전 * - useSettings ?��? 기본 locale?� ko-KR * - 마이??권한 ?�인/?�벨미터/?�리(force kill) ?�장 * - ?�름/?�메??비�?번호 ?�규??검�??�틸 ?�장 * - 브라?��? SpeechRecognition 직접 구동 (?�릭 컨텍?�트?�서 즉시 start) * - Firebase Auth ?�동 (?�원가??로그?? * - TTS ?�드�?(?�성 ?�내) * - HTTPS 체크·가??(보안 강화) * * ?�용�? * 1) ???�일???�로?�트??추�? * 2) ?�우?��? ?�다�???컴포?�트�??�우?�에 ?�결 *    (?�는 App.tsx ?�에??<VoiceSignUpPage /> ?�더) */// ----------------------------------------------------// ?�� HTTPS 체크·가??// ----------------------------------------------------function checkHTTPS(): boolean {  if (window.location.protocol === 'https:') return true;  if (window.location.hostname === 'localhost') return true;  if (window.location.hostname === '127.0.0.1') return true;  return false;}function showHTTPSWarning(): void {  if (!checkHTTPS()) {    alert('?�️ 보안???�해 HTTPS ?�결???�요?�니??\n?�재 HTTP�??�속 중입?�다.');  }}// ----------------------------------------------------// ?�� TTS ?�드�??�틸// ----------------------------------------------------function speak(text: string, rate: number = 1.5): void {  if ('speechSynthesis' in window) {    // 기존 ?�성 중�?    window.speechSynthesis.cancel();        const utterance = new SpeechSynthesisUtterance(text);    utterance.lang = 'ko-KR';    utterance.rate = rate; // 최적 ?�도 1.5    utterance.pitch = 1.0;    utterance.volume = 1.0;        window.speechSynthesis.speak(utterance);  }}// ----------------------------------------------------// ?�� Firebase Auth ?�동// ----------------------------------------------------async function signUpWithFirebase(email: string, password: string): Promise<UserCredential> {  try {    const userCredential = await createUserWithEmailAndPassword(auth, email, password);    return userCredential;  } catch (error: any) {    if (error && typeof error === 'object' && 'code' in error) {      throw new Error(getFirebaseErrorMessage(error.code));    }    throw new Error('?????�는 ?�류가 발생?�습?�다.');  }}async function signInWithFirebase(email: string, password: string): Promise<UserCredential> {  try {    const userCredential = await signInWithEmailAndPassword(auth, email, password);    return userCredential;  } catch (error: any) {    if (error && typeof error === 'object' && 'code' in error) {      throw new Error(getFirebaseErrorMessage(error.code));    }    throw new Error('?????�는 ?�류가 발생?�습?�다.');  }}function getFirebaseErrorMessage(code: string): string {  switch (code) {    case 'auth/email-already-in-use':      return '?��? ?�용 중인 ?�메?�입?�다.';    case 'auth/invalid-email':      return '?�바르�? ?��? ?�메???�식?�니??';    case 'auth/operation-not-allowed':      return '?�메??비�?번호 로그?�이 비활?�화?�어 ?�습?�다.';    case 'auth/weak-password':      return '비�?번호가 ?�무 ?�합?�다. 8???�상?�로 ?�정??주세??';    case 'auth/user-disabled':      return '비활?�화??계정?�니??';    case 'auth/user-not-found':      return '?�록?��? ?��? ?�메?�입?�다.';    case 'auth/wrong-password':      return '?�못??비�?번호?�니??';    case 'auth/too-many-requests':      return '?�무 많�? 로그???�도가 ?�었?�니?? ?�시 ???�시 ?�도??주세??';    default:      return '?�증 �??�류가 발생?�습?�다.';  }}// ----------------------------------------------------// 브라?��? ?�???�전 처리 (webkitSpeechRecognition ?�??// ----------------------------------------------------type SpeechRecognitionErrorCode =  | "no-speech"  | "aborted"  | "audio-capture"  | "network"  | "not-allowed"  | "service-not-allowed"  | "bad-grammar"  | "language-not-supported"  | "unknown";type SRLike = SpeechRecognition & {  // webkitSpeechRecognition???�함};declare global {  interface Window {    webkitSpeechRecognition?: {      new (): SRLike;    };    SpeechRecognition?: {      new (): SRLike;    };  }}// ----------------------------------------------------// 간단 Settings ?��???(기본 ko-KR)// ----------------------------------------------------function useSettingsFallback() {  return { locale: "ko-KR" as const };}// ----------------------------------------------------// ?�� 마이???�틸: 권한/?�벨미터/강제종료// ----------------------------------------------------async function ensureMicPermission(): Promise<void> {  // 권한 강제 ?�인 (권한 ?�롬?�트)  await navigator.mediaDevices.getUserMedia({ audio: true });}type MeterStopper = () => void;/** * 마이???�벨 미터 ?�작 * - callback(v): 0~1 RMS 근사�? * - 반환�? ?��? ?�수 */async function startMicLevelMeter(  callback: (level01: number) => void): Promise<MeterStopper> {  const stream = await navigator.mediaDevices.getUserMedia({    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },  });  const Ctx = window.AudioContext || (window as any).webkitAudioContext;  const ctx = new Ctx();  const source = ctx.createMediaStreamSource(stream);  const analyser = ctx.createAnalyser();  analyser.fftSize = 1024;  source.connect(analyser);  const buf = new Float32Array(analyser.fftSize);  let rafId = 0;  const tick = () => {    analyser.getFloatTimeDomainData(buf);    let sum = 0;    for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];    const rms = Math.sqrt(sum / buf.length); // 0~1 근사    callback(Math.max(0, Math.min(1, rms)));    rafId = requestAnimationFrame(tick);  };  rafId = requestAnimationFrame(tick);  // ?��? ?�수  const stop = () => {    try {      cancelAnimationFrame(rafId);      source.disconnect();      analyser.disconnect();      ctx.close();    } catch {}    try {      stream.getTracks().forEach((t) => t.stop());    } catch {}  };  return stop;}/** 마이???�디??리소??강제 종료??(보수?�으�??�출) */function forceKillMic() {  // ???�복 ?�일?�선 startMicLevelMeter가 리턴?�는 stop?�로 관리되므�?  // ?�기?�는 추�?�?종료???�트�?컨텍?�트�?추적?��? ?�음.  // ?�요???�장 가??}// ----------------------------------------------------// ?�� ?�규??검�??�틸// ----------------------------------------------------function cleanName(raw: string): string {  // ?��?/?�문/공백�??��?, ?�중 공백 ?�일??  return (raw || "")    .replace(/[^a-zA-Z가-??s]/g, "")    .replace(/\s+/g, " ")    .trim();}function normalizeEmail(raw: string): string {  let t = (raw || "").toLowerCase().trim();  // ?��? ?�성 ?�현 치환  // ?? "골뱅?? -> @, "?? -> ".", "?�컴" -> ".com"  t = t    .replace(/\s+/g, " ")    .replace(/골뱅?????�이??g, "@")    .replace(/??s?/g, ".")    .replace(/?�컴|??�???�?g, ".com")    .replace(/\s+/g, "");  // 공백 ?�거, ?�한 ?��? ?�메??발화 보정  t = t    .replace(/지메일|gmail\.?com/g, "gmail.com")    .replace(/?�이�?naver\.?com/g, "naver.com")    .replace(/?�음|daum\.?net/g, "daum.net")    .replace(/?�후|yahoo\.?com/g, "yahoo.com");  return t;}function isValidEmail(v: string): boolean {  if (!v) return false;  // 간단/견고??검�?  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);}function isStrongPassword(v: string): boolean {  return (v || "").length >= 8; // ?�요??규칙 강화}// ----------------------------------------------------// ?�� 메인 컴포?�트// ----------------------------------------------------type Step = 0 | 1 | 2 | 3; // 0: ?�름, 1: ?�메?? 2: 비번, 3: ?�인/?�출type Mode = "signup" | "signin"; // ?�원가???�는 로그??모드export default function VoiceSignUpPage() {  const { locale } = useSettingsFallback();  const safeLocale = locale || "ko-KR";  // HTTPS 체크  useEffect(() => {    showHTTPSWarning();  }, []);  const [mode, setMode] = useState<Mode>("signup");  const [step, setStep] = useState<Step>(0);  const [name, setName] = useState("");  const [email, setEmail] = useState("");  const [pw, setPw] = useState("");  const [listening, setListening] = useState(false);  const [error, setError] = useState<string | null>(null);  const [loading, setLoading] = useState(false);  // STT 로그 ?�시 (콘솔 ??봐도 ?�인 ?�악)  const [srLog, setSrLog] = useState<string[]>([]);  const log = (m: string) => setSrLog((xs) => [...xs.slice(-80), m]);  // 마이???�벨 미터 ?�태  const [micLevel, setMicLevel] = useState(0); // 0~1  const meterStopRef = useRef<null | (() => void)>(null);  const [meterOn, setMeterOn] = useState(false);  const mounted = useRef(true);  useEffect(() => {    mounted.current = true;    return () => {      mounted.current = false;      try {        meterStopRef.current?.();      } catch {}      forceKillMic();    };  }, []);  // 미터 ?�작/종료  async function startMeter() {    try {      await ensureMicPermission();      meterStopRef.current = await startMicLevelMeter((v) => setMicLevel(v));      setMeterOn(true);      speak("마이?��? ?�성?�되?�습?�다.");    } catch {      setError("마이??권한???�요?�니?? 주소�??�쪽 ?��?�서 ?�용?�로 변경하?�요.");      speak("마이??권한???�요?�니??");    }  }  function stopMeter() {    try {      meterStopRef.current?.();    } catch {}    meterStopRef.current = null;    setMeterOn(false);    setMicLevel(0);    speak("마이?��? 비활?�화?�었?�니??");  }  // ?�성 ?�기 (브라?��? SR 직접)  const doListen = (field: "name" | "email" | "pw") => {    if (listening) return;    setError(null);    setListening(true);    // TTS ?�드�?    if (field === "name") {      speak("?�름??말�???주세??");    } else if (field === "email") {      speak("?�메?�을 말�???주세??");    } else {      speak("비�?번호�?말�???주세??");    }    try {      const SR = window.webkitSpeechRecognition || window.SpeechRecognition;      if (!SR) {        setListening(false);        setError("??브라?��????�성 ?�식??지?�하지 ?�습?�다. Chrome/Edge ?�용??권장?�니??");        speak("??브라?��????�성 ?�식??지?�하지 ?�습?�다.");        return;      }      // 반드???�용???�릭 ?�들??컨텍?�트?�서 즉시 ?�성/?�작 (await 금�?)      const r: SRLike = new SR();      r.lang = safeLocale;      r.interimResults = true;      r.maxAlternatives = 2;      r.continuous = false;      let finalText = "";      let interimText = "";      r.onstart = () => log("??onstart");      r.onaudiostart = () => log("??onaudiostart");      r.onsoundstart = () => log("??onsoundstart");      r.onspeechstart = () => log("??onspeechstart");      r.onresult = (e: SpeechRecognitionEvent) => {        try {          for (let i = e.resultIndex; i < e.results.length; i++) {            const res = e.results[i];            const alt = res && res[0];            const t = (alt?.transcript || "").trim();            if (!t) continue;            if (res.isFinal) finalText = t;            else interimText = t;          }          log(`?�� onresult: "${finalText || interimText}"`);        } catch {}      };      r.onerror = (e: any) => {        const code: SpeechRecognitionErrorCode = e?.error || "unknown";        log(`??onerror: ${code}`);        const errorMsg =           code === "not-allowed"            ? "마이??권한??거�??�었?�니?? 주소�??�쪽 ?��?�서 ?�용?�로 변경하?�요."            : code === "audio-capture"            ? "마이???�치�?찾을 ???�습?�다. OS???�력 ?�치�??�인?�세??"            : code === "no-speech"            ? "말소리�? 감�??��? ?�았?�니?? 조금 ???�게 ?�렷?�게 말�???주세??"            : "?�성 ?�식 ?�류가 발생?�습?�다. ?�시 ?�도??주세??";                setError(errorMsg);        speak(errorMsg);      };      r.onend = () => {        log("??onend");        setListening(false);        const text = (finalText || interimText || "").trim();        if (!text) {          speak("?�성??감�??��? ?�았?�니?? ?�시 ?�도??주세??");          return;        }        if (field === "name") {          const cleaned = cleanName(text);          setName(cleaned);          speak(`?�름??${cleaned}�??�정?�었?�니??`);        } else if (field === "email") {          const fixed = normalizeEmail(text);          setEmail(fixed);          if (!isValidEmail(fixed)) {            setError("?�메???�식???�바르�? ?�습?�다. ?�시 말�???주세??");            speak("?�메???�식???�바르�? ?�습?�다. ?�시 말�???주세??");          } else {            speak(`?�메?�이 ${fixed}�??�정?�었?�니??`);          }        } else {          const val = text.replace(/\s+/g, "");          setPw(val);          if (!isStrongPassword(val)) {            setError("비�?번호??8???�상?�어???�니??");            speak("비�?번호??8???�상?�어???�니??");          } else {            speak("비�?번호가 ?�정?�었?�니??");          }        }      };      r.start(); // 즉시 ?�작      log(`?�� start(lang=${r.lang})`);    } catch (err: any) {      setListening(false);      setError(err?.message || "?�성 ?�식 초기???�패");      speak("?�성 ?�식 초기?�에 ?�패?�습?�다.");    }  };  // ?�계 검�?  const stepValid =    (step === 0 && cleanName(name.trim()).length >= 2) ||    (step === 1 && isValidEmail(email.trim())) ||    (step === 2 && isStrongPassword(pw)) ||    step === 3;  const next = () => {    setStep((s) => (Math.min(3, s + 1) as Step));    if (step < 3) {      const nextStep = step + 1;      if (nextStep === 1) speak("?�름???�인?�었?�니?? ?�메?�을 ?�력??주세??");      else if (nextStep === 2) speak("?�메?�이 ?�인?�었?�니?? 비�?번호�??�력??주세??");      else if (nextStep === 3) speak("모든 ?�보가 ?�력?�었?�니?? ?�인 ??가?�해 주세??");    }  };    const prev = () => {    setStep((s) => (Math.max(0, s - 1) as Step));    if (step > 0) {      const prevStep = step - 1;      if (prevStep === 0) speak("?�름 ?�력 ?�계�??�아갔습?�다.");      else if (prevStep === 1) speak("?�메???�력 ?�계�??�아갔습?�다.");      else if (prevStep === 2) speak("비�?번호 ?�력 ?�계�??�아갔습?�다.");    }  };  // Firebase Auth ?�출  async function submitAuth() {    setError(null);    setLoading(true);        try {      if (mode === "signup") {        // ?�원가??        const userCredential = await signUpWithFirebase(email, pw);        speak(`?�원가?�이 ?�료?�었?�니?? ?�영?�니?? ${name}??`);        alert(`?�� ?�원가???�료!\n?�름: ${name}\n?�메?? ${email}\nUID: ${userCredential.user.uid}`);                // ?�름 ?�데?�트 (?�택?�항)        // await updateProfile(userCredential.user, { displayName: name });              } else {        // 로그??        const userCredential = await signInWithFirebase(email, pw);        speak(`로그?�이 ?�료?�었?�니?? ?�영?�니?? ${userCredential.user.displayName || email}??`);        alert(`?�� 로그???�료!\n?�메?? ${email}\nUID: ${userCredential.user.uid}`);      }            // TODO: ?�제 ?�우??(?? 메인 ?�이지�??�동)      // navigate('/dashboard');          } catch (e: any) {      setError(e?.message || "?�증 �??�류가 발생?�습?�다.");      speak(e?.message || "?�증 �??�류가 발생?�습?�다.");    } finally {      setLoading(false);    }  }  // 모드 ?�환  const toggleMode = () => {    const newMode = mode === "signup" ? "signin" : "signup";    setMode(newMode);    setStep(0);    setName("");    setEmail("");    setPw("");    setError(null);        if (newMode === "signup") {      speak("?�원가??모드�??�환?�었?�니??");    } else {      speak("로그??모드�??�환?�었?�니??");    }  };  // ---------------- UI ?��???----------------  const wrap: React.CSSProperties = {    maxWidth: 560,    margin: "32px auto",    padding: "0 16px",    fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",  };  const title: React.CSSProperties = { fontSize: 22, fontWeight: 800, margin: "12px 0 4px" };  const sub: React.CSSProperties = { color: "#64748b", marginBottom: 16 };  const row: React.CSSProperties = { display: "flex", gap: 8, alignItems: "center" };  const btn: React.CSSProperties = {    border: 0,    background: "#2563eb",    color: "#fff",    padding: "10px 14px",    borderRadius: 10,    cursor: "pointer",    fontWeight: 700,  };  const ghost: React.CSSProperties = {    border: "2px solid #e2e8f0",    background: "#fff",    color: "#334155",    padding: "8px 12px",    borderRadius: 10,    cursor: "pointer",    fontWeight: 700,  };  const input: React.CSSProperties = {    flex: 1,    border: "2px solid #e2e8f0",    borderRadius: 10,    padding: "10px 12px",    outline: "none",  };  const modeToggle: React.CSSProperties = {    ...ghost,    background: mode === "signup" ? "#10b981" : "#f59e0b",    color: "#fff",    borderColor: mode === "signup" ? "#10b981" : "#f59e0b",  };  return (    <div style={wrap}>      {/* HTTPS ?�태 ?�시 */}      <div style={{         padding: "8px 12px",         background: checkHTTPS() ? "#dcfce7" : "#fef3c7",         color: checkHTTPS() ? "#166534" : "#92400e",        borderRadius: 8,        marginBottom: 16,        fontSize: 12,        textAlign: "center"      }}>        {checkHTTPS() ? "?�� HTTPS 보안 ?�결" : "?�️ HTTP ?�결 (보안 권장)"}      </div>      <h2 style={title}>        {mode === "signup" ? "?�성 ?�원가?? : "?�성 로그??}      </h2>            {/* 모드 ?�환 버튼 */}      <div style={{ marginBottom: 16 }}>        <button style={modeToggle} onClick={toggleMode}>          {mode === "signup" ? "?�� 로그??모드�??�환" : "?�� ?�원가??모드�??�환"}        </button>      </div>      <div style={sub}>        ?�어: {safeLocale}{" "}        <span style={{ marginLeft: 8 }}>          {meterOn ? (            <button style={ghost} onClick={stopMeter}>?�� 미터 종료</button>          ) : (            <button style={ghost} onClick={startMeter}>?�� 미터 ?�작</button>          )}        </span>      </div>      {/* 마이???�력 ?�벨 ?�시 */}      <div style={{ margin: "8px 0 16px" }}>        <div style={{ fontSize: 12, color: "#64748b", marginBottom: 4 }}>          마이???�력 ?�벨{" "}          {listening ? "?�� ?�성 ?�식 �? : meterOn ? (micLevel > 0.1 ? "?�� ?�력 감�?" : "???기중") : "(꺼짐)"}        </div>        <div style={{ height: 8, background: "#e2e8f0", borderRadius: 6, overflow: "hidden" }}>          <div            style={{              height: "100%",              width: `${listening ? 100 : Math.round(micLevel * 100)}%`,              background: listening ? "#2563eb" : "#10b981",              transition: "width .08s",            }}          />        </div>      </div>      {/* 진행 �?*/}      <div style={{ height: 8, background: "#e2e8f0", borderRadius: 6, overflow: "hidden", margin: "12px 0 24px" }}>        <div          style={{            height: "100%",            width: `${(step + 1) * 25}%`,            background: "#2563eb",            transition: "width .15s",          }}        />      </div>      {step === 0 && (        <section>          <h3 style={title}>1/4 ?�름 말하�?/h3>          <p style={sub}>?? "?�름?� ?�재�? / "백승�?</p>          <div style={row}>            <input              style={input}              aria-label="?�름"              placeholder="?�름"              value={name}              onChange={(e) => setName(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("name")}              disabled={listening}              title="?�름???�성?�로 ?�력"            >              {listening ? "?�는 �?.." : "?�� 말하�?}            </button>          </div>        </section>      )}      {step === 1 && (        <section>          <h3 style={title}>2/4 ?�메??말하�?/h3>          <p style={sub}>?? "?�메?��? jaeman 골뱅??지메일 ??�?</p>          <div style={row}>            <input              style={input}              aria-label="?�메??              placeholder="?�메??              value={email}              onChange={(e) => setEmail(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("email")}              disabled={listening}              title="?�메?�을 ?�성?�로 ?�력"            >              {listening ? "?�는 �?.." : "?�� 말하�?}            </button>          </div>          {!isValidEmail(email) && email && (            <div style={{ color: "#dc2626", marginTop: 8 }}>?�바�??�메???�식???�닙?�다.</div>          )}        </section>      )}      {step === 2 && (        <section>          <h3 style={title}>3/4 비�?번호 말하�?/h3>          <p style={sub}>8???�상 권장. (공개 ?�소?�서??직접 ?�력 권장)</p>          <div style={row}>            <input              style={input}              type="password"              aria-label="비�?번호"              placeholder="비�?번호"              value={pw}              onChange={(e) => setPw(e.target.value)}            />            <button              style={ghost}              onClick={() => doListen("pw")}              disabled={listening}              title="비�?번호�??�성?�로 ?�력"            >              {listening ? "?�는 �?.." : "?�� 말하�?}            </button>          </div>          {!isStrongPassword(pw) && pw && (            <div style={{ color: "#dc2626", marginTop: 8 }}>비�?번호??8???�상?�어???�니??</div>          )}        </section>      )}      {step === 3 && (        <section>          <h3 style={title}>4/4 ?�인 ??{mode === "signup" ? "가?? : "로그??}</h3>          <ul style={{ lineHeight: 1.8, color: "#334155" }}>            <li><b>?�름</b>: {name || "-"}</li>            <li><b>?�메??/b>: {email || "-"}</li>          </ul>          <p style={{ color: "#64748b" }}>??비�?번호??보안???�시?��? ?�습?�다.</p>        </section>      )}      {/* ?�류 */}      {error && <div style={{ color: "#dc2626", marginTop: 8 }}>{error}</div>}      {/* STT 로그 */}      <div        style={{          marginTop: 16,          padding: 12,          background: "#f8fafc",          borderRadius: 8,          border: "1px solid #e2e8f0",        }}      >        <div style={{ fontSize: 12, fontWeight: 600, color: "#475569", marginBottom: 8 }}>          ?�� STT 로그:        </div>        <div          style={{            height: 120,            overflow: "auto",            fontSize: 11,            fontFamily: "monospace",            background: "#0f172a",            color: "#e2e8f0",            padding: 8,            borderRadius: 4,          }}        >          {srLog.length === 0 ? (            <span style={{ color: "#64748b" }}>?�성 ?�식???�작?�면 로그가 ?�시?�니??..</span>          ) : (            srLog.map((msg, i) => <div key={i} style={{ marginBottom: 2 }}>{msg}</div>)          )}        </div>      </div>      {/* ?�비게이??*/}      <div style={{ display: "flex", gap: 8, marginTop: 16 }}>        <button style={ghost} onClick={prev} disabled={step === 0}>          ?�전        </button>        {step < 3 ? (          <button            style={{ ...btn, opacity: stepValid ? 1 : 0.6 }}            onClick={next}            disabled={!stepValid}          >            ?�음          </button>        ) : (          <button            style={{ ...btn, opacity: stepValid ? 1 : 0.6 }}            onClick={submitAuth}            disabled={!stepValid || loading}          >            {loading ? "처리 �?.." : mode === "signup" ? "가?�하�? : "로그??}          </button>        )}      </div>      {/* TTS ?�스??버튼 */}      <div style={{ marginTop: 16, textAlign: "center" }}>        <button           style={{ ...ghost, fontSize: 12, padding: "6px 10px" }}          onClick={() => speak("?�성 ?�드백이 ?�상 ?�동?�고 ?�습?�다.")}        >          ?�� TTS ?�스??        </button>      </div>    </div>  );}
