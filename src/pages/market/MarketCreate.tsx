import React, { useCallback, useMemo, useRef, useState } from "react";import { useNavigate } from "react-router-dom";import { createProduct } from "@/services/productService";type Mode = "manual" | "auto";type FieldKey = "title" | "category" | "description" | "price";type ProductValues = {  title: string;  category: string;  description: string;  price: number | "";};type AIResult = Partial<{  title: string;  category: string;  description: string;  price: number; // ?«ì ê¶Œì¥}>;const initialValues: ProductValues = {  title: "",  category: "",  description: "",  price: "",};// ---- ?” ?œë²„ ?°ê²°ë§?ê°ˆì•„?¼ìš°ë©??˜ëŠ” AI ë¶„ì„ ?¨ìˆ˜ (?ˆì‹œ) ----async function analyzeProductFromImage(file: File, signal?: AbortSignal): Promise<AIResult> {  // ?¬ê¸°ë¥??¤ì œ ë°±ì—”???”ë“œ?¬ì¸?¸ë¡œ êµì²´?˜ì„¸??  // ??   // const fd = new FormData();  // fd.append("image", file);  // const res = await fetch("/api/vision/analyze-market", { method: "POST", body: fd, signal });  // if (!res.ok) throw new Error(await res.text());  // return (await res.json()) as AIResult;  // ?€?€ Demo fallback (?¤ì„œë²??°ê²° ???„ì‹œ ëª¨ì˜ê°? ?€?€  await new Promise((r) => setTimeout(r, 900));  return {    title: "ê°€ì£??¬ë¡œ?¤ë°± (?íƒœ Aê¸?",    category: "ê°€ë°?,    description: "ë¶€?œëŸ¬???Œê?ì£??¬ë¡œ?¤ë°±. ?´ì¥ ?¬ì¼“ 3ê°? ?í™œ ?¤í¬?˜ì¹˜ ê±°ì˜ ?†ìŒ.",    price: 38000,  };}// ???¤ì œ createProduct ?¨ìˆ˜ë¥??¬ìš©?˜ë?ë¡????¨ìˆ˜?????´ìƒ ?„ìš”?˜ì? ?ŠìŒexport default function MarketCreate() {  const navigate = useNavigate();    // ëª¨ë“œ/?´ë?ì§€/?„ë“œ ?íƒœ  const [mode, setMode] = useState<Mode>("manual");  const [file, setFile] = useState<File | null>(null);  const [previewUrl, setPreviewUrl] = useState<string>("");  // ?¬ìš©???…ë ¥ê°?+ AI ?œì•ˆê°?  const [values, setValues] = useState<ProductValues>(initialValues);  const [ai, setAI] = useState<AIResult | null>(null);  // ?´ë–¤ ?„ë“œë¥??¬ìš©?ê? ì§ì ‘ ?˜ì •?ˆëŠ”ì§€ (trueë©??ë™ë¶„ì„????–´?°ì? ?ŠìŒ)  const [edited, setEdited] = useState<Record<FieldKey, boolean>>({    title: false,    category: false,    description: false,    price: false,  });  // ë¶„ì„ ?íƒœ  const [status, setStatus] = useState<"idle" | "running" | "done" | "error">("idle");  const [error, setError] = useState<string>("");  // ì¤‘ë³µ ë¶„ì„ ë°©ì?/ì·¨ì†Œë¥??„í•œ ref  const currentAnalysis = useRef<{ abort?: AbortController; fileSig?: string } | null>(null);  // ?Œì¼ ê³ ìœ  ?œê·¸?ˆì²˜ (ê°™ì? ?Œì¼ ?°ì† ë¶„ì„ ë°©ì????œìš© ê°€??  const fileSig = useMemo(() => {    if (!file) return "";    return `${file.name}-${file.size}-${file.lastModified}`;  }, [file]);  // ---- UI: ?„ë“œ ?˜ì • ì²˜ë¦¬ (?˜ì •?˜ë©´ ?´ë‹¹ ?„ë“œ ? ê¸ˆ) ----  const onChangeField = useCallback(    (key: FieldKey, raw: string) => {      setValues((prev) => {        if (key === "price") {          const num = raw === "" ? "" : Number(raw.replace(/,/g, ""));          return { ...prev, price: Number.isFinite(num as number) ? (num as number) : "" };        }        return { ...prev, [key]: raw };      });      setEdited((e) => ({ ...e, [key]: true })); // ?¬ìš©??ì§ì ‘ ?˜ì • ?œì‹œ    },    []  );  // ---- ?¬ì§„ ? íƒ ----  const onPickFile = useCallback(    (f: File | null) => {      console.log(`[DEBUG] ?Œì¼ ? íƒ: mode=${mode}, file=${f?.name}`);            // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹       setFile(f);      setError("");      setAI(null);      setStatus("idle");      if (f) {        const url = URL.createObjectURL(f);        setPreviewUrl(url);      } else {        setPreviewUrl("");      }            // ??ê·œì¹™: ?¬ì§„ ? íƒë§??˜ë©´ ?„ë“œ??ê·¸ë?ë¡?? ì?      // ???ë™ ëª¨ë“œ???Œë§Œ, ?¬ì§„ ? íƒ ??AI ë¶„ì„ ?¤í–‰      if (f && mode === "auto") {        console.log(`[DEBUG] ?ë™ ëª¨ë“œ: AI ë¶„ì„ ?¤í–‰`);        runAnalysis("image-selected", f);      } else if (f) {        console.log(`[DEBUG] ?˜ë™ ëª¨ë“œ: ?Œì¼ë§?? íƒ, AI ë¶„ì„ ?¤í–‰ ?ˆí•¨`);      }    },    [mode]  );  // ---- ëª¨ë“œ ?„í™˜ ----  const onToggleMode = useCallback(    (m: Mode) => {      setMode(m);      setError("");      if (m === "auto" && file) {        // ?ë™ ëª¨ë“œë¡??„í™˜?ˆê³  ?¬ì§„???ˆìœ¼ë©?ì¦‰ì‹œ ë¶„ì„        runAnalysis("mode-toggle", file);      }    },    [file]  );  // ---- AI ë¶„ì„ ?¤í–‰ ----  const runAnalysis = useCallback(    async (reason: "image-selected" | "mode-toggle", targetFile?: File) => {      const f = targetFile ?? file;      if (!f) return;      // ?´ì „ ë¶„ì„ ì·¨ì†Œ      if (currentAnalysis.current?.abort) {        currentAnalysis.current.abort.abort();      }      const abort = new AbortController();      currentAnalysis.current = { abort, fileSig };      try {        setStatus("running");        const result = await analyzeProductFromImage(f, abort.signal);        setAI(result || null);        // ë³‘í•© ê·œì¹™: ?¬ìš©?ê? ?˜ì •???„ë“œ??? ì?, ?˜ì •?˜ì? ?Šì? ?„ë“œ??AI ê°’ìœ¼ë¡?ì±„ì?        setValues((prev) => {          const merged: ProductValues = { ...prev };          if (!edited.title && result?.title) merged.title = result.title;          if (!edited.category && result?.category) merged.category = result.category;          if (!edited.description && result?.description) merged.description = result.description;          if (!edited.price && typeof result?.price === "number") merged.price = result.price;          return merged;        });        setStatus("done");      } catch (e: any) {        if (e?.name === "AbortError") {          // ì·¨ì†Œ??ê²½ìš°??ì¡°ìš©??ë¬´ì‹œ          return;        }        console.error("[AI ERROR]", e);        setError(e?.message || "ë¶„ì„ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆì–´??");        setStatus("error");      }    },    [file, fileSig, edited]  );  // ---- ?±ë¡(?€?? ----  const onSubmit = useCallback(    async (ev: React.FormEvent) => {      ev.preventDefault();      // ê°„ë‹¨??? íš¨??ê²€???ˆì‹œ      if (!values.title || !values.category || !values.description || values.price === "") {        alert("?œëª©/ì¹´í…Œê³ ë¦¬/?¤ëª…/ê°€ê²©ì„ ëª¨ë‘ ?…ë ¥??ì£¼ì„¸??");        return;      }            // ê°€ê²?? íš¨??ê²€??(0ë³´ë‹¤ ì»¤ì•¼ ??      if (typeof values.price === "number" && values.price <= 0) {        alert("ê°€ê²©ì? 0ë³´ë‹¤ ì»¤ì•¼ ?©ë‹ˆ??");        return;      }      try {        setStatus("running");                // ???¤ì œ createProduct ?¨ìˆ˜ ?¬ìš©        const newId = await createProduct(values, file ?? undefined);        console.log("[CREATE] newId =", newId);   // ?”ë²„ê¹?                setStatus("done");        alert("?í’ˆ???±ë¡?˜ì—ˆ?µë‹ˆ??");                // ??ë°˜í™˜??doc.idë¡??¤ë¹„ê²Œì´??        navigate(`/market/${newId}`);              } catch (e: any) {        console.error("[SAVE ERROR]", e);        alert("?±ë¡ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆì–´??");        setStatus("error");      }    },    [values, file, navigate]  );  // ---- UI êµ¬ì„± ----  return (    <div className="mx-auto max-w-3xl p-4">      <h1 className="text-2xl font-bold mb-4">?í’ˆ ?±ë¡</h1>      {/* ëª¨ë“œ ? ê? */}      <div className="flex gap-2 mb-4">        <button          type="button"          onClick={() => onToggleMode("manual")}          className={`px-3 py-2 rounded ${mode === "manual" ? "bg-black text-white" : "bg-gray-200"}`}        >          ?˜ë™ ëª¨ë“œ        </button>        <button          type="button"          onClick={() => onToggleMode("auto")}          className={`px-3 py-2 rounded ${mode === "auto" ? "bg-black text-white" : "bg-gray-200"}`}        >          ?ë™ ëª¨ë“œ        </button>      </div>      {/* ?ˆë‚´ ë°°ì? */}      <p className="text-sm text-gray-600 mb-4">        {mode === "manual"          ? "?˜ë™ ëª¨ë“œ: ?¬ì§„??? íƒ?´ë„ AI ë¶„ì„???ë™ ?¤í–‰?˜ì? ?ŠìŠµ?ˆë‹¤."          : "?ë™ ëª¨ë“œ: ?¬ì§„ ? íƒ ?ëŠ” ëª¨ë“œ ?„í™˜ ??AIê°€ ?ë™?¼ë¡œ ë¶„ì„?©ë‹ˆ??"}      </p>      {/* ?¬ì§„ ?…ë¡œ??+ ?„ë¦¬ë·?*/}      <div className="mb-4">        <label className="block text-sm font-medium mb-1">?í’ˆ ?´ë?ì§€</label>        <input          type="file"          accept="image/*"          onChange={(e) => onPickFile(e.target.files?.[0] ?? null)}        />        {previewUrl && (          <div className="mt-3">            <img              src={previewUrl}              alt="preview"              className="w-full max-h-72 object-contain border rounded"            />          </div>        )}      </div>      {/* ??*/}      <form onSubmit={onSubmit} className="space-y-4">        <Field          label="?œëª©"          value={values.title}          onChange={(v) => onChangeField("title", v)}          locked={edited.title}        />        <Field          label="ì¹´í…Œê³ ë¦¬"          value={values.category}          onChange={(v) => onChangeField("category", v)}          locked={edited.category}        />        <TextArea          label="?¤ëª…"          value={values.description}          onChange={(v) => onChangeField("description", v)}          locked={edited.description}        />        <Field          label="ê°€ê²?          type="number"          placeholder="?«ìë§??…ë ¥"          value={values.price === "" ? "" : String(values.price)}          onChange={(v) => onChangeField("price", v)}          locked={edited.price}        />        {/* ?íƒœ/?ëŸ¬ ?œì‹œ */}        {status === "running" && (          <p className="text-sm text-blue-600">ì²˜ë¦¬ ì¤‘â€?/p>        )}        {error && (          <p className="text-sm text-red-600">?¤ë¥˜: {error}</p>        )}        <div className="pt-2">          <button            type="submit"            className="px-4 py-2 rounded bg-blue-600 text-white disabled:opacity-60"            disabled={status === "running"}          >            ?±ë¡          </button>        </div>      </form>      {/* (? íƒ) ?”ë²„ê·?ë¸”ë¡: ìµœê·¼ AI ?œì•ˆ ?•ì¸??*/}      {ai && (        <details className="mt-6">          <summary className="cursor-pointer text-sm text-gray-500">AI ?œì•ˆê°?ë³´ê¸°(?”ë²„ê·?</summary>          <pre className="text-xs bg-gray-50 p-2 rounded border mt-2">{JSON.stringify(ai, null, 2)}</pre>        </details>      )}      {/* ë³´ë¥˜ ê¸°ëŠ¥: AI ë²„íŠ¼ ê°•ì œ ??–´?°ê¸° (UI ?¨ê?) */}      {/*       <button onClick={() => forceOverwriteWithAI()} className="hidden">AIë¡?ê°•ì œ ??–´?°ê¸°</button>      */}    </div>  );}// ---- ?¬ì‚¬??ê°€?¥í•œ ?Œí˜• ?…ë ¥ ì»´í¬?ŒíŠ¸??----function Field(props: {  label: string;  value: string | number | "";  onChange: (v: string) => void;  locked?: boolean;  type?: string;  placeholder?: string;}) {  const { label, value, onChange, locked, type = "text", placeholder } = props;  return (    <div>      <label className="block text-sm font-medium mb-1">        {label}{" "}        {locked && (          <span className="ml-2 text-[11px] px-2 py-[2px] rounded bg-yellow-100 text-yellow-800 align-middle">            ?˜ì •???ë™ë¶„ì„ ??–´?°ê¸° ê¸ˆì?)          </span>        )}      </label>      <input        className="w-full border rounded px-3 py-2"        type={type}        placeholder={placeholder}        value={value}        onChange={(e) => onChange(e.target.value)}      />    </div>  );}function TextArea(props: {  label: string;  value: string;  onChange: (v: string) => void;  locked?: boolean;}) {  const { label, value, onChange, locked } = props;  return (    <div>      <label className="block text-sm font-medium mb-1">        {label}{" "}        {locked && (          <span className="ml-2 text-[11px] px-2 py-[2px] rounded bg-yellow-100 text-yellow-800 align-middle">            ?˜ì •???ë™ë¶„ì„ ??–´?°ê¸° ê¸ˆì?)          </span>        )}      </label>      <textarea        className="w-full border rounded px-3 py-2 min-h-28"        value={value}        onChange={(e) => onChange(e.target.value)}      />    </div>  );} 