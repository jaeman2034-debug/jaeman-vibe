import { useEffect, useState } from 'react';import { Link, useNavigate } from 'react-router-dom';import { collection, query, orderBy, onSnapshot, where } from 'firebase/firestore';import { db } from '@/lib/firebase';import SearchBox from '../../components/search/SearchBox';import FavoriteButton from '../../components/favorite/FavoriteButton';import StatusBadge from '../../components/market/StatusBadge';import DistanceBadge from '../../components/market/DistanceBadge';import Thumbnail from '../../components/ui/Thumbnail';import { getUserLocation } from '@/lib/location';import { useAuth } from '@/lib/auth';import { getFirstImageUrl } from '@/lib/images';interface MarketItem {  id: string;  title: string;  price: number;  description: string;  images: string[];  sellerId: string; // ownerId ??sellerIdë¡?ë³€ê²?  createdAt: any;  status: 'active' | 'reserved' | 'sold'; // ItemStatus ?€?…ê³¼ ?¼ì¹˜  geo?: { lat: number; lng: number; geohash: string; accuracy?: number; ts?: number } | null;  ai?: {    category?: string;    condition?: string;    tags?: string[];    brand?: string;    color?: string;  };}export default function MarketList() {  const { user } = useAuth();  const [items, setItems] = useState<MarketItem[]>([]);  const [loading, setLoading] = useState(true);  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);  const [collectionType, setCollectionType] = useState<'products' | 'market'>('products');  const navigate = useNavigate();  const uid = user?.uid;  useEffect(() => {    const loadUserLocation = async () => {      try {        const location = await getUserLocation();        setUserLocation(location);      } catch (error) {        console.log('?¬ìš©???„ì¹˜ë¥?ê°€?¸ì˜¬ ???†ìŠµ?ˆë‹¤:', error);        // ?„ì¹˜ ?•ë³´ê°€ ?†ì–´??ê³„ì† ì§„í–‰      }    };    loadUserLocation();  }, []);  useEffect(() => {    const q = query(      collection(db, collectionType),       ...(collectionType === 'products' ? [where('isDeleted', '!=', true)] : []), // productsë§?isDeleted ?„í„°      orderBy('createdAt', 'desc')    );        const unsubscribe = onSnapshot(q, (snapshot) => {      const marketItems = snapshot.docs.map(doc => ({        id: doc.id,        ...doc.data()      })) as MarketItem[];            setItems(marketItems);      setLoading(false);    });    return () => unsubscribe();  }, [collectionType]);  // AI ì»¨ë””??ë°°ì? ?‰ìƒ  const getConditionColor = (condition?: string) => {    switch (condition) {      case 'A': return { bg: '#dcfce7', text: '#166534', border: '#bbf7d0' };      case 'B': return { bg: '#fef3c7', text: '#92400e', border: '#fde68a' };      case 'C': return { bg: '#fee2e2', text: '#991b1b', border: '#fecaca' };      default: return { bg: '#f3f4f6', text: '#6b7280', border: '#d1d5db' };    }  };  // ê²€??ê²°ê³¼ ì²˜ë¦¬  const handleSearchResults = (results: any[]) => {    if (results.length > 0) {      // ê²€??ê²°ê³¼ê°€ ?ˆìœ¼ë©?ê²€???˜ì´ì§€ë¡??´ë™      navigate(`/search?q=${encodeURIComponent(results[0]?.title || '')}`);    }  };  if (loading) {    return (      <div style={{         padding: 32,         textAlign: 'center',        minHeight: '60vh',        display: 'flex',        flexDirection: 'column',        alignItems: 'center',        justifyContent: 'center'      }}>        <div style={{           width: 48,           height: 48,           border: '4px solid #f3f3f3',          borderTop: '4px solid #007bff',          borderRadius: '50%',          animation: 'spin 1s linear infinite',          marginBottom: 16        }}></div>        <p style={{ fontSize: 18, color: '#666', margin: 0 }}>?í’ˆ ëª©ë¡??ë¶ˆëŸ¬?¤ëŠ” ì¤?..</p>        <style>{`          @keyframes spin {            0% { transform: rotate(0deg); }            100% { transform: rotate(360deg); }          }        `}</style>      </div>    );  }  return (    <div style={{ maxWidth: 1200, margin: '0 auto', padding: 16 }}>      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>        <h1 style={{ fontSize: 28, fontWeight: 700 }}>?›’ ?¤í¬ì¸?ë§ˆì¼“</h1>        <div style={{ display: 'flex', gap: 12 }}>          {/* ì»¬ë ‰??? ê? ë²„íŠ¼ */}          <div style={{             display: 'flex',             backgroundColor: '#f3f4f6',             borderRadius: 8,             padding: 4,            gap: 4          }}>            <button              onClick={() => setCollectionType('products')}              style={{                padding: '8px 16px',                backgroundColor: collectionType === 'products' ? '#2563eb' : 'transparent',                color: collectionType === 'products' ? 'white' : '#374151',                border: 'none',                borderRadius: 6,                fontWeight: 600,                cursor: 'pointer',                fontSize: 14              }}            >              Products            </button>            <button              onClick={() => setCollectionType('market')}              style={{                padding: '8px 16px',                backgroundColor: collectionType === 'market' ? '#2563eb' : 'transparent',                color: collectionType === 'market' ? 'white' : '#374151',                border: 'none',                borderRadius: 6,                fontWeight: 600,                cursor: 'pointer',                fontSize: 14              }}            >              Market            </button>          </div>          <Link             to={uid ? "/favorites" : "/login"}            style={{              padding: '12px 24px',              backgroundColor: '#f3f4f6',              color: '#374151',              textDecoration: 'none',              borderRadius: 8,              fontWeight: 600,              display: 'flex',              alignItems: 'center',              gap: 8            }}          >            ?¤ï¸ ì°œí•œ ?í’ˆ          </Link>          <Link             to={uid ? "/my-items" : "/login"}            style={{              padding: '12px 24px',              backgroundColor: '#f3f4f6',              color: '#374151',              textDecoration: 'none',              borderRadius: 8,              fontWeight: 600,              display: 'flex',              alignItems: 'center',              gap: 8            }}          >            ?“¦ ???í’ˆ ê´€ë¦?          </Link>          <Link             to={uid ? "/market/new" : "/login"}            style={{              padding: '12px 24px',              backgroundColor: '#2563eb',              color: 'white',              textDecoration: 'none',              borderRadius: 8,              fontWeight: 600            }}          >            + ?í’ˆ ?±ë¡          </Link>        </div>      </div>      {/* ê²€??ë°•ìŠ¤ */}      <div style={{ marginBottom: 24 }}>        <SearchBox           onSearchResults={handleSearchResults}          placeholder="?í’ˆëª? ?œê·¸, ë¸Œëœ?œë¡œ ê²€??.."        />      </div>      {items.length === 0 ? (        <div style={{ textAlign: 'center', padding: 48, color: '#666' }}>          <h3>?±ë¡???í’ˆ???†ìŠµ?ˆë‹¤</h3>          <p>ì²?ë²ˆì§¸ ?í’ˆ???±ë¡?´ë³´?¸ìš”!</p>        </div>      ) : (                <ul className="grid gap-4 grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">          {items.map((item) => {            // ?”ë²„ê¹? ?´ë?ì§€ ë°°ì—´ ?íƒœ ?•ì¸            console.log('[MARKET_LIST] Item:', item.id, 'Images:', item.images?.length || 0, 'First image type:', typeof item.images?.[0]);                        return (              <li key={item.id} className="rounded-xl overflow-hidden border bg-white hover:shadow-md transition-shadow">                <Link                  to={`/market/${item.id}`}                  className="block"                >                  {/* ê³ ì • ë¹„ìœ¨ ?¸ë„¤??(?•ì‚¬ê°í˜•) */}                  <div className="relative aspect-square bg-slate-50">                    <img                      src={getFirstImageUrl(item)}                      alt={item.title ?? '?í’ˆ ?´ë?ì§€'}                      loading="lazy"                      onError={(e) => {                        e.currentTarget.src = "/img/placeholder.svg";                      }}                      className="absolute inset-0 w-full h-full object-cover pointer-events-none"                      draggable={false}                    />                    {/* AI ì»¨ë””??ë°°ì? */}                    {item.ai?.condition && (                      <div style={{                        position: 'absolute',                        top: 8,                        right: 8,                        padding: '4px 8px',                        borderRadius: 12,                        fontSize: 12,                        fontWeight: 600,                        ...getConditionColor(item.ai.condition)                      }}>                        {item.ai.condition}ê¸?                      </div>                    )}                    {/* AI ë¸Œëœ??ë°°ì? */}                    {item.ai?.brand && item.ai.brand !== 'unknown' && (                      <div style={{                        position: 'absolute',                        top: 8,                        left: 8,                        padding: '4px 8px',                        backgroundColor: 'rgba(0,0,0,0.7)',                        color: 'white',                        borderRadius: 12,                        fontSize: 12,                        fontWeight: 600                      }}>                        {item.ai.brand}                      </div>                    )}                    {/* ê±°ë¦¬ ?œì‹œ */}                    {item.geo && userLocation && (                      <div style={{                        position: 'absolute',                        top: 8,                        left: item.ai?.brand && item.ai.brand !== 'unknown' ? 80 : 8,                        zIndex: 10                      }}>                        <DistanceBadge                          itemGeo={item.geo}                          userLocation={userLocation}                          showIcon={false}                        />                      </div>                    )}                    {/* ?íƒœ ë°°ì? (ì¢Œí•˜?? */}                    <div style={{                      position: 'absolute',                      bottom: 8,                      left: 8,                      zIndex: 10                    }}>                      <StatusBadge status={item.status} size="sm" />                    </div>                    {/* ì°œí•˜ê¸?ë²„íŠ¼ (?°ìƒ?? */}                    <div style={{                      position: 'absolute',                      top: 8,                      right: 8,                      zIndex: 10                    }}>                      <FavoriteButton itemId={item.id} size="sm" />                    </div>                    {/* ?”ë³´ê¸?ë©”ë‰´ ë²„íŠ¼ (?°ìƒ?? ì°œí•˜ê¸??„ë˜) */}                    <div style={{                      position: 'absolute',                      top: 44,                      right: 8,                      zIndex: 10                    }}>                      <button                        type="button"                        onClick={(e) => {                          e.preventDefault();                          e.stopPropagation();                          console.log('?”ë³´ê¸?ë©”ë‰´:', item.id);                        }}                        className="w-8 h-8 flex items-center justify-center rounded-full bg-white/90 hover:bg-white shadow-sm border"                        title="?”ë³´ê¸?                      >                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">                          <circle cx="12" cy="12" r="1"/>                          <circle cx="19" cy="12" r="1"/>                          <circle cx="5" cy="12" r="1"/>                        </svg>                      </button>                    </div>                  </div>                  {/* ë©”í? ?•ë³´ */}                  <div className="p-3">                    <div className="text-sm font-semibold truncate text-gray-900">{item.title}</div>                    <div className="text-xs text-gray-500 mt-1">{Number(item.price).toLocaleString()}??/div>                  </div>                </Link>              </li>            );          })}        </ul>      )}    </div>  );} 