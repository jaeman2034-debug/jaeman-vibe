import { useEffect, useState } from 'react';import { Link } from 'react-router-dom';type Item = {  id: string;  title: string;  price: number;  address: string;  lat: number;  lng: number;  distanceM: number;  thumbnail?: string|null;};export default function NearProductsPage() {  const [pos, setPos] = useState<{lat:number;lng:number}|null>(null);  const [items, setItems] = useState<Item[]>([]);  const [loading, setLoading] = useState(false);  const [radius, setRadius] = useState(2000); // meters  const [sort, setSort] = useState<'distance'|'latest'>('distance');  const [useRegion, setUseRegion] = useState(false);  const [region, setRegion] = useState<{b_code:string,label:string}|null>(null);  useEffect(() => {    // ?„ì¬ ?„ì¹˜ ?œë„, ?¤íŒ¨???œìš¸?œì²­ ì¢Œí‘œë¡?    navigator.geolocation.getCurrentPosition(      (p) => setPos({ lat: p.coords.latitude, lng: p.coords.longitude }),      () => setPos({ lat: 37.5665, lng: 126.9780 })    );  }, []);  // ?„ì¬ ?„ì¹˜ ?¡íŒ ??regioncode ?¸ì¶œ  useEffect(() => {    if (!pos) return;    (async () => {      const r = await fetch(`/api/regioncode?lat=${pos.lat}&lng=${pos.lng}`);      const j = await r.json();      if (j.ok) {        const label = `${j.region_1depth_name} ${j.region_2depth_name} ${j.region_3depth_name}`;        setRegion({ b_code: j.b_code, label });      }    })();  }, [pos]);  // ëª©ë¡ fetch ë¡œì§ ë¶„ê¸°  useEffect(() => {    if (!pos) return;    (async () => {      setLoading(true);      try {        let url = '';        if (useRegion && region?.b_code) {          const level = 8; // ?ë©´???¨ìœ„          url = `/api/products/region?b=${region.b_code}&level=${level}`;        } else {          url = `/api/products/near?lat=${pos.lat}&lng=${pos.lng}&radius=${radius}&sort=${sort}`;        }        const r = await fetch(url);        const j = await r.json();        let items = j.items ?? [];        // ê±°ë¦¬???•ë ¬???„ìš”?œë° /region ?¸ì¶œ??distanceM???†ì„ ???ˆì–´, ?´ë¼?ì„œ ê³„ì‚°:        if (useRegion && items.length && pos) {          const R = 6371;          const toRad = (v:number)=>v*Math.PI/180;          items = items.map((it:any)=> {            if (it.lat && it.lng) {              const dLat = toRad(it.lat - pos.lat);              const dLng = toRad(it.lng - pos.lng);              const a = Math.sin(dLat/2)**2 + Math.cos(toRad(pos.lat))*Math.cos(toRad(it.lat))*Math.sin(dLng/2)**2;              const distM = Math.round(2*R*Math.asin(Math.sqrt(a))*1000);              return { ...it, distanceM: distM };            }            return it;          });          if (sort === 'distance') items.sort((a:any,b:any)=>(a.distanceM||9e9)-(b.distanceM||9e9));          else items.sort((a:any,b:any)=>(b.createdAt||0)-(a.createdAt||0));        }        setItems(items);      } finally {        setLoading(false);      }    })();  }, [pos, useRegion, region?.b_code, radius, sort]);  const openMap = (it: Item) => {    // ì¹´ì¹´?¤ë§µ ë§í¬ (ì§€??ë³´ê¸°)    window.open(`https://map.kakao.com/link/map/${encodeURIComponent(it.title||'?í’ˆ')},${it.lat},${it.lng}`, '_blank');  };  const openRoute = (it: Item) => {    // ì¹´ì¹´?¤ë§µ ê¸¸ì°¾ê¸?ë§í¬ (to: ëª©ì ì§€)    window.open(`https://map.kakao.com/link/to/${encodeURIComponent(it.title||'?í’ˆ')},${it.lat},${it.lng}`, '_blank');  };  return (    <div style={{maxWidth:900, margin:'24px auto', padding:'0 12px'}}>      <h2>ê·¼ì²˜ {(radius/1000).toFixed(1)}km ?í’ˆ</h2>      <p style={{opacity:.7}}>ê¸°ì? ì¢Œí‘œ: {pos ? `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}` : '?•ì¸ ì¤?..'}</p>            <div style={{display:'flex', gap:12, alignItems:'center', margin:'12px 0'}}>        <label>ë°˜ê²½: {(radius/1000).toFixed(1)}km</label>        <input type="range" min={500} max={5000} step={500}          value={radius} onChange={e=>setRadius(Number(e.target.value))} />        <select value={sort} onChange={e=>setSort(e.target.value as any)}>          <option value="distance">ê±°ë¦¬??/option>          <option value="latest">ìµœì‹ ??/option>        </select>        <label style={{display:'flex', alignItems:'center', gap:6}}>          <input type="checkbox" checked={useRegion} onChange={e=>setUseRegion(e.target.checked)} />          ?™ë„¤ë§?{region?.label ? `(${region.label})` : ''}        </label>      </div>            {loading && <p>ë¶ˆëŸ¬?¤ëŠ” ì¤?..</p>}      <div style={{display:'grid', gap:12}}>        {items.map(it => (          <div key={it.id} style={{display:'grid', gridTemplateColumns:'80px 1fr auto', gap:12, padding:12, border:'1px solid #e5e7eb', borderRadius:8}}>            <div style={{width:80, height:80, background:'#f3f4f6', borderRadius:8, overflow:'hidden'}}>              {it.thumbnail ? <img src={it.thumbnail} alt="" style={{width:'100%', height:'100%', objectFit:'cover'}}/> : null}            </div>            <div>              <div style={{fontWeight:700}}>                <Link to={`/products/${it.id}`} style={{textDecoration:'none'}}>{it.title}</Link>              </div>              <div style={{opacity:.8}}>{it.address}</div>              <div style={{marginTop:4}}>{it.price?.toLocaleString?.() ?? ''}??Â· {Math.round(it.distanceM)}m</div>            </div>            <div style={{display:'flex', flexDirection:'column', gap:8}}>              <button onClick={()=>openMap(it)} style={{padding:'6px 10px'}}>ì§€??/button>              <button onClick={()=>openRoute(it)} style={{padding:'6px 10px'}}>ê¸¸ì°¾ê¸?/button>            </div>          </div>        ))}        {!loading && items.length===0 && <p>ê·¼ì²˜???í’ˆ???†ìŠµ?ˆë‹¤.</p>}      </div>    </div>  );}
