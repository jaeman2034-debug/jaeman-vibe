import * as tf from '@tensorflow/tfjs';import * as mobilenet from '@tensorflow-models/mobilenet';// AI ëª¨ë¸ ì´ˆê¸°??(??ë²ˆë§Œ)let model: mobilenet.MobileNet | null = null;export async function initializeAIModel() {  if (!model) {    try {      await tf.ready();      model = await mobilenet.load();      console.log('AI ëª¨ë¸ ë¡œë“œ ?„ë£Œ');    } catch (error) {      console.error('AI ëª¨ë¸ ë¡œë“œ ?¤íŒ¨:', error);      throw error;    }  }  return model;}// ?´ë?ì§€ ?ˆì§ˆ ë¶„ì„export function analyzeImageQuality(imageElement: HTMLImageElement) {  const canvas = document.createElement('canvas');  const ctx = canvas.getContext('2d')!;    canvas.width = imageElement.naturalWidth;  canvas.height = imageElement.naturalHeight;  ctx.drawImage(imageElement, 0, 0);    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);  const data = imageData.data;    let brightness = 0;  let contrast = 0;  let sharpness = 0;    // ë°ê¸° ê³„ì‚°  for (let i = 0; i < data.length; i += 4) {    const r = data[i];    const g = data[i + 1];    const b = data[i + 2];    brightness += (r + g + b) / 3;  }  brightness = brightness / (data.length / 4);    // ?€ë¹?ê³„ì‚°  let sum = 0;  let sumSq = 0;  for (let i = 0; i < data.length; i += 4) {    const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;    sum += gray;    sumSq += gray * gray;  }  const mean = sum / (data.length / 4);  const variance = (sumSq / (data.length / 4)) - (mean * mean);  contrast = Math.sqrt(variance);    // ? ëª…??ê³„ì‚° (Laplacian ?„í„°)  let laplacianSum = 0;  for (let y = 1; y < canvas.height - 1; y++) {    for (let x = 1; x < canvas.width - 1; x++) {      const idx = (y * canvas.width + x) * 4;      const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;            const left = (data[idx - 4] + data[idx - 3] + data[idx - 2]) / 3;      const right = (data[idx + 4] + data[idx + 5] + data[idx + 6]) / 3;      const top = (data[(y - 1) * canvas.width * 4 + x * 4] + data[(y - 1) * canvas.width * 4 + x * 4 + 1] + data[(y - 1) * canvas.width * 4 + x * 4 + 2]) / 3;      const bottom = (data[(y + 1) * canvas.width * 4 + x * 4] + data[(y + 1) * canvas.width * 4 + x * 4 + 1] + data[(y + 1) * canvas.width * 4 + x * 4 + 2]) / 3;            const laplacian = Math.abs(4 * gray - left - right - top - bottom);      laplacianSum += laplacian;    }  }  sharpness = laplacianSum / ((canvas.width - 2) * (canvas.height - 2));    // ?ìˆ˜ ê³„ì‚° (0-100)  const brightnessScore = Math.max(0, Math.min(100, (brightness / 255) * 100));  const contrastScore = Math.max(0, Math.min(100, (contrast / 128) * 100));  const sharpnessScore = Math.max(0, Math.min(100, (sharpness / 50) * 100));    const overallScore = Math.round((brightnessScore + contrastScore + sharpnessScore) / 3);    return {    overallScore,    brightness: Math.round(brightnessScore),    contrast: Math.round(contrastScore),    sharpness: Math.round(sharpnessScore),    details: {      brightness: brightnessScore < 30 ? '?ˆë¬´ ?´ë‘¡?µë‹ˆ?? : brightnessScore > 80 ? '?ˆë¬´ ë°ìŠµ?ˆë‹¤' : '?ì ˆ?©ë‹ˆ??,      contrast: contrastScore < 30 ? '?€ë¹„ê? ë¶€ì¡±í•©?ˆë‹¤' : '?ì ˆ?©ë‹ˆ??,      sharpness: sharpnessScore < 30 ? '?ë¦¿?©ë‹ˆ?? : '? ëª…?©ë‹ˆ??    }  };}// ?´ë?ì§€ ?¼ë²¨ ì¶”ì¶œ (MobileNet ?¬ìš©)export async function extractImageLabels(imageElement: HTMLImageElement) {  try {    const model = await initializeAIModel();    const predictions = await model.classify(imageElement);        // ?ìœ„ 5ê°??ˆì¸¡ ê²°ê³¼    const topLabels = predictions      .slice(0, 5)      .map(p => ({        label: p.className,        confidence: Math.round(p.probability * 100)      }));        // ?¤í¬ì¸?ê´€???¤ì›Œ??ë§¤ì¹­    const sportsKeywords = {      'ì¶•êµ¬': ['soccer', 'football', 'ball', 'goal', 'field'],      '?êµ¬': ['basketball', 'basket', 'court', 'hoop'],      '?¼êµ¬': ['baseball', 'bat', 'glove', 'diamond'],      '?¬ë‹': ['running', 'shoe', 'sneaker', 'athletic'],      '?Œë‹ˆ??: ['tennis', 'racket', 'court'],      'ê³¨í”„': ['golf', 'club', 'course'],      'ê¸°í?': ['sport', 'athletic', 'equipment']    };        let recommendedCategory = 'ê¸°í?';    let maxScore = 0;        for (const [category, keywords] of Object.entries(sportsKeywords)) {      let score = 0;      for (const prediction of topLabels) {        for (const keyword of keywords) {          if (prediction.label.toLowerCase().includes(keyword)) {            score += prediction.confidence;          }        }      }      if (score > maxScore) {        maxScore = score;        recommendedCategory = category;      }    }        return {      labels: topLabels,      recommendedCategory,      confidence: maxScore    };  } catch (error) {    console.error('?´ë?ì§€ ?¼ë²¨ ì¶”ì¶œ ?¤íŒ¨:', error);    return {      labels: [],      recommendedCategory: 'ê¸°í?',      confidence: 0    };  }}// ?¬ì´¬?????ì„±export function generateRetakeTips(quality: any, labels: any) {  const tips: string[] = [];    // ?ˆì§ˆ ê¸°ë°˜ ??  if (quality.brightness < 30) {    tips.push('?’¡ ??ë°ì? ê³³ì—??ì´¬ì˜?˜ì„¸??);  } else if (quality.brightness > 80) {    tips.push('?Œ¤ï¸?ì§ì‚¬ê´‘ì„ ???¼í•´ ì´¬ì˜?˜ì„¸??);  }    if (quality.sharpness < 30) {    tips.push('?“± ì¹´ë©”?¼ë? ê³ ì •?˜ê³  ì´¬ì˜?˜ì„¸??);  }    if (quality.contrast < 30) {    tips.push('?¨ ë°°ê²½ê³??í’ˆ???€ë¹„ë? ?’ì´?¸ìš”');  }    // ?¼ë²¨ ê¸°ë°˜ ??  if (labels.confidence < 50) {    tips.push('?” ?í’ˆ???„ë ˆ???ˆì— ???¬ê²Œ ë³´ì´?„ë¡ ì´¬ì˜?˜ì„¸??);  }    if (tips.length === 0) {    tips.push('???´ë?ì§€ ?ˆì§ˆ??ì¢‹ìŠµ?ˆë‹¤!');  }    return tips;}// ?„ì²´ AI ë¶„ì„export async function analyzeImageWithAI(imageElement: HTMLImageElement) {  try {    const [quality, labels] = await Promise.all([      analyzeImageQuality(imageElement),      extractImageLabels(imageElement)    ]);        const retakeTips = generateRetakeTips(quality, labels);        return {      quality,      labels,      retakeTips,      recommendedTitle: `AI ë¶„ì„??${labels.recommendedCategory} ?©í’ˆ`,      recommendedPrice: Math.floor(Math.random() * 100000) + 10000, // 1ë§Œì› ~ 11ë§Œì›      recommendedDescription: `AIê°€ ë¶„ì„??${labels.recommendedCategory} ê´€???¤í¬ì¸??©í’ˆ?…ë‹ˆ?? ${quality.overallScore}?ì˜ ?´ë?ì§€ ?ˆì§ˆ??ê°€ì§€ê³??ˆìŠµ?ˆë‹¤.`    };  } catch (error) {    console.error('AI ë¶„ì„ ?¤íŒ¨:', error);    throw error;  }}
