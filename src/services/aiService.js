"use strict";
// src/services/aiService.ts/** 공통 ?�??*/export type VisionResult = { text: string; raw?: any };/** ?�러 메시지 ?�규??*/export function getErrorMessage(err: unknown): string {  if (typeof err === 'string') return err;  if (err instanceof Error) return err.message;  try {    return JSON.stringify(err);  } catch {    return String(err);  }}/** ?��?지 ?�일 ?�효??검??*/export function validateImageFile(  file: File,  opts?: { maxMB?: number; accept?: string[] }): { ok: true } | { ok: false; error: string } {  const maxMB = opts?.maxMB ?? 10; // 기본 10MB  const allow = (opts?.accept ?? ['image/jpeg', 'image/png', 'image/webp']).map(s => s.toLowerCase());  if (!allow.includes(file.type.toLowerCase())) {    return { ok: false, error: `지?�하지 ?�는 ?�식?�니??(${file.type}). ?�용: ${allow.join(', ')}` };  }  const sizeMB = file.size / (1024 * 1024);  if (sizeMB > maxMB) {    return { ok: false, error: `?�일???�무 ?�니??(${sizeMB.toFixed(2)}MB > ${maxMB}MB)` };  }  return { ok: true };}/** ?�일??base64(?�더 ?�거)�?변??*/export async function fileToBase64(file: File): Promise<string> {  return await new Promise((resolve, reject) => {    const r = new FileReader();    r.onload = () => {      const s = String(r.result || '');      resolve(s.includes(',') ? s.split(',')[1] : s);    };    r.onerror = reject;    r.readAsDataURL(file);  });}/** (?�션) ?�반 ?�스??분석 ?�록??*/export async function analyzeText(prompt: string): Promise<VisionResult> {  const r = await fetch('/api/ai/chat', {    method: 'POST',    headers: { 'Content-Type': 'application/json' },    body: JSON.stringify({ prompt }),  });  if (!r.ok) {    return { text: '[stub] chat endpoint not found; returning dummy.', raw: await r.text() };  }  const data = await r.json();  const text = data.text ?? data.choices?.[0]?.message?.content ?? JSON.stringify(data);  return { text, raw: data };}/** ?��?지(base64) 분석 ???�버??비전 ?�드?�인?�로 ?�록???�출 */export async function analyzeImageBase64(  imageBase64: string,  prompt = 'Describe the image.'): Promise<VisionResult> {  const r = await fetch('/api/ai/vision', {    method: 'POST',    headers: { 'Content-Type': 'application/json' },    body: JSON.stringify({ imageBase64, prompt }),  });  if (!r.ok) {    // ?�버 ?�우?��? ?�직 ?�다�??��? ?�답 반환    return { text: '[stub] vision endpoint not found; returning dummy.', raw: await r.text() };  }  const data = await r.json();  const text =    data.text ??    data.result ??    data.choices?.[0]?.message?.content ??    JSON.stringify(data);  return { text, raw: data };}/** ?�일 ?�일 분석(?�효??검???�함) */export async function analyzeProductImage(  file: File,  prompt = '?�품 ?��?지�?분석???�심 ?�징???�약?�줘.'): Promise<VisionResult> {  const v = validateImageFile(file);  if (!v.ok) return { text: v.error };  const b64 = await fileToBase64(file);  return analyzeImageBase64(b64, prompt);}/** ?�러 ???��?지 분석 */export async function analyzeMultipleImages(  files: File[],  prompt = '?�러 ?�품 ?��?지�??�께 보고 ?�???�징???�약?�줘.'): Promise<VisionResult[]> {  const tasks = files.map(async (f) => {    const v = validateImageFile(f);    if (!v.ok) return { text: v.error };    const b64 = await fileToBase64(f);    return analyzeImageBase64(b64, prompt);  });  return Promise.all(tasks);} 
