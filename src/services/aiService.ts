// src/services/aiService.ts/** ê³µí†µ ?€??*/export type VisionResult = { text: string; raw?: any };/** ?ëŸ¬ ë©”ì‹œì§€ ?•ê·œ??*/export function getErrorMessage(err: unknown): string {  if (typeof err === 'string') return err;  if (err instanceof Error) return err.message;  try {    return JSON.stringify(err);  } catch {    return String(err);  }}/** ?´ë?ì§€ ?Œì¼ ? íš¨??ê²€??*/export function validateImageFile(  file: File,  opts?: { maxMB?: number; accept?: string[] }): { ok: true } | { ok: false; error: string } {  const maxMB = opts?.maxMB ?? 10; // ê¸°ë³¸ 10MB  const allow = (opts?.accept ?? ['image/jpeg', 'image/png', 'image/webp']).map(s => s.toLowerCase());  if (!allow.includes(file.type.toLowerCase())) {    return { ok: false, error: `ì§€?í•˜ì§€ ?ŠëŠ” ?•ì‹?…ë‹ˆ??(${file.type}). ?ˆìš©: ${allow.join(', ')}` };  }  const sizeMB = file.size / (1024 * 1024);  if (sizeMB > maxMB) {    return { ok: false, error: `?Œì¼???ˆë¬´ ?½ë‹ˆ??(${sizeMB.toFixed(2)}MB > ${maxMB}MB)` };  }  return { ok: true };}/** ?Œì¼??base64(?¤ë” ?œê±°)ë¡?ë³€??*/export async function fileToBase64(file: File): Promise<string> {  return await new Promise((resolve, reject) => {    const r = new FileReader();    r.onload = () => {      const s = String(r.result || '');      resolve(s.includes(',') ? s.split(',')[1] : s);    };    r.onerror = reject;    r.readAsDataURL(file);  });}/** (?µì…˜) ?¼ë°˜ ?ìŠ¤??ë¶„ì„ ?„ë¡??*/export async function analyzeText(prompt: string): Promise<VisionResult> {  const r = await fetch('/api/ai/chat', {    method: 'POST',    headers: { 'Content-Type': 'application/json' },    body: JSON.stringify({ prompt }),  });  if (!r.ok) {    return { text: '[stub] chat endpoint not found; returning dummy.', raw: await r.text() };  }  const data = await r.json();  const text = data.text ?? data.choices?.[0]?.message?.content ?? JSON.stringify(data);  return { text, raw: data };}/** ?´ë?ì§€(base64) ë¶„ì„ ???œë²„??ë¹„ì „ ?”ë“œ?¬ì¸?¸ë¡œ ?„ë¡???¸ì¶œ */export async function analyzeImageBase64(  imageBase64: string,  prompt = 'Describe the image.'): Promise<VisionResult> {  const r = await fetch('/api/ai/vision', {    method: 'POST',    headers: { 'Content-Type': 'application/json' },    body: JSON.stringify({ imageBase64, prompt }),  });  if (!r.ok) {    // ?œë²„ ?¼ìš°?¸ê? ?„ì§ ?†ë‹¤ë©??”ë? ?‘ë‹µ ë°˜í™˜    return { text: '[stub] vision endpoint not found; returning dummy.', raw: await r.text() };  }  const data = await r.json();  const text =    data.text ??    data.result ??    data.choices?.[0]?.message?.content ??    JSON.stringify(data);  return { text, raw: data };}/** ?¨ì¼ ?Œì¼ ë¶„ì„(? íš¨??ê²€???¬í•¨) */export async function analyzeProductImage(  file: File,  prompt = '?í’ˆ ?´ë?ì§€ë¥?ë¶„ì„???µì‹¬ ?¹ì§•???”ì•½?´ì¤˜.'): Promise<VisionResult> {  const v = validateImageFile(file);  if (!v.ok) return { text: v.error };  const b64 = await fileToBase64(file);  return analyzeImageBase64(b64, prompt);}/** ?¬ëŸ¬ ???´ë?ì§€ ë¶„ì„ */export async function analyzeMultipleImages(  files: File[],  prompt = '?¬ëŸ¬ ?í’ˆ ?´ë?ì§€ë¥??¨ê»˜ ë³´ê³  ?€???¹ì§•???”ì•½?´ì¤˜.'): Promise<VisionResult[]> {  const tasks = files.map(async (f) => {    const v = validateImageFile(f);    if (!v.ok) return { text: v.error };    const b64 = await fileToBase64(f);    return analyzeImageBase64(b64, prompt);  });  return Promise.all(tasks);} 