import { collection } from 'firebase/firestore';
import { auth, db } from '@/lib/firebase';
export async function createOrGetThread(productId, sellerId) { const user = auth.currentUser; if (!user)
    throw new Error('로그?�이 ?�요?�니??'); const buyerId = user.uid; const threadsRef = collection(db, 'threads'); } // ??규칙???�과?�는 쿼리: "?��? 멤버?? ?�레?�만 조회  const q = query(threadsRef, where('members', 'array-contains', buyerId), limit(20));  const snap = await getDocs(q);  // ???�레??�?같�? ?�품/?�매?��? ?�으�??�사??  const exist = snap.docs.find(d => {    const data = d.data() as any;    return data.productId === productId && Array.isArray(data.members) && data.members.includes(sellerId);  });  if (exist) return exist.id;  // ?�으�??�성  const created = await addDoc(threadsRef, {    members: [buyerId, sellerId],    productId,    status: 'negotiating',    lastMessage: '',    lastMessageAt: serverTimestamp(),    createdAt: serverTimestamp(),  });  return created.id;}export async function sendMessage(threadId: string, text: string) {  const user = auth.currentUser;  if (!user) throw new Error('로그?�이 ?�요?�니??');  const msgRef = collection(db, 'threads', threadId, 'messages');  await addDoc(msgRef, {    senderId: user.uid,    text,    createdAt: serverTimestamp(),  });  // 최근 메시지 갱신  await setDoc(doc(db, 'threads', threadId), {    lastMessage: text,    lastMessageAt: serverTimestamp(),  }, { merge: true });}// ?�레???�보 조회export async function getThread(threadId: string) {  const threadDoc = await getDoc(doc(db, 'threads', threadId));  if (!threadDoc.exists()) throw new Error('?�레?��? 찾을 ???�습?�다.');    return {    id: threadDoc.id,    ...threadDoc.data()  };}// ?�용?�의 채팅 ?�레??목록 조회export async function getUserThreads() {  const user = auth.currentUser;  if (!user) throw new Error('로그?�이 ?�요?�니??');  const threadsRef = collection(db, 'threads');  const q = query(threadsRef, where('members', 'array-contains', user.uid));  const snap = await getDocs(q);    return snap.docs.map(doc => ({    id: doc.id,    ...doc.data()  }));}
