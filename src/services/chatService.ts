import { addDoc, collection, doc, getDoc, getDocs, limit, query, serverTimestamp, setDoc, where } from 'firebase/firestore';import { auth, db } from '@/lib/firebase';export async function createOrGetThread(productId: string, sellerId: string) {  const user = auth.currentUser;  if (!user) throw new Error('ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??');  const buyerId = user.uid;  const threadsRef = collection(db, 'threads');  // ??ê·œì¹™???µê³¼?˜ëŠ” ì¿¼ë¦¬: "?´ê? ë©¤ë²„?? ?¤ë ˆ?œë§Œ ì¡°íšŒ  const q = query(threadsRef, where('members', 'array-contains', buyerId), limit(20));  const snap = await getDocs(q);  // ???¤ë ˆ??ì¤?ê°™ì? ?í’ˆ/?ë§¤?ê? ?ˆìœ¼ë©??¬ì‚¬??  const exist = snap.docs.find(d => {    const data = d.data() as any;    return data.productId === productId && Array.isArray(data.members) && data.members.includes(sellerId);  });  if (exist) return exist.id;  // ?†ìœ¼ë©??ì„±  const created = await addDoc(threadsRef, {    members: [buyerId, sellerId],    productId,    status: 'negotiating',    lastMessage: '',    lastMessageAt: serverTimestamp(),    createdAt: serverTimestamp(),  });  return created.id;}export async function sendMessage(threadId: string, text: string) {  const user = auth.currentUser;  if (!user) throw new Error('ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??');  const msgRef = collection(db, 'threads', threadId, 'messages');  await addDoc(msgRef, {    senderId: user.uid,    text,    createdAt: serverTimestamp(),  });  // ìµœê·¼ ë©”ì‹œì§€ ê°±ì‹   await setDoc(doc(db, 'threads', threadId), {    lastMessage: text,    lastMessageAt: serverTimestamp(),  }, { merge: true });}// ?¤ë ˆ???•ë³´ ì¡°íšŒexport async function getThread(threadId: string) {  const threadDoc = await getDoc(doc(db, 'threads', threadId));  if (!threadDoc.exists()) throw new Error('?¤ë ˆ?œë? ì°¾ì„ ???†ìŠµ?ˆë‹¤.');    return {    id: threadDoc.id,    ...threadDoc.data()  };}// ?¬ìš©?ì˜ ì±„íŒ… ?¤ë ˆ??ëª©ë¡ ì¡°íšŒexport async function getUserThreads() {  const user = auth.currentUser;  if (!user) throw new Error('ë¡œê·¸?¸ì´ ?„ìš”?©ë‹ˆ??');  const threadsRef = collection(db, 'threads');  const q = query(threadsRef, where('members', 'array-contains', user.uid));  const snap = await getDocs(q);    return snap.docs.map(doc => ({    id: doc.id,    ...doc.data()  }));}