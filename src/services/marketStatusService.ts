import {   doc,   getDoc,   updateDoc,   collection,   query,   where,   orderBy,   getDocs,  onSnapshot,  writeBatch} from 'firebase/firestore';import { db } from '@/lib/firebase';import type { MarketItem } from '../features/market/types';// ?�품 ?�태 ?�??export type ItemStatus = 'active' | 'reserved' | 'sold';// ?�태 변�??�력 ?�??export interface StatusChangeHistory {  id: string;  itemId: string;  userId: string;  oldStatus: ItemStatus;  newStatus: ItemStatus;  reason?: string;  createdAt: any; // Firestore Timestamp}// ?�태 변�?권한 ?�인export const canUpdateStatus = async (itemId: string, userId: string): Promise<boolean> => {  try {    const itemRef = doc(db, 'market', itemId);    const itemSnap = await getDoc(itemRef);        if (!itemSnap.exists()) {      return false;    }        const itemData = itemSnap.data() as MarketItem;    return itemData.ownerId === userId;  } catch (error) {    console.error('?�태 변�?권한 ?�인 ?�패:', error);    return false;  }};// ?�품 ?�태 ?�데?�트export const updateItemStatus = async (  itemId: string,   userId: string,   newStatus: ItemStatus,  reason?: string): Promise<void> => {  try {    // 권한 ?�인    const hasPermission = await canUpdateStatus(itemId, userId);    if (!hasPermission) {      throw new Error('?�품 ?�태�?변경할 권한???�습?�다.');    }    // ?�재 ?�태 조회    const itemRef = doc(db, 'market', itemId);    const itemSnap = await getDoc(itemRef);        if (!itemSnap.exists()) {      throw new Error('?�품??찾을 ???�습?�다.');    }        const currentData = itemSnap.data() as MarketItem;    const oldStatus = currentData.status;    // ?�태 변경이 ?�제�??�요?��? ?�인    if (oldStatus === newStatus) {      console.log('?�태가 ?��? ?�일?�니??', newStatus);      return;    }    // ?�품 ?�태 ?�데?�트    await updateDoc(itemRef, {      status: newStatus,      updatedAt: new Date()    });    // ?�태 변�??�력 ?�??    await saveStatusChangeHistory(itemId, userId, oldStatus, newStatus, reason);    console.log('?�품 ?�태 ?�데?�트 ?�료:', {      itemId,      oldStatus,      newStatus,      reason    });  } catch (error) {    console.error('?�품 ?�태 ?�데?�트 ?�패:', error);    throw error;  }};// ?�태 변�??�력 ?�??const saveStatusChangeHistory = async (  itemId: string,  userId: string,  oldStatus: ItemStatus,  newStatus: ItemStatus,  reason?: string): Promise<void> => {  try {    const historyRef = doc(collection(db, 'status_changes'));    await updateDoc(historyRef, {      itemId,      userId,      oldStatus,      newStatus,      reason,      createdAt: new Date()    });  } catch (error) {    console.error('?�태 변�??�력 ?�???�패:', error);    // ?�력 ?�???�패???�품 ?�태 ?�데?�트�?막�? ?�음  }};// ?�용?�의 ?�품 ?�태�?조회export const getUserItemsByStatus = async (  userId: string,  status?: ItemStatus): Promise<MarketItem[]> => {  try {    let q = query(      collection(db, 'market'),      where('ownerId', '==', userId),      orderBy('createdAt', 'desc')    );    if (status) {      q = query(q, where('status', '==', status));    }    const querySnapshot = await getDocs(q);    const items: MarketItem[] = [];        querySnapshot.forEach((doc) => {      items.push({        id: doc.id,        ...doc.data()      } as MarketItem);    });        return items;  } catch (error) {    console.error('?�용???�품 ?�태�?조회 ?�패:', error);    return [];  }};// ?�품 ?�태�??�계 조회export const getStatusStatistics = async (userId: string): Promise<{  active: number;  reserved: number;  sold: number;  total: number;}> => {  try {    const allItems = await getUserItemsByStatus(userId);        const stats = {      active: allItems.filter(item => item.status === 'active').length,      reserved: allItems.filter(item => item.status === 'reserved').length,      sold: allItems.filter(item => item.status === 'sold').length,      total: allItems.length    };        return stats;  } catch (error) {    console.error('?�태 ?�계 조회 ?�패:', error);    return { active: 0, reserved: 0, sold: 0, total: 0 };  }};// ?�시�??�품 ?�태 모니?�링export const subscribeToUserItemsStatus = (  userId: string,  callback: (items: MarketItem[]) => void) => {  try {    const q = query(      collection(db, 'market'),      where('ownerId', '==', userId),      orderBy('createdAt', 'desc')    );        return onSnapshot(q, (snapshot) => {      const items: MarketItem[] = [];      snapshot.forEach((doc) => {        items.push({          id: doc.id,          ...doc.data()        } as MarketItem);      });            callback(items);    });  } catch (error) {    console.error('?�품 ?�태 ?�시�?구독 ?�패:', error);    return () => {};  }};// ?�태 변�??�력 조회export const getStatusChangeHistory = async (  itemId: string,  limit: number = 10): Promise<StatusChangeHistory[]> => {  try {    const q = query(      collection(db, 'status_changes'),      where('itemId', '==', itemId),      orderBy('createdAt', 'desc'),      limit    );        const querySnapshot = await getDocs(q);    const history: StatusChangeHistory[] = [];        querySnapshot.forEach((doc) => {      history.push({        id: doc.id,        ...doc.data()      } as StatusChangeHistory);    });        return history;  } catch (error) {    console.error('?�태 변�??�력 조회 ?�패:', error);    return [];  }};// ?�괄 ?�태 ?�데?�트 (?�러 ?�품)export const batchUpdateItemStatus = async (  operations: {    itemId: string;    userId: string;    newStatus: ItemStatus;    reason?: string;  }[]): Promise<void> => {  try {    const batch = writeBatch(db);        for (const operation of operations) {      // 권한 ?�인      const hasPermission = await canUpdateStatus(operation.itemId, operation.userId);      if (!hasPermission) {        throw new Error(`?�품 ${operation.itemId}???�태�?변경할 권한???�습?�다.`);      }            const itemRef = doc(db, 'market', operation.itemId);      batch.update(itemRef, {        status: operation.newStatus,        updatedAt: new Date()      });    }        await batch.commit();    console.log('?�괄 ?�태 ?�데?�트 ?�료:', operations.length, '�?);      } catch (error) {    console.error('?�괄 ?�태 ?�데?�트 ?�패:', error);    throw error;  }};// ?�태�??�품 ?�터�?export const filterItemsByStatus = (  items: MarketItem[],  status?: ItemStatus): MarketItem[] => {  if (!status) return items;  return items.filter(item => item.status === status);};// ?�태 변�?가???��? ?�인export const canChangeToStatus = (  currentStatus: ItemStatus,  targetStatus: ItemStatus): boolean => {  // ?�태 변�?규칙 ?�의  const allowedTransitions: Record<ItemStatus, ItemStatus[]> = {    active: ['reserved', 'sold'],      // ?�매�????�약�? ?�매?�료    reserved: ['active', 'sold'],     // ?�약�????�매�? ?�매?�료    sold: []                          // ?�매?�료 ??변�?불�?  };    return allowedTransitions[currentStatus].includes(targetStatus);};// ?�태�??�상 �??�스??export const getStatusDisplayInfo = (status: ItemStatus): {  color: string;  backgroundColor: string;  text: string;  description: string;} => {  switch (status) {    case 'active':      return {        color: '#059669',        backgroundColor: '#d1fae5',        text: '?�매�?,        description: '?�재 ?�매 중인 ?�품?�니??      };    case 'reserved':      return {        color: '#d97706',        backgroundColor: '#fed7aa',        text: '?�약�?,        description: '구매?��? ?�약???�품?�니??      };    case 'sold':      return {        color: '#dc2626',        backgroundColor: '#fecaca',        text: '?�매?�료',        description: '?�매가 ?�료???�품?�니??      };    default:      return {        color: '#6b7280',        backgroundColor: '#f3f4f6',        text: '?????�음',        description: '?�태 ?�보가 ?�습?�다'      };  }}; 
