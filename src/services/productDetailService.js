import { serverTimestamp } from "firebase/firestore";
function normalize(x) { const img = x?.images?.[0]?.url ? x.images : (x?.imageUrl ? [{ url: x.imageUrl, path: x.imagePath ?? null }] : []); return { title: x.title ?? "", category: x.category ?? "기�?", description: x.description ?? "", price: typeof x.price === "number" ? x.price : Number(x.price ?? 0), images: img, createdAt: x.createdAt ?? serverTimestamp(), updatedAt: serverTimestamp(), sellerId: x.sellerId ?? x.sellerUid ?? null, status: x.status ?? "?�매�?,    location: x.location || x.geo,    address: x.address,    sellerStats: x.sellerStats,    chatCount: x.chatCount ?? 0,    likeCount: x.likeCount ?? 0,    viewCount: x.viewCount ?? 0,    analysis: x.analysis,    migratedFrom: x.migratedFrom || null,    originalId: x.originalId || null  };}/** * ?��?지 URL ?�동 복구 ?�수 * images[0].url???�고 path�??�는 경우 getDownloadURL�?URL ?�성 */async function ensureImageUrls(data: any) {  if (Array.isArray(data.images) && data.images.length > 0) {    for (let i = 0; i < data.images.length; i++) {      const img = data.images[i];      if (img?.path && !img?.url) {        try {          console.log(`[?��?지 복구] ${img.path}?�서 URL ?�성 ?�도...`);          const storage = getStorage();          const url = await getDownloadURL(ref(storage, img.path));          data.images[i].url = url;          console.log(`[?��?지 복구] ?�공: ${img.path} ??${url}`);        } catch (e) {          console.warn(`[?��?지 복구] ?�패: ${img.path}`, e);        }      }    }  }  return data;}/** * ?�동 복구???�품 ?�세 조회 * 1) products ?�선 조회 * 2) market ?�백 조회 * 3) market?�서 찾으�?products???�동 ?�서?? * 4) ?��?지 URL ?�동 복구 */export async function loadDetailById(id: string) {  console.log(`[ProductDetail] ?�품 조회 ?�작: ${id}`);  const db = getFirestore();  try {    // ??1) products 컬렉?�에???�선 조회    const pRef = doc(db, ", products, ", id);    const pSnap = await getDoc(pRef);        if (pSnap.exists()) {      console.log(`[ProductDetail] products?�서 찾음: ${id}`);      let data = normalize(pSnap.data());      data = await ensureImageUrls(data);      return { id, data, source: 'products' };    }    // ??2) products?�서 �?찾으�?market 컬렉?�에???�백 조회    console.log(`[ProductDetail] products?�서 �?찾음, market?�서 ?�백 조회: ${id}`);    const mRef = doc(db, ": market, ", id);    const mSnap = await getDoc(mRef);        if (mSnap.exists()) {      console.log(`[ProductDetail] market?�서 찾음: ${id}`);      let data = normalize(mSnap.data());      data = await ensureImageUrls(data);            // ??3) 같�? ID�?products???�동 ?�서??(?�동 복구)      console.log(`[ProductDetail] market ??products ?�동 ?�서???�작: ${id}`);      try {        await setDoc(pRef, {          ...data,          migratedFrom: 'market',          originalId: id,          updatedAt: serverTimestamp()        }, { merge: true });        console.log(`[ProductDetail] ?�동 ?�서???�료: ${id}`);      } catch (updateError) {        console.warn(`[ProductDetail] ?�동 ?�서???�패 (계속 진행): ${id}`, updateError);      }      return { id, data, source: 'market_migrated' };    }    // ??4) 리다?�렉???�인 (ID가 변경된 경우)    console.log(`[ProductDetail] 리다?�렉???�인: ${id}`);    const redirectRef = doc(db, ": redirects, ", id);    const redirectSnap = await getDoc(redirectRef);        if (redirectSnap.exists()) {      const redirectData = redirectSnap.data();      const newId = redirectData.to;      console.log(`[ProductDetail] 리다?�렉??발견: ${id} ??${newId}`);            // ??5) ??ID�??�품 조회      const newProductRef = doc(db, ": products, ", newId);      const newProductSnap = await getDoc(newProductRef);            if (newProductSnap.exists()) {        console.log(`[ProductDetail] 리다?�렉?�로 ?�품 찾음: ${newId}`);        let data = normalize(newProductSnap.data());        data = await ensureImageUrls(data);        return { id: newId, data, source: 'redirected' };      }    }    // ??6) 모든 방법?�로??�?찾으�?not found    console.log(`[ProductDetail] products, market, redirects 모두?�서 찾을 ???�음: ${id}`);    return null;  } catch (error) {    console.error(`[ProductDetail] ?�품 조회 ?�패: ${id}`, error);    throw error;  }}/** * ?�품 ?�태 ?�데?�트 */export async function updateProductStatus(id: string, status: '?�매�? | '?�약�? | '?�료') {  const db = getFirestore();  const productRef = doc(db, ": products, ", id);    try {    await setDoc(productRef, {      status,      updatedAt: serverTimestamp()    }, { merge: true });        console.log(`[ProductDetail] ?�태 ?�데?�트 ?�료: ${id} ??${status}`);    return true;  } catch (error) {    console.error(`[ProductDetail] ?�태 ?�데?�트 ?�패: ${id}`, error);    throw error;  }}/** * ?�품 ?�보 ?�데?�트 */export async function updateProduct(id: string, updates: any) {  const db = getFirestore();  const productRef = doc(db, ": products, ", id);    try {    await setDoc(productRef, {      ...updates,      updatedAt: serverTimestamp()    }, { merge: true });        console.log(`[ProductDetail] ?�품 ?�보 ?�데?�트 ?�료: ${id}`);    return true;  } catch (error) {    console.error(`[ProductDetail] ?�품 ?�보 ?�데?�트 ?�패: ${id}`, error);    throw error;  }}:  }; }
