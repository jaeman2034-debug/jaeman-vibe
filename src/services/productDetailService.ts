import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "firebase/firestore";import { getStorage, ref, getDownloadURL } from "firebase/storage";/** * ?í’ˆ ?°ì´???•ê·œ???¨ìˆ˜ * ?¤ì–‘???•íƒœ???°ì´?°ë? ?œì? ?•íƒœë¡?ë³€?? */function normalize(x: any) {  const img = x?.images?.[0]?.url    ? x.images    : (x?.imageUrl ? [{ url: x.imageUrl, path: x.imagePath ?? null }] : []);    return {    title: x.title ?? "",    category: x.category ?? "ê¸°í?",    description: x.description ?? "",    price: typeof x.price === "number" ? x.price : Number(x.price ?? 0),    images: img,    createdAt: x.createdAt ?? serverTimestamp(),    updatedAt: serverTimestamp(),    sellerId: x.sellerId ?? x.sellerUid ?? null,    status: x.status ?? "?ë§¤ì¤?,    location: x.location || x.geo,    address: x.address,    sellerStats: x.sellerStats,    chatCount: x.chatCount ?? 0,    likeCount: x.likeCount ?? 0,    viewCount: x.viewCount ?? 0,    analysis: x.analysis,    migratedFrom: x.migratedFrom || null,    originalId: x.originalId || null  };}/** * ?´ë?ì§€ URL ?ë™ ë³µêµ¬ ?¨ìˆ˜ * images[0].url???†ê³  pathë§??ˆëŠ” ê²½ìš° getDownloadURLë¡?URL ?ì„± */async function ensureImageUrls(data: any) {  if (Array.isArray(data.images) && data.images.length > 0) {    for (let i = 0; i < data.images.length; i++) {      const img = data.images[i];      if (img?.path && !img?.url) {        try {          console.log(`[?´ë?ì§€ ë³µêµ¬] ${img.path}?ì„œ URL ?ì„± ?œë„...`);          const storage = getStorage();          const url = await getDownloadURL(ref(storage, img.path));          data.images[i].url = url;          console.log(`[?´ë?ì§€ ë³µêµ¬] ?±ê³µ: ${img.path} ??${url}`);        } catch (e) {          console.warn(`[?´ë?ì§€ ë³µêµ¬] ?¤íŒ¨: ${img.path}`, e);        }      }    }  }  return data;}/** * ?ë™ ë³µêµ¬???í’ˆ ?ì„¸ ì¡°íšŒ * 1) products ?°ì„  ì¡°íšŒ * 2) market ?´ë°± ì¡°íšŒ * 3) market?ì„œ ì°¾ìœ¼ë©?products???ë™ ?…ì„œ?? * 4) ?´ë?ì§€ URL ?ë™ ë³µêµ¬ */export async function loadDetailById(id: string) {  console.log(`[ProductDetail] ?í’ˆ ì¡°íšŒ ?œìž‘: ${id}`);  const db = getFirestore();  try {    // ??1) products ì»¬ë ‰?˜ì—???°ì„  ì¡°íšŒ    const pRef = doc(db, "products", id);    const pSnap = await getDoc(pRef);        if (pSnap.exists()) {      console.log(`[ProductDetail] products?ì„œ ì°¾ìŒ: ${id}`);      let data = normalize(pSnap.data());      data = await ensureImageUrls(data);      return { id, data, source: 'products' };    }    // ??2) products?ì„œ ëª?ì°¾ìœ¼ë©?market ì»¬ë ‰?˜ì—???´ë°± ì¡°íšŒ    console.log(`[ProductDetail] products?ì„œ ëª?ì°¾ìŒ, market?ì„œ ?´ë°± ì¡°íšŒ: ${id}`);    const mRef = doc(db, "market", id);    const mSnap = await getDoc(mRef);        if (mSnap.exists()) {      console.log(`[ProductDetail] market?ì„œ ì°¾ìŒ: ${id}`);      let data = normalize(mSnap.data());      data = await ensureImageUrls(data);            // ??3) ê°™ì? IDë¡?products???ë™ ?…ì„œ??(?ë™ ë³µêµ¬)      console.log(`[ProductDetail] market ??products ?ë™ ?…ì„œ???œìž‘: ${id}`);      try {        await setDoc(pRef, {          ...data,          migratedFrom: 'market',          originalId: id,          updatedAt: serverTimestamp()        }, { merge: true });        console.log(`[ProductDetail] ?ë™ ?…ì„œ???„ë£Œ: ${id}`);      } catch (updateError) {        console.warn(`[ProductDetail] ?ë™ ?…ì„œ???¤íŒ¨ (ê³„ì† ì§„í–‰): ${id}`, updateError);      }      return { id, data, source: 'market_migrated' };    }    // ??4) ë¦¬ë‹¤?´ë ‰???•ì¸ (IDê°€ ë³€ê²½ëœ ê²½ìš°)    console.log(`[ProductDetail] ë¦¬ë‹¤?´ë ‰???•ì¸: ${id}`);    const redirectRef = doc(db, "redirects", id);    const redirectSnap = await getDoc(redirectRef);        if (redirectSnap.exists()) {      const redirectData = redirectSnap.data();      const newId = redirectData.to;      console.log(`[ProductDetail] ë¦¬ë‹¤?´ë ‰??ë°œê²¬: ${id} ??${newId}`);            // ??5) ??IDë¡??í’ˆ ì¡°íšŒ      const newProductRef = doc(db, "products", newId);      const newProductSnap = await getDoc(newProductRef);            if (newProductSnap.exists()) {        console.log(`[ProductDetail] ë¦¬ë‹¤?´ë ‰?¸ë¡œ ?í’ˆ ì°¾ìŒ: ${newId}`);        let data = normalize(newProductSnap.data());        data = await ensureImageUrls(data);        return { id: newId, data, source: 'redirected' };      }    }    // ??6) ëª¨ë“  ë°©ë²•?¼ë¡œ??ëª?ì°¾ìœ¼ë©?not found    console.log(`[ProductDetail] products, market, redirects ëª¨ë‘?ì„œ ì°¾ì„ ???†ìŒ: ${id}`);    return null;  } catch (error) {    console.error(`[ProductDetail] ?í’ˆ ì¡°íšŒ ?¤íŒ¨: ${id}`, error);    throw error;  }}/** * ?í’ˆ ?íƒœ ?…ë°?´íŠ¸ */export async function updateProductStatus(id: string, status: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ') {  const db = getFirestore();  const productRef = doc(db, "products", id);    try {    await setDoc(productRef, {      status,      updatedAt: serverTimestamp()    }, { merge: true });        console.log(`[ProductDetail] ?íƒœ ?…ë°?´íŠ¸ ?„ë£Œ: ${id} ??${status}`);    return true;  } catch (error) {    console.error(`[ProductDetail] ?íƒœ ?…ë°?´íŠ¸ ?¤íŒ¨: ${id}`, error);    throw error;  }}/** * ?í’ˆ ?•ë³´ ?…ë°?´íŠ¸ */export async function updateProduct(id: string, updates: any) {  const db = getFirestore();  const productRef = doc(db, "products", id);    try {    await setDoc(productRef, {      ...updates,      updatedAt: serverTimestamp()    }, { merge: true });        console.log(`[ProductDetail] ?í’ˆ ?•ë³´ ?…ë°?´íŠ¸ ?„ë£Œ: ${id}`);    return true;  } catch (error) {    console.error(`[ProductDetail] ?í’ˆ ?•ë³´ ?…ë°?´íŠ¸ ?¤íŒ¨: ${id}`, error);    throw error;  }}
