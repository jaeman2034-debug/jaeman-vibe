import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc } from "firebase/firestore";import type { UploadedImage } from "./uploadService";import { uploadProductImage, uploadProductImages } from "./uploadService";import { getCurrentLocation } from "@/features/location/locationService";const db = getFirestore();export type ProductInput = {  title: string;  category: string;  description: string;  price: number;  sellerId?: string | null;  dongCode?: string | null;  location?: { lat: number; lng: number } | null;  address?: { sido: string; sigungu: string; dong: string; full: string } | null;};export type ProductData = ProductInput & {  images: UploadedImage[];  imageUrls: string[];  thumbnail: string;  status: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ';  createdAt: any;  updatedAt: any;};// ???¨ì¼ ?´ë?ì§€ë¡??í’ˆ ?ì„± (?”ì²­??ë¡œì§)export async function createProduct(values: any, file?: File): Promise<string> {  const db = getFirestore();  let images = [];    if (file) {    const up = await uploadProductImage(file); // {url, path}    images = [up];  }    // ?”¥ values?ì„œ id ?„ë“œ ?œê±° (data.id ê¸ˆì?)  const { id, ...cleanValues } = values;  if (id) {    console.warn(`[createProduct] values?ì„œ id ?„ë“œ ?œê±°?? ${id}`);  }    // ?”¥ ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?(ë°˜ë“œ???€??  let currentLocation = null;  try {    currentLocation = await getCurrentLocation();    console.log("[CREATE] ?„ì¬ ?„ì¹˜ ê°€?¸ì˜´:", currentLocation);  } catch (error) {    console.warn("[CREATE] ?„ì¹˜ ê°€?¸ì˜¤ê¸??¤íŒ¨:", error);  }    // ? ï¸ payload??id ?£ì? ë§ˆì„¸??(data.id ê¸ˆì?)  const docRef = await addDoc(collection(db, "products"), {    ...cleanValues,    images,    // ?”¥ ?„ì¬ ?„ì¹˜ ë°˜ë“œ???€??(?†ìœ¼ë©??ì›??pending/fail)    loc: currentLocation && {      lat: currentLocation.lat,      lng: currentLocation.lng,    },    // ?”¥ ê¸°ë³¸ ì£¼ì†Œ ?íƒœ ?¤ì •    addr: {      hjdStatus: 'pending' as const    },    createdAt: serverTimestamp(),  });    return docRef.id;                 // ??ë°˜ë“œ??ë°˜í™˜}// ???¤ì¤‘ ?´ë?ì§€ë¡??í’ˆ ?ì„±export async function createProductWithImages(  values: any,   files: FileList,  onProgress?: (current: number, total: number, fileName: string) => void): Promise<string> {  if (!files || files.length === 0) {    return createProduct(values);  }    // ?”¥ values?ì„œ id ?„ë“œ ?œê±° (data.id ê¸ˆì?)  const { id, ...cleanValues } = values;  if (id) {    console.warn(`[createProductWithImages] values?ì„œ id ?„ë“œ ?œê±°?? ${id}`);  }    // ?”¥ ?„ì¬ ?„ì¹˜ ê°€?¸ì˜¤ê¸?(ë°˜ë“œ???€??  let currentLocation = null;  try {    currentLocation = await getCurrentLocation();    console.log("[CREATE] ?„ì¬ ?„ì¹˜ ê°€?¸ì˜´:", currentLocation);  } catch (error) {    console.warn("[CREATE] ?„ì¹˜ ê°€?¸ì˜¤ê¸??¤íŒ¨:", error);  }    // ??ë¨¼ì? ?í’ˆ ë¬¸ì„œ ?ì„±  const docRef = await addDoc(collection(db, "products"), {    ...cleanValues,    images: [],    // ?”¥ ?„ì¬ ?„ì¹˜ ë°˜ë“œ???€??(?†ìœ¼ë©??ì›??pending/fail)    loc: currentLocation && {      lat: currentLocation.lat,      lng: currentLocation.lng,    },    // ?”¥ ê¸°ë³¸ ì£¼ì†Œ ?íƒœ ?¤ì •    addr: {      hjdStatus: 'pending' as const    },    createdAt: serverTimestamp(),  });    // ???´ë?ì§€ ?…ë¡œ??(ì§„í–‰ë¥?ì½œë°± ?¬í•¨)  const uploadedImages = await uploadProductImages(files, onProgress);    // ??ë¬¸ì„œ ?…ë°?´íŠ¸ (?´ë?ì§€ ?•ë³´ ì¶”ê?)  await updateDoc(docRef, {    images: uploadedImages,    updatedAt: serverTimestamp(),  });    return docRef.id;}// ???í’ˆ ?…ë°?´íŠ¸ (?´ë?ì§€ ì¶”ê?/êµì²´)export async function updateProductImages(  productId: string,   files: FileList,  onProgress?: (current: number, total: number, fileName: string) => void): Promise<void> {  if (!files || files.length === 0) return;    // ??ê¸°ì¡´ ?´ë?ì§€ ?•ë³´ ê°€?¸ì˜¤ê¸?  const productRef = doc(db, "products", productId);    // ?????´ë?ì§€ ?…ë¡œ??  const uploadedImages = await uploadProductImages(files, onProgress);    // ??ë¬¸ì„œ ?…ë°?´íŠ¸ (ê¸°ì¡´ ?´ë?ì§€ + ???´ë?ì§€)  await updateDoc(productRef, {    images: uploadedImages,    imageUrls: uploadedImages.map(img => img.url),    thumbnail: uploadedImages[0]?.url || "",    updatedAt: serverTimestamp(),  });}// ???í’ˆ ?íƒœ ?…ë°?´íŠ¸export async function updateProductStatus(  productId: string,   status: '?ë§¤ì¤? | '?ˆì•½ì¤? | '?„ë£Œ'): Promise<void> {  const productRef = doc(db, "products", productId);  await updateDoc(productRef, {    status,    updatedAt: serverTimestamp(),  });}// ???í’ˆ ?•ë³´ ?…ë°?´íŠ¸export async function updateProduct(  productId: string,   updates: Partial<ProductInput>): Promise<void> {  const productRef = doc(db, "products", productId);  await updateDoc(productRef, {    ...updates,    updatedAt: serverTimestamp(),  });} 
