"use strict";
// src/services/searchService.tsimport { collection, query, where, orderBy, limit, getDocs, startAfter } from 'firebase/firestore';import { db } from '@/lib/firebase';import type { MarketItem, SearchResult, Location } from '../features/market/types';import { searchItemsByLocation, calculateLocationScore } from './locationService';// 검???�???�의export type SearchType = 'text' | 'image' | 'voice' | 'semantic';// 검???�터 ?�터?�이??export interface SearchFilters {  category?: string;  priceRange?: {    min: number;    max: number;  };  condition?: string;  region?: string;  radiusKm?: number;  brand?: string;  tags?: string[];}// 검???�션 ?�터?�이??export interface SearchOptions {  type: SearchType;  query: string;  filters?: SearchFilters;  userLocation?: Location;  limit?: number;  offset?: number;  sortBy?: 'relevance' | 'distance' | 'price' | 'freshness' | 'popularity';}// 검??결과 ?�터?�이??export interface SearchResultWithScore extends SearchResult {  finalScore: number;  relevance: number;  distance?: number;  freshness: number;  popularity: number;}// ?�스??검??(Algolia/Meilisearch ?��??�이??export const performTextSearch = async (  query: string,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?�제로는 Algolia/Meilisearch API ?�출    // ?�기?�는 Firestore 기반 ?��??�이??        let q = query(      collection(db, 'market_items'),      where('status', '==', 'active')    );    // 카테고리 ?�터    if (filters?.category) {      q = query(q, where('category', '==', filters.category));    }    // 가�?범위 ?�터    if (filters?.priceRange) {      if (filters.priceRange.min > 0) {        q = query(q, where('price', '>=', filters.priceRange.min));      }      if (filters.priceRange.max < 1000000) {        q = query(q, where('price', '<=', filters.priceRange.max));      }    }    // ?�태 ?�급 ?�터    if (filters?.condition) {      q = query(q, where('condition', '==', filters.condition));    }    // 지???�터    if (filters?.region) {      q = query(q, where('geo.region', '==', filters.region));    }    // 기본 ?�렬 (최신??    q = query(q, orderBy('createdAt', 'desc'), limit(limitCount));    const querySnapshot = await getDocs(q);    const results: SearchResult[] = [];    querySnapshot.forEach((doc) => {      const data = doc.data() as MarketItem;            // ?�스??관?�성 계산 (간단???�워??매칭)      const relevance = calculateTextRelevance(query, data);            if (relevance > 0.1) { // 최소 관?�성 ?�계�?                 results.push({           id: doc.id,           title: data.title,           description: data.description,           price: data.price,           category: data.category,           region: data.region || '지???�보 ?�음',           distance: undefined, // ?�치 기반 검?�에??계산           relevance,           imageUrl: data.images?.[0] || '/placeholder.jpg',           ai: data.ai,           createdAt: data.createdAt         });      }    });    // 관?�성 ?�으�??�렬    return results.sort((a, b) => b.relevance - a.relevance);  } catch (error) {    console.error('?�스??검???�패:', error);    return [];  }};// ?��?지 검??(CLIP/OpenAI Vision ?��??�이??export const performImageSearch = async (  imageFile: File,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?�제로는 ?��?지 ?�베???�성 ??벡터 DB 검??    // ?�기?�는 ?��??�이??        // ?��?지 분석 ?��??�이??    await new Promise(resolve => setTimeout(resolve, 2000));        // ?�사???�품 검??결과 ?��??�이??    const mockResults: SearchResult[] = [      {        id: 'img-1',        title: '?�로???��?지?� ?�사??축구??,        description: '?��?지 분석 결과?� 가???�사???�품',        price: 180000,        category: '축구??,        region: '?�울',        distance: undefined,        relevance: 0.85,        imageUrl: '/mock-similar-shoe.jpg',        ai: { quality_score: 0.82, confidence: 0.88 }      },      {        id: 'img-2',        title: '?�사???��??�의 축구??,        description: '?�자?�과 ?�상???�사???�품',        price: 150000,        category: '축구??,        region: '부??,        distance: undefined,        relevance: 0.78,        imageUrl: '/mock-similar-style.jpg',        ai: { quality_score: 0.75, confidence: 0.81 }      }    ];    // ?�터 ?�용    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?��?지 검???�패:', error);    return [];  }};// ?�성 검??(Web Speech API ?��??�이??export const performVoiceSearch = async (  audioBlob: Blob,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?�제로는 Web Speech API ?�는 ?�성 ?�식 ?�비???�용    // ?�기?�는 ?��??�이??        // ?�성 ?�식 ?��??�이??    await new Promise(resolve => setTimeout(resolve, 1500));        // ?�성 검??결과 ?��??�이??    const mockResults: SearchResult[] = [      {        id: 'voice-1',        title: '?�성 검?? 축구??,        description: '?�성?�로 검?�한 축구???�품',        price: 95000,        category: '축구??,        region: '?�천',        distance: undefined,        relevance: 0.72,        imageUrl: '/mock-voice-result.jpg',        ai: { quality_score: 0.68, confidence: 0.75 }      }    ];    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?�성 검???�패:', error);    return [];  }};// ?��? 검??(?�베??기반 ?��??�이??export const performSemanticSearch = async (  query: string,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?�제로는 OpenAI/Vertex AI ?�베???�성 ??Pinecone/Weaviate 검??    // ?�기?�는 ?��??�이??        // ?��? 분석 ?��??�이??    await new Promise(resolve => setTimeout(resolve, 1000));        // ?��????�사??기반 검??결과 ?��??�이??    const mockResults: SearchResult[] = [      {        id: 'semantic-1',        title: '?��????�사??기반 검??결과',        description: '?�베??벡터 ?�사?�로 찾�? ?�품',        price: 135000,        category: '축구??,        region: '?��?,        distance: undefined,        relevance: 0.91,        imageUrl: '/mock-semantic-result.jpg',        ai: { quality_score: 0.85, confidence: 0.88 }      },      {        id: 'semantic-2',        title: '컨텍?�트 기반 추천 ?�품',        description: '검?�어??맥락??고려??추천',        price: 165000,        category: '축구??,        region: '광주',        distance: undefined,        relevance: 0.87,        imageUrl: '/mock-context-result.jpg',        ai: { quality_score: 0.79, confidence: 0.83 }      }    ];    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?��? 검???�패:', error);    return [];  }};// ?�합 검???�비??export const performUnifiedSearch = async (  options: SearchOptions): Promise<SearchResultWithScore[]> => {  try {    let searchResults: SearchResult[] = [];    // 검???�?�별 ?�행    switch (options.type) {      case 'text':        searchResults = await performTextSearch(          options.query,          options.filters,          options.limit || 20        );        break;            case 'image':        // ?��?지 ?�일???�요?��?�??�기?�는 ?��??�이??        searchResults = await performImageSearch(          new File([''], 'mock.jpg'),          options.filters,          options.limit || 20        );        break;            case 'voice':        // ?�성 ?�이?��? ?�요?��?�??�기?�는 ?��??�이??        searchResults = await performVoiceSearch(          new Blob([''], { type: 'audio/wav' }),          options.filters,          options.limit || 20        );        break;            case 'semantic':        searchResults = await performSemanticSearch(          options.query,          options.filters,          options.limit || 20        );        break;    }    // 가중치 기반 ??�� ?�용    const rankedResults = applyWeightedRanking(      searchResults,      options.userLocation,      options.sortBy || 'relevance'    );    return rankedResults;  } catch (error) {    console.error('?�합 검???�패:', error);    return [];  }};// 가중치 기반 ??�� ?�용export const applyWeightedRanking = (  results: SearchResult[],  userLocation?: Location,  sortBy: string = 'relevance'): SearchResultWithScore[] => {  return results.map(item => {    let finalScore = 0;        // Relevance 가중치 (60%)    const relevanceScore = item.relevance || 0;    finalScore += relevanceScore * 0.6;        // Distance 가중치 (20%) - ?�용???�치가 ?�을 ?�만    let distanceScore = 0;    if (userLocation && item.distance !== undefined) {      distanceScore = Math.max(0, 1 - (item.distance / 50)); // 50km 기�? ?�규??      finalScore += distanceScore * 0.2;    }        // Freshness 가중치 (20%) - 최신 ?�품 ?�선    const freshnessScore = 0.8; // ?�제로는 createdAt 기반 계산    finalScore += freshnessScore * 0.2;        // Popularity 가중치 (추�? ?�수)    const popularityScore = calculatePopularityScore(item);        return {      ...item,      finalScore,      relevance: relevanceScore,      distance: item.distance,      freshness: freshnessScore,      popularity: popularityScore    };  }).sort((a, b) => b.finalScore - a.finalScore);};// ?�스??관?�성 계산const calculateTextRelevance = (query: string, item: MarketItem): number => {  const queryLower = query.toLowerCase();  const titleLower = item.title.toLowerCase();  const descLower = item.description.toLowerCase();  const categoryLower = item.category.toLowerCase();    let score = 0;    // ?�목 매칭 (가???��? 가중치)  if (titleLower.includes(queryLower)) {    score += 0.8;  }    // ?�명 매칭  if (descLower.includes(queryLower)) {    score += 0.4;  }    // 카테고리 매칭  if (categoryLower.includes(queryLower)) {    score += 0.6;  }    // 브랜??모델 매칭  if (item.brand && item.brand.toLowerCase().includes(queryLower)) {    score += 0.7;  }    if (item.model && item.model.toLowerCase().includes(queryLower)) {    score += 0.7;  }    // ?�그 매칭  if (item.ai?.tags) {    const tagMatches = item.ai.tags.filter(tag =>       tag.toLowerCase().includes(queryLower)    ).length;    score += tagMatches * 0.3;  }    return Math.min(1, score);};// ?�기???�수 계산const calculatePopularityScore = (item: MarketItem): number => {  let score = 0.5; // 기본 ?�수    // AI ?�질 ?�수 반영  if (item.ai?.quality_score) {    score += item.ai.quality_score * 0.3;  }    // 가�??��??�질 (?�가 고품�??�품 ?�호)  if (item.price > 0) {    const priceQualityRatio = (item.ai?.quality_score || 0.5) / (item.price / 100000);    score += Math.min(0.2, priceQualityRatio);  }    return Math.min(1, score);};// ?�터 ?�용const applyFilters = (results: SearchResult[], filters?: SearchFilters): SearchResult[] => {  if (!filters) return results;    return results.filter(item => {    // 카테고리 ?�터    if (filters.category && item.category !== filters.category) {      return false;    }        // 가�?범위 ?�터    if (filters.priceRange) {      if (item.price < filters.priceRange.min || item.price > filters.priceRange.max) {        return false;      }    }        // ?�태 ?�급 ?�터    if (filters.condition && item.ai?.quality_score) {      const condition = item.ai.quality_score > 0.8 ? 'A' :                        item.ai.quality_score > 0.6 ? 'B' : 'C';      if (condition !== filters.condition) {        return false;      }    }        // 지???�터    if (filters.region && item.region !== filters.region) {      return false;    }        // 브랜???�터    if (filters.brand && item.title.toLowerCase().indexOf(filters.brand.toLowerCase()) === -1) {      return false;    }        return true;  });};// 검???�안 (?�동?�성)export const getSearchSuggestions = async (  partialQuery: string,  limitCount: number = 5): Promise<string[]> => {  try {    if (partialQuery.length < 2) return [];        // ?�제로는 검???�진???�동?�성 API ?�용    // ?�기?�는 간단???��??�이??        const suggestions = [      '축구??,      'NIKE 머큐리얼',      'Adidas ?�레?�터',      '축구 ?�니??,      '보호?�비',      '축구�?,      '?�레?�닝�?    ];        return suggestions      .filter(suggestion =>         suggestion.toLowerCase().includes(partialQuery.toLowerCase())      )      .slice(0, limitCount);        } catch (error) {    console.error('검???�안 ?�패:', error);    return [];  }};// ?�기 검?�어export const getPopularSearches = async (): Promise<string[]> => {  try {    // ?�제로는 검??로그 분석 ?�는 ?�기 ?�품 기반    return [      '축구??,      'NIKE',      'Adidas',      '?�레?�터',      '머큐리얼',      '?�니??,      '보호?�비'    ];  } catch (error) {    console.error('?�기 검?�어 조회 ?�패:', error);    return [];  }};// 검???�계export const getSearchStats = async (): Promise<{  totalSearches: number;  popularCategories: string[];  averageRelevance: number;}> => {  try {    // ?�제로는 검??로그 분석    return {      totalSearches: 1250,      popularCategories: ['축구??, '?�니??, '보호?�비'],      averageRelevance: 0.78    };  } catch (error) {    console.error('검???�계 조회 ?�패:', error);    return {      totalSearches: 0,      popularCategories: [],      averageRelevance: 0    };  }}; 
