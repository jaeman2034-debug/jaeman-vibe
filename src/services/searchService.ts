// src/services/searchService.tsimport { collection, query, where, orderBy, limit, getDocs, startAfter } from 'firebase/firestore';import { db } from '@/lib/firebase';import type { MarketItem, SearchResult, Location } from '../features/market/types';import { searchItemsByLocation, calculateLocationScore } from './locationService';// ê²€???€???•ì˜export type SearchType = 'text' | 'image' | 'voice' | 'semantic';// ê²€???„í„° ?¸í„°?˜ì´??export interface SearchFilters {  category?: string;  priceRange?: {    min: number;    max: number;  };  condition?: string;  region?: string;  radiusKm?: number;  brand?: string;  tags?: string[];}// ê²€???µì…˜ ?¸í„°?˜ì´??export interface SearchOptions {  type: SearchType;  query: string;  filters?: SearchFilters;  userLocation?: Location;  limit?: number;  offset?: number;  sortBy?: 'relevance' | 'distance' | 'price' | 'freshness' | 'popularity';}// ê²€??ê²°ê³¼ ?¸í„°?˜ì´??export interface SearchResultWithScore extends SearchResult {  finalScore: number;  relevance: number;  distance?: number;  freshness: number;  popularity: number;}// ?ìŠ¤??ê²€??(Algolia/Meilisearch ?œë??ˆì´??export const performTextSearch = async (  query: string,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?¤ì œë¡œëŠ” Algolia/Meilisearch API ?¸ì¶œ    // ?¬ê¸°?œëŠ” Firestore ê¸°ë°˜ ?œë??ˆì´??        let q = query(      collection(db, 'market_items'),      where('status', '==', 'active')    );    // ì¹´í…Œê³ ë¦¬ ?„í„°    if (filters?.category) {      q = query(q, where('category', '==', filters.category));    }    // ê°€ê²?ë²”ìœ„ ?„í„°    if (filters?.priceRange) {      if (filters.priceRange.min > 0) {        q = query(q, where('price', '>=', filters.priceRange.min));      }      if (filters.priceRange.max < 1000000) {        q = query(q, where('price', '<=', filters.priceRange.max));      }    }    // ?íƒœ ?±ê¸‰ ?„í„°    if (filters?.condition) {      q = query(q, where('condition', '==', filters.condition));    }    // ì§€???„í„°    if (filters?.region) {      q = query(q, where('geo.region', '==', filters.region));    }    // ê¸°ë³¸ ?•ë ¬ (ìµœì‹ ??    q = query(q, orderBy('createdAt', 'desc'), limit(limitCount));    const querySnapshot = await getDocs(q);    const results: SearchResult[] = [];    querySnapshot.forEach((doc) => {      const data = doc.data() as MarketItem;            // ?ìŠ¤??ê´€?¨ì„± ê³„ì‚° (ê°„ë‹¨???¤ì›Œ??ë§¤ì¹­)      const relevance = calculateTextRelevance(query, data);            if (relevance > 0.1) { // ìµœì†Œ ê´€?¨ì„± ?„ê³„ê°?                 results.push({           id: doc.id,           title: data.title,           description: data.description,           price: data.price,           category: data.category,           region: data.region || 'ì§€???•ë³´ ?†ìŒ',           distance: undefined, // ?„ì¹˜ ê¸°ë°˜ ê²€?‰ì—??ê³„ì‚°           relevance,           imageUrl: data.images?.[0] || '/placeholder.jpg',           ai: data.ai,           createdAt: data.createdAt         });      }    });    // ê´€?¨ì„± ?œìœ¼ë¡??•ë ¬    return results.sort((a, b) => b.relevance - a.relevance);  } catch (error) {    console.error('?ìŠ¤??ê²€???¤íŒ¨:', error);    return [];  }};// ?´ë?ì§€ ê²€??(CLIP/OpenAI Vision ?œë??ˆì´??export const performImageSearch = async (  imageFile: File,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?¤ì œë¡œëŠ” ?´ë?ì§€ ?„ë² ???ì„± ??ë²¡í„° DB ê²€??    // ?¬ê¸°?œëŠ” ?œë??ˆì´??        // ?´ë?ì§€ ë¶„ì„ ?œë??ˆì´??    await new Promise(resolve => setTimeout(resolve, 2000));        // ? ì‚¬???í’ˆ ê²€??ê²°ê³¼ ?œë??ˆì´??    const mockResults: SearchResult[] = [      {        id: 'img-1',        title: '?…ë¡œ???´ë?ì§€?€ ? ì‚¬??ì¶•êµ¬??,        description: '?´ë?ì§€ ë¶„ì„ ê²°ê³¼?€ ê°€??? ì‚¬???í’ˆ',        price: 180000,        category: 'ì¶•êµ¬??,        region: '?œìš¸',        distance: undefined,        relevance: 0.85,        imageUrl: '/mock-similar-shoe.jpg',        ai: { quality_score: 0.82, confidence: 0.88 }      },      {        id: 'img-2',        title: '? ì‚¬???¤í??¼ì˜ ì¶•êµ¬??,        description: '?”ì?¸ê³¼ ?‰ìƒ??? ì‚¬???í’ˆ',        price: 150000,        category: 'ì¶•êµ¬??,        region: 'ë¶€??,        distance: undefined,        relevance: 0.78,        imageUrl: '/mock-similar-style.jpg',        ai: { quality_score: 0.75, confidence: 0.81 }      }    ];    // ?„í„° ?ìš©    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?´ë?ì§€ ê²€???¤íŒ¨:', error);    return [];  }};// ?Œì„± ê²€??(Web Speech API ?œë??ˆì´??export const performVoiceSearch = async (  audioBlob: Blob,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?¤ì œë¡œëŠ” Web Speech API ?ëŠ” ?Œì„± ?¸ì‹ ?œë¹„???¬ìš©    // ?¬ê¸°?œëŠ” ?œë??ˆì´??        // ?Œì„± ?¸ì‹ ?œë??ˆì´??    await new Promise(resolve => setTimeout(resolve, 1500));        // ?Œì„± ê²€??ê²°ê³¼ ?œë??ˆì´??    const mockResults: SearchResult[] = [      {        id: 'voice-1',        title: '?Œì„± ê²€?? ì¶•êµ¬??,        description: '?Œì„±?¼ë¡œ ê²€?‰í•œ ì¶•êµ¬???í’ˆ',        price: 95000,        category: 'ì¶•êµ¬??,        region: '?¸ì²œ',        distance: undefined,        relevance: 0.72,        imageUrl: '/mock-voice-result.jpg',        ai: { quality_score: 0.68, confidence: 0.75 }      }    ];    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?Œì„± ê²€???¤íŒ¨:', error);    return [];  }};// ?˜ë? ê²€??(?„ë² ??ê¸°ë°˜ ?œë??ˆì´??export const performSemanticSearch = async (  query: string,  filters?: SearchFilters,  limitCount: number = 20): Promise<SearchResult[]> => {  try {    // ?¤ì œë¡œëŠ” OpenAI/Vertex AI ?„ë² ???ì„± ??Pinecone/Weaviate ê²€??    // ?¬ê¸°?œëŠ” ?œë??ˆì´??        // ?˜ë? ë¶„ì„ ?œë??ˆì´??    await new Promise(resolve => setTimeout(resolve, 1000));        // ?˜ë???? ì‚¬??ê¸°ë°˜ ê²€??ê²°ê³¼ ?œë??ˆì´??    const mockResults: SearchResult[] = [      {        id: 'semantic-1',        title: '?˜ë???? ì‚¬??ê¸°ë°˜ ê²€??ê²°ê³¼',        description: '?„ë² ??ë²¡í„° ? ì‚¬?„ë¡œ ì°¾ì? ?í’ˆ',        price: 135000,        category: 'ì¶•êµ¬??,        region: '?€êµ?,        distance: undefined,        relevance: 0.91,        imageUrl: '/mock-semantic-result.jpg',        ai: { quality_score: 0.85, confidence: 0.88 }      },      {        id: 'semantic-2',        title: 'ì»¨í…?¤íŠ¸ ê¸°ë°˜ ì¶”ì²œ ?í’ˆ',        description: 'ê²€?‰ì–´??ë§¥ë½??ê³ ë ¤??ì¶”ì²œ',        price: 165000,        category: 'ì¶•êµ¬??,        region: 'ê´‘ì£¼',        distance: undefined,        relevance: 0.87,        imageUrl: '/mock-context-result.jpg',        ai: { quality_score: 0.79, confidence: 0.83 }      }    ];    return applyFilters(mockResults, filters);  } catch (error) {    console.error('?˜ë? ê²€???¤íŒ¨:', error);    return [];  }};// ?µí•© ê²€???œë¹„??export const performUnifiedSearch = async (  options: SearchOptions): Promise<SearchResultWithScore[]> => {  try {    let searchResults: SearchResult[] = [];    // ê²€???€?…ë³„ ?¤í–‰    switch (options.type) {      case 'text':        searchResults = await performTextSearch(          options.query,          options.filters,          options.limit || 20        );        break;            case 'image':        // ?´ë?ì§€ ?Œì¼???„ìš”?˜ë?ë¡??¬ê¸°?œëŠ” ?œë??ˆì´??        searchResults = await performImageSearch(          new File([''], 'mock.jpg'),          options.filters,          options.limit || 20        );        break;            case 'voice':        // ?Œì„± ?°ì´?°ê? ?„ìš”?˜ë?ë¡??¬ê¸°?œëŠ” ?œë??ˆì´??        searchResults = await performVoiceSearch(          new Blob([''], { type: 'audio/wav' }),          options.filters,          options.limit || 20        );        break;            case 'semantic':        searchResults = await performSemanticSearch(          options.query,          options.filters,          options.limit || 20        );        break;    }    // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ??‚¹ ?ìš©    const rankedResults = applyWeightedRanking(      searchResults,      options.userLocation,      options.sortBy || 'relevance'    );    return rankedResults;  } catch (error) {    console.error('?µí•© ê²€???¤íŒ¨:', error);    return [];  }};// ê°€ì¤‘ì¹˜ ê¸°ë°˜ ??‚¹ ?ìš©export const applyWeightedRanking = (  results: SearchResult[],  userLocation?: Location,  sortBy: string = 'relevance'): SearchResultWithScore[] => {  return results.map(item => {    let finalScore = 0;        // Relevance ê°€ì¤‘ì¹˜ (60%)    const relevanceScore = item.relevance || 0;    finalScore += relevanceScore * 0.6;        // Distance ê°€ì¤‘ì¹˜ (20%) - ?¬ìš©???„ì¹˜ê°€ ?ˆì„ ?Œë§Œ    let distanceScore = 0;    if (userLocation && item.distance !== undefined) {      distanceScore = Math.max(0, 1 - (item.distance / 50)); // 50km ê¸°ì? ?•ê·œ??      finalScore += distanceScore * 0.2;    }        // Freshness ê°€ì¤‘ì¹˜ (20%) - ìµœì‹  ?í’ˆ ?°ì„     const freshnessScore = 0.8; // ?¤ì œë¡œëŠ” createdAt ê¸°ë°˜ ê³„ì‚°    finalScore += freshnessScore * 0.2;        // Popularity ê°€ì¤‘ì¹˜ (ì¶”ê? ?ìˆ˜)    const popularityScore = calculatePopularityScore(item);        return {      ...item,      finalScore,      relevance: relevanceScore,      distance: item.distance,      freshness: freshnessScore,      popularity: popularityScore    };  }).sort((a, b) => b.finalScore - a.finalScore);};// ?ìŠ¤??ê´€?¨ì„± ê³„ì‚°const calculateTextRelevance = (query: string, item: MarketItem): number => {  const queryLower = query.toLowerCase();  const titleLower = item.title.toLowerCase();  const descLower = item.description.toLowerCase();  const categoryLower = item.category.toLowerCase();    let score = 0;    // ?œëª© ë§¤ì¹­ (ê°€???’ì? ê°€ì¤‘ì¹˜)  if (titleLower.includes(queryLower)) {    score += 0.8;  }    // ?¤ëª… ë§¤ì¹­  if (descLower.includes(queryLower)) {    score += 0.4;  }    // ì¹´í…Œê³ ë¦¬ ë§¤ì¹­  if (categoryLower.includes(queryLower)) {    score += 0.6;  }    // ë¸Œëœ??ëª¨ë¸ ë§¤ì¹­  if (item.brand && item.brand.toLowerCase().includes(queryLower)) {    score += 0.7;  }    if (item.model && item.model.toLowerCase().includes(queryLower)) {    score += 0.7;  }    // ?œê·¸ ë§¤ì¹­  if (item.ai?.tags) {    const tagMatches = item.ai.tags.filter(tag =>       tag.toLowerCase().includes(queryLower)    ).length;    score += tagMatches * 0.3;  }    return Math.min(1, score);};// ?¸ê¸°???ìˆ˜ ê³„ì‚°const calculatePopularityScore = (item: MarketItem): number => {  let score = 0.5; // ê¸°ë³¸ ?ìˆ˜    // AI ?ˆì§ˆ ?ìˆ˜ ë°˜ì˜  if (item.ai?.quality_score) {    score += item.ai.quality_score * 0.3;  }    // ê°€ê²??€ë¹??ˆì§ˆ (?€ê°€ ê³ í’ˆì§??í’ˆ ? í˜¸)  if (item.price > 0) {    const priceQualityRatio = (item.ai?.quality_score || 0.5) / (item.price / 100000);    score += Math.min(0.2, priceQualityRatio);  }    return Math.min(1, score);};// ?„í„° ?ìš©const applyFilters = (results: SearchResult[], filters?: SearchFilters): SearchResult[] => {  if (!filters) return results;    return results.filter(item => {    // ì¹´í…Œê³ ë¦¬ ?„í„°    if (filters.category && item.category !== filters.category) {      return false;    }        // ê°€ê²?ë²”ìœ„ ?„í„°    if (filters.priceRange) {      if (item.price < filters.priceRange.min || item.price > filters.priceRange.max) {        return false;      }    }        // ?íƒœ ?±ê¸‰ ?„í„°    if (filters.condition && item.ai?.quality_score) {      const condition = item.ai.quality_score > 0.8 ? 'A' :                        item.ai.quality_score > 0.6 ? 'B' : 'C';      if (condition !== filters.condition) {        return false;      }    }        // ì§€???„í„°    if (filters.region && item.region !== filters.region) {      return false;    }        // ë¸Œëœ???„í„°    if (filters.brand && item.title.toLowerCase().indexOf(filters.brand.toLowerCase()) === -1) {      return false;    }        return true;  });};// ê²€???œì•ˆ (?ë™?„ì„±)export const getSearchSuggestions = async (  partialQuery: string,  limitCount: number = 5): Promise<string[]> => {  try {    if (partialQuery.length < 2) return [];        // ?¤ì œë¡œëŠ” ê²€???”ì§„???ë™?„ì„± API ?¬ìš©    // ?¬ê¸°?œëŠ” ê°„ë‹¨???œë??ˆì´??        const suggestions = [      'ì¶•êµ¬??,      'NIKE ë¨¸íë¦¬ì–¼',      'Adidas ?„ë ˆ?°í„°',      'ì¶•êµ¬ ? ë‹ˆ??,      'ë³´í˜¸?¥ë¹„',      'ì¶•êµ¬ê³?,      '?¸ë ˆ?´ë‹ë³?    ];        return suggestions      .filter(suggestion =>         suggestion.toLowerCase().includes(partialQuery.toLowerCase())      )      .slice(0, limitCount);        } catch (error) {    console.error('ê²€???œì•ˆ ?¤íŒ¨:', error);    return [];  }};// ?¸ê¸° ê²€?‰ì–´export const getPopularSearches = async (): Promise<string[]> => {  try {    // ?¤ì œë¡œëŠ” ê²€??ë¡œê·¸ ë¶„ì„ ?ëŠ” ?¸ê¸° ?í’ˆ ê¸°ë°˜    return [      'ì¶•êµ¬??,      'NIKE',      'Adidas',      '?„ë ˆ?°í„°',      'ë¨¸íë¦¬ì–¼',      '? ë‹ˆ??,      'ë³´í˜¸?¥ë¹„'    ];  } catch (error) {    console.error('?¸ê¸° ê²€?‰ì–´ ì¡°íšŒ ?¤íŒ¨:', error);    return [];  }};// ê²€???µê³„export const getSearchStats = async (): Promise<{  totalSearches: number;  popularCategories: string[];  averageRelevance: number;}> => {  try {    // ?¤ì œë¡œëŠ” ê²€??ë¡œê·¸ ë¶„ì„    return {      totalSearches: 1250,      popularCategories: ['ì¶•êµ¬??, '? ë‹ˆ??, 'ë³´í˜¸?¥ë¹„'],      averageRelevance: 0.78    };  } catch (error) {    console.error('ê²€???µê³„ ì¡°íšŒ ?¤íŒ¨:', error);    return {      totalSearches: 0,      popularCategories: [],      averageRelevance: 0    };  }}; 