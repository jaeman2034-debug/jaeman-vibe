// ê¸°ì¡´ ?í’ˆ?¤ì˜ ?‰ì •???•ë³´ë¥??¼ê´„ ë³´ì •?˜ëŠ” ë°±í•„ ? í‹¸ë¦¬í‹°import { collection, doc, getDocs, serverTimestamp, updateDoc } from 'firebase/firestore';import { db } from '@/lib/firebase';import { reverseGeocodeDong } from '@/lib/geo';export async function backfillProductDong() {  const snap = await getDocs(collection(db, 'products'));  for (const d of snap.docs) {    const p = d.data() as any;    if (p.address?.dong || !p.geo?.lat) continue;    try {      const a = await reverseGeocodeDong(p.geo.lat, p.geo.lng);      await updateDoc(doc(db, 'products', d.id), {        address: a,        updatedAt: serverTimestamp()      });      await new Promise(r => setTimeout(r, 120)); // ?ë„ ?œí•œ ?Œí”¼    } catch {}  }}/** * ê¸°ì¡´ ?í’ˆ?¤ì˜ ?‰ì •???•ë³´ë¥??¼ê´„ ë³´ì • * - products ì»¬ë ‰?˜ì˜ ê¸°ì¡´ ?í’ˆ?¤ì„ ?€?ìœ¼ë¡??? * - ?´ë? addressê°€ ?ˆê±°??geo ì¢Œí‘œê°€ ?†ëŠ” ?í’ˆ?€ ê±´ë„ˆ?€ * - ì¹´ì¹´??API ?ë„ ?œí•œ??ê³ ë ¤?˜ì—¬ 120ms ?œë ˆ???ìš© */export async function backfillDong() {  console.log('?  [BACKFILL] ?‰ì •???•ë³´ ?¼ê´„ ë³´ì • ?œì‘');    try {    const snap = await getDocs(collection(db, 'products'));    console.log(`?  [BACKFILL] ì´?${snap.docs.length}ê°??í’ˆ ë°œê²¬`);        let processed = 0;    let updated = 0;    let skipped = 0;    let errors = 0;        for (const d of snap.docs) {      processed++;      const p = d.data() as any;            // ?´ë? addressê°€ ?ˆê±°??geo ì¢Œí‘œê°€ ?†ëŠ” ?í’ˆ?€ ê±´ë„ˆ?°ê¸°      if (p.address?.dong || !p.geo?.lat) {        skipped++;        continue;      }            try {        console.log(`?  [BACKFILL] ${processed}/${snap.docs.length} ì²˜ë¦¬ ì¤? ${p.title || d.id}`);                const addr = await reverseGeocodeDong(p.geo.lat, p.geo.lng);        await updateDoc(doc(db, 'products', d.id), {           address: addr,           updatedAt: serverTimestamp()         });                updated++;        console.log(`??[BACKFILL] ${d.id} ?…ë°?´íŠ¸ ?„ë£Œ: ${addr.full}`);                // ì¹´ì¹´??API ?ë„ ?œí•œ ?Œí”¼ (120ms ?œë ˆ??        await new Promise(r => setTimeout(r, 120));              } catch (error) {        errors++;        console.error(`??[BACKFILL] ${d.id} ?…ë°?´íŠ¸ ?¤íŒ¨:`, error);      }    }        console.log(`?  [BACKFILL] ?„ë£Œ! ì²˜ë¦¬: ${processed}, ?…ë°?´íŠ¸: ${updated}, ê±´ë„ˆ?€: ${skipped}, ?¤ë¥˜: ${errors}`);    return { processed, updated, skipped, errors };      } catch (error) {    console.error('?  [BACKFILL] ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);    throw error;  }}/** * market ì»¬ë ‰?˜ì˜ ê¸°ì¡´ ?í’ˆ?¤ì„ products ì»¬ë ‰?˜ìœ¼ë¡?ë§ˆì´ê·¸ë ˆ?´ì…˜ * - ê¸°ì¡´ market ì»¬ë ‰?˜ì˜ ?í’ˆ?¤ì„ ?ˆë¡œ??êµ¬ì¡°ë¡?ë³€?? * - ?‰ì •???•ë³´???¨ê»˜ ?ì„± */export async function migrateMarketToProducts() {  console.log('?”„ [MIGRATE] market ??products ë§ˆì´ê·¸ë ˆ?´ì…˜ ?œì‘');    try {    const { collection: firestoreCollection, addDoc, serverTimestamp } = await import('firebase/firestore');        const marketSnap = await getDocs(firestoreCollection(db, 'market'));    console.log(`?”„ [MIGRATE] ì´?${marketSnap.docs.length}ê°?market ?í’ˆ ë°œê²¬`);        let processed = 0;    let migrated = 0;    let errors = 0;        for (const d of marketSnap.docs) {      processed++;      const p = d.data() as any;            try {        console.log(`?”„ [MIGRATE] ${processed}/${marketSnap.docs.length} ì²˜ë¦¬ ì¤? ${p.title || d.id}`);                // ?ˆë¡œ???í’ˆ êµ¬ì¡°ë¡?ë³€??        const newProduct = {          title: p.title || '?œëª© ?†ìŒ',          description: p.desc || p.description || '',          price: p.price || 0,          category: p.category || 'ê¸°í?',          images: Array.isArray(p.images) ? p.images : [],          status: p.status || '?ë§¤ì¤?,          sellerId: p.sellerId || p.sellerUid || 'unknown',          createdAt: p.createdAt || serverTimestamp(),          updatedAt: serverTimestamp(),          // ?„ì¹˜ ?•ë³´ ë³€??          geo: p.location ? {            lat: p.location.lat || p.location.latitude || 0,            lng: p.location.lng || p.location.longitude || 0          } : p.lat && p.lng ? {            lat: Number(p.lat),            lng: Number(p.lng)          } : null,          // ê¸°ì¡´ location ?•ë³´ ? ì? (?˜ìœ„ ?¸í™˜??          location: p.location ? {            lat: p.location.lat || p.location.latitude || 0,            lng: p.location.lng || p.location.longitude || 0,            placeName: p.location.placeName || p.location.name || ''          } : p.lat && p.lng ? {            lat: Number(p.lat),            lng: Number(p.lng),            placeName: ''          } : undefined,          // ê¸°í? ?„ë“œ          chatCount: p.chatCount || 0,          likeCount: p.likeCount || 0,          viewCount: p.viewCount || 0,          analysis: p.analysis || null        };                // ?‰ì •???•ë³´ ?ì„± (geo ì¢Œí‘œê°€ ?ˆëŠ” ê²½ìš°)        if (newProduct.geo?.lat && newProduct.geo?.lng) {          try {            const addr = await reverseGeocodeDong(newProduct.geo.lat, newProduct.geo.lng);            newProduct.address = addr;            console.log(`?“ [MIGRATE] ?‰ì •???•ë³´ ?ì„±: ${addr.full}`);          } catch (geoError) {            console.warn(`? ï¸ [MIGRATE] ?‰ì •???•ë³´ ?ì„± ?¤íŒ¨:`, geoError);          }        }                // products ì»¬ë ‰?˜ì— ì¶”ê?        await addDoc(firestoreCollection(db, 'products'), newProduct);        migrated++;        console.log(`??[MIGRATE] ${d.id} ë§ˆì´ê·¸ë ˆ?´ì…˜ ?„ë£Œ`);                // ì¹´ì¹´??API ?ë„ ?œí•œ ?Œí”¼        if (newProduct.address) {          await new Promise(r => setTimeout(r, 120));        }              } catch (error) {        errors++;        console.error(`??[MIGRATE] ${d.id} ë§ˆì´ê·¸ë ˆ?´ì…˜ ?¤íŒ¨:`, error);      }    }        console.log(`?”„ [MIGRATE] ?„ë£Œ! ì²˜ë¦¬: ${processed}, ë§ˆì´ê·¸ë ˆ?´ì…˜: ${migrated}, ?¤ë¥˜: ${errors}`);    return { processed, migrated, errors };      } catch (error) {    console.error('?”„ [MIGRATE] ?„ì²´ ?„ë¡œ?¸ìŠ¤ ?¤íŒ¨:', error);    throw error;  }}/** * ê°œë°œ??ì½˜ì†”?ì„œ ?¤í–‰?????ˆëŠ” ?„ì—­ ?¨ìˆ˜?? */if (typeof window !== 'undefined') {  (window as any).backfillDong = backfillDong;  (window as any).migrateMarketToProducts = migrateMarketToProducts;    console.log('?”§ [BACKFILL] ?„ì—­ ?¨ìˆ˜ ?±ë¡ ?„ë£Œ:');  console.log('  - backfillDong() : ê¸°ì¡´ ?í’ˆ ?‰ì •???•ë³´ ë³´ì •');  console.log('  - migrateMarketToProducts() : market ??products ë§ˆì´ê·¸ë ˆ?´ì…˜');}// ?´ë?ì§€ URL ë°±í•„ ? í‹¸ë¦¬í‹°export async function backfillImageUrls() {  console.log('[ë°±í•„] ?´ë?ì§€ URL ë°±í•„ ?œì‘...');    try {    const { db } = await import('@/lib/firebase');    const { collection, getDocs, updateDoc, doc } = await import('firebase/firestore');        // products ì»¬ë ‰?˜ì˜ ëª¨ë“  ë¬¸ì„œ ì¡°íšŒ    const snapshot = await getDocs(collection(db, 'products'));    let updatedCount = 0;    let errorCount = 0;        for (const docSnapshot of snapshot.docs) {      const data = docSnapshot.data();            try {        // ?´ë?ì§€ê°€ ?†ê±°??ë¹?ë°°ì—´??ê²½ìš° ê±´ë„ˆ?°ê¸°        if (!data.images || data.images.length === 0) {          console.log(`[ë°±í•„] ${docSnapshot.id}: ?´ë?ì§€ ?†ìŒ, ê±´ë„ˆ?°ê¸°`);          continue;        }                // ?´ë? ?¬ë°”ë¥?êµ¬ì¡°ë¡??˜ì–´ ?ˆëŠ”ì§€ ?•ì¸        if (Array.isArray(data.images) && data.images.length > 0) {          const firstImage = data.images[0];                    // ?´ë? êµ¬ì¡°?”ëœ ?°ì´?°ì¸ ê²½ìš°          if (typeof firstImage === 'object' && firstImage.url) {            console.log(`[ë°±í•„] ${docSnapshot.id}: ?´ë? ?¬ë°”ë¥?êµ¬ì¡°`);            continue;          }                    // ?¨ìˆœ URL ë°°ì—´??ê²½ìš° êµ¬ì¡°??          if (typeof firstImage === 'string') {            const imageData = data.images.map((url: string, index: number) => ({              url,              path: `products/${data.sellerId || 'unknown'}/${docSnapshot.id}_${index}.jpg`,              filename: `image_${index}.jpg`,              size: 0,              type: 'image/jpeg',              uploadedAt: new Date()            }));                        await updateDoc(doc(db, 'products', docSnapshot.id), {              images: imageData,              imageUrls: data.images,              thumbnail: data.images[0],              updatedAt: new Date()            });                        console.log(`[ë°±í•„] ${docSnapshot.id}: êµ¬ì¡°???„ë£Œ (${data.images.length}ê°??´ë?ì§€)`);            updatedCount++;          }        }      } catch (error) {        console.error(`[ë°±í•„] ${docSnapshot.id} ì²˜ë¦¬ ?¤íŒ¨:`, error);        errorCount++;      }    }        console.log(`[ë°±í•„] ?„ë£Œ: ${updatedCount}ê°??…ë°?´íŠ¸, ${errorCount}ê°??¤íŒ¨`);    return { updatedCount, errorCount };      } catch (error) {    console.error('[ë°±í•„] ?„ì²´ ?¤íŒ¨:', error);    throw error;  }}// ?„ì—­ ?¨ìˆ˜ë¡??±ë¡ (ê°œë°œ ëª¨ë“œ?ì„œë§?if (import.meta.env.DEV) {  (window as any).backfillImageUrls = backfillImageUrls;  console.log('[ë°±í•„] ?„ì—­ ?¨ìˆ˜ ?±ë¡?? window.backfillImageUrls()');}