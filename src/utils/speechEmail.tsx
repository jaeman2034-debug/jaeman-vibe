// src/utils/speechEmail.tsximport React, { useState, useRef, useCallback, useEffect } from 'react';// === ?´ë©”??STT ?«í”½??? í‹¸ ===const AT_WORDS = /(ê³¨ë±…????\bat\b)/g;         // '@' ?¸ë¦¬ê±?const DOT_WORDS = /(????ì©?/g;                // '.' ì¹˜í™˜ ?„ìš©const EMAIL_ID_ALLOWED = /[a-z0-9._-]/;         // ?ˆìš© ë¬¸ìconst sanitizeId = (s: string) =>  (s || "")    .toLowerCase()    // '@' ?˜ì˜¤ê¸??„ê¹Œì§€???ì„ ëª¨ë‘ ?œê±° (?„í™˜ ë°©ì?)    .replace(/\./g, "")    .split("")    .filter(ch => EMAIL_ID_ALLOWED.test(ch))    .join("");const sanitizeDomain = (s: string) =>  (s || "")    .toLowerCase()    .replace(DOT_WORDS, ".")    .replace(/\s+/g, "")    .replace(/\.{2,}/g, ".")    .replace(/^\./, "")    .replace(/\.$/, "");// ?„ë©”???œêµ­??ì¶•ì•½ ë³´ì •const fixDomainCommon = (dom: string) => {  if (!dom) return dom;  if (dom === "gmail") return "gmail.com";  if (dom === "naver") return "naver.com";  if (dom === "daum") return "daum.net";  if (dom === "hanmail") return "hanmail.net";  if (dom === "kakao") return "kakao.com";  return dom;};// === ?´ë©”??STT ?µì‹¬ ë¡œì§ ===export const onEmailSpeechFinal = (  raw: string,  mode: "id" | "domain",  emailId: string,  emailDomain: string,  setEmailId: (id: string) => void,  setEmailDomain: (id: string | ((prev: string) => string)) => void,  setMode: (mode: "id" | "domain") => void,  domainSwitchedRef: React.MutableRefObject<boolean>,  pushLog: (msg: string) => void) => {  let t = (raw || "").toLowerCase().trim();  // ê³µí†µ ì¹˜í™˜  t = t.replace(DOT_WORDS, ".");     // '????ì©? -> '.'  t = t.replace(AT_WORDS, "@");      // 'ê³¨ë±…????at' -> '@'  if (mode === "id") {    // '@'ê°€ ?¤ì–´?¤ë©´ ??ë²ˆë§Œ ?„ë©”??ëª¨ë“œë¡??„í™˜    if (t.includes("@")) {      const [left, right = ""] = t.split("@");      // 1) ?¨ì? ID ?•ë¦¬ ('.' ?„ë? ë¬´ì‹œ)      const idNew = sanitizeId(emailId + left);      setEmailId(idNew);      // 2) ?„ë©”??ëª¨ë“œë¡?'??ë²ˆë§Œ' ?„í™˜      if (!domainSwitchedRef.current) {        domainSwitchedRef.current = true;        setMode("domain");        pushLog("?Œ ?„ë©”???…ë ¥ ëª¨ë“œë¡??„í™˜");      }      // 3) ì²??„ë©”???œë“œ ë°˜ì˜      const domSeed = fixDomainCommon(sanitizeDomain(right));      setEmailDomain(prev => (prev ? prev : domSeed));      return;    }    // '@' ?„ì—???ˆë? ?„í™˜/?„ì ??'.'???°ì? ?ŠìŒ    const idAcc = sanitizeId(emailId + t);    setEmailId(idAcc);    pushLog(`?‘¤ ID ì¡°ê° ì¶”ê?: ${t} ???„ì : ${idAcc}`);    return;  }  // mode === 'domain'  const domAcc = fixDomainCommon(sanitizeDomain(emailDomain + t));  setEmailDomain(domAcc);  pushLog(`?Œ ?„ë©”??ì¡°ê° ì¶”ê?: ${t} ???„ì : ${domAcc}`);};// === ?„ë£Œ ?„ë³´ ê²€??===export const isLikelyEmail = (id: string, dom: string) =>  !!id && !!dom && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(`${id}@${dom}`);// === EmailVoiceField ì»´í¬?ŒíŠ¸ ===interface EmailVoiceFieldProps {  emailId: string;  emailDomain: string;  mode: "id" | "domain";  setEmailId: (id: string) => void;  setEmailDomain: (domain: string) => void;  setMode: (mode: "id" | "domain") => void;  domainSwitchedRef: React.MutableRefObject<boolean>;  pushLog: (msg: string) => void;  onTryNext: () => void;  onFinal?: (text: string) => void;   // ??ì¶”ê?: ìµœì¢… ê²°ê³¼ ?„ë‹¬}export const EmailVoiceField: React.FC<EmailVoiceFieldProps> = ({  emailId,  emailDomain,  mode,  setEmailId,  setEmailDomain,  setMode,  domainSwitchedRef,  pushLog,  onTryNext,  onFinal}) => {  // ?Œì„± ?¸ì‹ê¸?ê´€???íƒœ ë°?ref  const [listening, setListening] = useState(false);  const userStopRef = useRef(false);   // ?¬ìš©?ê? ì§ì ‘ ë©ˆì·„?”ì? ?¬ë?  const recRef = useRef<any>(null);  // ?Œì„± ?¸ì‹ê¸??ì„± ë°??¤ì •  const ensureRecognizer = useCallback(() => {    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;    if (!SR) return null;    if (!recRef.current) {      const rec = new SR();      rec.lang = "ko-KR";      rec.interimResults = true;   // ??ì¤‘ê°„ ê²°ê³¼ ON      rec.continuous = true;       // ???°ì† ?¸ì‹ ON      rec.maxAlternatives = 3;            // ìµœì¢… ë¬¸ì¥ë§?ëª¨ì•„??ë¶€ëª¨ì— ?„ë‹¬      rec.onresult = (e: any) => {        const finals: string[] = [];        for (let i = e.resultIndex; i < e.results.length; i++) {          const alt = e.results[i];          if (alt.isFinal) {            for (let k = 0; k < alt.length; k++) finals.push(alt[k].transcript);          }        }        if (finals.length > 0) {          const txt = finals.join(" ");          // ë¶€ëª¨ë¡œ ìµœì¢… ê²°ê³¼ ?„ë‹¬          onFinal?.(txt);          // ?´ë©”???„ì  ?¨ìˆ˜ ?¸ì¶œ (ê¸°ì¡´ ë¡œì§ ? ì?)          onEmailSpeechFinal(            txt,            mode,            emailId,            emailDomain,            setEmailId,            setEmailDomain,            setMode,            domainSwitchedRef,            pushLog          );        }      };      rec.onerror = (ev: any) => {        setListening(false);        // ?¬ìš©?ê? ë©ˆì¶˜ ê²??„ë‹ˆê³? aborted ???ëŸ¬ë©??¬ì‹œ??        if (!userStopRef.current && ev?.error !== "aborted") {          setTimeout(() => { try { rec.start(); setListening(true); } catch {} }, 600);        }      };      rec.onend = () => {        setListening(false);        // ?¬ìš©?ê? ë©ˆì¶˜ ê²??„ë‹ˆë©?ë°”ë¡œ ?¬ì‹œ??        if (!userStopRef.current) {          setTimeout(() => { try { rec.start(); setListening(true); } catch {} }, 600);        }      };            recRef.current = rec;    }    return recRef.current;  }, [mode, emailId, emailDomain, setEmailId, setEmailDomain, setMode, domainSwitchedRef, pushLog, onFinal]);  // ?Œì„± ?¸ì‹ ?œì‘  const start = useCallback(() => {    const rec = ensureRecognizer();    if (!rec) return alert("??ë¸Œë¼?°ì????Œì„± ?¸ì‹??ì§€?í•˜ì§€ ?Šì•„??");    userStopRef.current = false;    try { rec.start(); setListening(true); } catch {}  }, [ensureRecognizer]);  // ?Œì„± ?¸ì‹ ì¤‘ì?  const stop = useCallback(() => {    userStopRef.current = true;    try { recRef.current?.stop(); } catch {}    setListening(false);  }, []);  // ì»´í¬?ŒíŠ¸ ?¸ë§ˆ?´íŠ¸ ???•ë¦¬  useEffect(() => {    return () => {      userStopRef.current = true;      try { recRef.current?.stop(); recRef.current?.abort(); } catch {}    };  }, []);  return (    <div style={{ marginTop: 16 }}>      <label>?´ë©”??(?Œì„± ?…ë ¥)</label>      {/* ?Œì„± ?¸ì‹ ë²„íŠ¼ ì¶”ê? */}      <div style={{ margin: "8px 0", display: "flex", gap: 8 }}>        <button           type="button"           onClick={() => (listening ? stop() : start())}          style={{            padding: "8px 16px",            borderRadius: 8,            border: "1px solid rgba(34,197,94,0.5)",            background: listening ? "rgba(239,68,68,0.2)" : "rgba(34,197,94,0.2)",            color: listening ? "#f87171" : "#22c55e",            cursor: "pointer",            fontWeight: "bold"          }}        >          {listening ? "?£ê¸° ì¢…ë£Œ" : "ë§í•˜ê¸?}        </button>        {listening && (          <div style={{             display: "flex",             alignItems: "center",             padding: "8px 12px",             background: "rgba(34,197,94,0.1)",             borderRadius: 6,            fontSize: 12,            color: "#22c55e"          }}>            ?¤ ?Œì„± ?¸ì‹ ì¤?.. (?ë™ ?¬ì‹œ??          </div>        )}      </div>      <div style={{ margin: "8px 0", padding: 12, background: "#1f2330", borderRadius: 8 }}>        <div style={{ fontSize: 13, opacity: 0.85, marginBottom: 6 }}>          ?Œì„± ?…ë ¥ ì¤? {mode === "id" ? "?„ì´??ëª¨ë“œ" : "?„ë©”??ëª¨ë“œ"}        </div>        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>          <code style={{ padding: "4px 8px", borderRadius: 6, background: "#0e111a" }}>            {emailId || "ID ?…ë ¥ ì¤?.."}          </code>          <code style={{ padding: "4px 8px", borderRadius: 6, background: "#0e111a" }}>@</code>          <code style={{ padding: "4px 8px", borderRadius: 6, background: "#0e111a" }}>            {emailDomain || "?„ë©”???…ë ¥ ì¤?.."}          </code>        </div>        {emailId && emailDomain && (          <div style={{ marginTop: 8, padding: 8, background: "rgba(34,197,94,0.1)", borderRadius: 6, fontSize: 12 }}>            ?„ì„±???´ë©”?? <strong>{emailId}@{emailDomain}</strong>          </div>        )}      </div>      {/* ?ì£¼ ?°ëŠ” ?„ë©”???¨ì¶• ë²„íŠ¼ */}      <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 8 }}>        {["gmail.com","naver.com","daum.net","outlook.com"].map(d => (          <button             key={d}             type="button"             onClick={()=>{               setMode("domain");               domainSwitchedRef.current=true;               setEmailDomain(d);             }}            style={{              padding: "4px 8px",              borderRadius: 6,              border: "1px solid rgba(255,255,255,0.2)",              background: "rgba(255,255,255,0.08)",              color: "#fff",              fontSize: 12,              cursor: "pointer"            }}          >            {d}          </button>        ))}      </div>      {/* IDê°€ ë¹„ì–´?ˆì„ ???„ë©”??ëª¨ë“œ?ì„œ ID ?…ë ¥ ? ë„ */}      {mode === "domain" && !emailId && (        <div style={{ marginTop: 8, padding: 8, background: "rgba(239,68,68,0.1)", borderRadius: 6, border: "1px solid rgba(239,68,68,0.3)" }}>          <div style={{ fontSize: 12, color: "#f87171", marginBottom: 6 }}>            ? ï¸ ?„ì´?”ê? ë¹„ì–´?ˆìŠµ?ˆë‹¤. ë¨¼ì? ?„ì´?”ë? ?…ë ¥??ì£¼ì„¸??          </div>          <button            type="button"            onClick={() => {               setMode("id");               domainSwitchedRef.current = false;               pushLog("?”„ ID ?…ë ¥ ëª¨ë“œë¡??Œì•„ê°€ê¸?);            }}            style={{              padding: "6px 12px",              borderRadius: 6,              border: "1px solid rgba(239,68,68,0.5)",              background: "rgba(239,68,68,0.2)",              color: "#f87171",              fontSize: 12,              cursor: "pointer"            }}          >            ID ë¨¼ì? ?…ë ¥?˜ê¸°          </button>        </div>      )}      <div style={{ display: "flex", gap: 8, marginTop: 8 }}>        <button           type="button"           onClick={onTryNext}           disabled={!isLikelyEmail(emailId, fixDomainCommon(emailDomain))}          style={{            padding: "8px 16px",            borderRadius: 8,            border: "1px solid rgba(139,92,246,0.5)",            background: "linear-gradient(135deg,#8b5cf6,#22d3ee)",            color: "#fff",            cursor: "pointer"          }}        >          ?¤ìŒ        </button>        <button          type="button"          onClick={() => {            setEmailId("");            setEmailDomain("");            setMode("id");            domainSwitchedRef.current = false;            pushLog("?»ï¸ ?´ë©”???…ë ¥ ì´ˆê¸°??);          }}          style={{            padding: "8px 16px",            borderRadius: 8,            border: "1px solid rgba(255,255,255,0.2)",            background: "rgba(255,255,255,0.08)",            color: "#fff",            cursor: "pointer"          }}        >          ì´ˆê¸°??        </button>      </div>    </div>  );}; 
