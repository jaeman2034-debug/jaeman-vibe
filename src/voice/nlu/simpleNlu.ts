import { PAGE_SYNONYMS, type Command, type Intent, type Entities } from "../intents";const NUM_KOR = [  ["ì²?, 1000], ["ë§?, 10000], ["??§Œ", 100000], ["ë°±ë§Œ", 1000000]] as const;function parsePrice(s: string): number | undefined {  // ?? "6ë§?ì²œì›", "65000??, "6ë§?5ì²?  const digits = s.match(/[0-9]{3,}/);  if (digits) return parseInt(digits[0], 10);  let n = 0;  let rest = s;  for (const [unit, mul] of NUM_KOR) {    const m = rest.match(new RegExp(`([0-9]+)\\s*${unit}`));    if (m) n += parseInt(m[1], 10) * mul;  }  if (!n) {    const m = rest.match(/([0-9]+)\s*??);    if (m) n = parseInt(m[1], 10);  }  return n || undefined;}function parseRadiusKm(s: string): number | undefined {  const m = s.match(/([0-9]+(?:\.[0-9]+)?)\s*(?:?¬ë¡œ|km|?¤ë¡œ)/i);  return m ? parseFloat(m[1]) : undefined;}function findPage(s: string): Entities["page"] | undefined {  for (const k of Object.keys(PAGE_SYNONYMS)) {    if (s.includes(k)) return PAGE_SYNONYMS[k];  }  return undefined;}export function nlu(text: string): Command | null {  const raw = text.trim();  const s = raw.replace(/\s+/g, "");  // ì·¨ì†Œ  if (/ì·¨ì†Œ|?«ì•„|ê·¸ë§Œ|ì¤‘ì?/.test(s)) return { intent: "CANCEL", raw };  // ?„ì?ë§?  if (/?„ì?ë§?ë¬´ì—‡???´ë–»ê²??¬ìš©ë²?.test(s)) return { intent: "HELP", raw };  // ?˜ì´ì§€/ì¹´í…Œê³ ë¦¬ ?´ë™  if (/(?´ë™|ê°€|?´ì–´|ë³´ì—¬|?¤ì–´ê°€)/.test(s)) {    const page = findPage(raw);    if (page) return { intent: "NAVIGATE", entities: { page }, raw };    // ì¹´í…Œê³ ë¦¬ ?´ë™(ë§ˆì¼“ ?˜ìœ„): ??"ì¶•êµ¬??ì¹´í…Œê³ ë¦¬ë¡??´ë™"    const mCat = raw.match(/([ê°€-?£a-zA-Z0-9 ]+?)\s*(ì¹´í…Œê³ ë¦¬|ì°¾ì•„|ë³´ì—¬)/);    if (mCat) return { intent: "NAVIGATE", entities: { page: "market", category: mCat[1].trim() }, raw };  }  // ì¹´ë©”??ì´¬ì˜  if (/(ì´¬ì˜|ì¹´ë©”???¬ì§„ì°?ì´¬ì˜?œì‘|?¬ì§„ì°ì–´)/.test(s)) {    return { intent: "CAPTURE_PRODUCT", raw };  }  // ?í’ˆ ?±ë¡  if (/(?í’ˆ?±ë¡|?±ë¡???¬ë ¤|?ë§¤?±ë¡|?±ë¡?œì‘)/.test(s)) {    const price = parsePrice(raw) ?? undefined;    const mCat = raw.match(/(ì¶•êµ¬??? ë‹ˆ???¼ì¼“|ê³?ë³´í˜¸?€|ê³¨í”„ì±?/);    return { intent: "REGISTER_PRODUCT", entities: { category: mCat?.[1], price }, raw };  }  // AI ë¶„ì„  if (/(ë¶„ì„|AIë¶„ì„|?ë™ë¶„ë¥˜|ì¹´í…Œê³ ë¦¬ë¶„ì„)/.test(s)) {    return { intent: "ANALYZE_PRODUCT", raw };  }  // ?„ì¹˜ ë¶„ì„/ë°˜ê²½ ê²€??  if (/(ê·¼ì²˜|ì£¼ë?|ê°€ê¹Œìš´|ë°˜ê²½|?´ì£¼ë³€)/.test(s)) {    const r = parseRadiusKm(raw) ?? 2; // ê¸°ë³¸ 2km    return { intent: "LOCATION_ANALYSIS", entities: { radiusKm: r }, raw };  }  // /voice ëª¨ë‹¬ (?ŒìŠ¤??  if (/(vad|asr|?ìƒ·|?Œì„±ê°€??/i.test(raw)) {    return { intent: "OPEN_MODAL", raw };  }  // ?´ë°±: ?˜ì´ì§€ ?¤ì›Œ?œë§Œ ?¸ì??˜ë©´ NAVIGATE  const page = findPage(raw);  if (page) return { intent: "NAVIGATE", entities: { page }, raw };  return null;} 