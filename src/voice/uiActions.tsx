import type { Entities } from "./intents";import { createPortal } from "react-dom";import type { NavigateFunction } from "react-router-dom";import { getCurrentPosition } from "./util/location";import { fetchWithinRadius } from "./util/geoquery";import { uploadBlobToStorage } from "./util/upload";// ?°í???ì£¼ì…: navigate/useModal.open ?±ì„ ?¸ë??ì„œ ?¸íŒ…let _navigate: NavigateFunction | null = null;let _openModal: ((key: string, props?: any) => void) | null = null;let _setOverlay: ((node: JSX.Element | null) => void) | null = null;let _lastImageUrl: string | null = null;export const uiBridge = {  setNavigate(n: NavigateFunction) { _navigate = n; },  setOpenModal(fn: (key: string, props?: any) => void) { _openModal = fn; },  setOverlaySetter(fn: (node: JSX.Element | null) => void) { _setOverlay = fn; },};function ensure(cond: any, msg: string) { if (!cond) throw new Error(msg); }export const uiActions = {  navigate(e?: Entities) {    ensure(_navigate, "navigate not set");    const n = _navigate!;    const page = e?.page ?? "home";    const paths: Record<string, string> = { home: "/", market: "/market", meet: "/meet", jobs: "/jobs", sell: "/sell" };    if (e?.category && page === "market") {      n(`/market?cat=${encodeURIComponent(e.category)}`);      return;    }    n(paths[page]);  },  openAny(raw: string) {    ensure(_openModal, "openModal not set");    const open = _openModal!;    if (/vad/i.test(raw)) return open("voice:vad");    if (/asr/i.test(raw)) return open("voice:asr");    if (/?ìƒ·|ê°€??.test(raw)) return open("voice:signup");    // ê¸°ë³¸: Voice Hub    open("voice:asr");  },  captureProduct() {    ensure(_openModal, "openModal not set");    _openModal!("voice:capture", {      onCaptured: async (blob: Blob) => {        const url = await uploadBlobToStorage(blob);        _lastImageUrl = url;        _openModal!("voice:register", { preset: {}, imageUrl: url });      },    });  },  registerProduct(e?: Entities) {    ensure(_openModal, "openModal not set");    _openModal!("voice:register", { preset: e });  },  analyzeProduct(imageUrl?: string) {    ensure(_openModal, "openModal not set");    _openModal!("voice:analyze", { imageUrl: imageUrl ?? _lastImageUrl ?? undefined });  },  async locationSearch(e?: Entities) {    const radiusKm = e?.radiusKm ?? 2;    const pos = await getCurrentPosition({ enableHighAccuracy: true, timeout: 8000 });    const items = await fetchWithinRadius("products", { lat: pos.coords.latitude, lng: pos.coords.longitude }, radiusKm);    // ê°„ë‹¨ ?¤ë²„?ˆì´ ì¶œë ¥ (?„ìš” ??ë³„ë„ ëª¨ë‹¬ë¡?êµì²´)    _setOverlay?.(      <div className="fixed inset-0 bg-black/40 grid place-items-center p-4" onClick={() => _setOverlay?.(null)}>        <div className="bg-white dark:bg-zinc-900 rounded-2xl p-4 w-full max-w-xl">          <h3 className="text-lg font-semibold mb-2">??ì£¼ë? {radiusKm}km ê²°ê³¼</h3>          <ul className="max-h-80 overflow-auto list-disc pl-5 space-y-1">            {items.length === 0 ? (              <li className="list-none text-sm text-zinc-500">ì£¼ë? {radiusKm}km ??ê²°ê³¼ê°€ ?†ìŠµ?ˆë‹¤.</li>            ) : (              items.map((it) => (                <li key={it.id}>                  <a className="hover:underline" href={`/market/${it.id}`}>{it.title}</a>                  {" "}??{(it.distanceKm).toFixed(2)}km                </li>              ))            )}          </ul>        </div>      </div>    );  },  help() {    _setOverlay?.(      <div className="fixed inset-0 bg-black/40 grid place-items-center p-4" onClick={() => _setOverlay?.(null)}>        <div className="bg-white dark:bg-zinc-900 rounded-2xl p-5 w-full max-w-xl space-y-2">          <h3 className="text-lg font-semibold">?Œì„± ëª…ë ¹ ?ˆì‹œ</h3>          <ul className="list-disc pl-5 text-sm space-y-1">            <li>"ë§ˆì¼“?¼ë¡œ ?´ë™" / "ëª¨ì„ ?˜ì´ì§€ ?´ì–´ì¤?</li>            <li>"ì¶•êµ¬??ì¹´í…Œê³ ë¦¬ ë³´ì—¬ì¤?</li>            <li>"?í’ˆ ì´¬ì˜ ?œì‘" / "ì¹´ë©”???´ì–´ì¤?</li>            <li>"?í’ˆ ?±ë¡ ?œì‘" / "6ë§?ì²œì›???±ë¡??</li>            <li>"?í’ˆ AI ë¶„ì„?´ì¤˜"</li>            <li>"??ì£¼ë? 2km ë§¤ë¬¼ ë³´ì—¬ì¤?</li>            <li>"?«ì•„" / "ì·¨ì†Œ"</li>          </ul>        </div>      </div>    );  },  cancel() { _setOverlay?.(null); },}; 