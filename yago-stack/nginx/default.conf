# YAGO VIBE ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •

upstream n8n_backend {
    server n8n:5678;
}

upstream cast_bridge_backend {
    server cast-bridge:4000;
}

upstream firebase_ui_backend {
    server firebase-emulator:4001;
}

# HTTP ì„œë²„ (HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸)
server {
    listen 80;
    server_name localhost;
    
    # HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return 301 https://$server_name$request_uri;
}

# HTTPS ì„œë²„
server {
    listen 443 ssl http2;
    server_name localhost;
    
    # SSL ì¸ì¦ì„œ ì„¤ì •
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # SSL ë³´ì•ˆ ì„¤ì •
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # ë³´ì•ˆ í—¤ë”
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # n8n í”„ë¡ì‹œ
    location /n8n/ {
        proxy_pass http://n8n_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket ì§€ì›
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Cast Bridge í”„ë¡ì‹œ
    location /cast/ {
        proxy_pass http://cast_bridge_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Firebase Emulator UI í”„ë¡ì‹œ
    location /firebase/ {
        proxy_pass http://firebase_ui_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ê¸°ë³¸ í˜ì´ì§€ (ì„œë¹„ìŠ¤ ëª©ë¡)
    location / {
        return 200 '
        <!DOCTYPE html>
        <html>
        <head>
            <title>ğŸ§ YAGO VIBE ìŠ¤ë§ˆíŠ¸ ìŠ¤í”¼ì»¤ ìŠ¤íƒ</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                h1 { color: #2563eb; text-align: center; }
                .service { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .service h3 { margin: 0 0 10px 0; color: #374151; }
                .service a { color: #2563eb; text-decoration: none; }
                .service a:hover { text-decoration: underline; }
                .status { color: #10b981; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ§ YAGO VIBE ìŠ¤ë§ˆíŠ¸ ìŠ¤í”¼ì»¤ ìŠ¤íƒ</h1>
                <div class="service">
                    <h3>ğŸ”§ n8n ì›Œí¬í”Œë¡œìš° ì—”ì§„</h3>
                    <p>ìë™í™” ì›Œí¬í”Œë¡œìš° ë° ì›¹í›… ê´€ë¦¬</p>
                    <a href="/n8n/" target="_blank">n8n ëŒ€ì‹œë³´ë“œ ì—´ê¸°</a>
                </div>
                <div class="service">
                    <h3>ğŸµ Cast Bridge</h3>
                    <p>Google Nest/Home ìŠ¤í”¼ì»¤ ìºìŠ¤íŠ¸ ì„œë²„</p>
                    <a href="/cast/status" target="_blank">Cast Bridge ìƒíƒœ í™•ì¸</a>
                </div>
                <div class="service">
                    <h3>ğŸ”¥ Firebase Emulator</h3>
                    <p>ë¡œì»¬ Firestore, Storage, Auth ì—ë®¬ë ˆì´í„°</p>
                    <a href="/firebase/" target="_blank">Firebase Emulator UI ì—´ê¸°</a>
                </div>
                <div class="service">
                    <h3>ğŸ“± ìŠ¤ë§ˆíŠ¸ ìŠ¤í”¼ì»¤ í…ŒìŠ¤íŠ¸</h3>
                    <p>Kakao Mini, Google Home ì—°ë™ í…ŒìŠ¤íŠ¸</p>
                    <span class="status">âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ ì¤‘</span>
                </div>
            </div>
        </body>
        </html>
        ';
        add_header Content-Type text/html;
    }
}
